<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRF Charity Donation - Digital Rufiya</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Web3Modal and WalletConnect -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.11/dist/index.js"></script>

  <style>
    body {
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1470&q=80') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .overlay {
      background: rgba(0,0,0,0.7);
      padding: 2rem;
      border-radius: 1rem;
      max-width: 480px;
      margin: auto;
      box-shadow: 0 0 15px 5px rgba(0,255,0,0.2);
    }
    h1, h3 {
      color: #00ff6a;
      font-weight: 700;
    }
    label {
      font-weight: 600;
    }
    .btn-connect, .btn-donate, .btn-addtoken {
      width: 100%;
      margin-top: 1rem;
      font-weight: 600;
    }
    .btn-addtoken {
      background-color: #007bff;
    }
    .btn-connect {
      background-color: #28a745;
    }
    .btn-donate {
      background-color: #dc3545;
    }
    .form-check-label {
      user-select: none;
    }
    .referral-text {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #aaffaa;
      word-break: break-word;
    }
    .alert-info-custom {
      background-color: #222;
      border-color: #00ff6a;
      color: #00ff6a;
    }
  </style>
</head>
<body>
  <div class="overlay text-center">
    <h1>Donate to Save Orphan Children</h1>
    <p>Your charity helps provide water, food, and hope to orphans in need.</p>

    <button id="btnConnect" class="btn btn-connect">Connect Wallet</button>

    <div id="walletInfo" style="margin-top: 1rem; display:none;">
      <strong>Connected Wallet:</strong> <span id="walletAddress"></span>
    </div>

    <label for="donationAmount" class="mt-4">Donation Amount (USDC):</label>
    <input type="number" id="donationAmount" class="form-control text-center" min="0.1" step="0.1" placeholder="Enter amount in USDC" />

    <div class="form-check mt-3">
      <input class="form-check-input" type="checkbox" value="" id="anonymousToggle" />
      <label class="form-check-label" for="anonymousToggle">Donate Anonymously</label>
    </div>

    <button id="btnDonate" class="btn btn-donate" disabled>Donate Now</button>

    <button id="btnAddToken" class="btn btn-addtoken" style="display:none;">Add DRF Token to Wallet</button>

    <div id="referralSection" class="mt-3" style="display:none;">
      <small>Share your referral link to help us grow:</small>
      <div class="referral-text" id="referralLink"></div>
    </div>

    <div id="donationStatus" class="alert mt-3" role="alert" style="display:none;"></div>
  </div>

  <script>
    const USDC_ADDRESS = '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d'; // USDC on BSC
    const CHARITY_ADDRESS = '0x88253D87990EdD1E647c3B6eD21F57fb061a3040'; // Your charity USDC receiving address
    const DRF_TOKEN = {
      address: '0x7788a60dbC85AB46767F413EC7d51F149AA1bec6', // DRF token contract
      symbol: 'DRF',
      decimals: 18,
      image: 'https://i.postimg.cc/NFzPRcLc/IMG-20250421-210707-234.jpg'
    };
    const BSC_CHAIN_ID = '0x38';

    let web3Modal;
    let provider;
    let signer;
    let userAddress;

    const btnConnect = document.getElementById('btnConnect');
    const btnDonate = document.getElementById('btnDonate');
    const btnAddToken = document.getElementById('btnAddToken');
    const walletAddressSpan = document.getElementById('walletAddress');
    const walletInfoDiv = document.getElementById('walletInfo');
    const donationAmountInput = document.getElementById('donationAmount');
    const anonymousToggle = document.getElementById('anonymousToggle');
    const donationStatus = document.getElementById('donationStatus');
    const referralSection = document.getElementById('referralSection');
    const referralLinkDiv = document.getElementById('referralLink');

    // Initialize Web3Modal for mobile+desktop wallet connect
    function init() {
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: {
              56: 'https://bsc-dataseed.binance.org/'
            }
          }
        }
      };

      web3Modal = new window.Web3Modal.default({
        cacheProvider: false, // optional
        providerOptions,
        theme: 'dark'
      });
    }

    async function switchToBSC() {
      try {
        await provider.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: BSC_CHAIN_ID }]
        });
        return true;
      } catch (switchError) {
        // This error code indicates that the chain has not been added to MetaMask
        if (switchError.code === 4902) {
          try {
            await provider.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: BSC_CHAIN_ID,
                chainName: 'Binance Smart Chain Mainnet',
                nativeCurrency: { name: 'Binance Coin', symbol: 'BNB', decimals: 18 },
                rpcUrls: ['https://bsc-dataseed.binance.org/'],
                blockExplorerUrls: ['https://bscscan.com']
              }]
            });
            return true;
          } catch (addError) {
            console.error('Failed to add BSC network', addError);
            return false;
          }
        } else {
          console.error('Failed to switch to BSC network', switchError);
          return false;
        }
      }
    }

    async function connectWallet() {
      try {
        provider = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(provider);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        walletAddressSpan.textContent = userAddress;
        walletInfoDiv.style.display = 'block';
        btnConnect.textContent = 'Wallet Connected';
        btnConnect.disabled = true;
        btnDonate.disabled = false;
        btnAddToken.style.display = 'inline-block';

        // Check network and switch if needed
        const network = await provider.getNetwork();
        if (network.chainId !== 56) {
          const switched = await switchToBSC();
          if (!switched) {
            donationStatus.style.display = 'block';
            donationStatus.className = 'alert alert-danger';
            donationStatus.textContent = 'Please switch your wallet network to Binance Smart Chain (BSC) manually.';
            btnDonate.disabled = true;
            return;
          }
        }

        // Show referral if any
        showReferral();

        donationStatus.style.display = 'none';
      } catch (err) {
        console.error(err);
        alert('Failed to connect wallet. Please try again.');
      }
    }

    async function donate() {
      if (!signer) {
        alert('Please connect your wallet first.');
        return;
      }

      let amount = parseFloat(donationAmountInput.value);
      if (isNaN(amount) || amount <= 0) {
        alert('Enter a valid donation amount.');
        return;
      }

      // USDC has 6 decimals on BSC
      const amountInUnits = ethers.utils.parseUnits(amount.toString(), 6);

      const erc20Abi = ['function transfer(address to, uint amount) returns (bool)'];
      const usdcContract = new ethers.Contract(USDC_ADDRESS, erc20Abi, signer);

      try {
        btnDonate.disabled = true;
        donationStatus.style.display = 'block';
        donationStatus.className = 'alert alert-info';
        donationStatus.textContent = 'Processing your donation... please approve the transaction in your wallet.';

        const tx = await usdcContract.transfer(CHARITY_ADDRESS, amountInUnits);
        await tx.wait();

        donationStatus.className = 'alert alert-success';
        donationStatus.textContent = `Thank you for your generous donation of ${amount} USDC!`;

        // Clear amount input
        donationAmountInput.value = '';

        // Optionally, generate and prompt receipt download here (could be done later)

      } catch (error) {
        console.error(error);
        donationStatus.className = 'alert alert-danger';
        donationStatus.textContent = 'Donation failed or was rejected.';
      } finally {
        btnDonate.disabled = false;
      }
    }

    async function addDRFToken() {
      if (!provider) {
        alert('Connect your wallet first!');
        return;
      }

      try {
        await provider.provider.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: DRF_TOKEN.address,
              symbol: DRF_TOKEN.symbol,
              decimals: DRF_TOKEN.decimals,
              image: DRF_TOKEN.image
            }
          }
        });
      } catch (err) {
        console.error('Failed to add token', err);
      }
    }

    // Referral link from URL param 'ref'
    function showReferral() {
      const params = new URLSearchParams(window.location.search);
      const ref = params.get('ref');
      if (ref && /^0x[a-fA-F0-9]{40}$/.test(ref)) {
        referralSection.style.display = 'block';
        const currentUrl = window.location.origin + window.location.pathname;
        const link = `${currentUrl}?ref=${ref}`;
        referralLinkDiv.textContent = link;
        referralLinkDiv.title = 'Click to copy referral link';
        referralLinkDiv.style.cursor = 'pointer';

        referralLinkDiv.onclick = () => {
          navigator.clipboard.writeText(link);
          alert('Referral link copied to clipboard!');
        };
      }
    }

    btnConnect.addEventListener('click', connectWallet);
    btnDonate.addEventListener('click', donate);
    btnAddToken.addEventListener('click', addDRFToken);

    window.addEventListener('load', () => {
      init();
    });
  </script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
