<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRFMedia</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
    header { background: #fff; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h1 { margin: 0; font-size: 22px; }
    #uploadForm, #loadMoreBtn { max-width: 700px; margin: 15px auto; display: block; }
    form { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    textarea, input[type="file"] { width: 100%; margin: 10px 0; padding: 8px; font-size: 14px; }
    button { padding: 10px 20px; background: #0066cc; color: #fff; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
    button:hover { background: #0051a3; }
    .post-item { background: white; margin: 10px auto; padding: 15px; border-radius: 8px; max-width: 700px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    .post-item video, .post-item img { width: 100%; border-radius: 8px; }
    .post-caption { font-size: 15px; margin: 10px 0; }
    .post-owner, .post-time { font-size: 12px; color: #777; }
    .post-actions { display: flex; justify-content: space-between; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>üì∫ DRFMedia</h1>
    <button id="loginBtn">Sign in with Google</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </header>

  <form id="uploadForm" style="display:none;">
    <input type="file" id="mediaFile" accept="image/*,video/*" required />
    <textarea id="caption" placeholder="Write your caption..." required></textarea>
    <button type="submit">Upload</button>
  </form>

  <div id="postContainer"></div>
  <button id="loadMoreBtn" style="display:none;">Load More</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getDatabase, ref, push, update, onValue } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8", authDomain: "drfsocial-23a06.firebaseapp.com", databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com", projectId: "drfsocial-23a06", storageBucket: "drfsocial-23a06.appspot.com", messagingSenderId: "608135115201", appId: "1:608135115201:web:dc999df2c0f37241ff3f40" };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let posts = [];
    let index = 0;
    const batch = 10;

    const postContainer = document.getElementById("postContainer");
    const uploadForm = document.getElementById("uploadForm");
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      currentUser = user;
      loginBtn.style.display = user ? 'none' : 'block';
      logoutBtn.style.display = user ? 'block' : 'none';
      uploadForm.style.display = user ? 'block' : 'none';
    });

    const pinataJWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";";

    async function uploadToPinata(file) {
      const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
      const formData = new FormData();
      formData.append('file', file);
      const metadata = JSON.stringify({ name: file.name });
      formData.append('pinataMetadata', metadata);
      const response = await fetch(url, { method: 'POST', headers: { Authorization: pinataJWT }, body: formData });
      if (!response.ok) throw new Error('Pinata upload failed');
      const data = await response.json();
      return data.IpfsHash;
    }

    uploadForm.onsubmit = async e => {
      e.preventDefault();
      const file = document.getElementById("mediaFile").files[0];
      const caption = document.getElementById("caption").value.trim();
      if (!file || caption.length < 4 || !currentUser) return;
      const cid = await uploadToPinata(file);
      const type = file.type.startsWith("video") ? "video" : "image";
      const fileUrl = `https://gateway.pinata.cloud/ipfs/${cid}`;
      await push(ref(db, 'posts'), {
        caption,
        fileUrl,
        type,
        timestamp: Date.now(),
        likes: 0,
        views: 0,
        uid: currentUser.uid,
        userName: currentUser.displayName,
        userPhoto: currentUser.photoURL
      });
      document.getElementById("mediaFile").value = "";
      document.getElementById("caption").value = "";
    }

    function renderPosts() {
      const nextPosts = posts.slice(index, index + batch);
      nextPosts.forEach(post => {
        const viewedKey = `viewed_${post.id}`;
        if (!sessionStorage.getItem(viewedKey)) {
          update(ref(db, `posts/${post.id}`), { views: (post.views || 0) + 1 });
          sessionStorage.setItem(viewedKey, "1");
        }
        const div = document.createElement("div");
        div.className = "post-item";
        div.innerHTML = `
          ${post.type === 'video' ? `<video controls preload="metadata"><source src="${post.fileUrl}"></video>` : `<img src="${post.fileUrl}" loading="lazy">`}
          <p class="post-caption">${post.caption}</p>
          <p class="post-owner">By ${post.userName}</p>
          <p class="post-time">${timeAgo(post.timestamp)} ‚Ä¢ üëÅÔ∏è ${post.views || 0}</p>
          <div class="post-actions">
            <span>üëç ${post.likes || 0}</span>
            <button onclick="navigator.share ? navigator.share({ url: '${post.fileUrl}' }) : prompt('Copy:', '${post.fileUrl}')">Share</button>
          </div>`;
        postContainer.appendChild(div);
      });
      index += batch;
      loadMoreBtn.style.display = index < posts.length ? 'block' : 'none';
      localStorage.setItem("drf_cache", JSON.stringify(posts.slice(0, 20)));
    }

    function timeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      const units = { year: 31536000, month: 2592000, week: 604800, day: 86400, hour: 3600, minute: 60, second: 1 };
      for (let unit in units) {
        const val = Math.floor(seconds / units[unit]);
        if (val >= 1) return `${val} ${unit}${val > 1 ? 's' : ''} ago`;
      }
      return "Just now";
    }

    function loadPosts() {
      const postsRef = ref(db, 'posts');
      onValue(postsRef, snapshot => {
        posts = [];
        snapshot.forEach(child => posts.push({ id: child.key, ...child.val() }));
        posts.sort((a, b) => b.timestamp - a.timestamp);
        postContainer.innerHTML = "";
        index = 0;
        renderPosts();
      }, { onlyOnce: true });
    }

    loadMoreBtn.onclick = renderPosts;

    try {
      loadPosts();
    } catch {
      const cached = JSON.parse(localStorage.getItem("drf_cache") || "[]");
      posts = cached;
      renderPosts();
    }
  </script>
</body>
</html>
