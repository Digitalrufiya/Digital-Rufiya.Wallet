<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile Upload with Pinata + Firebase</title>
</head>
<body>

<input type="file" id="profilePhotoInput" accept="image/*" />
<button id="uploadBtn">Upload Profile Photo</button>
<img id="preview" src="" alt="Profile Preview" width="200" />

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
  import { getDatabase, ref, update } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js';
  import { getAuth, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js';

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // Your Pinata JWT token (NO 'Bearer ' prefix here!)
  const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

  const profilePhotoInput = document.getElementById('profilePhotoInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const preview = document.getElementById('preview');

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    currentUser = user;
    if (!user) {
      alert("Please log in first.");
    }
  });

  async function uploadToPinata(file) {
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${PINATA_JWT}`
      },
      body: formData
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`Pinata upload failed: ${res.status} ${errorText}`);
    }

    const data = await res.json();
    return `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;
  }

  uploadBtn.addEventListener('click', async () => {
    if (!currentUser) {
      alert("Please login to upload");
      return;
    }

    const file = profilePhotoInput.files[0];
    if (!file) {
      alert("Please select a file first");
      return;
    }

    try {
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";

      // Upload file to Pinata
      const pinataUrl = await uploadToPinata(file);
      preview.src = pinataUrl;

      // Save the URL to Firebase Realtime Database
      const updates = {};
      updates.photoURL = pinataUrl;
      await update(ref(db, `users/${currentUser.uid}`), updates);

      // Update Firebase Auth profile photoURL as well
      await updateProfile(currentUser, { photoURL: pinataUrl });

      alert("Profile photo uploaded and saved!");

    } catch (error) {
      alert(error.message);
      console.error(error);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Upload Profile Photo";
    }
  });
</script>

</body>
</html>
