<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DRFMedia Profile</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; margin: 0; }
    header { background: #0066cc; color: #fff; padding: 20px; text-align: center; }
    #profile { max-width: 700px; margin: 20px auto; background: #fff; border-radius: 10px; padding: 20px; }
    #coverPhoto { width: 100%; height: 180px; object-fit: cover; cursor: pointer; border-radius: 10px 10px 0 0; }
    #profilePhotoWrapper { position: relative; width: 120px; height: 120px; margin: -60px auto 10px; border-radius: 50%; border: 4px solid white; overflow: hidden; cursor: pointer; background: #eee; }
    #profilePhoto { width: 100%; height: 100%; object-fit: cover; }
    input[type="text"], textarea { width: 100%; margin: 10px 0; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    button { display: block; margin: 10px auto; padding: 12px 30px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
    input[type="file"] { display: none; }
  </style>
</head>
<body>

<header>
  <h1>DRFMedia Profile</h1>
</header>

<div id="profile">
  <img id="coverPhoto" src="" alt="Cover Photo" />
  <div id="profilePhotoWrapper">
    <img id="profilePhoto" src="" alt="Profile Photo" />
  </div>
  <input type="file" id="coverPhotoInput" accept="image/*">
  <input type="file" id="profilePhotoInput" accept="image/*">

  <input type="text" id="editName" placeholder="Your name" maxlength="50">
  <textarea id="editBio" placeholder="Your bio (optional)" maxlength="250"></textarea>
  <button id="saveProfileBtn">Save Profile</button>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
import { getDatabase, ref, update, onValue } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js';
import { getAuth, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:dc999df2c0f37241ff3f40"
};

const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";"; // shortened

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const coverPhoto = document.getElementById('coverPhoto');
const profilePhoto = document.getElementById('profilePhoto');
const coverPhotoInput = document.getElementById('coverPhotoInput');
const profilePhotoInput = document.getElementById('profilePhotoInput');
const editName = document.getElementById('editName');
const editBio = document.getElementById('editBio');
const saveBtn = document.getElementById('saveProfileBtn');

let currentUser;

const pinToIPFS = async (file) => {
  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
    method: "POST",
    headers: { Authorization: PINATA_JWT },
    body: formData
  });

  const json = await res.json();
  return `https://gateway.pinata.cloud/ipfs/${json.IpfsHash}`;
};

saveBtn.addEventListener('click', async () => {
  if (!currentUser) return;

  saveBtn.textContent = "Saving...";

  const updates = {};

  if (coverPhotoInput.files[0]) {
    const url = await pinToIPFS(coverPhotoInput.files[0]);
    updates.coverPhoto = url;
    coverPhoto.src = url;
  }

  if (profilePhotoInput.files[0]) {
    const url = await pinToIPFS(profilePhotoInput.files[0]);
    updates.photoURL = url;
    profilePhoto.src = url;
    await updateProfile(currentUser, { photoURL: url });
  }

  if (editName.value.trim() !== "") {
    updates.displayName = editName.value.trim();
    await updateProfile(currentUser, { displayName: updates.displayName });
  }

  if (editBio.value.trim() !== "") {
    updates.bio = editBio.value.trim();
  }

  if (Object.keys(updates).length > 0) {
    await update(ref(db, `users/${currentUser.uid}`), updates);
  }

  alert("Profile saved successfully!");
  saveBtn.textContent = "Save Profile";
});

coverPhoto.addEventListener('click', () => coverPhotoInput.click());
profilePhotoWrapper.addEventListener('click', () => profilePhotoInput.click());

onAuthStateChanged(auth, user => {
  if (!user) {
    alert("Not logged in");
    return;
  }
  currentUser = user;
  const userRef = ref(db, `users/${user.uid}`);
  onValue(userRef, snap => {
    const data = snap.val() || {};
    coverPhoto.src = data.coverPhoto || "https://via.placeholder.com/700x180";
    profilePhoto.src = data.photoURL || "https://i.pravatar.cc/120";
    editName.value = user.displayName || "";
    editBio.value = data.bio || "";
  });
});
</script>

</body>
</html>
