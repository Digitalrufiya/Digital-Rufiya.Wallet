<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRFTube Profile</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 0; margin: 0; }
    .container {
      max-width: 700px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; color: #0a84ff; }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #0a84ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled { background: #aaa; cursor: not-allowed; }
    img { max-width: 150px; border-radius: 50%; display: block; margin: 10px auto; }
  </style>
</head>
<body>
  <div class="container">
    <h2>DRFTube Profile</h2>
    <img id="profilePreview" src="https://via.placeholder.com/150" alt="Profile Preview" />
    <input type="file" id="profileImage" accept="image/*" />
    <input type="text" id="displayName" placeholder="Your Name" />
    <textarea id="bio" placeholder="Bio"></textarea>
    <input type="text" id="token" placeholder="Token Address" />
    <input type="email" id="email" placeholder="Email" />
    <input type="text" id="country" placeholder="Country" />
    <input type="number" id="age" placeholder="Age" />
    <select id="gender">
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
    <button id="saveBtn">Save Profile</button>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getDatabase, ref, update, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCdFX1PbNEgubM4Zib7U-hgtJbSOONPk6U",
    authDomain: "drftube-634c6.firebaseapp.com",
    projectId: "drftube-634c6",
    storageBucket: "drftube-634c6.appspot.com",
    messagingSenderId: "819828633864",
    appId: "1:819828633864:web:513002b461259b000cbcbd"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const profileImage = document.getElementById('profileImage');
  const preview = document.getElementById('profilePreview');
  const saveBtn = document.getElementById('saveBtn');

  let selectedFile = null;
  let currentUser = null;

  profileImage.addEventListener('change', e => {
    selectedFile = e.target.files[0];
    if (selectedFile) preview.src = URL.createObjectURL(selectedFile);
  });

  onAuthStateChanged(auth, async user => {
    if (!user) return alert("You must be logged in.");
    currentUser = user;
    const snap = await get(ref(db, 'users/' + user.uid));
    if (snap.exists()) {
      const data = snap.val();
      document.getElementById('displayName').value = user.displayName || '';
      document.getElementById('bio').value = data.bio || '';
      document.getElementById('token').value = data.token || '';
      document.getElementById('email').value = data.email || '';
      document.getElementById('country').value = data.country || '';
      document.getElementById('age').value = data.age || '';
      document.getElementById('gender').value = data.gender || '';
      if (data.photoHash) preview.src = `https://ipfs.io/ipfs/${data.photoHash}`;
    }
  });

  saveBtn.onclick = async () => {
    if (!currentUser) return;
    saveBtn.disabled = true;
    saveBtn.textContent = "Saving...";

    let photoHash = null;
    if (selectedFile) {
      const form = new FormData();
      form.append("file", selectedFile);
      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        headers: {
          Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6...REPLACE_THIS..."
        },
        body: form
      });
      const data = await res.json();
      photoHash = data.IpfsHash;
    }

    const updates = {
      bio: document.getElementById('bio').value,
      token: document.getElementById('token').value,
      email: document.getElementById('email').value,
      country: document.getElementById('country').value,
      age: document.getElementById('age').value,
      gender: document.getElementById('gender').value,
    };
    if (photoHash) updates.photoHash = photoHash;

    if (document.getElementById('displayName').value !== currentUser.displayName) {
      await updateProfile(currentUser, {
        displayName: document.getElementById('displayName').value
      });
    }

    await update(ref(db, 'users/' + currentUser.uid), updates);
    alert("Profile saved");
    saveBtn.disabled = false;
    saveBtn.textContent = "Save Profile";
  }
</script>
</body>
</html>
