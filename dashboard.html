<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DRF Wallet Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body style="font-family: Arial; background: #f4f9fb; padding: 20px;">

  <!-- LOADER -->
  <div id="loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; display: flex; align-items: center; justify-content: center; z-index: 9999;">
    <div style="border: 6px solid #f3f3f3; border-top: 6px solid #007bff; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
  </div>

  <header style="display: flex; justify-content: space-between; align-items: center; position: relative;">
    <h2 style="font-size: 24px; font-weight: bold;">My Assets</h2>
    <div style="font-size: 14px; color: #007bff; text-align: center; animation: rotation 5s linear infinite;">Digital Rufiya Wallet - Financial Revolution Powered by BSC Blockchain Network</div>
    <a href="settings.html" style="font-size: 14px; text-decoration: none;">⚙️ Settings</a>
  </header>

  <div>
    <h3>Total Portfolio Value: <span id="totalValue">0.00</span> USD</h3>
    <p id="walletAddress" style="font-weight: bold;"></p>
  </div>

  <div style="max-width: 400px; margin: auto; padding: 20px; background: #fff; border-radius: 10px;">
    <h3>Balances</h3>
    <div>
      <p>DRF: <span id="drfBalance">0</span> (<small id="drfPrice">—</small> USD)</p>
      <p>USDC: <span id="usdcBalance">0</span> (<small id="usdcPrice">—</small> USD)</p>
      <p>USDT: <span id="usdtBalance">0</span> (<small id="usdtPrice">—</small> USD)</p>
    </div>

    <h3>Token Logos</h3>
    <div>
      <img src="https://ik.imagekit.io/ttbbg9ocv/download%20(1).png?updatedAt=1746299785429" alt="USDC Logo" width="30" />
      <img src="https://ik.imagekit.io/ttbbg9ocv/images%20(1).png?updatedAt=1746299762762" alt="USDT Logo" width="30" />
      <img src="https://ik.imagekit.io/ttbbg9ocv/1000000655.jpg" alt="DRF Logo" width="30" />
    </div>
  </div>

  <h3 style="margin-top: 30px;">Deposit Tokens</h3>
  <div style="background: #fff; padding: 15px; border-radius: 10px; max-width: 400px; margin: auto;">
    <p><strong>Deposit DRF:</strong> Send DRF to your wallet address shown above.</p>
    <p><strong>Deposit USDC:</strong> Send USDC to your wallet address.</p>
    <p><strong>Deposit USDT:</strong> Send USDT (BEP-20) to your wallet.</p>
    <small style="color: gray;">Make sure to use the Binance Smart Chain (BSC).</small>
  </div>

  <h3 style="margin-top: 30px;">Receive Tokens</h3>
  <div id="receiveSection"></div>

  <!-- Sell DRF -->
  <div style="margin-top: 30px;">
    <button onclick="sellDRF()" style="padding: 10px 20px; background-color: #007bff; color: white;">Sell DRF to Mainnet</button>
  </div>

  <!-- Affiliate -->
  <div style="margin-top: 20px;">
    <button onclick="shareAffiliateLink()" style="padding: 10px 20px; background-color: #28a745; color: white;">Earn by Promoting</button>
  </div>

  <!-- FOOTER NAV -->
  <div class="bottom-nav" style="position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ccc;">
    <a href="dashboard.html"><img src="icon/dashboard.png" alt="Dashboard" width="24" /><br>Dashboard</a>
    <a href="send.html"><img src="icon/send.png" alt="Send" width="24" /><br>Send</a>
    <a href="swap.html"><img src="icon/swap.png" alt="Swap" width="24" /><br>Swap</a>
    <a href="transactions.html"><img src="icon/transactions.png" alt="Transactions" width="24" /><br>Transactions</a>
    <a href="tokensale.html"><img src="icon/token.png" alt="Token" width="24" /><br>Token</a>
  </div>

  <footer style="text-align: center; margin-top: 30px;">
    <p>2025 © DRF Wallet powered by AI technology and ChatGPT</p>
  </footer>

  <script>
    const BSC_RPC = "https://bsc-dataseed.binance.org/";
    const provider = new ethers.providers.JsonRpcProvider(BSC_RPC);

    const tokens = {
      DRF: {address: "0x7788a60dbC85AB46767F413EC7d51F149AA1bec6", symbol: "DRF", decimals: 18},
      USDC: {address: "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d", symbol: "USDC", decimals: 18},
      USDT: {address: "0x55d398326f99059fF775485246999027B3197955", symbol: "USDT", decimals: 18}
    };

    async function loadDashboard() {
      const encrypted = sessionStorage.getItem("drf_wallet_json") || localStorage.getItem("drf_encrypted_wallet");
      if (!encrypted) return location.href = "index.html";

      const password = sessionStorage.getItem("drf_wallet_pw");
      const wallet = await ethers.Wallet.fromEncryptedJson(encrypted, password);
      const addr = wallet.address;

      document.getElementById("walletAddress").innerText = "Wallet: " + addr;

      // Fetch balances
      let totalValue = 0;
      for (let token in tokens) {
        const contract = new ethers.Contract(tokens[token].address, ["function balanceOf(address) view returns(uint256)"], provider);
        const balance = await contract.balanceOf(addr);
        const formattedBalance = ethers.utils.formatUnits(balance, tokens[token].decimals);
        document.getElementById(`${token.toLowerCase()}Balance`).innerText = formattedBalance;

        const price = await getPrice(tokens[token].symbol);
        document.getElementById(`${token.toLowerCase()}Price`).innerText = price ? "$" + price.toFixed(4) : "—";
        totalValue += parseFloat(formattedBalance) * (price || 0);
      }

      document.getElementById("totalValue").innerText = totalValue.toFixed(2);
      showReceiveSection(addr);
    }

    async function getPrice(tokenSymbol) {
      const symbolMap = { DRF: "drf-token", USDC: "usd-coin", USDT: "tether" };
      try {
        const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${symbolMap[tokenSymbol]}&vs_currencies=usd`);
        const data = await response.json();
        return data[symbolMap[tokenSymbol]]?.usd || 0;
      } catch {
        return 0;
      }
    }

    function showReceiveSection(address) {
      const section = document.getElementById("receiveSection");
      const tokens = ["BNB", "DRF", "USDC", "USDT"];
      tokens.forEach(token => {
        const div = document.createElement("div");
        div.style.margin = "10px 0";
        div.innerHTML = `
          <strong>Receive ${token}:</strong><br>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${address}" /><br>
          <input type="text" value="${address}" readonly style="width:90%;" onclick="this.select()" /><br>
          <a href="https://bscscan.com/address/${address}" target="_blank">View on BscScan</a>
          <hr/>
        `;
        section.appendChild(div);
      });
    }

    function sellDRF() {
      alert("Sell 15.42 DRF = $1 to mainnet wallet. (Payment will be received on Mainnet)");
    }

    function shareAffiliateLink() {
      const encrypted = sessionStorage.getItem("drf_wallet_json") || localStorage.getItem("drf_encrypted_wallet");
      if (!encrypted) return alert("Wallet not connected");
      const address = JSON.parse(atob(encrypted.split('.')[1] || ""))?.address || "user";
      const affiliateLink = `https://your-dapp-link.com?ref=${address}`;
      prompt("Share this affiliate link to boost your wallet!", affiliateLink);
    }

    function hideLoader() {
      const loader = document.getElementById("loader");
      if (loader) loader.style.display = "none";
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await loadDashboard();
      setTimeout(hideLoader, 300);
    });
  </script>

</body>
</html>
