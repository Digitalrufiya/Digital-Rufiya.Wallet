<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRF Payment</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 480px;
      margin: auto;
      background: #f4f9fb;
      padding: 20px;
      color: #222;
    }
    h2 {
      text-align: center;
      color: #007bff;
      margin-bottom: 10px;
    }
    .request-details {
      background: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgb(0 123 255 / 0.15);
      margin-bottom: 20px;
    }
    .request-details p {
      margin: 8px 0;
      font-weight: 600;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
      color: #333;
    }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      width: 100%;
      background-color: #007bff;
      border: none;
      color: white;
      padding: 14px;
      font-size: 1.1rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    .error {
      color: #b00020;
      background: #ffd7d7;
      padding: 10px;
      border-radius: 6px;
      margin-top: 15px;
      font-weight: 600;
      text-align: center;
    }
    .success {
      color: #155724;
      background: #d4edda;
      padding: 10px;
      border-radius: 6px;
      margin-top: 15px;
      font-weight: 600;
      text-align: center;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>Complete Payment</h2>

  <div id="container">
    <p>Loading payment request...</p>
  </div>

  <script>
    const DRF_ADDRESS = "0x7788a60dbC85AB46767F413EC7d51F149AA1bec6";
    const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
    const USDC_ADDRESS = "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d";
    const BSC_RPC_URL = "https://bsc-dataseed.binance.org/";

    const STORAGE_KEY = 'drf_payment_requests';

    function getRequests() {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }

    function findRequestById(id) {
      return getRequests().find(r => r.id === id);
    }

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    async function sendPayment(request, signer, provider) {
      try {
        let tx;
        const amountStr = request.amount.toString();
        if (request.token === "BNB") {
          tx = await signer.sendTransaction({
            to: request.wallet,
            value: ethers.utils.parseEther(amountStr)
          });
        } else {
          const tokenAddress = 
            request.token === "DRF" ? DRF_ADDRESS : 
            request.token === "USDT" ? USDT_ADDRESS : 
            request.token === "USDC" ? USDC_ADDRESS : null;

          if (!tokenAddress) throw new Error("Unsupported token");

          const decimals = 18; // Usually 18, but USDT/USDC often have 6 decimals on BSC (important!)
          // For safety, USDT and USDC on BSC have 18 decimals here for example, adjust if you know differently.
          // You can also fetch decimals dynamically if needed.

          const tokenContract = new ethers.Contract(tokenAddress, ["function transfer(address,uint256) returns (bool)"], signer);
          tx = await tokenContract.transfer(request.wallet, ethers.utils.parseUnits(amountStr, decimals));
        }
        return tx.wait();
      } catch (e) {
        throw e;
      }
    }

    async function main() {
      const container = document.getElementById('container');
      const requestId = getQueryParam('id');

      if (!requestId) {
        container.innerHTML = `<div class="error">No payment request ID provided.</div>`;
        return;
      }

      const request = findRequestById(requestId);

      if (!request) {
        container.innerHTML = `<div class="error">Payment request not found or expired.</div>`;
        return;
      }

      container.innerHTML = `
        <div class="request-details">
          <p><strong>Amount:</strong> ${request.amount} ${request.token}</p>
          <p><strong>Pay To Wallet:</strong> ${request.wallet}</p>
          ${request.message ? `<p><strong>Message:</strong> ${request.message}</p>` : ""}
        </div>

        <label for="payerWallet">Your Wallet Address (to pay from):</label>
        <input type="text" id="payerWallet" placeholder="Connect your wallet address or paste here" />

        <button id="payBtn">Pay ${request.amount} ${request.token}</button>

        <div id="status"></div>
      `;

      const payBtn = document.getElementById('payBtn');
      const payerWalletInput = document.getElementById('payerWallet');
      const statusDiv = document.getElementById('status');

      // Connect wallet with Metamask or fallback to manual input
      let provider;
      let signer;

      async function connectWallet() {
        if (window.ethereum) {
          try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            const addr = await signer.getAddress();
            payerWalletInput.value = addr;
            payerWalletInput.disabled = true;
            return true;
          } catch (err) {
            statusDiv.innerHTML = `<div class="error">Wallet connection rejected.</div>`;
            return false;
          }
        } else {
          statusDiv.innerHTML = `<div class="error">No Ethereum wallet detected. Please install MetaMask or similar.</div>`;
          return false;
        }
      }

      await connectWallet();

      payBtn.onclick = async () => {
        statusDiv.innerHTML = "";
        payBtn.disabled = true;
        payBtn.classList.add('loading');

        // Confirm payer wallet matches signer address
        let payerAddress;
        if (signer) {
          try {
            payerAddress = await signer.getAddress();
            if (payerAddress.toLowerCase() !== payerWalletInput.value.trim().toLowerCase()) {
              statusDiv.innerHTML = `<div class="error">Connected wallet does not match the payer address input.</div>`;
              payBtn.disabled = false;
              payBtn.classList.remove('loading');
              return;
            }
          } catch {
            statusDiv.innerHTML = `<div class="error">Unable to verify connected wallet address.</div>`;
            payBtn.disabled = false;
            payBtn.classList.remove('loading');
            return;
          }
        } else {
          payerAddress = payerWalletInput.value.trim();
          if (!ethers.utils.isAddress(payerAddress)) {
            statusDiv.innerHTML = `<div class="error">Invalid payer wallet address.</div>`;
            payBtn.disabled = false;
            payBtn.classList.remove('loading');
            return;
          }
          statusDiv.innerHTML = `<div class="error">Please connect your wallet to send payment.</div>`;
          payBtn.disabled = false;
          payBtn.classList.remove('loading');
          return;
        }

        try {
          await sendPayment(request, signer, provider);
          statusDiv.innerHTML = `<div class="success">Payment successful! Thank you.</div>`;
          payBtn.style.display = 'none';
        } catch (err) {
          statusDiv.innerHTML = `<div class="error">Payment failed: ${err.message}</div>`;
          payBtn.disabled = false;
          payBtn.classList.remove('loading');
        }
      };
    }

    window.onload = main;
  </script>
</body>
</html>
