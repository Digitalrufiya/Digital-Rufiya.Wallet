<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRF Marketing Tool</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { background:#f0f2f5; font-family:sans-serif; }
  #uploadSection { background:white; padding:20px; margin:20px auto; max-width:700px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
  #dropArea { border:2px dashed #6366f1; padding:20px; text-align:center; border-radius:8px; cursor:pointer; margin-bottom:10px; }
  #dropArea.dragover { background:#eef2ff; }
  .carousel { display:flex; overflow-x:auto; gap:10px; margin-top:10px; }
  .carousel-item { position:relative; flex:0 0 auto; scroll-snap-align:start; }
  .carousel-item img, .carousel-item video { max-height:200px; border-radius:8px; }
  .logo-overlay { position:absolute; bottom:5px; right:5px; width:30px; height:30px; pointer-events:none; border-radius:50%; }
  .post { background:white; margin:20px auto; max-width:700px; padding:15px; border-radius:8px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
  .buttons { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .buttons button { flex:1; padding:8px; border:none; border-radius:5px; cursor:pointer; color:white; }
  .share-btn { background:#6366f1; }
</style>
</head>
<body>

<section id="uploadSection">
  <h2 class="text-xl font-bold mb-2">Create Marketing Post</h2>
  <textarea id="postText" placeholder="Write your post..." class="w-full p-2 border rounded mb-2"></textarea>
  <div id="dropArea">Drag & drop images/videos here or click to select
    <input type="file" id="fileInput" multiple accept="image/*,video/*" class="hidden">
  </div>
  <div id="preview" class="carousel"></div>
  <button id="uploadBtn" class="bg-green-600 px-4 py-2 rounded text-white mt-2">Upload Post</button>
  <div id="uploadStatus" class="mt-2 text-gray-600"></div>
</section>

<section id="feed"></section>
<div id="loading" class="text-center mt-4 text-gray-500">Loading posts...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, orderBy, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const pinataJWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI0MjA3ZmYxYS05MDU2LTRkZTktOGE2Yi1lM2JiZTA1YmY0YmEiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWF1bml2ZXJzaXR5QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiIyYjA3YjEyOWJkYTA0YTY2YmE0YSIsInNjb3BlZEtleVNlY3JldCI6IjYxZDdhMGVhYzVmNjAyNzhhNjQyODNlMjdmMTM2YjkxMjQ3YjM4NDg5MjA4YTUzNGYxNWFlMTE2Njc3ZGNkZGQiLCJleHAiOjE3ODYyNzUyNDJ9.BFUeEjlCR0jtpr1vylWYd5VkKVtDkNDhEuC2-3IFW1w"; // Your JWT

let currentUser = null;
onAuthStateChanged(auth, user => { if(!user) signInAnonymously(auth).catch(console.error); else currentUser=user; });

const dropArea = document.getElementById("dropArea");
const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");
const postText = document.getElementById("postText");
const uploadBtn = document.getElementById("uploadBtn");
const feed = document.getElementById("feed");
const uploadStatus = document.getElementById("uploadStatus");

let mediaFiles = [];

dropArea.addEventListener("click",()=>fileInput.click());
dropArea.addEventListener("dragover",e=>{ e.preventDefault(); dropArea.classList.add("dragover"); });
dropArea.addEventListener("dragleave",e=>{ e.preventDefault(); dropArea.classList.remove("dragover"); });
dropArea.addEventListener("drop",e=>{ e.preventDefault(); dropArea.classList.remove("dragover"); handleFiles(e.dataTransfer.files); });
fileInput.addEventListener("change",()=>handleFiles(fileInput.files));

function handleFiles(files){
  Array.from(files).forEach(f=>mediaFiles.push(f));
  renderPreview();
}

function renderPreview(){
  preview.innerHTML='';
  mediaFiles.forEach((file,index)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const div = document.createElement("div"); div.className='carousel-item';
      let el;
      if(file.type.startsWith("image/")) el=document.createElement("img");
      else if(file.type.startsWith("video/")){ el=document.createElement("video"); el.controls=true; }
      el.src = e.target.result; el.className="carousel-item";
      const logo = document.createElement("img"); logo.src="https://ik.imagekit.io/ttbbg9ocv/1000000655.jpg"; logo.className="logo-overlay";
      div.appendChild(el); div.appendChild(logo);
      preview.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}

async function uploadToPinata(file){
  const url="https://api.pinata.cloud/pinning/pinFileToIPFS";
  const formData = new FormData(); formData.append("file",file);
  const res = await fetch(url,{method:"POST", headers:{Authorization:`Bearer ${pinataJWT}`}, body:formData});
  if(!res.ok) throw new Error("Pinata upload failed");
  const data = await res.json(); return data.IpfsHash;
}

uploadBtn.onclick = async ()=>{
  if(!postText.value.trim() || mediaFiles.length===0){ alert("Post text and media required"); return; }
  uploadBtn.disabled = true; uploadStatus.textContent="Uploading...";
  try{
    const uploadedMedia=[];
    for(const f of mediaFiles){
      const ipfsHash = await uploadToPinata(f);
      uploadedMedia.push({ ipfsHash, type: f.type.startsWith("video")?"video":"image" });
    }
    await addDoc(collection(db,"marketingPosts"),{
      text: postText.value.trim(),
      media: uploadedMedia,
      createdAt: serverTimestamp()
    });
    uploadStatus.textContent="Upload successful!";
    postText.value=""; preview.innerHTML=""; mediaFiles=[];
    loadFeed();
  }catch(err){ console.error(err); uploadStatus.textContent="Upload failed!"; }
  finally{ uploadBtn.disabled=false; }
};

async function loadFeed(){
  feed.innerHTML=""; document.getElementById("loading").style.display="block";
  try{
    const q = query(collection(db,"marketingPosts"), orderBy("createdAt","desc"));
    const snapshot = await getDocs(q);
    snapshot.forEach(doc=>{
      const data = doc.data(); const div=document.createElement("div"); div.className="post";
      div.innerHTML = `<p>${data.text}</p><div class="carousel"></div><div class="buttons"><button class="share-btn">Share</button></div>`;
      const carouselDiv = div.querySelector(".carousel");
      data.media.forEach(m=>{
        let el;
        if(m.type==="video"){ el=document.createElement("video"); el.controls=true; el.src="https://gateway.pinata.cloud/ipfs/"+m.ipfsHash; }
        else{ el=document.createElement("img"); el.src="https://gateway.pinata.cloud/ipfs/"+m.ipfsHash; }
        el.style.maxHeight="200px"; el.style.borderRadius="8px";
        const logo = document.createElement("img"); logo.src="https://ik.imagekit.io/ttbbg9ocv/1000000655.jpg"; logo.className="logo-overlay";
        const wrapper = document.createElement("div"); wrapper.className="carousel-item"; wrapper.appendChild(el); wrapper.appendChild(logo);
        carouselDiv.appendChild(wrapper);
      });
      div.querySelector(".share-btn").onclick=()=>{ if(navigator.share) navigator.share({title:"DRF Post", text:data.text, url:window.location.href}); else alert("Sharing not supported"); };
      feed.appendChild(div);
    });
  }catch(err){ console.error(err); }
  document.getElementById("loading").style.display="none";
}

// Initial load
loadFeed();
</script>
</body>
</html>
