<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRF Marketplace</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 10px; background: #f7f7f7; }
  h1 { text-align: center; }
  form { background: white; padding: 15px; margin-bottom: 30px; border-radius: 6px; box-shadow: 0 0 8px #ccc; }
  label { display: block; margin-top: 10px; }
  input, textarea, select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 4px; border: 1px solid #ccc; }
  button { margin-top: 15px; padding: 10px 15px; font-size: 1rem; cursor: pointer; }
  #posts { margin-top: 40px; }
  .post { background: white; padding: 15px; margin-bottom: 20px; border-radius: 6px; box-shadow: 0 0 6px #bbb; }
  .post img, .post video { max-width: 100%; border-radius: 6px; margin-top: 10px; }
  .btns { margin-top: 15px; }
  .btns button, .btns a { margin-right: 10px; text-decoration: none; padding: 8px 12px; border-radius: 5px; border: none; cursor: pointer; }
  .btn-whatsapp { background: #25D366; color: white; }
  .btn-payment { background: #4CAF50; color: white; }
  .btn-like { background: #e91e63; color: white; }
  .btn-share { background: #2196F3; color: white; }
</style>
</head>
<body>

<h1>DRF Marketplace - Sell Your Photos & Videos</h1>

<form id="postForm">
  <label>Title *</label>
  <input type="text" id="title" required />

  <label>Description *</label>
  <textarea id="description" rows="3" required></textarea>

  <label>Country *</label>
  <input type="text" id="country" required />

  <label>City *</label>
  <input type="text" id="city" required />

  <label>WhatsApp Number (with country code, e.g. +123456789) *</label>
  <input type="text" id="whatsapp" pattern="^\+\d{7,15}$" placeholder="+123456789" required />

  <label>Payment Link (URL) *</label>
  <input type="url" id="paymentLink" placeholder="https://..." required />

  <label>Upload Photo or Video *</label>
  <input type="file" id="mediaFile" accept="image/*,video/*" required />

  <button type="submit">Post Listing</button>
</form>

<div id="posts"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
    authDomain: "drfmarket-place.firebaseapp.com",
    projectId: "drfmarket-place",
    storageBucket: "drfmarket-place.appspot.com",
    messagingSenderId: "752616443115",
    appId: "1:752616443115:web:73b71924daf66ae9c882ae",
    measurementId: "G-MV9JQZHLLY"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const postForm = document.getElementById('postForm');
  const postsDiv = document.getElementById('posts');

  // Submit form handler
  postForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = postForm.title.value.trim();
    const description = postForm.description.value.trim();
    const country = postForm.country.value.trim();
    const city = postForm.city.value.trim();
    const whatsapp = postForm.whatsapp.value.trim();
    const paymentLink = postForm.paymentLink.value.trim();
    const fileInput = postForm.mediaFile;
    const file = fileInput.files[0];

    if (!file) {
      alert('Please upload a photo or video file.');
      return;
    }

    // Upload file to Firebase Storage
    const storageRef = ref(storage, `marketplace_media/${Date.now()}_${file.name}`);
    const uploadTask = uploadBytesResumable(storageRef, file);

    uploadTask.on('state_changed',
      null,
      (error) => alert('Upload failed: ' + error.message),
      async () => {
        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

        // Add post to Firestore
        try {
          await addDoc(collection(db, 'marketplace_posts'), {
            title,
            description,
            country,
            city,
            whatsapp,
            paymentLink,
            mediaURL: downloadURL,
            mediaType: file.type.startsWith('video') ? 'video' : 'image',
            likes: 0,
            timestamp: Date.now()
          });
          alert('Post uploaded successfully!');
          postForm.reset();
        } catch (err) {
          alert('Error saving post: ' + err.message);
        }
      }
    );
  });

  // Listen for posts realtime and display
  const q = query(collection(db, 'marketplace_posts'), orderBy('timestamp', 'desc'));
  onSnapshot(q, (snapshot) => {
    postsDiv.innerHTML = '';
    snapshot.forEach(docSnap => {
      const post = docSnap.data();
      const id = docSnap.id;

      const postEl = document.createElement('div');
      postEl.className = 'post';

      // Title & desc
      postEl.innerHTML = `
        <h3>${escapeHTML(post.title)}</h3>
        <p>${escapeHTML(post.description)}</p>
        <p><b>Location:</b> ${escapeHTML(post.city)}, ${escapeHTML(post.country)}</p>
      `;

      // Media
      if(post.mediaType === 'video') {
        const video = document.createElement('video');
        video.src = post.mediaURL;
        video.controls = true;
        video.style.maxWidth = '100%';
        postEl.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = post.mediaURL;
        img.alt = post.title;
        postEl.appendChild(img);
      }

      // WhatsApp & Payment buttons
      const btnsDiv = document.createElement('div');
      btnsDiv.className = 'btns';

      const whatsappBtn = document.createElement('a');
      whatsappBtn.href = `https://wa.me/${post.whatsapp.replace(/\D/g, '')}`;
      whatsappBtn.target = '_blank';
      whatsappBtn.rel = 'noopener noreferrer';
      whatsappBtn.className = 'btn-whatsapp';
      whatsappBtn.textContent = 'WhatsApp Seller';

      const paymentBtn = document.createElement('a');
      paymentBtn.href = post.paymentLink;
      paymentBtn.target = '_blank';
      paymentBtn.rel = 'noopener noreferrer';
      paymentBtn.className = 'btn-payment';
      paymentBtn.textContent = 'Pay Now';

      btnsDiv.appendChild(whatsappBtn);
      btnsDiv.appendChild(paymentBtn);

      // Like button
      const likeBtn = document.createElement('button');
      likeBtn.className = 'btn-like';
      likeBtn.textContent = `👍 Like (${post.likes || 0})`;
      likeBtn.onclick = async () => {
        try {
          const postRef = doc(db, 'marketplace_posts', id);
          await updateDoc(postRef, { likes: (post.likes || 0) + 1 });
        } catch (e) {
          alert('Error liking post: ' + e.message);
        }
      };
      btnsDiv.appendChild(likeBtn);

      // Share button
      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn-share';
      shareBtn.textContent = 'Share';
      shareBtn.onclick = () => {
        if (navigator.share) {
          navigator.share({
            title: post.title,
            text: post.description,
            url: window.location.href + '#post-' + id,
          }).catch(console.error);
        } else {
          alert('Share API not supported in this browser.');
        }
      };
      btnsDiv.appendChild(shareBtn);

      postEl.appendChild(btnsDiv);
      postEl.id = 'post-' + id;

      postsDiv.appendChild(postEl);
    });
  });

  // Simple HTML escape to prevent injection
  function escapeHTML(str) {
    return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>

</body>
</html>
