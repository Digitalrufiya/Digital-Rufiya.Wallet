<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>DRF Marketplace</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    input, textarea, select, button { display: block; margin: 10px 0; padding: 8px; width: 100%; max-width: 400px; }
    .post { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
    .post img, .post video { max-width: 100%; height: auto; border-radius: 5px; }
    .buttons { margin-top: 10px; }
    .buttons button, .buttons a { margin-right: 10px; }
    #logoutBtn { margin-bottom: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>DRF Marketplace</h1>

  <div id="authDiv">
    <h3>Login / Register</h3>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
    <p id="authStatus"></p>
  </div>

  <div id="appDiv" class="hidden">
    <button id="logoutBtn">Logout</button>

    <h3>Post New Item</h3>
    <input type="file" id="fileInput" accept="image/*,video/*" />
    <input id="productTitle" type="text" placeholder="Title" maxlength="100" />
    <textarea id="productDescription" placeholder="Description"></textarea>
    <input id="country" type="text" placeholder="Country" />
    <input id="city" type="text" placeholder="City" />
    <input id="whatsapp" type="text" placeholder="WhatsApp Number" />
    <input id="paymentLink" type="url" placeholder="Payment Link (URL)" />
    <button id="postBtn">Post Item</button>
    <p id="postStatus"></p>

    <h3>Marketplace Posts</h3>
    <div id="postsList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
      authDomain: "drfmarket-place.firebaseapp.com",
      projectId: "drfmarket-place",
      storageBucket: "drfmarket-place.appspot.com",
      messagingSenderId: "752616443115",
      appId: "1:752616443115:web:73b71924daf66ae9c882ae",
      measurementId: "G-MV9JQZHLLY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const authDiv = document.getElementById('authDiv');
    const appDiv = document.getElementById('appDiv');
    const authStatus = document.getElementById('authStatus');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const fileInput = document.getElementById('fileInput');
    const productTitle = document.getElementById('productTitle');
    const productDescription = document.getElementById('productDescription');
    const country = document.getElementById('country');
    const city = document.getElementById('city');
    const whatsapp = document.getElementById('whatsapp');
    const paymentLink = document.getElementById('paymentLink');
    const postBtn = document.getElementById('postBtn');
    const postStatus = document.getElementById('postStatus');
    const postsList = document.getElementById('postsList');

    let currentUser = null;

    // Auth handlers
    loginBtn.onclick = () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        authStatus.textContent = 'Enter email and password.';
        return;
      }
      signInWithEmailAndPassword(auth, email, password)
        .catch(e => authStatus.textContent = 'Login failed: ' + e.message);
    };

    registerBtn.onclick = () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        authStatus.textContent = 'Enter email and password.';
        return;
      }
      createUserWithEmailAndPassword(auth, email, password)
        .catch(e => authStatus.textContent = 'Register failed: ' + e.message);
    };

    logoutBtn.onclick = () => {
      signOut(auth);
    };

    onAuthStateChanged(auth, user => {
      if(user) {
        currentUser = user;
        authStatus.textContent = 'Logged in as: ' + user.email;
        authDiv.classList.add('hidden');
        appDiv.classList.remove('hidden');
        loadPosts();
      } else {
        currentUser = null;
        authStatus.textContent = 'Please login or register.';
        authDiv.classList.remove('hidden');
        appDiv.classList.add('hidden');
        postsList.innerHTML = '';
      }
    });

    // Upload and post
    postBtn.onclick = async () => {
      postStatus.textContent = '';
      if (!currentUser) {
        postStatus.textContent = 'You must be logged in.';
        return;
      }
      if (!fileInput.files[0]) {
        postStatus.textContent = 'Please select an image or video file.';
        return;
      }
      if (!productTitle.value.trim()) {
        postStatus.textContent = 'Enter product title.';
        return;
      }
      // Other validations can be added here...

      const file = fileInput.files[0];
      const storageRef = ref(storage, `marketplace_media/${Date.now()}_${file.name}`);

      const uploadTask = uploadBytesResumable(storageRef, file);

      uploadTask.on('state_changed',
        (snapshot) => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          postStatus.textContent = `Upload is ${progress.toFixed(0)}% done`;
        },
        (error) => {
          postStatus.textContent = 'Upload failed: ' + error.message;
        },
        async () => {
          const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
          try {
            await addDoc(collection(db, 'posts'), {
              userId: currentUser.uid,
              productTitle: productTitle.value.trim(),
              productDescription: productDescription.value.trim(),
              country: country.value.trim(),
              city: city.value.trim(),
              whatsapp: whatsapp.value.trim(),
              paymentLink: paymentLink.value.trim(),
              mediaURL: downloadURL,
              mediaType: file.type.startsWith('video') ? 'video' : 'image',
              likes: 0,
              timestamp: serverTimestamp()
            });
            postStatus.textContent = 'Post created successfully!';
            // Clear form
            fileInput.value = '';
            productTitle.value = '';
            productDescription.value = '';
            country.value = '';
            city.value = '';
            whatsapp.value = '';
            paymentLink.value = '';
          } catch(e) {
            postStatus.textContent = 'Error saving post: ' + e.message;
          }
        }
      );
    };

    // Load posts and listen for real-time updates
    function loadPosts() {
      postsList.innerHTML = 'Loading posts...';
      const q = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
      onSnapshot(q, snapshot => {
        postsList.innerHTML = '';
        if (snapshot.empty) {
          postsList.textContent = 'No posts yet.';
          return;
        }
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const postEl = document.createElement('div');
          postEl.className = 'post';

          let mediaHTML = '';
          if (data.mediaType === 'video') {
            mediaHTML = `<video controls src="${data.mediaURL}"></video>`;
          } else {
            mediaHTML = `<img src="${data.mediaURL}" alt="Post media" />`;
          }

          postEl.innerHTML = `
            <strong>${escapeHTML(data.productTitle)}</strong><br />
            <em>${escapeHTML(data.productDescription)}</em><br />
            <small>${escapeHTML(data.city)}, ${escapeHTML(data.country)}</small><br />
            ${mediaHTML}
            <div class="buttons">
              <a href="https://wa.me/${encodeURIComponent(data.whatsapp)}" target="_blank">
                <button>WhatsApp</button>
              </a>
              <a href="${escapeHTML(data.paymentLink)}" target="_blank">
                <button>Payment Link</button>
              </a>
              <button class="likeBtn">Like (${data.likes || 0})</button>
              <button class="shareBtn">Share</button>
            </div>
          `;

          // Like button logic
          const likeBtn = postEl.querySelector('.likeBtn');
          likeBtn.onclick = async () => {
            // Simple like increment without user checks (can improve later)
            try {
              await updateDoc(doc(db, 'posts', docSnap.id), {
                likes: (data.likes || 0) + 1
              });
            } catch(e) {
              alert('Failed to like: ' + e.message);
            }
          };

          // Share button logic
          const shareBtn = postEl.querySelector('.shareBtn');
          shareBtn.onclick = () => {
            if (navigator.share) {
              navigator.share({
                title: data.productTitle,
                text: data.productDescription,
                url: window.location.href
              }).catch(console.error);
            } else {
              alert('Share not supported on this browser.');
            }
          };

          postsList.appendChild(postEl);
        });
      }, err => {
        postsList.textContent = 'Failed to load posts: ' + err.message;
      });
    }

    // Basic XSS prevention for text display
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m]);
    }
  </script>
</body>
</html>
