<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRF Marketplace</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
  #upload-section { background: white; padding: 15px; margin: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  input, textarea, button { display: block; width: 100%; margin: 10px 0; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  button { cursor: pointer; background-color: #007bff; color: white; border: none; }
  button:disabled { background: #aaa; cursor: default; }
  #posts { max-width: 600px; margin: auto; padding: 10px; }
  .post { background: white; margin-bottom: 20px; border-radius: 8px; padding: 15px; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
  .post h3 { margin: 0 0 5px 0; }
  .post video, .post img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
  .buttons { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
  .buttons button { flex: 1; }
  #loading { text-align: center; padding: 20px; font-size: 18px; color: #555; }
</style>
</head>
<body>

<section id="upload-section">
  <h2>Upload your Listing</h2>

  <!-- Trust Wallet payment -->
  <button id="payBtn">Pay 1 USDC to Upload</button>

  <input type="file" id="mediaInput" accept="image/*,video/*" disabled />
  <input type="text" id="titleInput" placeholder="Title" required disabled />
  <textarea id="descriptionInput" placeholder="Description" rows="3" required disabled></textarea>
  <input type="number" id="priceInput" placeholder="Price" required disabled />
  <input type="text" id="locationInput" placeholder="Location" required disabled />
  <input type="text" id="whatsappInput" placeholder="WhatsApp Number" required disabled />
  <input type="url" id="paymentLinkInput" placeholder="Payment Link" required disabled />
  <button id="uploadBtn" disabled>Upload Listing</button>
  <div id="uploadStatus"></div>
</section>

<section id="posts"></section>
<div id="loading">Loading posts...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, startAfter, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

Remind them that the Prophet ﷺ said:
“If a man says to his brother, ‘O kafir,’ then surely one of them is such.”
(Sahih al-Bukhari, Sahih Muslim)
— Meaning, you can’t just accuse someone of disbelief without proof, or you might be wrong yourself.

Explain that unity and mercy are essential in Islam, and differences of opinion should be handled with wisdom and patience, not violence and killing.

let lastVisible = null;
let loadingPosts = false;
const postsContainer = document.getElementById("posts");
const loadingEl = document.getElementById("loading");
let currentUser = null;

// Enable fields after payment
const payBtn = document.getElementById("payBtn");
const uploadBtn = document.getElementById("uploadBtn");
const inputs = ["mediaInput","titleInput","descriptionInput","priceInput","locationInput","whatsappInput","paymentLinkInput"].map(id => document.getElementById(id));

payBtn.onclick = () => {
  const trustWalletLink = "https://link.trustwallet.com/send?coin=20000714&address=0x88253D87990EdD1E647c3B6eD21F57fb061a3040&amount=1.0&token_id=0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";
  window.open(trustWalletLink, "_blank");
  inputs.forEach(input => input.disabled = false);
  uploadBtn.disabled = false;
  payBtn.disabled = true;
};

// Upload to Pinata
async function uploadToPinata(file) {
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const data = new FormData();
  data.append("file", file);
  const res = await fetch(url, { method: "POST", headers: { Authorization: `Bearer ${pinataJWT}` }, body: data });
  if (!res.ok) throw new Error("Pinata upload failed");
  const result = await res.json();
  return result.IpfsHash;
}

// Create post element
function createPostElement(postData, postId) {
  const div = document.createElement("div");
  div.classList.add("post");
  div.dataset.id = postId;

  div.innerHTML = `
    <h3>${postData.title}</h3>
    <p>${postData.description}</p>
    <p><strong>Price:</strong> $${postData.price}</p>
    <p><strong>Location:</strong> ${postData.location}</p>
    <p><strong>WhatsApp:</strong> <a href="https://wa.me/${postData.whatsapp}" target="_blank">${postData.whatsapp}</a></p>
    <div>
      ${postData.mediaType === "video" ? 
        `<video controls playsinline preload="metadata" width="100%" src="https://gateway.pinata.cloud/ipfs/${postData.ipfsHash}"></video>`
        :
        `<img src="https://gateway.pinata.cloud/ipfs/${postData.ipfsHash}" alt="${postData.title}" />`
      }
    </div>
    <div class="buttons">
      <button class="payBtn">Pay</button>
      <button class="whatsappBtn">Contact Seller</button>
      <button class="shareBtn">Share</button>
    </div>
  `;

  div.querySelector(".payBtn").onclick = () => {
    if (postData.paymentLink) window.open(postData.paymentLink, "_blank");
  };
  div.querySelector(".whatsappBtn").onclick = () => {
    if (postData.whatsapp) window.open(`https://wa.me/${postData.whatsapp}`, "_blank");
  };
  div.querySelector(".shareBtn").onclick = () => {
    if (navigator.share) navigator.share({ title: postData.title, text: postData.description, url: window.location.href });
    else alert("Sharing not supported");
  };

  return div;
}

// Load posts
async function loadPosts() {
  if (loadingPosts) return;
  loadingPosts = true;
  loadingEl.style.display = "block";

  let q = lastVisible
    ? query(collection(db, "posts"), orderBy("createdAt", "desc"), startAfter(lastVisible), limit(5))
    : query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(5));

  const querySnapshot = await getDocs(q);
  if (querySnapshot.empty) { loadingEl.textContent = "No more posts"; loadingPosts = false; return; }

  lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
  querySnapshot.forEach(docSnap => { postsContainer.appendChild(createPostElement(docSnap.data(), docSnap.id)); });

  loadingPosts = false;
  loadingEl.style.display = "none";

  document.querySelectorAll("video").forEach(video => {
    if (video.getBoundingClientRect().top < window.innerHeight && video.getBoundingClientRect().bottom > 0) video.play();
    else video.pause();
  });
}

window.addEventListener("scroll", () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) loadPosts();
  document.querySelectorAll("video").forEach(video => {
    if (video.getBoundingClientRect().top < window.innerHeight && video.getBoundingClientRect().bottom > 0) video.play();
    else video.pause();
  });
});

// Upload post
uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value;
  const desc = document.getElementById("descriptionInput").value;
  const price = document.getElementById("priceInput").value;
  const location = document.getElementById("locationInput").value;
  const whatsapp = document.getElementById("whatsappInput").value;
  const paymentLink = document.getElementById("paymentLinkInput").value;
  const status = document.getElementById("uploadStatus");

  if (!fileInput.files.length) { alert("Select file"); return; }
  if (!title || !desc || !price) { alert("Fill all fields"); return; }

  status.textContent = "Uploading...";
  const file = fileInput.files[0];
  let ipfsHash;
  try { ipfsHash = await uploadToPinata(file); } 
  catch(e) { status.textContent = "Upload failed"; return; }

  const mediaType = file.type.startsWith("video") ? "video" : "image";

  await addDoc(collection(db, "posts"), {
    title, description: desc, price, location, whatsapp, paymentLink,
    mediaType, ipfsHash, createdAt: serverTimestamp()
  });

  status.textContent = "Uploaded!";
  fileInput.value = ""; document.getElementById("titleInput").value = "";
  document.getElementById("descriptionInput").value = ""; document.getElementById("priceInput").value = "";
  document.getElementById("locationInput").value = ""; document.getElementById("whatsappInput").value = "";
  document.getElementById("paymentLinkInput").value = "";
};

// Anonymous sign in
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, user => { currentUser = user; loadPosts(); });

</script>

</body>
</html>
