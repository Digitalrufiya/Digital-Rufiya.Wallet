<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRFMarketplace — Gaza Support</title>
<style>
  :root{
    --bg:#f0f2f5;
    --card:#fff;
    --text:#111;
    --muted:#666;
    --primary:#1877f2;
    --danger:#e0245e;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:var(--primary);color:#fff;padding:10px 14px;display:flex;align-items:center;gap:12px}
  header img{width:36px;height:36px;border-radius:8px;background:#fff;padding:2px}
  header .brand{font-weight:700}
  #wrap{max-width:760px;margin:0 auto;padding:14px}
  #upload-section{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  input,textarea,button{width:100%;margin:8px 0;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:15px}
  textarea{resize:vertical}
  button{border:none;background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  #posts{margin-top:16px}
  .post{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .post h3{margin:0 0 6px 0}
  .meta{font-size:13px;color:var(--muted);margin-bottom:8px}
  .media{margin-top:10px}
  .media img,.media video{width:100%;border-radius:12px;display:block;background:#000}
  .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .buttons button,.buttons a{flex:1;text-align:center;text-decoration:none}
  .like-btn.liked{background:var(--danger)}
  .skeleton{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:16px;overflow:hidden;position:relative}
  .shimmer{height:12px;background:#e6e6e6;border-radius:8px;margin:10px 0;position:relative;overflow:hidden}
  .shimmer::after{
    content:"";position:absolute;inset:0;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
    transform:translateX(-100%);animation:sh 1.1s infinite;
  }
  .sk-title{height:16px}
  .sk-line{height:12px;width:80%}
  .sk-media{height:220px;border-radius:12px;background:#ddd}
  @keyframes sh{to{transform:translateX(100%)}}
  #loaderEnd{color:#777;text-align:center;padding:12px}
  .badge{display:inline-block;background:#eef3ff;color:#2b4fda;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
  .status{font-size:13px;color:#555;margin-top:6px}
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="logo">
  <div class="brand">DRFMarketplace</div>
  <span class="badge">Gaza Support</span>
</header>

<div id="wrap">
  <!-- UPLOAD (kept same, with progress text) -->
  <section id="upload-section">
    <h2>Upload your Listing</h2>
    <input type="file" id="mediaInput" accept="image/*,video/*" />
    <input type="text" id="titleInput" placeholder="Title" required />
    <textarea id="descriptionInput" placeholder="Description" rows="3" required></textarea>
    <input type="number" id="priceInput" placeholder="Price" required />
    <input type="text" id="locationInput" placeholder="Location" required />
    <input type="text" id="whatsappInput" placeholder="WhatsApp Number" required />
    <input type="url" id="paymentLinkInput" placeholder="Payment Link" required />
    <button id="uploadBtn">Upload Listing</button>
    <div class="status" id="uploadStatus"></div>
  </section>

  <!-- POSTS -->
  <section id="posts" aria-live="polite"></section>
  <div id="loaderEnd"></div>
</div>

<script type="module">
/* ===== Firebase (your config) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, startAfter, getDocs, doc, onSnapshot, updateDoc, arrayUnion, arrayRemove, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ===== Pinata (your JWT) ===== */
const pinataJWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI0MjA3ZmYxYS05MDU2LTRkZTktOGE2Yi1lM2JiZTA1YmY0YmEiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWF1bml2ZXJzaXR5QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiIyYjA3YjEyOWJkYTA0YTY2YmE0YSIsInNjb3BlZEtleVNlY3JldCI6IjYxZDdhMGVhYzVmNjAyNzhhNjQyODNlMjdmMTM2YjkxMjQ3YjM4NDg5MjA4YTUzNGYxNWFlMTE2Njc3ZGNkZGQiLCJleHAiOjE3ODYyNzUyNDJ9.BFUeEjlCR0jtpr1vylWYd5VkKVtDkNDhEuC2-3IFW1w";

/* ===== Helpers ===== */
const postsEl = document.getElementById("posts");
const loaderEnd = document.getElementById("loaderEnd");
const statusEl = document.getElementById("uploadStatus");
let currentUser = null;
let pageCursor = null;
let loading = false;
let reachedEnd = false;
const PAGE_SIZE = 8;

/* Facebook-like shimmer placeholders */
function showSkeleton(count=3){
  for(let i=0;i<count;i++){
    const sk = document.createElement("div");
    sk.className="skeleton";
    sk.innerHTML = `
      <div class="shimmer sk-title" style="width:40%"></div>
      <div class="shimmer sk-line" style="width:80%"></div>
      <div class="shimmer sk-line" style="width:60%"></div>
      <div class="sk-media shimmer" style="margin-top:10px"></div>
      <div class="shimmer sk-line" style="width:50%"></div>
    `;
    postsEl.appendChild(sk);
  }
}
function clearSkeleton(){
  document.querySelectorAll(".skeleton").forEach(n=>n.remove());
}

/* Upload to Pinata */
async function uploadToPinata(file){
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const data = new FormData();
  data.append("file", file);

  const res = await fetch(url, {
    method:"POST",
    headers:{ Authorization:`Bearer ${pinataJWT}` },
    body:data
  });
  if(!res.ok) throw new Error("Pinata upload failed");
  const json = await res.json();
  return json.IpfsHash;
}

/* Create a post DOM node with real-time likes and actions */
function createPostNode(p, id){
  const div = document.createElement("article");
  div.className = "post";
  div.id = `post-${id}`;
  const priceFmt = isFinite(p.price) ? Number(p.price).toLocaleString() : p.price;

  div.innerHTML = `
    <h3>${escapeHtml(p.title||"")}</h3>
    <div class="meta">
      ${p.location ? escapeHtml(p.location) + " • " : ""} 
      ${p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : ""}
    </div>
    <p>${escapeHtml(p.description||"")}</p>
    <div class="media"></div>
    <div class="buttons">
      <a class="payBtn" href="${p.paymentLink||'#'}" target="_blank" rel="noopener">Pay</a>
      <a class="waBtn" href="https://wa.me/${encodeURIComponent((p.whatsapp||'').replace(/[^0-9]/g,''))}" target="_blank" rel="noopener">Contact Seller</a>
      <button class="shareBtn">Share</button>
      <button class="like-btn">❤️ Like (0)</button>
    </div>
  `;

  // media
  const m = div.querySelector(".media");
  if(p.mediaType === "video"){
    const v = document.createElement("video");
    v.src = `https://gateway.pinata.cloud/ipfs/${p.ipfsHash}`;
    v.muted = true;
    v.playsInline = true;
    v.preload = "metadata";
    m.appendChild(v);
    observeMedia(v, true);
  }else{
    const img = document.createElement("img");
    img.loading = "lazy";
    img.alt = p.title || "media";
    img.dataset.src = `https://gateway.pinata.cloud/ipfs/${p.ipfsHash}`;
    lazyImage(img);
    m.appendChild(img);
  }

  // Share button (share marketplace URL with anchor to the post)
  const shareBtn = div.querySelector(".shareBtn");
  shareBtn.onclick = async ()=>{
    const url = `${location.origin}${location.pathname}#post-${id}`;
    const data = { title:p.title||"Listing", text:p.description||"", url };
    try{
      if(navigator.share){
        await navigator.share(data);
      }else{
        await navigator.clipboard.writeText(url);
        alert("Post link copied!");
      }
    }catch(e){}
  };

  // Likes (real-time)
  const likeBtn = div.querySelector(".like-btn");
  const refDoc = doc(db, "posts", id);

  const unsub = onSnapshot(refDoc, (snap)=>{
    if(!snap.exists()) return;
    const data = snap.data();
    const likes = data.likes || [];
    const count = likes.length;
    const isLiked = !!(currentUser && likes.includes(currentUser.uid));
    likeBtn.textContent = isLiked ? `❤️ Liked (${count})` : `❤️ Like (${count})`;
    likeBtn.classList.toggle("liked", isLiked);
  });

  likeBtn.onclick = async ()=>{
    if(!currentUser) return; // will always be set (anon) before load
    try{
      const likesField = (await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js")).arrayUnion;
      const unlikesField = (await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js")).arrayRemove;

      // We need current state to decide toggle; use a quick get via onSnapshot cache:
      // Simpler: try to add first; if already liked, we remove — but Firestore lets us idempotently do either.
      const isLiked = likeBtn.classList.contains("liked");
      await updateDoc(refDoc, {
        likes: isLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid)
      });
    }catch(e){ console.error(e); }
  };

  return div;
}

/* Lazy-load images */
function lazyImage(img){
  const io = new IntersectionObserver((entries, obs)=>{
    for(const entry of entries){
      if(entry.isIntersecting){
        img.src = img.dataset.src;
        obs.unobserve(img);
      }
    }
  }, { rootMargin:"200px" });
  io.observe(img);
}

/* Observe videos for lazy load + smart autoplay/pause */
const playingSet = new Set();
function observeMedia(el, isVideo=false){
  const io = new IntersectionObserver((entries)=>{
    for(const entry of entries){
      if(entry.isIntersecting){
        if(isVideo){
          // start loading & play when mostly in view
          smartPlay(entry.target);
        }
      }else{
        if(isVideo){
          entry.target.pause();
          playingSet.delete(entry.target);
        }
      }
    }
  }, { threshold:[0, .6, 1], rootMargin:"200px" });
  io.observe(el);
}
function smartPlay(video){
  // Pause other videos
  playingSet.forEach(v => { if(v!==video) v.pause(); });
  playingSet.clear();

  const tryPlay = async ()=>{
    try{
      await video.play();
      playingSet.add(video);
    }catch(e){
      // Browser might block; ignore
    }
  };
  tryPlay();
}

/* Escape HTML */
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* Load a page of posts (newest first) */
async function loadPosts(){
  if(loading || reachedEnd) return;
  loading = true;
  showSkeleton(pageCursor ? 2 : 4);

  let qRef;
  if(pageCursor){
    qRef = query(collection(db,"posts"), orderBy("createdAt","desc"), startAfter(pageCursor), limit(PAGE_SIZE));
  }else{
    qRef = query(collection(db,"posts"), orderBy("createdAt","desc"), limit(PAGE_SIZE));
  }
  const snap = await getDocs(qRef);
  clearSkeleton();

  if(snap.empty){
    reachedEnd = true;
    loaderEnd.textContent = "No more posts";
    loading = false;
    return;
  }

  pageCursor = snap.docs[snap.docs.length-1];

  snap.forEach(docSnap=>{
    const node = createPostNode(docSnap.data(), docSnap.id);
    postsEl.appendChild(node);
  });

  loading = false;
}

/* Infinite scroll */
window.addEventListener("scroll", ()=>{
  if(reachedEnd || loading) return;
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;
  if(nearBottom){ loadPosts(); }
});

/* Upload handler */
document.getElementById("uploadBtn").onclick = async ()=>{
  const fileInput = document.getElementById("mediaInput");
  const titleInput = document.getElementById("titleInput");
  const descriptionInput = document.getElementById("descriptionInput");
  const priceInput = document.getElementById("priceInput");
  const locationInput = document.getElementById("locationInput");
  const whatsappInput = document.getElementById("whatsappInput");
  const paymentLinkInput = document.getElementById("paymentLinkInput");

  if(!fileInput.files.length) return alert("Please select a media file");
  if(!titleInput.value.trim()||!descriptionInput.value.trim()||!priceInput.value||!locationInput.value.trim()||!whatsappInput.value.trim()||!paymentLinkInput.value.trim()){
    return alert("Please fill all fields");
  }

  statusEl.textContent = "Uploading media to IPFS…";
  const file = fileInput.files[0];

  try{
    const ipfsHash = await uploadToPinata(file);
    statusEl.textContent = "Saving listing…";

    const mediaType = file.type.startsWith("video") ? "video" : "image";

    await addDoc(collection(db,"posts"),{
      title: titleInput.value.trim(),
      description: descriptionInput.value.trim(),
      price: Number(priceInput.value),
      location: locationInput.value.trim(),
      whatsapp: whatsappInput.value.trim(),
      paymentLink: paymentLinkInput.value.trim(),
      ipfsHash,
      mediaType,
      createdAt: serverTimestamp(),
      likes: []
    });

    statusEl.textContent = "Listing uploaded!";
    fileInput.value = "";
    titleInput.value = "";
    descriptionInput.value = "";
    priceInput.value = "";
    locationInput.value = "";
    whatsappInput.value = "";
    paymentLinkInput.value = "";

    // reset feed to show the brand new post on top
    postsEl.innerHTML = "";
    pageCursor = null;
    reachedEnd = false;
    await loadPosts();
    window.scrollTo({ top:0, behavior:"smooth" });
  }catch(e){
    statusEl.textContent = "Upload failed: " + (e?.message||e);
  }
};

/* Auth: sign in anonymously first, THEN load feed (so likes work) */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    try{ await signInAnonymously(auth); }catch(e){ console.error(e); }
    return;
  }
  currentUser = user;
  if(postsEl.childElementCount===0){
    await loadPosts();
  }
});
</script>
</body>
</html>
