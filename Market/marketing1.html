<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRF Marketing Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:18px; background:#f3f4f6; color:#111; }
  #upload-section { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:900px; margin:auto; }
  input, textarea, button { box-sizing:border-box; width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #d1d5db; }
  button{ background:#2563eb; color:#fff; border:none; padding:10px; cursor:pointer; }
  button:disabled{ background:#9ca3af; cursor:default; }
  #posts{ max-width:900px; margin:18px auto; }
  .post{ background:#fff; padding:14px; border-radius:8px; margin-bottom:14px; box-shadow:0 4px 12px rgba(0,0,0,0.04); }
  .post img, .post video{ max-width:100%; border-radius:6px; margin-top:8px; }
  .buttons{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
</style>
</head>
<body>

<section id="upload-section">
  <h2>Share Your Marketing Content</h2>
  <input type="file" id="mediaInput" accept="image/*,video/*" />
  <input type="text" id="titleInput" placeholder="Title" />
  <textarea id="descriptionInput" placeholder="Description" rows="3"></textarea>
  <div style="margin-top:12px">
    <button id="uploadBtn">Upload Content</button>
  </div>
  <div id="uploadStatus" class="small" style="margin-top:10px"></div>
</section>

<section id="posts"></section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, user => {
  if (user) currentUser = user;
  else signInAnonymously(auth).catch(console.error);
});

/* --- Pinata Upload --- */
const pinataJWT = "Bearer YOUR_PINATA_JWT_HERE"; // replace with your own
async function uploadToPinata(file) {
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const data = new FormData();
  data.append("file", file);
  const res = await fetch(url, { method: "POST", headers: { Authorization: pinataJWT }, body: data });
  if (!res.ok) throw new Error("Pinata upload failed");
  const json = await res.json();
  return json.IpfsHash;
}

const uploadBtn = document.getElementById("uploadBtn");
const uploadStatus = document.getElementById("uploadStatus");
const postsContainer = document.getElementById("posts");

uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();

  if (!fileInput.files[0] || !title || !description) {
    alert("All fields are required");
    return;
  }

  uploadBtn.disabled = true;
  uploadStatus.textContent = "Uploading media to IPFS...";

  try {
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video") ? "video" : "image";

    const docRef = await addDoc(collection(db, "marketingPosts"), {
      title, description, ipfsHash, mediaType, createdAt: serverTimestamp()
    });

    uploadStatus.textContent = "âœ… Content uploaded successfully!";
    fileInput.value = "";
    document.getElementById("titleInput").value = "";
    document.getElementById("descriptionInput").value = "";

    loadPosts();
  } catch (err) {
    console.error(err);
    uploadStatus.textContent = "Upload error: " + (err.message || err);
    alert("Upload failed: " + (err.message || err));
  } finally {
    uploadBtn.disabled = false;
  }
};

/* --- Display posts --- */
async function loadPosts() {
  postsContainer.innerHTML = "";
  const q = query(collection(db, "marketingPosts"), orderBy("createdAt", "desc"));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc => {
    const data = doc.data();
    const postEl = document.createElement("div");
    postEl.className = "post";

    // Share URL: create a static URL using ipfs hash for OG preview
    const shareURL = `https://gateway.pinata.cloud/ipfs/${data.ipfsHash}`;

    postEl.innerHTML = `
      <h3>${data.title}</h3>
      <p>${data.description}</p>
      ${data.mediaType === "video" 
        ? `<video src="https://gateway.pinata.cloud/ipfs/${data.ipfsHash}" controls></video>` 
        : `<img src="https://gateway.pinata.cloud/ipfs/${data.ipfsHash}" />`}
      <div class="buttons">
        <button onclick="navigator.clipboard.writeText('${shareURL}').then(()=>alert('Link copied!'))">Copy Link</button>
        <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareURL)}','_blank')">Facebook</button>
        <button onclick="window.open('https://twitter.com/intent/tweet?url=${encodeURIComponent(shareURL)}&text=${encodeURIComponent(data.title)}','_blank')">Twitter</button>
        <button onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(shareURL)}&title=${encodeURIComponent(data.title)}&summary=${encodeURIComponent(data.description)}','_blank')">LinkedIn</button>
      </div>
    `;
    postsContainer.appendChild(postEl);
  });
}

// initial load
loadPosts();
</script>

</body>
</html>
