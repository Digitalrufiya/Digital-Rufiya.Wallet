<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRF Marketing Tool</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:18px; background:#f3f4f6; color:#111; }
  #upload-section { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:900px; margin:auto; }
  input, textarea, button { box-sizing:border-box; width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #d1d5db; }
  button{ background:#2563eb; color:#fff; border:none; padding:10px; cursor:pointer; }
  button:disabled{ background:#9ca3af; cursor:default; }
  #feed{ max-width:900px; margin:18px auto; }
  .post{ background:#fff; padding:14px; border-radius:8px; margin-bottom:14px; box-shadow:0 4px 12px rgba(0,0,0,0.04); }
  .share-buttons{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
  .share-buttons button{ flex:1; background:#e5e7eb; color:#111; padding:6px; font-size:12px; border-radius:4px; cursor:pointer; }
</style>
</head>
<body>

<section id="upload-section">
  <h2>Create Marketing Campaign</h2>
  <input type="file" id="mediaInput" accept="image/*,video/*" />
  <input type="text" id="titleInput" placeholder="Campaign Title" />
  <textarea id="descriptionInput" placeholder="Campaign Description" rows="3"></textarea>
  <button id="uploadBtn">Upload Campaign</button>
  <div id="uploadStatus" style="font-size:13px; color:#374151; margin-top:10px;"></div>
</section>

<section id="feed"></section>

<script type="module">
// --- FIREBASE CONFIG ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUser = null;
onAuthStateChanged(auth, user => { if(user) currentUser=user; else signInAnonymously(auth).catch(console.error); });

// --- PINATA UPLOAD ---
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA"; // replace with your JWT

async function uploadToPinata(file){
  const data = new FormData();
  data.append("file", file);
  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
    method:"POST",
    headers:{ Authorization: pinataJWT },
    body: data
  });
  if(!res.ok) throw new Error("Pinata upload failed");
  const json = await res.json();
  return json.IpfsHash;
}

// --- UPLOAD BUTTON ---
const uploadBtn = document.getElementById("uploadBtn");
const uploadStatus = document.getElementById("uploadStatus");
uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();
  if(!fileInput.files[0] || !title || !description) { alert("All fields required"); return; }

  uploadBtn.disabled = true;
  uploadStatus.textContent = "Uploading media to IPFS...";
  try {
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video") ? "video" : "image";

    await addDoc(collection(db,"marketing_campaigns"),{
      title, description, ipfsHash, mediaType, createdAt: serverTimestamp()
    });

    uploadStatus.textContent = "✅ Campaign uploaded successfully!";
    fileInput.value=""; document.getElementById("titleInput").value=""; document.getElementById("descriptionInput").value="";
    loadFeed();
  } catch(err){
    console.error(err);
    uploadStatus.textContent = "❌ Upload failed: "+err.message;
  } finally { uploadBtn.disabled=false; }
};

// --- LOAD FEED ---
async function loadFeed(){
  const feed = document.getElementById("feed");
  feed.innerHTML = "";
  const snapshot = await getDocs(collection(db,"marketing_campaigns"));
  snapshot.forEach(doc=>{
    const post = doc.data();
    const ipfsUrl = `https://ipfs.io/ipfs/${post.ipfsHash}`;
    const mediaHtml = post.mediaType==="video"
      ? `<video controls class="mt-2 rounded w-full"><source src="${ipfsUrl}" type="video/mp4"></video>`
      : `<img src="${ipfsUrl}" class="mt-2 rounded w-full">`;
    
    const shareUrl = encodeURIComponent(window.location.href + "?postId=" + doc.id);
    feed.innerHTML += `
      <div class="post">
        <h3>${post.title}</h3>
        <p>${post.description}</p>
        ${mediaHtml}
        <div class="share-buttons">
          <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${shareUrl}','_blank')">Facebook</button>
          <button onclick="window.open('https://twitter.com/intent/tweet?url=${shareUrl}&text=${encodeURIComponent(post.title)}','_blank')">Twitter</button>
          <button onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}','_blank')">LinkedIn</button>
          <button onclick="copyLink('${shareUrl}')">Copy Link</button>
        </div>
      </div>
    `;
  });
}

// --- COPY LINK ---
window.copyLink = (link)=>{
  navigator.clipboard.writeText(decodeURIComponent(link)).then(()=>alert("Link copied!"));
}

// auto-load feed
loadFeed();
</script>
</body>
</html>
