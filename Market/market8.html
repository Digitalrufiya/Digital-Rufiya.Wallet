<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pay to Upload</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.esm.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h2>Pay 1 USDC to Upload</h2>
<button id="payBtn">Pay 1 USDC</button>
<div id="status"></div>

<section id="upload-section" style="display:none;">
  <h3>Upload Your File</h3>
  <input type="file" id="fileInput" />
  <button id="uploadBtn">Upload</button>
</section>

<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.esm.min.js";

// --- USDC Payment ---
const USDC_ADDRESS = "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";
const RECEIVER_ADDRESS = "0x88253D87990EdD1E647c3B6eD21F57fb061a3040";
const USDC_ABI = [
  "function balanceOf(address owner) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function transfer(address to, uint256 amount) returns (bool)"
];

let userWallet;

async function connectWallet() {
  if (window.ethereum) {
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const provider = new ethers.BrowserProvider(window.ethereum);
    userWallet = await provider.getSigner();
    return userWallet;
  } else {
    alert("Trust Wallet / MetaMask required!");
  }
}

async function payUSDC() {
  await connectWallet();

  const provider = new ethers.BrowserProvider(window.ethereum);
  const signer = provider.getSigner();
  const usdc = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);

  const decimals = await usdc.decimals();
  const amount = ethers.parseUnits("1.0", decimals);

  try {
    const tx = await usdc.transfer(RECEIVER_ADDRESS, amount);
    document.getElementById("status").innerText = "Transaction sent, waiting confirmation...";
    await tx.wait();
    document.getElementById("status").innerText = "Payment received! You can now upload.";
    document.getElementById("upload-section").style.display = "block";
  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "Payment failed or rejected.";
  }
}

document.getElementById("payBtn").onclick = payUSDC;

// --- Firebase Setup ---
const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- Pinata Upload ---
const pinataJWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI0MjA3ZmYxYS05MDU2LTRkZTktOGE2Yi1lM2JiZTA1YmY0YmEiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWF1bml2ZXJzaXR5QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiIyYjA3YjEyOWJkYTA0YTY2YmE0YSIsInNjb3BlZEtleVNlY3JldCI6IjYxZDdhMGVhYzVmNjAyNzhhNjQyODNlMjdmMTM2YjkxMjQ3YjM4NDg5MjA4YTUzNGYxNWFlMTE2Njc3ZGNkZGQiLCJleHAiOjE3ODYyNzUyNDJ9.BFUeEjlCR0jtpr1vylWYd5VkKVtDkNDhEuC2-3IFW1w";

document.getElementById("uploadBtn").onclick = async () => {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("Select a file first");

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
    method: "POST",
    body: formData,
    headers: { Authorization: `Bearer ${pinataJWT}` }
  });
  const data = await res.json();
  const ipfsHash = data.IpfsHash;
  alert("File uploaded to IPFS: " + ipfsHash);

  // Store in Firebase
  await db.collection("uploads").add({
    ipfsHash,
    fileName: file.name,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Upload saved in Firebase!");
};
</script>

</body>
</html>
