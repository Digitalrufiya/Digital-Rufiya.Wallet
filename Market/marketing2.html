<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRF Marketing Post</title>

<!-- Default OG tags -->
<meta property="og:title" content="DRF Marketing Post" />
<meta property="og:description" content="Check out this post!" />
<meta property="og:image" content="" />
<meta property="og:url" content="" />
<meta property="og:type" content="website" />

<style>
body { font-family: Arial, sans-serif; margin:0; padding:18px; background:#f3f4f6; color:#111; }
#post-container { max-width:800px; margin:auto; background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
h1 { font-size:22px; margin-bottom:8px; }
p { font-size:16px; margin-bottom:12px; }
img, video { max-width:100%; border-radius:6px; margin-bottom:12px; }
input, textarea, button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #d1d5db; }
button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
button:disabled { background:#9ca3af; cursor:default; }
.share-buttons { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
.share-btn { flex:1; text-align:center; padding:8px 0; background:#10b981; color:#fff; border-radius:6px; cursor:pointer; font-size:14px; text-decoration:none; }
</style>
</head>
<body>

<section id="post-container">
  <h1 id="post-title">Loading...</h1>
  <p id="post-description"></p>
  <div id="post-media"></div>
  <div class="share-buttons" id="share-buttons"></div>
</section>

<hr style="margin:30px 0;">

<section id="upload-section" style="max-width:800px; margin:auto; background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06);">
  <h2>Upload New Post</h2>
  <input type="file" id="mediaInput" accept="image/*,video/*" />
  <input type="text" id="titleInput" placeholder="Title" />
  <textarea id="descriptionInput" placeholder="Description" rows="3"></textarea>
  <button id="uploadBtn">Upload</button>
  <div id="uploadStatus" style="margin-top:10px;"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
onAuthStateChanged(auth, user => {
  if(user) currentUser = user;
  else signInAnonymously(auth).catch(console.error);
});

// Pinata JWT
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA"; // ðŸ”‘ Replace with your JWT

async function uploadToPinata(file){
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const data = new FormData();
  data.append("file", file);
  const res = await fetch(url, { method:"POST", headers:{Authorization:pinataJWT}, body:data });
  if(!res.ok) throw new Error("Pinata upload failed");
  const json = await res.json();
  return json.IpfsHash;
}

// DOM elements
const uploadBtn = document.getElementById("uploadBtn");
const uploadStatus = document.getElementById("uploadStatus");
const mediaInput = document.getElementById("mediaInput");
const titleInput = document.getElementById("titleInput");
const descInput = document.getElementById("descriptionInput");
const postTitle = document.getElementById("post-title");
const postDesc = document.getElementById("post-description");
const postMedia = document.getElementById("post-media");
const shareButtons = document.getElementById("share-buttons");

// Upload new post
uploadBtn.onclick = async () => {
  if(!mediaInput.files[0] || !titleInput.value.trim() || !descInput.value.trim()){
    alert("All fields are required!");
    return;
  }
  uploadBtn.disabled = true;
  uploadStatus.textContent = "Uploading...";
  try{
    const ipfsHash = await uploadToPinata(mediaInput.files[0]);
    const mediaType = mediaInput.files[0].type.startsWith("video") ? "video" : "image";

    const docRef = await addDoc(collection(db,"marketingPosts"),{
      title:titleInput.value.trim(),
      description:descInput.value.trim(),
      ipfsHash,
      mediaType,
      createdAt:serverTimestamp()
    });

    uploadStatus.textContent = "âœ… Upload successful!";
    mediaInput.value = "";
    titleInput.value = "";
    descInput.value = "";
    window.location.href = window.location.pathname+"?id="+docRef.id;
  }catch(err){
    console.error(err);
    uploadStatus.textContent = "Upload failed: "+(err.message||err);
  }finally{
    uploadBtn.disabled=false;
  }
}

// Load post by ID
const params = new URLSearchParams(window.location.search);
const postId = params.get("id");

if(postId){
  async function loadPost(){
    try{
      const docRef = doc(db,"marketingPosts",postId);
      const docSnap = await getDoc(docRef);
      if(docSnap.exists()){
        const data = docSnap.data();
        postTitle.textContent = data.title;
        postDesc.textContent = data.description;

        if(data.mediaType==="video"){
          const video = document.createElement("video");
          video.src=`https://gateway.pinata.cloud/ipfs/${data.ipfsHash}`;
          video.controls=true;
          postMedia.appendChild(video);
        }else{
          const img = document.createElement("img");
          img.src=`https://gateway.pinata.cloud/ipfs/${data.ipfsHash}`;
          postMedia.appendChild(img);
        }

        // Update OG tags
        document.querySelector('meta[property="og:title"]').setAttribute("content",data.title);
        document.querySelector('meta[property="og:description"]').setAttribute("content",data.description);
        document.querySelector('meta[property="og:image"]').setAttribute("content",`https://gateway.pinata.cloud/ipfs/${data.ipfsHash}`);
        document.querySelector('meta[property="og:url"]').setAttribute("content",window.location.href);

        // Social share buttons
        const link = encodeURIComponent(window.location.href);
        const text = encodeURIComponent(`${data.title} - ${data.description}`);
        shareButtons.innerHTML = `
          <a class="share-btn" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=${link}">Facebook</a>
          <a class="share-btn" target="_blank" href="https://twitter.com/intent/tweet?url=${link}&text=${text}">Twitter</a>
          <a class="share-btn" target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=${link}&title=${text}">LinkedIn</a>
          <div class="share-btn" onclick="navigator.clipboard.writeText('${window.location.href}').then(()=>alert('Link copied!'))">Copy Link</div>
        `;

      }else{
        postTitle.textContent="Post not found!";
      }
    }catch(err){
      console.error(err);
      postTitle.textContent="Error loading post";
    }
  }
  loadPost();
}else{
  postTitle.textContent="No post selected. Upload a new post below!";
}
</script>
</body>
</html>
