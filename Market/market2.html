<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia Marketplace — Buy & Sell</title>
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="light dark" />
<style>
:root {
  --accent: #007bff;
  --accent-hover: #0056b3;
  --accent-muted: #3399ff;
  --bg-body: #f8f9fa;
  --bg-surface: #fff;
  --bg-surface-alt: #fafafa;
  --text-body: #212529;
  --text-muted: #6c757d;
  --radius: .5rem;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
  --shadow-md: 0 2px 4px rgba(0,0,0,.1)
}
@media(prefers-color-scheme:dark) {
  :root {
    --bg-body: #181a1b;
    --bg-surface: #242628;
    --bg-surface-alt: #2b2e30;
    --text-body: #f1f3f5;
    --text-muted: #adb5bd;
    --shadow-sm: none;
    --shadow-md: none
  }
}
* {
  box-sizing: border-box;
  margin: 0
}
body {
  font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg-body);
  color: var(--text-body);
  min-height: 100vh;
  display: flex;
  flex-direction: column
}
a {
  color: inherit;
  text-decoration: none
}
img,
video {
  max-width: 100%;
  border-radius: var(--radius);
  background: #000;
  display: block;
  opacity: 0;
  transition: opacity .3s
}
[data-loaded=true] {
  opacity: 1
}
header {
  background: var(--accent);
  color: #fff;
  padding: .75rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
  position: sticky;
  top: 0;
  z-index: 1000
}
.brand {
  display: flex;
  align-items: center;
  gap: .5rem;
  font-weight: 700
}
.brand img {
  width: 2.25rem;
  height: 2.25rem;
  border-radius: .25rem;
  background: #fff;
  padding: 2px
}
#primaryNav {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}
#primaryNav a {
  color: #fff;
  font-weight: 600;
  padding: .5rem .75rem;
  border-radius: var(--radius);
  transition: background-color 0.2s ease;
}
#primaryNav a:hover,
#primaryNav a.active {
  background-color: var(--accent-hover);
}
#menuToggle {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 1.5rem;
  cursor: pointer;
  display: none;
  user-select: none;
}
@media (max-width: 600px) {
  #primaryNav {
    display: none;
    flex-direction: column;
    width: 100%;
    background: var(--accent);
    margin-top: 0.5rem;
    border-radius: var(--radius);
  }
  #primaryNav.show {
    display: flex;
  }
  #menuToggle {
    display: block;
  }
}
.btn {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: .5rem 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background .2s
}
.btn:hover {
  background: var(--accent-hover)
}
.btn:disabled {
  background: #adb5bd;
  cursor: not-allowed
}
.container {
  width: min(100%, 700px);
  margin: 0 auto;
  padding: 0 1rem
}
#searchInput {
  width: 100%;
  padding: .55rem .85rem;
  margin: 1rem 0;
  border: 1px solid #ced4da;
  border-radius: var(--radius);
  background: var(--bg-surface);
  color: var(--text-body)
}
.post-item {
  background: var(--bg-surface-alt);
  border: 1px solid #dee2e6;
  border-radius: var(--radius);
  padding: 1rem;
  margin: 1.25rem 0;
  box-shadow: var(--shadow-sm)
}
.post-owner {
  display: flex;
  align-items: center;
  gap: .6rem;
  font-weight: 700
}
.avatar {
  width: 2.25rem;
  height: 2.25rem;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #ccc
}
.post-time {
  font-size: .8rem;
  color: var(--text-muted)
}
.post-caption {
  margin-top: .75rem;
  white-space: pre-wrap
}
.product-info {
  margin-top: 0.75rem;
  font-weight: 600;
}
.product-price {
  color: var(--accent);
  font-size: 1.1rem;
  margin-top: 0.3rem;
}
.product-contact {
  margin-top: 0.5rem;
}
.buttons {
  margin-top: 0.75rem;
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.buttons a,
.buttons button {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: 0.5rem 1rem;
  cursor: pointer;
  font-weight: 600;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  transition: background .2s;
}
.buttons a:hover,
.buttons button:hover {
  background: var(--accent-hover);
}
.disclaimer {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 1rem;
  border-top: 1px solid #ccc;
  padding-top: 1rem;
}
video,
img {
  max-width: 100%;
  border-radius: var(--radius);
  background: #000;
  display: block;
  opacity: 0;
  transition: opacity .3s
}
[data-loaded=true] {
  opacity: 1
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="logo" />
    <span>DRFMedia Marketplace</span>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">☰</button>
  <nav id="primaryNav">
    <a href="media.html" class="active">timeline</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Donate Ghaza</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search products…" />
  <button id="loginBtn" class="btn">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;background:#dc3545">Logout</button>

  <form id="uploadForm" style="display:none" autocomplete="off">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <input id="productTitle" type="text" placeholder="Product Title" minlength="2" required />
    <input id="productPrice" type="number" min="0" step="0.01" placeholder="Price (MVR)" required />
    <input id="productLocation" type="text" placeholder="Location (optional)" />
    <input id="productContact" type="text" placeholder="WhatsApp or Phone Number" minlength="5" required />
    <input id="paymentLink" type="url" placeholder="DRF Wallet Payment Link (optional)" />
    <div id="prog" style="display:none"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post Product</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>

  <div class="disclaimer">
    ⚠️ DRFMedia is a marketplace platform only. We do not guarantee payment, delivery, or product authenticity. Always verify before buying or sending money.
  </div>
</main>

<script type="module">
  const menuToggle = document.getElementById("menuToggle");
  const primaryNav = document.getElementById("primaryNav");

  // Responsive menu toggle for mobile
  if(window.innerWidth <= 600) {
    primaryNav.style.display = "none";
  }
  menuToggle.addEventListener("click", () => {
    if (primaryNav.style.display === "flex") {
      primaryNav.style.display = "none";
    } else {
      primaryNav.style.display = "flex";
    }
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    a.addEventListener("click", () => {
      if (window.innerWidth <= 600) {
        primaryNav.style.display = "none";
      }
    });
  });
  document.addEventListener("click", (e) => {
    const target = e.target;
    if (
      window.innerWidth <= 600 &&
      !primaryNav.contains(target) &&
      target !== menuToggle
    ) {
      primaryNav.style.display = "none";
    }
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    if (location.pathname.endsWith(a.getAttribute("href"))) {
      a.classList.add("active");
    } else {
      a.classList.remove("active");
    }
  });

  // Firebase imports and config
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const pinataJWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI0MjA3ZmYxYS05MDU2LTRkZTktOGE2Yi1lM2JiZTA1YmY0YmEiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWF1bml2ZXJzaXR5QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiJhNjEzMWU0MTdmNGUzOTljZDgwNiIsInNjb3BlZEtleVNlY3JldCI6ImQ4MDgwZjMzN2RjNDdhNjY1YWRlNTU3NWU2MDA0NmU4NDU0YjZkNmQ4MDcxYTY5YzBiODM2ODhiOTE2Mzg4OWYiLCJleHAiOjE3ODYyNzM3MTd9.AuOo1PiDfQEK_TodAsAcHBYiH4MkA4xwIYAtcX1Le6s";

  const firebaseConfig = {
    apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
    authDomain: "drfmarket-place.firebaseapp.com",
    projectId: "drfmarket-place",
    storageBucket: "drfmarket-place.firebasestorage.app",
    messagingSenderId: "752616443115",
    appId: "1:752616443115:web:73b71924daf66ae9c882ae",
    measurementId: "G-MV9JQZHLLY"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = (id) => document.getElementById(id);
  const login = $("loginBtn"),
    logout = $("logoutBtn");
  const upload = $("uploadForm"),
    fileIn = $("mediaFile"),
    titleIn = $("productTitle"),
    priceIn = $("productPrice"),
    locationIn = $("productLocation"),
    contactIn = $("productContact"),
    paymentLinkIn = $("paymentLink");
  const prog = $("prog"),
    bar = $("progBar");
  const posts = $("postContainer"),
    qIn = $("searchInput"),
    nav = $("primaryNav");

  let user = null,
    all = [];

  const escapeHTML = (s) =>
    s.replace(/[&<>"']/g, (m) => ({"&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"}[m]));

  async function getGatewayUrl(cid) {
    const gateways = [
      "https://gateway.pinata.cloud/ipfs/",
      "https://cloudflare-ipfs.com/ipfs/",
      "https://ipfs.io/ipfs/",
    ];
    for (const g of gateways) {
      try {
        const res = await fetch(g + cid, { method: "HEAD" });
        if (res.ok) return g + cid;
      } catch {}
    }
    return null;
  }

  function lazyLoadVideo(video) {
    video.dataset.loaded = false;
    video.oncanplay = () => (video.dataset.loaded = "true");
    video.onerror = () => {
      if (!video.retryCount) video.retryCount = 0;
      if (video.retryCount < 3) {
        setTimeout(() => {
          video.src = video.dataset.src; // retry loading
          video.load();
          video.retryCount++;
        }, 2 ** video.retryCount * 1000);
      }
    };
    video.src = video.dataset.src;
    video.load();
  }

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          lazyLoadVideo(entry.target);
          obs.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.25 }
  );

  async function shareProduct(p) {
    if (navigator.share) {
      try {
        await navigator.share({
          title: p.productTitle || 'DRFMedia product',
          text: `Check out this product: ${p.productTitle}`,
          url: location.origin + '/media.html#' + p.id
        });
      } catch (err) {
        alert('Share cancelled or failed');
      }
    } else {
      // fallback: copy URL to clipboard
      const shareUrl = location.origin + '/media.html#' + p.id;
      try {
        await navigator.clipboard.writeText(shareUrl);
        alert('Link copied to clipboard:\n' + shareUrl);
      } catch {
        alert('Sharing not supported on this browser');
      }
    }
  }

  async function render() {
    const term = qIn.value.trim().toLowerCase();
    posts.innerHTML = "";
    for (const p of all) {
      if (term && !(p.caption || "").toLowerCase().includes(term) && !(p.productTitle || "").toLowerCase().includes(term) && !(p.productLocation || "").toLowerCase().includes(term))
        continue;

      const card = document.createElement("article");
      card.className = "post-item";
      card.innerHTML = `
        <header class="post-owner">
          <img class="avatar" src="${p.photoURL || "https://via.placeholder.com/40"}" alt="User avatar" />
          <div>
            <div>${escapeHTML(p.displayName || "Anon")}</div>
            <time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">
              ${new Date(p.timestamp).toLocaleString()}
            </time>
          </div>
        </header>
        <div class="post-caption">${escapeHTML(p.caption || "")}</div>
        <div class="post-media" id="media-${p.id}"></div>
        <div class="product-info">${escapeHTML(p.productTitle)}</div>
        <div class="product-price">Price: MVR ${p.productPrice}</div>
        <div class="product-contact">Contact: ${escapeHTML(p.productContact)}</div>
        ${p.productLocation ? `<div class="product-location">Location: ${escapeHTML(p.productLocation)}</div>` : ""}
        ${p.paymentLink ? `<div class="product-payment">Pay: <a href="${escapeHTML(p.paymentLink)}" target="_blank" rel="noopener noreferrer">${escapeHTML(p.paymentLink)}</a></div>` : ""}
        <div class="buttons">
          <button data-id="${p.id}" class="share-btn">Share</button>
        </div>
      `;

      // Render media
      const mediaDiv = card.querySelector(`#media-${p.id}`);
      if (p.mediaType === "video") {
        const video = document.createElement("video");
        video.controls = true;
        video.dataset.src = p.mediaUrl;
        video.preload = "none";
        mediaDiv.appendChild(video);
        observer.observe(video);
      } else if (p.mediaType === "image") {
        const img = document.createElement("img");
        img.src = p.mediaUrl;
        img.onload = () => img.setAttribute("data-loaded", "true");
        mediaDiv.appendChild(img);
      }

      posts.appendChild(card);
    }

    // Add share buttons handlers
    posts.querySelectorAll(".share-btn").forEach((btn) =>
      btn.addEventListener("click", (e) => {
        const id = e.target.dataset.id;
        const p = all.find((x) => x.id === id);
        if (p) shareProduct(p);
      })
    );
  }

  async function loadPosts() {
    try {
      const dbRef = ref(db, "marketplace");
      const snap = await get(dbRef);
      all = [];
      if (snap.exists()) {
        snap.forEach((childSnap) => {
          const val = childSnap.val();
          all.push({ id: childSnap.key, ...val });
        });
      }
      all.sort((a, b) => b.timestamp - a.timestamp);
      render();
    } catch (err) {
      console.error("Failed to load posts", err);
    }
  }

  async function uploadToPinata(file) {
    return new Promise((resolve, reject) => {
      const fd = new FormData();
      fd.append("file", file);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "https://api.pinata.cloud/pinning/pinFileToIPFS");
      xhr.setRequestHeader("Authorization", "Bearer " + pinataJWT);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          bar.style.width = ((e.loaded / e.total) * 100).toFixed(2) + "%";
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          try {
            const res = JSON.parse(xhr.responseText);
            if (res.IpfsHash) {
              resolve(res.IpfsHash);
            } else {
              reject("Pinata upload failed: No IpfsHash");
            }
          } catch (e) {
            reject("Pinata upload failed: Invalid JSON response");
          }
        } else {
          reject("Pinata upload failed: " + xhr.status + " " + xhr.statusText);
        }
      };

      xhr.onerror = () => reject("Pinata upload failed: Network error");
      xhr.send(fd);
    });
  }

  upload.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!user) {
      alert("Please sign in first");
      return;
    }
    prog.style.display = "block";
    bar.style.width = "0%";

    try {
      const file = fileIn.files[0];
      if (!file) {
        alert("Please select a file");
        return;
      }

      const ipfsHash = await uploadToPinata(file);
      const mediaUrl = "https://gateway.pinata.cloud/ipfs/" + ipfsHash;

      // Determine media type
      const mediaType = file.type.startsWith("video") ? "video" : "image";

      const data = {
        caption: "",
        displayName: user.displayName,
        photoURL: user.photoURL,
        productTitle: titleIn.value.trim(),
        productPrice: priceIn.value.trim(),
        productLocation: locationIn.value.trim(),
        productContact: contactIn.value.trim(),
        paymentLink: paymentLinkIn.value.trim(),
        mediaUrl,
        mediaType,
        timestamp: Date.now(),
        uid: user.uid,
      };

      const dbRef = ref(db, "marketplace");
      await push(dbRef, data);

      alert("Product posted successfully!");
      upload.reset();
      prog.style.display = "none";
      bar.style.width = "0%";
      loadPosts();
    } catch (err) {
      alert(err);
      prog.style.display = "none";
      bar.style.width = "0%";
      console.error(err);
    }
  });

  login.addEventListener("click", async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  });

  logout.addEventListener("click", async () => {
    try {
      await signOut(auth);
    } catch (err) {
      alert("Logout failed: " + err.message);
    }
  });

  onAuthStateChanged(auth, (u) => {
    user = u;
    if (user) {
      login.style.display = "none";
      logout.style.display = "inline-block";
      upload.style.display = "block";
    } else {
      login.style.display = "inline-block";
      logout.style.display = "none";
      upload.style.display = "none";
    }
  });

  qIn.addEventListener("input", render);

  // Initial load
  loadPosts();
</script>
</body>
</html>
