<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRF Marketplace</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
  #upload-section { background: white; padding: 15px; margin: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  input, textarea, button { display: block; width: 100%; margin: 10px 0; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  button { cursor: pointer; background-color: #007bff; color: white; border: none; }
  button:disabled { background: #aaa; cursor: default; }
  #posts { max-width: 600px; margin: auto; padding: 10px; }
  .post { background: white; margin-bottom: 20px; border-radius: 8px; padding: 15px; box-shadow: 0 0 6px rgba(0,0,0,0.1); }
  .post h3 { margin: 0 0 5px 0; }
  .post video, .post img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
  .buttons { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
  .buttons button { flex: 1; }
  #loading { text-align: center; padding: 20px; font-size: 18px; color: #555; }
</style>
</head>
<body>

<section id="upload-section">
  <h2>Upload your Listing</h2>
  <input type="file" id="mediaInput" accept="image/*,video/*" />
  <input type="text" id="titleInput" placeholder="Title" required />
  <textarea id="descriptionInput" placeholder="Description" rows="3" required></textarea>
  <input type="number" id="priceInput" placeholder="Price" required />
  <input type="text" id="locationInput" placeholder="Location" required />
  <input type="text" id="whatsappInput" placeholder="WhatsApp Number" required />
  <!-- NEW: sellerâ€™s own payment link -->
  <input type="url" id="sellerPayInput" placeholder="Seller Payment Link (e.g. your gateway URL)" />
  <button id="payBtn">Pay 1 USDC</button>
  <button id="uploadBtn" disabled>Upload Listing</button>
  <div id="uploadStatus"></div>
</section>

<section id="posts"></section>
<div id="loading">Loading posts...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, startAfter, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// keep your JWT as-is
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI0MjA3ZmYxYS05MDU2LTRkZTktOGE2Yi1lM2JiZTA1YmY0YmEiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWF1bml2ZXJzaXR5QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiIyYjA3YjEyOWJkYTA0YTY2YmE0YSIsInNjb3BlZEtleVNlY3JldCI6IjYxZDdhMGVhYzVmNjAyNzhhNjQyODNlMjdmMTM2YjkxMjQ3YjM4NDg5MjA4YTUzNGYxNWFlMTE2Njc3ZGNkZGQiLCJleHAiOjE3ODYyNzUyNDJ9.BFUeEjlCR0jtpr1vylWYd5VkKVtDkNDhEuC2-3IFW1w"; 

let lastVisible = null;
let loadingPosts = false;
const postsContainer = document.getElementById("posts");
const loadingEl = document.getElementById("loading");
let currentUser = null;

const uploadBtn = document.getElementById("uploadBtn");
const payBtn = document.getElementById("payBtn");
const trustWalletLink = "https://link.trustwallet.com/send?coin=20000714&address=0x88253D87990EdD1E647c3B6eD21F57fb061a3040&amount=1.0&token_id=0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d";

// --- Helpers: robust IPFS URL + visibility/autoplay ---
const GATEWAYS = [
  "https://gateway.pinata.cloud/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/",
  "https://ipfs.io/ipfs/"
];

async function resolveIpfsUrl(cid) {
  // Try Pinata first, then fall back
  for (const base of GATEWAYS) {
    try {
      const head = await fetch(base + cid, { method: "HEAD" });
      if (head.ok) return base + cid;
    } catch {}
  }
  // default to pinata even if HEAD fails (some gateways block HEAD)
  return GATEWAYS[0] + cid;
}

function autoPlayIfVisible(el) {
  const rect = el.getBoundingClientRect();
  const viewportH = window.innerHeight || document.documentElement.clientHeight;
  // play if ~20% visible
  const visible = rect.top < viewportH * 0.9 && rect.bottom > viewportH * 0.1;
  if (visible) {
    el.play().catch(()=>{});
  } else {
    el.pause();
  }
}

const io = new IntersectionObserver((entries) => {
  entries.forEach((e) => {
    const v = e.target;
    if (e.isIntersecting) {
      autoPlayIfVisible(v);
    } else {
      v.pause();
    }
  });
}, { threshold: [0.2, 0.5] });

function wireVideoEvents(v) {
  // Retries for transient IPFS hiccups
  v._retry = 0;
  v.addEventListener("error", () => {
    if (v._retry < 3) {
      v._retry++;
      setTimeout(() => {
        const src = v.querySelector("source")?.src || v.src;
        if (src) {
          v.load();
          v.play().catch(()=>{});
        }
      }, 2 ** v._retry * 800);
    }
  });
  // Keep attempting autoplay when visible
  ["loadeddata","canplay","playing"].forEach(evt =>
    v.addEventListener(evt, () => autoPlayIfVisible(v))
  );
  io.observe(v);
}

payBtn.onclick = () => {
  window.open(trustWalletLink, "_blank");
  alert("After payment, click OK to enable upload");
  uploadBtn.disabled = false;
  payBtn.disabled = true;
};

async function uploadToPinata(file) {
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const data = new FormData();
  data.append("file", file);

  const res = await fetch(url, {
    method: "POST",
    headers: { Authorization: `Bearer ${pinataJWT}` },
    body: data
  });

  if (!res.ok) throw new Error("Pinata upload failed");
  const result = await res.json();
  return result.IpfsHash;
}

function createPostElement(postData, postId) {
  const div = document.createElement("div");
  div.classList.add("post");
  div.dataset.id = postId;

  const mediaHtml = postData.mediaType === "video"
    ? `<video playsinline muted controls preload="auto" width="100%"></video>`
    : `<img src="" alt="${postData.title}" />`;

  div.innerHTML = `
    <h3>${postData.title}</h3>
    <p>${postData.description}</p>
    <p><strong>Price:</strong> $${postData.price}</p>
    <p><strong>Location:</strong> ${postData.location}</p>
    <p><strong>WhatsApp:</strong> <a href="https://wa.me/${postData.whatsapp}" target="_blank">${postData.whatsapp}</a></p>
    <div class="media-holder">
      ${mediaHtml}
    </div>
    <div class="buttons">
      <button class="payBtn">Pay</button>
      <button class="whatsappBtn">Contact Seller</button>
      <button class="shareBtn">Share</button>
    </div>
  `;

  // Payment button: seller link first, fallback to owner link
  div.querySelector(".payBtn").onclick = () => {
    const u = (postData.sellerPaymentLink && postData.sellerPaymentLink.trim()) ? postData.sellerPaymentLink : trustWalletLink;
    window.open(u, "_blank");
  };
  div.querySelector(".whatsappBtn").onclick = () => {
    if (postData.whatsapp) window.open(`https://wa.me/${postData.whatsapp}`, "_blank");
  };
  div.querySelector(".shareBtn").onclick = () => {
    if (navigator.share) {
      navigator.share({ title: postData.title, text: postData.description, url: window.location.href });
    } else { alert("Sharing not supported"); }
  };

  // Load media with gateway fallback
  if (postData.mediaType === "video") {
    const v = div.querySelector("video");
    (async () => {
      const url = await resolveIpfsUrl(postData.ipfsHash);
      // use <source> for better type handling
      const s = document.createElement("source");
      s.src = url;
      // type is best effort; leaving empty allows browser to probe
      v.appendChild(s);
      wireVideoEvents(v);
      // try immediate play (esp. for first render / newly uploaded)
      v.play().catch(()=>{});
    })();
  } else {
    (async () => {
      const img = div.querySelector("img");
      const url = await resolveIpfsUrl(postData.ipfsHash);
      img.src = url;
    })();
  }

  return div;
}

async function loadPosts() {
  if (loadingPosts) return;
  loadingPosts = true;
  loadingEl.style.display = "block";

  try {
    let q = lastVisible
      ? query(collection(db, "posts"), orderBy("createdAt", "desc"), startAfter(lastVisible), limit(5))
      : query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(5));

    const querySnapshot = await getDocs(q);
    if (querySnapshot.empty) {
      loadingEl.textContent = "No more posts";
      loadingPosts = false;
      return;
    }

    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      const post = createPostElement(data, docSnap.id);
      postsContainer.appendChild(post);
    });

    lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
  } catch (err) {
    console.error("Failed to load posts:", err);
    loadingEl.textContent = "Failed to load posts";
  }

  loadingPosts = false;
  loadingEl.style.display = "none";
  // Try to play/pause based on visibility
  document.querySelectorAll("video").forEach(autoPlayIfVisible);
}

window.addEventListener("scroll", () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
    loadPosts();
  }
  document.querySelectorAll("video").forEach(autoPlayIfVisible);
});
window.addEventListener("resize", () => {
  document.querySelectorAll("video").forEach(autoPlayIfVisible);
});

// Anonymous login
onAuthStateChanged(auth, user => {
  if (user) currentUser = user;
  else signInAnonymously(auth).catch(console.error);
});

// Upload flow
uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();
  const price = parseFloat(document.getElementById("priceInput").value);
  const location = document.getElementById("locationInput").value.trim();
  const whatsapp = document.getElementById("whatsappInput").value.trim();
  const sellerPaymentLink = document.getElementById("sellerPayInput").value.trim();

  if (!fileInput.files[0] || !title || !description || isNaN(price) || !location || !whatsapp) {
    alert("All fields are required");
    return;
  }

  uploadBtn.disabled = true;
  document.getElementById("uploadStatus").textContent = "Uploading to IPFS...";

  try {
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video") ? "video" : "image";

    const docRef = await addDoc(collection(db, "posts"), {
      title,
      description,
      price,
      location,
      whatsapp,
      sellerPaymentLink: sellerPaymentLink || "", // NEW: save seller link
      ipfsHash,
      mediaType,
      createdAt: serverTimestamp()
    });

    const postData = { title, description, price, location, whatsapp, sellerPaymentLink, ipfsHash, mediaType };
    const newPostElement = createPostElement(postData, docRef.id);
    postsContainer.prepend(newPostElement);

    // Autoplay immediately if it's a video
    if (mediaType === "video") {
      const v = newPostElement.querySelector("video");
      v.play().catch(()=>{});
    }

    document.getElementById("uploadStatus").textContent = "Upload successful!";
    fileInput.value = "";
    // keep fields if you want; or clear:
    // document.getElementById("titleInput").value = "";
    // document.getElementById("descriptionInput").value = "";
    // document.getElementById("priceInput").value = "";
    // document.getElementById("locationInput").value = "";
    // document.getElementById("whatsappInput").value = "";
    // document.getElementById("sellerPayInput").value = "";
  } catch (err) {
    console.error(err);
    document.getElementById("uploadStatus").textContent = "Upload failed!";
  } finally {
    uploadBtn.disabled = false;
  }
};

// Initial load
loadPosts();
</script>

</body>
</html>
