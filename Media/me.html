// ===== Video with multiple gateway support and loading effect =====
function createVideo(cid) {
  const { g1, g2, g3 } = gw(cid);
  const v = document.createElement('video');
  v.controls = true;
  v.playsInline = true;
  v.preload = 'metadata'; // keep memory low until visible
  v.dataset.g1 = g1;
  v.dataset.g2 = g2;
  v.dataset.g3 = g3;
  v.dataset.idx = '0';
  
  // Create loading overlay
  const wrapper = document.createElement('div');
  wrapper.style.position = 'relative';
  wrapper.style.width = '100%';
  wrapper.style.background = '#000';
  
  const loader = document.createElement('div');
  loader.textContent = 'Loading...';
  loader.style.position = 'absolute';
  loader.style.top = '50%';
  loader.style.left = '50%';
  loader.style.transform = 'translate(-50%, -50%)';
  loader.style.color = '#fff';
  loader.style.fontWeight = 'bold';
  wrapper.appendChild(v);
  wrapper.appendChild(loader);
  
  v.onerror = () => switchGateway(v);
  v.oncanplay = () => {
    v.setAttribute('data-loaded', 'true');
    loader.style.display = 'none'; // hide loader when ready
  };

  return wrapper;
}

// ===== Switch gateway if video fails =====
window.switchGateway = function(video) {
  let idx = parseInt(video.dataset.idx || '0', 10) + 1;
  let next = '';
  if (idx === 1) next = video.dataset.g1;
  else if (idx === 2) next = video.dataset.g2;
  else if (idx === 3) next = video.dataset.g3;
  else {
    video.onerror = null; // all gateways failed
    return;
  }
  video.dataset.idx = String(idx);
  if (video.src !== next) {
    video.src = next;
    video.load();
  }
};
