<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMessenger</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    /* Existing CSS remains the same, skip here for brevity */
  </style>
</head>
<body>
  <!-- Existing HTML remains the same -->

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DATABASE_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let selectedUser = null;

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    loadUsers();
  } else {
    auth.signInAnonymously();
  }
});

function loadUsers() {
  const usersRef = db.ref("users");
  usersRef.once("value", snapshot => {
    usersListEl.innerHTML = "<h2>Users</h2>";
    snapshot.forEach(child => {
      const user = child.val();
      if (user.uid !== currentUser.uid) {
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
          <img src="${user.photoURL || 'https://i.pravatar.cc/40?u=' + user.uid}" class="user-avatar" />
          <div class="user-name">${user.displayName}</div>
        `;
        div.addEventListener('click', () => selectUser(user));
        usersListEl.appendChild(div);
      }
    });
  });
}

function selectUser(user) {
  selectedUser = user;
  chatHeaderEl.textContent = `Chat with ${user.displayName}`;
  inputMessageEl.disabled = false;
  sendBtnEl.disabled = false;
  renderMessages();
}

function getChatPath(uid1, uid2) {
  return `messages/${uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1}`;
}

function renderMessages() {
  const chatPath = getChatPath(currentUser.uid, selectedUser.uid);
  db.ref(chatPath).on("value", snapshot => {
    messagesContainerEl.innerHTML = "";
    snapshot.forEach(child => {
      const msg = child.val();
      const msgEl = document.createElement('div');
      msgEl.className = 'message ' + (msg.sender === currentUser.uid ? 'sent' : 'received');
      msgEl.textContent = msg.text;
      messagesContainerEl.appendChild(msgEl);
    });
    messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
  });
}

sendBtnEl.addEventListener('click', () => {
  const text = inputMessageEl.value.trim();
  if (text && selectedUser) {
    const chatPath = getChatPath(currentUser.uid, selectedUser.uid);
    db.ref(chatPath).push({
      sender: currentUser.uid,
      text,
      timestamp: Date.now()
    });
    inputMessageEl.value = "";
  }
});
</script>
</body>
</html>
