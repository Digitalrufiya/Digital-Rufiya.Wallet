<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DRFMessenger Debug</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; }
    nav { background:#0066cc; color:#fff; padding:10px; text-align:center; }
    #users { width:200px; overflow-y:auto; background:#fff; border-right:1px solid #ccc; }
    #users .user { padding:8px; cursor:pointer; border-bottom:1px solid #eee; }
    #users .user:hover { background:#e6f2ff; }
    #chat { flex:1; padding:10px; }
    #debug { background:#ffd; padding:10px; font-size:0.9em; height:100px; overflow:auto; }
  </style>
</head>
<body>
  <nav>DRFMessenger Debug</nav>
  <div style="display:flex; flex:1; overflow:hidden;">
    <div id="users"><h3>Users</h3></div>
    <div id="chat"><p>Select a user…</p></div>
  </div>
  <div id="debug"><strong>Debug log:</strong><br/></div>

  <script>
    // init firebase
    const cfg = {
      apiKey: "AIzaSyB…",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06"
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    const usersEl = document.getElementById('users');
    const chatEl = document.getElementById('chat');
    const dbg = document.getElementById('debug');
    function log(...args){ dbg.innerHTML += args.map(a=>JSON.stringify(a)).join(' ')+'<br>'; }

    const me = localStorage.getItem('drf_active_wallet');
    if(!me){
      usersEl.innerHTML = '<p>Please login to DRF Wallet first.</p>';
      throw 'no wallet';
    }
    log('My wallet:', me);

    function loadUsers(){
      db.ref('profiles').once('value')
        .then(snap=>{
          usersEl.innerHTML = '<h3>Users</h3>';
          snap.forEach(child=>{
            const wallet = child.key;
            const u = child.val();
            log('Profile key:', wallet, 'val:', u);
            if(wallet.toLowerCase()===me.toLowerCase()) return;
            const div = document.createElement('div');
            div.className = 'user';
            div.textContent = (u.name||wallet)+'   ('+wallet.slice(0,6)+'…)';
            div.onclick = ()=>startChat(wallet, u);
            usersEl.appendChild(div);
          });
        })
        .catch(e=>log('loadUsers error', e));
    }

    let currentChatId = null;
    function getChatId(a,b){
      a=a.toLowerCase(); b=b.toLowerCase();
      return a<b? a+'_'+b: b+'_'+a;
    }

    function startChat(wallet,u){
      chatEl.innerHTML = '<h4>Chat with '+(u.name||wallet)+'</h4><div id="msgs"></div><input id="inp"/><button id="btn">Send</button>';
      const msgsEl = document.getElementById('msgs');
      const inp = document.getElementById('inp');
      const btn = document.getElementById('btn');

      if(currentChatId)
        db.ref('messages/'+currentChatId).off();

      currentChatId = getChatId(me,wallet);
      log('listening on chatId', currentChatId);
      const ref = db.ref('messages/'+currentChatId);
      ref.on('value', snap=>{
        msgsEl.innerHTML = '';
        snap.forEach(c=>{
          const m=c.val();
          const d = document.createElement('div');
          d.textContent = (m.sender===me? 'Me: ':'Them: ')+m.text;
          msgsEl.appendChild(d);
        });
      });

      btn.onclick = ()=>{
        const text = inp.value.trim();
        if(!text) return;
        ref.push({ sender:me, text, timestamp:Date.now()});
        inp.value='';
      };
    }

    loadUsers();
  </script>
</body>
</html>
