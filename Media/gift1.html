<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>
  <style>
    /* ===== Basic Reset & Typography ===== */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #222;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== Header Navbar ===== */
    header {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .navbar-left img {
      height: 40px;
      width: 40px;
      border-radius: 4px;
      background: white;
      padding: 2px;
    }
    .navbar-left h1 {
      margin: 0;
      font-size: 1.4em;
      font-weight: 700;
    }
    #menuToggle {
      background: transparent;
      border: none;
      cursor: pointer;
      width: 30px;
      height: 25px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0;
    }
    #menuToggle span {
      display: block;
      height: 3.5px;
      background: white;
      border-radius: 3px;
    }
    #primaryNav {
      width: 100%;
      display: none;
      flex-direction: column;
      background: #0069d9;
      margin-top: 10px;
      border-radius: 4px;
    }
    #primaryNav.open {
      display: flex;
    }
    #primaryNav a {
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    #primaryNav a:first-child {
      border-top: none;
    }
    #primaryNav a:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Large screen nav */
    @media (min-width: 768px) {
      #menuToggle {
        display: none;
      }
      #primaryNav {
        display: flex !important;
        flex-direction: row;
        width: auto;
        background: transparent;
        margin-top: 0;
        border-radius: 0;
      }
      #primaryNav a {
        border: none;
        padding: 10px 15px;
        color: white;
      }
      #primaryNav a:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    }

    /* ===== Buttons ===== */
    button {
      cursor: pointer;
      border: none;
      background: #007bff;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 1em;
      transition: background-color 0.3s;
      margin: 5px 0;
    }
    button:hover {
      background: #0056b3;
    }
    button.liked {
      background: #28a745 !important; /* green */
      color: #fff !important;
    }
    button.boosted {
      background-color: gold !important;
      color: #000 !important;
    }

    /* ===== Forms ===== */
    form {
      max-width: 700px;
      margin: 20px auto;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
    }
    input[type="file"] {
      width: 100%;
      margin-bottom: 10px;
    }
    textarea {
      width: 100%;
      padding: 8px;
      font-size: 1em;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    select {
      color: #000;
      background: white;
      border: 1px solid #007bff;
      padding: 5px 10px;
      min-width: 110px;
      border-radius: 4px;
      margin-left: 5px;
    }
    select option {
      color: #000;
    }

    /* ===== Search bar ===== */
    #searchBar {
      max-width: 700px;
      margin: 10px auto 20px auto;
      padding: 0 15px;
    }
    #searchInput {
      width: 100%;
      padding: 8px 12px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* ===== Post container ===== */
    #postContainer {
      max-width: 700px;
      margin: 0 auto 40px auto;
      padding: 0 15px;
    }
    .post-item {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 30px;
      background: #fafafa;
    }
    .post-owner {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
    }
    .post-owner div {
      line-height: 1.1;
    }
    .post-time {
      font-size: 0.85em;
      color: #555;
      margin-top: 4px;
    }
    .post-caption {
      margin-top: 10px;
      font-size: 1em;
      white-space: pre-wrap;
    }
    .post-media {
      margin-top: 10px;
    }
    video,
    img {
      max-width: 100%;
      border-radius: 6px;
      background: black;
      display: block;
    }

    /* ===== Post actions ===== */
    .post-actions {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    /* ===== Comments Section ===== */
    .comments-section {
      margin-top: 15px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    .comments-list {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    .comment-item {
      border-bottom: 1px solid #ddd;
      padding: 5px 0;
    }
    .comment-item:last-child {
      border-bottom: none;
    }
    .comment-author {
      font-weight: 700;
      font-size: 0.9em;
    }
    .comment-text {
      font-size: 0.9em;
      margin-left: 8px;
    }
    .comment-time {
      font-size: 0.75em;
      color: #666;
      margin-left: 8px;
    }

    /* ===== Responsive tweaks ===== */
    @media (max-width: 480px) {
      header {
        justify-content: center;
      }
      .post-actions {
        flex-direction: column;
        align-items: flex-start;
      }
      button, select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="navbar-left">
      <img
        src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311"
        alt="DRFMedia Logo"
      />
      <h1>DRFMedia</h1>
    </div>
    <button id="menuToggle" aria-label="Toggle menu">
      <span></span><span></span><span></span>
    </button>
    <nav id="primaryNav">
      <a href="timeline.html">Timeline</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="loginNavLink">Login</a>
      <a href="#" id="logoutNavLink" style="display:none;">Logout</a>
    </nav>
  </header>

  <div id="searchBar">
    <input
      type="search"
      id="searchInput"
      placeholder="Search posts..."
      aria-label="Search posts"
    />
  </div>

  <button id="loginBtn" style="display: block; max-width: 700px; margin: 10px auto;">
    Sign in with Google
  </button>
  <button
    id="logoutBtn"
    style="display:none; max-width: 700px; margin: 10px auto;"
  >
    Logout
  </button>

  <form
    id="uploadForm"
    style="display:none; max-width:700px; margin:20px auto;"
    enctype="multipart/form-data"
  >
    <input type="file" id="mediaFile" accept="image/*,video/*" required />
    <textarea
      id="caption"
      placeholder="Write your caption..."
      required
      minlength="4"
      style="width:100%; margin-top:10px; padding:8px; font-size:1em;"
    ></textarea>
    <button type="submit" style="margin-top:10px; padding: 10px 20px; font-size:1em;">
      Post
    </button>
  </form>

  <div id="postContainer" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      get,
      update,
      runTransaction,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import {
      getAuth,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // Firebase config - replace with your own project config if needed
    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.appspot.com",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:dc999df2c0c37241ff3f40",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const uploadForm = document.getElementById("uploadForm");
    const mediaFile = document.getElementById("mediaFile");
    const captionInput = document.getElementById("caption");
    const postContainer = document.getElementById("postContainer");
    const searchInput = document.getElementById("searchInput");

    let currentUser = null;
    let allPosts = [];

    // Toggle menu on small screens
    document.getElementById("menuToggle").addEventListener("click", () => {
      document.getElementById("primaryNav").classList.toggle("open");
    });

    // Escape to prevent XSS
    const escapeHTML = (str) =>
      str.replace(/[&<>"]/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
      }[c]));

    // Auth state changed
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      uploadForm.style.display = user ? "block" : "none";
      loginBtn.style.display = user ? "none" : "block";
      logoutBtn.style.display = user ? "block" : "none";
      renderPosts();
    });

    loginBtn.onclick = () => signInWithPopup(auth, provider).catch((e) => alert("Login failed: " + e.message));
    logoutBtn.onclick = () => signOut(auth).catch((e) => alert("Logout failed: " + e.message));

    // Upload handler - uploads file to Pinata, then saves post to Firebase Realtime DB
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Please login.");
      if (!mediaFile.files.length) return alert("Select a file.");
      if (captionInput.value.trim().length < 4)
        return alert("Caption too short.");

      uploadForm.querySelector("button").disabled = true;
      const file = mediaFile.files[0];
      const fd = new FormData();
      fd.append("file", file);

      try {
        // Put your actual Pinata JWT here
        const pinataJWT =
          "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.your_jwt_token_here";

        const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
          method: "POST",
          headers: { Authorization: pinataJWT },
          body: fd,
        });
        if (!res.ok) throw new Error("Pinata upload failed: " + res.statusText);
        const { IpfsHash } = await res.json();

        const newPostRef = push(ref(db, "posts"));
        await set(newPostRef, {
          userId: currentUser.uid,
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          caption: captionInput.value.trim(),
          ipfsHash: IpfsHash,
          mediaType: file.type.startsWith("video") ? "video" : "image",
          mediaMimeType: file.type,
          timestamp: Date.now(),
          likesCount: 0,
          commentsCount: 0,
          boostsCount: 0,
          boostedBy: {},
          likesBy: {},
          comments: {}, // store comments here
        });

        captionInput.value = "";
        mediaFile.value = "";
        alert("Posted successfully!");
      } catch (err) {
        alert("Upload failed: " + err.message);
      } finally {
        uploadForm.querySelector("button").disabled = false;
      }
    });

    // Load posts and listen for updates
    const postsRef = ref(db, "posts");
    onValue(postsRef, (snapshot) => {
      const posts = snapshot.val() || {};
      allPosts = Object.entries(posts).map(([id, post]) => ({ id, ...post }));
      allPosts.sort((a, b) => b.timestamp - a.timestamp);
      renderPosts();
    });

    // Render posts with filtering and updated like/boost button states + comments
    function renderPosts() {
      const filter = searchInput.value.trim().toLowerCase();
      postContainer.innerHTML = "";
      for (const post of allPosts) {
        if (!post.caption.toLowerCase().includes(filter)) continue;

        const url1 = "https://gateway.pinata.cloud/ipfs/" + post.ipfsHash;

        const isBoosted = currentUser && post.boostedBy && post.boostedBy[currentUser.uid];
        const isLiked = currentUser && post.likesBy && post.likesBy[currentUser.uid];

        const dateStr = new Date(post.timestamp).toLocaleString();

        const mediaHTML =
          post.mediaType === "video"
            ? `<video src="${url1}" controls playsinline preload="metadata" poster="" loading="lazy"></video>`
            : `<img src="${url1}" alt="Post media" loading="lazy" />`;

        const likesCount = post.likesCount || 0;
        const boostsCount = post.boostsCount || 0;
        const commentsCount = post.commentsCount || 0;

        const likedClass = isLiked ? "liked" : "";
        const boostedClass = isBoosted ? "boosted" : "";

        // Comments HTML
        let commentsHTML = "";
        if (post.comments) {
          // Sort comments by timestamp ascending
          const commentsArr = Object.entries(post.comments)
            .map(([cid, c]) => ({ id: cid, ...c }))
            .sort((a, b) => a.timestamp - b.timestamp);

          commentsHTML = commentsArr
            .map(
              (c) => `
            <div class="comment-item" id="comment-${c.id}">
              <span class="comment-author">${escapeHTML(c.authorName)}</span>:
              <span class="comment-text">${escapeHTML(c.text)}</span>
              <time class="comment-time" datetime="${new Date(c.timestamp).toISOString()}" title="${new Date(c.timestamp).toLocaleString()}"> • ${timeAgo(c.timestamp)}</time>
            </div>`
            )
            .join("");
        }

        const card = document.createElement("article");
        card.className = "post-item";
        card.innerHTML = `
          <header class="post-owner" aria-label="Post owner info">
            <img src="${post.photoURL || "https://via.placeholder.com/40"}" alt="User avatar" class="avatar" />
            <div>
              <div>${escapeHTML(post.displayName || "Anonymous")}</div>
              <time class="post-time" datetime="${new Date(post.timestamp).toISOString()}" title="${dateStr}">${timeAgo(post.timestamp)}</time>
            </div>
          </header>

          <p class="post-caption">${escapeHTML(post.caption)}</p>

          <div class="post-media">${mediaHTML}</div>

          <div class="post-actions" role="group" aria-label="Post actions">
            <button
              class="${likedClass}"
              aria-pressed="${isLiked ? "true" : "false"}"
              aria-label="Like post"
              onclick="toggleLike('${post.id}')"
            >
              👍 Like (${likesCount})
            </button>

            <button
              class="${boostedClass}"
              aria-pressed="${isBoosted ? "true" : "false"}"
              aria-label="Boost post"
              onclick="toggleBoost('${post.id}')"
            >
              🚀 Boost (${boostsCount})
            </button>

            <label for="donateSelect-${post.id}" style="font-weight:600; margin-left: 10px;">Donate:</label>
            <select id="donateSelect-${post.id}" aria-label="Select donation amount" onchange="donateToPost('${post.id}', '${post.userId}', this.value)">
              <option value="">Choose</option>
              <option value="1">$1</option>
              <option value="5">$5</option>
              <option value="10">$10</option>
              <option value="20">$20</option>
            </select>
          </div>

          <!-- Comments Section -->
          <section class="comments-section" aria-label="Comments section for post">
            <div class="comments-list" id="commentsList-${post.id}" tabindex="0" aria-live="polite" aria-relevant="additions">
              ${commentsHTML || "<p>No comments yet. Be first!</p>"}
            </div>

            ${
              currentUser
                ? `
            <form
              onsubmit="addComment(event, '${post.id}')"
              aria-label="Add a comment form"
              style="display:flex; gap:6px; margin-top: 5px;"
            >
              <input
                type="text"
                name="comment"
                required
                minlength="1"
                placeholder="Write a comment..."
                aria-required="true"
                style="flex:1; padding: 6px 8px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;"
              />
              <button type="submit" aria-label="Post comment">Send</button>
            </form>
            `
                : `<p style="margin-top: 10px; font-style: italic;">Sign in to comment</p>`
            }
          </section>
        `;

        postContainer.appendChild(card);
      }
    }

    // Toggle like in Firebase
    async function toggleLike(postId) {
      if (!currentUser) return alert("Please login to like posts.");
      const likesRef = ref(db, `posts/${postId}/likesBy/${currentUser.uid}`);
      const likesCountRef = ref(db, `posts/${postId}/likesCount`);
      try {
        await runTransaction(likesRef, (currentVal) => {
          if (currentVal === true) return null;
          return true;
        });
        await runTransaction(likesCountRef, (currentVal) => (currentVal || 0) + 1);
      } catch {
        // if liked, remove like
        await set(likesRef, null);
        await runTransaction(likesCountRef, (currentVal) => Math.max((currentVal || 1) - 1, 0));
      }
    }

    // Toggle boost in Firebase
    async function toggleBoost(postId) {
      if (!currentUser) return alert("Please login to boost posts.");
      const boostsRef = ref(db, `posts/${postId}/boostedBy/${currentUser.uid}`);
      const boostsCountRef = ref(db, `posts/${postId}/boostsCount`);
      try {
        await runTransaction(boostsRef, (currentVal) => {
          if (currentVal === true) return null;
          return true;
        });
        await runTransaction(boostsCountRef, (currentVal) => (currentVal || 0) + 1);
      } catch {
        // if boosted, remove boost
        await set(boostsRef, null);
        await runTransaction(boostsCountRef, (currentVal) => Math.max((currentVal || 1) - 1, 0));
      }
    }

    // Skrill real payment integration (open Skrill payment page with donation)
    window.donateToPost = function (postId, postUserId, amount) {
      if (!currentUser) return alert("Please login to donate.");
      if (!amount) return;

      const skrillURL = new URL("https://pay.skrill.com");
      skrillURL.searchParams.set("pay_to_email", "digitalrufiyacoin@gmail.com");
      skrillURL.searchParams.set("recipient_description", "DRFMedia Donation");
      skrillURL.searchParams.set("transaction_id", postId + "-" + Date.now());
      skrillURL.searchParams.set("amount", amount);
      skrillURL.searchParams.set("currency", "USD");
      skrillURL.searchParams.set("detail1_description", "Support for DRFMedia Post");
      skrillURL.searchParams.set("detail1_text", `Post ID: ${postId}`);

      window.open(skrillURL.toString(), "_blank");

      // Reset dropdown after
      const selects = document.querySelectorAll("select");
      selects.forEach((sel) => (sel.value = ""));
    };

    // Add comment handler
    async function addComment(event, postId) {
      event.preventDefault();
      if (!currentUser) return alert("Please login to comment.");

      const form = event.target;
      const input = form.elements.comment;
      const text = input.value.trim();
      if (text.length < 1) return alert("Comment cannot be empty.");

      const commentRef = push(ref(db, `posts/${postId}/comments`));
      const commentData = {
        authorId: currentUser.uid,
        authorName: currentUser.displayName || "Anonymous",
        text,
        timestamp: Date.now(),
      };

      try {
        await set(commentRef, commentData);
        // Update comment count
        const commentCountRef = ref(db, `posts/${postId}/commentsCount`);
        await runTransaction(commentCountRef, (count) => (count || 0) + 1);
        input.value = "";
      } catch (err) {
        alert("Failed to add comment: " + err.message);
      }
    }

    // Utility for time ago display
    function timeAgo(time) {
      const now = Date.now();
      const diff = (now - time) / 1000;
      if (diff < 60) return "just now";
      if (diff < 3600) return Math.floor(diff / 60) + "m ago";
      if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
      if (diff < 604800) return Math.floor(diff / 86400) + "d ago";
      return new Date(time).toLocaleDateString();
    }

    // Search input event
    searchInput.addEventListener("input", renderPosts);
  </script>
</body>
</html>
