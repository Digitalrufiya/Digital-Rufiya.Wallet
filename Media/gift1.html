<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Timeline + Donations</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; background: #fff; color: #222; margin: 0; }
    header { background: #007bff; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    h1 { margin: 0; font-size: 1.4em; }
    .donate-btns button {
      margin: 5px; padding: 8px 12px; border: none; border-radius: 4px; font-size: 1em; cursor: pointer;
    }
    .rose { background: #e91e63; color: white; }
    .lion { background: #f39c12; color: white; }
    .dua  { background: #009688; color: white; }
    .star { background: #673ab7; color: white; }
    .highlight-btn { background: gold; color: black; font-weight: bold; }
    .highlighted { border: 2px solid gold !important; }
    .wallet-info { padding: 10px; background: #f1f1f1; margin: 15px auto; max-width: 700px; border-radius: 6px; }
    .withdraw-form textarea, .withdraw-form input { width: 100%; margin-top: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .withdraw-form button { margin-top: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; }
    #container-googlepay { margin-top: 20px; }
  </style>
  <script async
    src="https://pay.google.com/gp/p/js/pay.js"
    onload="onGooglePayLoaded()"></script>
</head>
<body>
  <header>
    <h1>DRFMedia ‚Äî Gaza Support</h1>
    <div>
      <button id="loginBtn">Sign in</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </header>

  <div id="wallet" class="wallet-info" style="display:none;">
    Welcome <span id="username"></span> | Coins: <strong id="coinBalance">0</strong><br />
    <button onclick="document.getElementById('withdrawSection').style.display='block'">Request Withdrawal</button>
  </div>

  <div id="postList"></div>

  <div id="container-googlepay"></div> <!-- Google Pay button container -->

  <div id="withdrawSection" class="withdraw-form" style="display:none; max-width: 600px; margin: auto;">
    <h3>Withdraw Request</h3>
    <input type="number" id="withdrawAmount" placeholder="Amount to withdraw (coins)" />
    <textarea id="withdrawInfo" placeholder="Enter your PayPal / Bank / Wallet info"></textarea>
    <button onclick="submitWithdraw()">Submit Request</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, set, push, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const wallet = document.getElementById("wallet");
const coinBalance = document.getElementById("coinBalance");
const username = document.getElementById("username");

let currentUser = null;

onAuthStateChanged(auth, async user => {
  currentUser = user;
  loginBtn.style.display = user ? "none" : "inline-block";
  logoutBtn.style.display = user ? "inline-block" : "none";
  wallet.style.display = user ? "block" : "none";

  if (user) {
    username.textContent = user.displayName || "User";
    const coinsRef = ref(db, `coins/${user.uid}`);
    const snapshot = await get(coinsRef);
    coinBalance.textContent = snapshot.exists() ? snapshot.val() : 0;
  }

  renderPosts();
});

loginBtn.onclick = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
logoutBtn.onclick = () => signOut(auth);

async function donate(postId, value) {
  if (!currentUser) return alert("Login required");

  const ownerRef = ref(db, `posts/${postId}/userId`);
  const ownerSnap = await get(ownerRef);

  if (!ownerSnap.exists()) return alert("Post owner not found");
  const ownerId = ownerSnap.val();

  const coinMap = { rose: 1, lion: 10, dua: 20, star: 30 };
  const coins = coinMap[value];
  const userCoinsRef = ref(db, `coins/${ownerId}`);
  const userSnap = await get(userCoinsRef);
  const current = userSnap.exists() ? userSnap.val() : 0;
  await set(userCoinsRef, current + coins);
  alert("Donation successful!");
  if (ownerId === currentUser.uid) coinBalance.textContent = current + coins;
}

function renderPosts() {
  document.getElementById("postList").innerHTML = "";
  const dummyPosts = [
    { id: "p1", user: "Ahmad from Gaza", owner: "user1", highlighted: true },
    { id: "p2", user: "Fatima from Syria", owner: "user2", highlighted: false }
  ];

  for (let post of dummyPosts) {
    const card = document.createElement("div");
    card.className = post.highlighted ? "highlighted" : "";
    card.innerHTML = `
      <h3>${post.user}</h3>
      <div class="donate-btns">
        <button class="rose" onclick="donate('${post.id}','rose')">üåπ Rose ($1)</button>
        <button class="lion" onclick="donate('${post.id}','lion')">ü¶Å Lion ($10)</button>
        <button class="dua" onclick="donate('${post.id}','dua')">üôè Dua ($20)</button>
        <button class="star" onclick="donate('${post.id}','star')">‚ú® Star ($30)</button>
      </div>
      <div><button class="highlight-btn" disabled>üîí Only admin can highlight verified posts</button></div>
    `;
    document.getElementById("postList").appendChild(card);
  }
}

window.donate = donate;

window.submitWithdraw = async function () {
  if (!currentUser) return alert("Login required");
  const amt = parseInt(document.getElementById("withdrawAmount").value);
  const info = document.getElementById("withdrawInfo").value.trim();
  if (!amt || !info) return alert("Fill all fields");

  const reqRef = push(ref(db, `withdrawals/${currentUser.uid}`));
  await set(reqRef, {
    amount: amt,
    info,
    status: "Pending",
    timestamp: Date.now()
  });
  alert("Withdraw request sent.");
  document.getElementById("withdrawSection").style.display = "none";
};

// === Google Pay integration ===

const paymentsClient = new google.payments.api.PaymentsClient({environment: 'TEST'});

const baseRequest = {
  apiVersion: 2,
  apiVersionMinor: 0
};

const allowedCardNetworks = ["AMEX", "DISCOVER", "JCB", "MASTERCARD", "VISA"];
const allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];

const tokenizationSpecification = {
  type: 'PAYMENT_GATEWAY',
  parameters: {
    'gateway': 'example', // Replace with your gateway name
    'gatewayMerchantId': 'exampleGatewayMerchantId' // Replace with your merchant ID
  }
};

const baseCardPaymentMethod = {
  type: 'CARD',
  parameters: {
    allowedAuthMethods: allowedCardAuthMethods,
    allowedCardNetworks: allowedCardNetworks
  }
};

const cardPaymentMethod = Object.assign(
  {},
  baseCardPaymentMethod,
  {
    tokenizationSpecification: tokenizationSpecification
  }
);

function getGoogleIsReadyToPayRequest() {
  return Object.assign({}, baseRequest, {
    allowedPaymentMethods: [baseCardPaymentMethod]
  });
}

function getGooglePaymentDataRequest() {
  const paymentDataRequest = Object.assign({}, baseRequest);
  paymentDataRequest.allowedPaymentMethods = [cardPaymentMethod];
  paymentDataRequest.transactionInfo = {
    totalPriceStatus: 'FINAL',
    totalPrice: '1.00', // Amount to charge; you can update dynamically
    currencyCode: 'USD',
  };
  paymentDataRequest.merchantInfo = {
    merchantName: 'DRFMedia Donations'
  };
  return paymentDataRequest;
}

function onGooglePayLoaded() {
  paymentsClient.isReadyToPay(getGoogleIsReadyToPayRequest())
  .then(function(response) {
    if (response.result) {
      addGooglePayButton();
    } else {
      console.log("Google Pay not available");
    }
  })
  .catch(function(err) {
    console.error(err);
  });
}

function addGooglePayButton() {
  const button = paymentsClient.createButton({onClick: onGooglePayButtonClicked});
  document.getElementById('container-googlepay').appendChild(button);
}

function onGooglePayButtonClicked() {
  const paymentDataRequest = getGooglePaymentDataRequest();
  paymentsClient.loadPaymentData(paymentDataRequest)
  .then(function(paymentData) {
    // handle the response here
    processPayment(paymentData);
  })
  .catch(function(err) {
    console.error(err);
  });
}

function processPayment(paymentData) {
  // For now, just alert success and log the payment token to console
  alert('Payment successful! Thank you for your donation.');
  console.log("Payment Token:", paymentData.paymentMethodData.tokenizationData.token);
  // Here you would send the token to your backend to process payment
}

</script>
</body>
</html>
