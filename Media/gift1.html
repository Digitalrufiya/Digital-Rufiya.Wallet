<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia — Post & View</title>
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="light dark" />
<style>
:root{--accent:#007bff;--accent-hover:#0056b3;--accent-muted:#3399ff;
      --bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;
      --text-body:#212529;--text-muted:#6c757d;--radius:.5rem;
      --shadow-sm:0 1px 2px rgba(0,0,0,.06);--shadow-md:0 2px 4px rgba(0,0,0,.1)}
@media(prefers-color-scheme:dark){:root{--bg-body:#181a1b;--bg-surface:#242628;
 --bg-surface-alt:#2b2e30;--text-body:#f1f3f5;--text-muted:#adb5bd;
 --shadow-sm:none;--shadow-md:none}}
*{box-sizing:border-box;margin:0}
body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
     background:var(--bg-body);color:var(--text-body);min-height:100vh;
     display:flex;flex-direction:column}
a{color:inherit;text-decoration:none}
img,video{max-width:100%}
/* header */
header{background:var(--accent);color:#fff;padding:.75rem 1rem;
       display:flex;align-items:center;justify-content:space-between;
       flex-wrap:wrap;gap:1rem;position:sticky;top:0;z-index:1000}
.brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
.brand img{width:2.25rem;height:2.25rem;border-radius:.25rem;background:#fff;padding:2px}
#primaryNav{display:none;gap:.75rem}
/* buttons */
.btn{background:var(--accent);color:#fff;border:none;border-radius:var(--radius);
     padding:.5rem 1rem;font-weight:600;cursor:pointer;transition:background .2s}
.btn:hover{background:var(--accent-hover)}.btn:disabled{background:#adb5bd;cursor:not-allowed}
/* layout */
.container{width:min(100%,700px);margin:0 auto;padding:0 1rem}
#searchInput{width:100%;padding:.55rem .85rem;margin:1rem 0;
             border:1px solid #ced4da;border-radius:var(--radius);
             background:var(--bg-surface);color:var(--text-body)}
.post-item{background:var(--bg-surface-alt);border:1px solid #dee2e6;
           border-radius:var(--radius);padding:1rem;margin:1.25rem 0;
           box-shadow:var(--shadow-sm)}
.post-owner{display:flex;align-items:center;gap:.6rem;font-weight:700}
.avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:1px solid #ccc}
.post-time{font-size:.8rem;color:var(--text-muted)}
.post-caption{margin-top:.75rem;white-space:pre-wrap}
/* media */
video,img{border-radius:var(--radius);background:#000;display:block;opacity:0;
          transition:opacity .3s}[data-loaded=true]{opacity:1}
/* upload */
#uploadForm{margin-top:1.25rem}
#uploadForm textarea{width:100%;min-height:6rem;padding:.65rem .85rem;margin:.75rem 0;
                     border:1px solid #ced4da;border-radius:var(--radius);resize:vertical}
#prog{width:100%;height:4px;background:#e9ecef;border-radius:2px;overflow:hidden;display:none}
#progBar{height:4px;width:0;background:var(--accent)}

/* Added for post-actions buttons */
.post-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.post-actions button, .post-actions select {
  cursor: pointer;
  border: none;
  background: var(--accent);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.9rem;
  user-select: none;
  transition: background-color 0.3s ease;
}
.post-actions button:hover, .post-actions select:hover {
  background: var(--accent-hover);
}
.post-actions button.liked {
  background: #28a745 !important;
  box-shadow: 0 0 8px #28a745aa;
}
.post-actions button.boosted {
  background: gold !important;
  color: #000 !important;
  box-shadow: 0 0 8px #ffd700cc;
}
.comments-container {
  margin-top: 10px;
  max-height: 160px;
  overflow-y: auto;
  border-top: 1px solid #ccc;
  padding-top: 8px;
}
.comment {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 8px;
  font-size: 0.9rem;
}
.comment .avatar {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #eee;
  object-fit: cover;
}
.comment-body {
  background: #f5f5f5;
  padding: 6px 12px;
  border-radius: 8px;
  flex: 1;
  word-break: break-word;
}
.comment-body strong {
  display: block;
  color: var(--accent);
  margin-bottom: 4px;
}
.comment-form {
  margin-top: 10px;
  display: flex;
  gap: 8px;
}
.comment-form input {
  flex: 1;
  padding: 8px 12px;
  border-radius: 6px;
  border: 1.5px solid #ccc;
  font-size: 1rem;
  font-family: inherit;
  outline-offset: 2px;
  transition: border-color 0.3s;
}
.comment-form input:focus {
  border-color: var(--accent);
  outline: none;
}
.comment-form button {
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  transition: background-color 0.3s;
}
.comment-form button:hover {
  background: var(--accent-hover);
}
</style>
</head>

<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="logo" />
    <span>DRFMedia</span>
  </div>
  <nav id="primaryNav"><a href="media.html">📜 Timeline</a></nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search posts…" />
  <button id="loginBtn"  class="btn">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;background:#dc3545">Logout</button>

  <form id="uploadForm" style="display:none">
    <input id="mediaFile" type="file" accept="image/*,video/*" required>
    <textarea id="caption" minlength="4" placeholder="Write your caption…" required></textarea>
    <div id="prog"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, get, runTransaction } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

/* ---------- 1)  PINATA  JWT  ---------- */
const pinataJWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

/* ---------- 2)  FIREBASE CONFIG  ---------- */
const firebaseConfig = {
  apiKey:            "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain:        "drfsocial-23a06.firebaseapp.com",
  databaseURL:       "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId:         "drfsocial-23a06",
  storageBucket:     "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId:             "1:608135115201:web:b3d1f368e0c09ac4400f43",
  measurementId:     "G-TBFQX80NRP"
};

/* ---- INIT ---- */
const app  = initializeApp(firebaseConfig);
const db   = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ---- DOM refs ---- */
const $ = id=>document.getElementById(id);
const login  = $("loginBtn"), logout = $("logoutBtn");
const upload = $("uploadForm"), fileIn = $("mediaFile"), capIn = $("caption");
const prog   = $("prog"), bar=$("progBar");
const posts  = $("postContainer"), qIn=$("searchInput"), nav=$("primaryNav");

/* ---- state ---- */
let user=null, all=[];

/* ---- helpers ---- */
const esc=s=>s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const gws=["https://gateway.pinata.cloud/ipfs/","https://cloudflare-ipfs.com/ipfs/","https://ipfs.io/ipfs/"];
const gwCache=new Map();
async function gw(cid){
  if(gwCache.has(cid)) return gwCache.get(cid);
  for(const g of gws){ try{ if((await fetch(g+cid,{method:"HEAD"})).ok){gwCache.set(cid,g+cid);return g+cid;} }catch{} }
  return null;
}

/* lazy video loader */
function loadVid(v){ let r=0; const go=()=>{v.src=v.dataset.src;v.load();}
  v.oncanplay=()=>v.dataset.loaded="true";
  v.onerror=()=>{ if(r<3) setTimeout(go,2**++r*1e3); };
  go();
}
const io=new IntersectionObserver(es=>es.filter(e=>e.isIntersecting)
 .forEach(e=>{loadVid(e.target);io.unobserve(e.target);}),{threshold:.25});

/* render feed with like, comment, boost, donate, delete */
async function render(){
  const term=qIn.value.trim().toLowerCase();
  posts.innerHTML="";
  for(const p of all){
    if(term && !(p.caption||"").toLowerCase().includes(term)) continue;

    const isLiked = user && p.likesBy && p.likesBy[user.uid];
    const isBoosted = user && p.boostedBy && p.boostedBy[user.uid];

    // Media URL fallback
    const url1 = `https://gateway.pinata.cloud/ipfs/${p.ipfsHash}`;
    const url2 = `https://cloudflare-ipfs.com/ipfs/${p.ipfsHash}`;
    const url3 = `https://ipfs.io/ipfs/${p.ipfsHash}`;

    const mediaHTML = (p.mediaType === "video")
      ? `<video controls preload="none" poster="${url2}" data-src="${url1}" style="border-radius:6px; width:100%; background:#000;">
           <source src="${url1}" type="${p.mediaMimeType || "video/mp4"}" />
         </video>`
      : `<img src="${url1}" alt="Post media" loading="lazy" onerror="this.onerror=null;this.src='${url2}'" style="border-radius:6px;" />`;

    const article = document.createElement("article");
    article.className = "post-item";
    article.innerHTML = `
      <header class="post-owner">
        <img class="avatar" src="${esc(p.photoURL || "https://via.placeholder.com/40")}" alt="User avatar" />
        <div>
          <div>${esc(p.displayName || "Anon")}</div>
          <time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">${new Date(p.timestamp).toLocaleString()}</time>
        </div>
      </header>
      <div class="post-caption">${esc(p.caption)}</div>
      <div class="post-media">${mediaHTML}</div>

      <div class="post-actions">
        <button class="${isLiked ? "liked" : ""}" aria-pressed="${isLiked ? "true" : "false"}" aria-label="Like post" data-id="${p.id}">👍 Like (${p.likesCount || 0})</button>
        <button aria-label="Comment on post" data-id="${p.id}">💬 Comment (${p.commentsCount || 0})</button>
        <button class="${isBoosted ? "boosted" : ""}" aria-pressed="${isBoosted ? "true" : "false"}" aria-label="Boost post" data-id="${p.id}">🚀 Boost (${p.boostsCount || 0})</button>
        <button aria-label="Repost post" data-id="${p.id}">🔄 Repost</button>
        <select aria-label="Donate to post" data-id="${p.id}">
          <option value="">Donate 💖</option>
          <option value="1">🌹 $1</option>
          <option value="10">🦁 $10</option>
          <option value="20">🙏 $20</option>
          <option value="30">✨ $30</option>
        </select>
        ${
          user && user.uid === p.userId
            ? `<button aria-label="Delete post" data-id="${p.id}" style="background:#dc3545; color:#fff; font-weight:700; padding:6px 12px; border-radius:6px; cursor:pointer;">🗑️ Delete</button>`
            : ''
        }
      </div>

      <div class="comments-container" id="comments-${p.id}" aria-live="polite"></div>
      ${
        user ? `
        <form class="comment-form" data-id="${p.id}" aria-label="Add comment form">
          <input type="text" placeholder="Write a comment..." required minlength="1" aria-required="true" />
          <button type="submit">Post</button>
        </form>` : ''
      }
    `;
    posts.appendChild(article);

    loadComments(p.id);
  }

  attachPostEventListeners();

  // Start observing videos for lazy load
  posts.querySelectorAll("video[data-src]").forEach(v=>io.observe(v));
}

function attachPostEventListeners() {
  // Like buttons
  posts.querySelectorAll("button[aria-label='Like post']").forEach(btn => {
    btn.onclick = async () => {
      if (!user) return alert("Please login first.");
      const postId = btn.getAttribute("data-id");
      const likesRef = ref(db, `posts/${postId}/likesBy/${user.uid}`);
      const countRef = ref(db, `posts/${postId}/likesCount`);

      const liked = btn.classList.contains("liked");
      if (liked) {
        await set(likesRef, null);
        await runTransaction(countRef, count => (count ? count - 1 : 0));
      } else {
        await set(likesRef, true);
        await runTransaction(countRef, count => (count ? count + 1 : 1));
      }
      setTimeout(getPosts, 500);
    };
  });

  // Comment buttons scroll to comment form
  posts.querySelectorAll("button[aria-label='Comment on post']").forEach(btn => {
    btn.onclick = () => {
      const postId = btn.getAttribute("data-id");
      const commentForm = posts.querySelector(`form.comment-form[data-id='${postId}'] input`);
      if (commentForm) commentForm.focus();
    };
  });

  // Boost buttons
  posts.querySelectorAll("button[aria-label='Boost post']").forEach(btn => {
    btn.onclick = async () => {
      if (!user) return alert("Please login first.");
      const postId = btn.getAttribute("data-id");
      const boostsRef = ref(db, `posts/${postId}/boostedBy/${user.uid}`);
      const countRef = ref(db, `posts/${postId}/boostsCount`);

      const boosted = btn.classList.contains("boosted");
      if (boosted) {
        await set(boostsRef, null);
        await runTransaction(countRef, count => (count ? count - 1 : 0));
      } else {
        await set(boostsRef, true);
        await runTransaction(countRef, count => (count ? count + 1 : 1));
      }
      setTimeout(getPosts, 500);
    };
  });

  // Repost buttons
  posts.querySelectorAll("button[aria-label='Repost post']").forEach(btn => {
    btn.onclick = () => {
      alert("Repost feature coming soon!");
    };
  });

  // Donate select dropdowns
  posts.querySelectorAll("select[aria-label='Donate to post']").forEach(sel => {
    sel.onchange = () => {
      const val = sel.value;
      if (!val) return;
      alert(`Thanks for donating $${val}!`);
      sel.value = "";
    };
  });

  // Delete buttons
  posts.querySelectorAll("button[aria-label='Delete post']").forEach(async btn => {
    btn.onclick = async () => {
      if (!user) return alert("Please login first.");
      const postId = btn.getAttribute("data-id");
      if (confirm("Are you sure you want to delete this post?")) {
        const postRef = ref(db, `posts/${postId}`);
        await set(postRef, null);
        setTimeout(getPosts, 500);
      }
    };
  });

  // Comment forms
  posts.querySelectorAll("form.comment-form").forEach(form => {
    form.onsubmit = async e => {
      e.preventDefault();
      if (!user) return alert("Please login first.");
      const postId = form.getAttribute("data-id");
      const input = form.querySelector("input");
      const val = input.value.trim();
      if (val.length === 0) return;
      const commentRef = push(ref(db, `posts/${postId}/comments`));
      await set(commentRef, {
        userId: user.uid,
        displayName: user.displayName || "Anon",
        photoURL: user.photoURL || "",
        comment: val,
        timestamp: Date.now()
      });
      // Update commentsCount
      const commentsCountRef = ref(db, `posts/${postId}/commentsCount`);
      await runTransaction(commentsCountRef, count => (count ? count + 1 : 1));
      input.value = "";
      setTimeout(getPosts, 500);
    };
  });
}

async function loadComments(postId) {
  const commentsEl = document.getElementById(`comments-${postId}`);
  if (!commentsEl) return;

  const snap = await get(ref(db, `posts/${postId}/comments`));
  if (!snap.exists()) {
    commentsEl.innerHTML = '<em>No comments yet.</em>';
    return;
  }

  const comments = Object.entries(snap.val())
    .sort((a,b) => a[1].timestamp - b[1].timestamp)
    .map(([id, c]) => `
      <div class="comment" tabindex="0">
        <img class="avatar" src="${esc(c.photoURL || "https://via.placeholder.com/40")}" alt="Avatar" />
        <div class="comment-body">
          <strong>${esc(c.displayName)}</strong>
          <span>${esc(c.comment)}</span>
        </div>
      </div>
    `).join("");

  commentsEl.innerHTML = comments;
}

/* --- Get Posts --- */
async function getPosts(){
  try {
    const snapshot = await get(ref(db, "posts"));
    if (snapshot.exists()) {
      const data = snapshot.val();
      all = Object.entries(data).map(([id, p]) => ({ id, ...p }));
      // Sort posts descending by timestamp
      all.sort((a,b)=>b.timestamp - a.timestamp);
    } else {
      all = [];
    }
    await render();
  } catch(e) {
    console.error("Error fetching posts:", e);
  }
}

/* --- Upload Form --- */
upload.onsubmit = async e => {
  e.preventDefault();
  if (!user) return alert("Please login first.");

  const file = fileIn.files[0];
  if (!file) return alert("Please select a file.");

  const caption = capIn.value.trim();
  if (caption.length < 4) return alert("Caption must be at least 4 characters.");

  const formData = new FormData();
  formData.append("file", file);

  prog.style.display = "block";
  bar.style.width = "0%";

  try {
    const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
      method: "POST",
      headers: { Authorization: `Bearer ${pinataJWT}` },
      body: formData,
      // Can't track progress via fetch; progress bar animation skipped
    });
    if (!res.ok) throw new Error("Upload failed");
    const data = await res.json();

    const ipfsHash = data.IpfsHash;
    const mediaType = file.type.startsWith("video") ? "video" : "image";

    const newPostRef = push(ref(db, "posts"));
    await set(newPostRef, {
      userId: user.uid,
      displayName: user.displayName || "Anon",
      photoURL: user.photoURL || "",
      caption,
      ipfsHash,
      mediaType,
      mediaMimeType: file.type,
      timestamp: Date.now(),
      likesCount: 0,
      commentsCount: 0,
      boostsCount: 0,
      likesBy: {},
      boostedBy: {},
      comments: {}
    });

    upload.reset();
    prog.style.display = "none";
    bar.style.width = "0%";

    getPosts();
  } catch (err) {
    alert("Upload failed: "+err.message);
    prog.style.display = "none";
    bar.style.width = "0%";
  }
};

/* --- AUTH --- */
login.onclick = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
logout.onclick = () => signOut(auth).catch(e => alert(e.message));
onAuthStateChanged(auth, u => {
  user = u;
  if(user){
    login.style.display = "none";
    logout.style.display = "inline-block";
    upload.style.display = "block";
    nav.style.display = "block";
  } else {
    login.style.display = "inline-block";
    logout.style.display = "none";
    upload.style.display = "none";
    nav.style.display = "none";
  }
  getPosts();
});

/* --- SEARCH --- */
qIn.oninput = () => render();

getPosts();
</script>
</body>
</html>
