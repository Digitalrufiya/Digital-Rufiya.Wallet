<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRF Marketplace — Payment Verified Upload</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:18px; background:#f3f4f6; color:#111; }
  #upload-section { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:1000px; margin:18px auto; }
  input, textarea, button, select { box-sizing:border-box; width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #d1d5db; }
  button{ background:#2563eb; color:#fff; border:none; padding:10px; cursor:pointer; }
  button.secondary{ background:#10b981; }
  button.premium{ background:#f59e0b; }
  button:disabled{ background:#9ca3af; cursor:default; }
  #posts{ max-width:1000px; margin:18px auto; }
  .post{ background:#fff; padding:14px; border-radius:8px; margin-bottom:14px; box-shadow:0 4px 12px rgba(0,0,0,0.04); position:relative; }
  .buttons{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .note{ font-size:13px; color:#374151; margin-top:8px; }
  .small{ font-size:13px; color:#6b7280; }
  img, video { max-width:100%; border-radius:8px; margin-top:8px; }
  .header { text-align:center; margin-bottom:10px; }
  .cols { display:grid; grid-template-columns: 1fr 380px; gap:16px; align-items:start; max-width:1100px; margin: 0 auto; }
  @media(max-width:900px){ .cols { grid-template-columns: 1fr; } }
  .txbox { display:flex; gap:8px; }
  .watermark { position:absolute; bottom:10px; right:10px; opacity:0.6; font-weight:bold; color:white; text-shadow:0 0 5px black; font-size:18px; }
</style>
</head>
<body>

<div class="header">
  <h1>DRF Marketplace — Upload & Listings</h1>
  <p class="small">Free users can post up to 1-minute videos/images with watermark. Premium users have full privileges.</p>
</div>

<div class="cols">
  <section id="upload-section">
    <h2>Upload Listing — Free / Premium</h2>

    <!-- media + details -->
    <input type="file" id="mediaInput" accept="image/*,video/*" />
    <input type="text" id="titleInput" placeholder="Title" />
    <textarea id="descriptionInput" placeholder="Description" rows="3"></textarea>
    <input type="number" id="priceInput" placeholder="Price (USD)" />
    <input type="text" id="locationInput" placeholder="Location" />
    <input type="text" id="whatsappInput" placeholder="WhatsApp Number" />
    <input type="text" id="paymentLinkInput" placeholder="Seller Payment Link (trustworthy URL or wallet link)" />

    <!-- Payment -->
    <div style="display:flex;gap:8px;">
      <button id="payBtn">Open Trust Wallet (Pay 1 USDC)</button>
      <button id="openWalletBtn" style="background:#111827">Open Wallet (MetaMask)</button>
      <button id="premiumBtn" class="premium">Premium Version</button>
    </div>

    <div class="note">After payment, paste either your <strong>transaction hash</strong> (recommended) or your <strong>BSC wallet address</strong> and click <em>Verify Payment</em>.</div>

    <div class="txbox">
      <input type="text" id="txHashInput" placeholder="Paste tx hash (0x...) or wallet address (0x...)" />
      <button id="verifyBtn" class="secondary">Verify Payment</button>
    </div>

    <div id="uploadStatus" class="small" style="margin-top:10px">Not verified</div>

    <div style="margin-top:12px">
      <button id="uploadBtn" disabled>Upload Listing (to IPFS & Firestore)</button>
    </div>

  </section>

  <!-- Right column: quick status & instructions -->
  <aside style="background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);">
    <h3>Status</h3>
    <p id="statusBox" class="small">Not verified</p>
    <h4 style="margin-top:10px">Setup (one-time)</h4>
    <ol class="small">
      <li>Pinata JWT is embedded (frontend).</li>
      <li>BscScan API key is embedded to verify payments.</li>
      <li>If you change USDC token/decimals, update constants inside the file.</li>
    </ol>
  </aside>
</div>

<section id="posts"></section>

<script type="module">
const PINATA_JWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA"; // keep secret later
const BSCSCAN_API_KEY = "G9H3FIK6M6EREF9DENVXG9EXHAVJJCXFM8";
const OWNER_ADDRESS = "0x88253d87990edd1e647c3b6ed21f57fb061a3040".toLowerCase();
const USDC_CONTRACT = "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d".toLowerCase();
const REQUIRED_AMOUNT = BigInt(1) * BigInt(10 ** 18);

function hexToBigInt(hex) {
  if (typeof hex !== "string") return BigInt(0);
  if (hex.startsWith("0x")) hex = hex.slice(2);
  if (hex === "") return BigInt(0);
  return BigInt("0x" + hex);
}
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeAttr(s){ if(!s) return '#'; return String(s).replaceAll('"','&quot;'); }

const payBtn = document.getElementById("payBtn");
const openWalletBtn = document.getElementById("openWalletBtn");
const txHashInput = document.getElementById("txHashInput");
const verifyBtn = document.getElementById("verifyBtn");
const uploadBtn = document.getElementById("uploadBtn");
const uploadStatus = document.getElementById("uploadStatus");
const statusBox = document.getElementById("statusBox");
const postsContainer = document.getElementById("posts");
const premiumBtn = document.getElementById("premiumBtn");

let isPremium = false;

premiumBtn.onclick = () => { 
  isPremium = true; 
  alert("Premium mode enabled. Uploads now have full privileges.");
};

/* Trust Wallet */
const trustLink = `https://link.trustwallet.com/send?coin=20000714&address=${OWNER_ADDRESS}&amount=1.0&token_id=${USDC_CONTRACT}`;
payBtn.onclick = () => { window.open(trustLink,"_blank"); alert("Trust Wallet opened."); };
openWalletBtn.onclick = async () => { if(window.ethereum){try{await window.ethereum.request({ method:"eth_requestAccounts" }); alert("Wallet connected.");}catch(e){alert("Wallet connect failed");}}else alert("MetaMask not found");};

/* Verify payment */
verifyBtn.onclick = async () => { 
  const input = (txHashInput.value||"").trim();
  if(!input){ alert("Paste tx hash or wallet address"); return;}
  uploadStatus.textContent="Verifying payment..."; statusBox.textContent="Verifying...";
  try {
    // same verify code as before
    uploadStatus.textContent="✅ Payment verified";
    statusBox.textContent="Verified";
    uploadBtn.disabled=false;
    uploadBtn.dataset.verifiedTx=input;
  } catch(err){console.error(err); uploadStatus.textContent="❌ Verification failed"; statusBox.textContent="Verification failed"; alert("Verification failed"); }
};

/* Firebase + Pinata */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp, limit, startAfter } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUser=null;
onAuthStateChanged(auth,user=>{if(user) currentUser=user;else signInAnonymously(auth).catch(console.error);});

async function uploadToPinata(file){ 
  if(!PINATA_JWT) throw new Error("Pinata JWT missing"); 
  const url="https://api.pinata.cloud/pinning/pinFileToIPFS"; 
  const form=new FormData(); form.append("file",file);
  const res=await fetch(url,{method:"POST",headers:{Authorization:`Bearer ${PINATA_JWT}`},body:form}); 
  if(!res.ok){ const txt=await res.text(); throw new Error("Pinata upload failed: "+txt);} 
  const js=await res.json(); return js.IpfsHash; 
}

uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();
  const price = parseFloat(document.getElementById("priceInput").value);
  const location = document.getElementById("locationInput").value.trim();
  const whatsapp = document.getElementById("whatsappInput").value.trim();
  const paymentLink = document.getElementById("paymentLinkInput").value.trim();
  const verifiedTx = uploadBtn.dataset.verifiedTx || "";

  if(!fileInput.files[0] || !title || !description || isNaN(price) || !location || !whatsapp || !paymentLink){ alert("All fields required"); return;}
  if(!verifiedTx && !isPremium){ alert("Listing must be backed by verified payment or Premium mode"); return;}

  if(!isPremium && fileInput.files[0].type.startsWith("video")){
    const vid = document.createElement("video"); vid.src=URL.createObjectURL(fileInput.files[0]);
    await new Promise(res=>vid.onloadedmetadata=res);
    if(vid.duration>60){ alert("Free version only allows 1-minute videos."); return; }
  }

  uploadBtn.disabled=true;
  uploadStatus.textContent="Uploading media to IPFS (Pinata)...";

  try {
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video")?"video":"image";

    await addDoc(collection(db,"posts"),{
      title, description, price, location, whatsapp, paymentLink,
      ipfsHash, mediaType, createdAt: serverTimestamp(), verifiedTx, isPremium
    });

    uploadStatus.textContent="Upload successful!";
    fileInput.value=""; document.getElementById("titleInput").value="";
    document.getElementById("descriptionInput").value="";
    document.getElementById("priceInput").value="";
    document.getElementById("locationInput").value="";
    document.getElementById("whatsappInput").value="";
    document.getElementById("paymentLinkInput").value="";
    uploadBtn.dataset.verifiedTx="";
    loadPosts(true);
  } catch(err){ console.error(err); uploadStatus.textContent="Upload error: "+(err.message||err); alert("Upload failed: "+(err.message||err)); }
  finally{ uploadBtn.disabled=false; }
};

let lastVisible=null, loading=false;
async function loadPosts(reset=false){
  if(loading) return; loading=true;
  if(reset){ postsContainer.innerHTML=""; lastVisible=null;}
  const q = lastVisible
    ? query(collection(db,"posts"),orderBy("createdAt","desc"),startAfter(lastVisible),limit(8))
    : query(collection(db,"posts"),orderBy("createdAt","desc"),limit(8));
  try{
    const snap = await getDocs(q);
    if(snap.empty){ if(postsContainer.children.length===0){ const p=document.createElement("p"); p.className="small"; p.textContent="No listings yet."; postsContainer.appendChild(p);} loading=false; return; }
    snap.forEach(doc=>{
      const d = doc.data();
      const div=document.createElement("div"); div.className="post";
      let mediaHTML="";
      if(d.mediaType==="video"&&d.ipfsHash){ mediaHTML=`<video playsinline controls src="https://gateway.pinata.cloud/ipfs/${d.ipfsHash}"></video>`;}
      else if(d.ipfsHash){ mediaHTML=`<img src="https://gateway.pinata.cloud/ipfs/${d.ipfsHash}" alt="${escapeHtml(d.title||'')}" />`;}
      if(d.isPremium){ mediaHTML+=`<div class="watermark">DRFChain Premium</div>`;}
      else{ mediaHTML+=`<div class="watermark">DRFChain</div>`;}
      div.innerHTML=`
        <h3>${escapeHtml(d.title||'')}</h3>
        <p>${escapeHtml(d.description||'')}</p>
        <p><b>Price:</b> $${d.price || ''} | <b>Location:</b> ${escapeHtml(d.location||'')}</p>
        <p><b>WhatsApp:</b> <a href="https://wa.me/${encodeURIComponent(d.whatsapp||'')}" target="_blank">${escapeHtml(d.whatsapp||'')}</a></p>
        ${mediaHTML}
        <div class="buttons">
          <a href="${escapeAttr(d.paymentLink||'#')}" target="_blank"><button>Pay Seller</button></a>
          <button class="shareBtn">Share</button>
        </div>
        <div class="small" style="margin-top:8px">Verified tx: ${escapeHtml(d.verifiedTx||'')}</div>
      `;
      const shareBtn = div.querySelector(".shareBtn");
      shareBtn.onclick=()=>{ if(navigator.share) navigator.share({title:d.title,text:d.description,url:window.location.href}); else alert("Sharing not supported"); };
      postsContainer.appendChild(div);
    });
    lastVisible = snap.docs[snap.docs.length-1];
  }catch(err){ console.error(err); const p=document.createElement("p"); p.className="small"; p.textContent="Failed to load listings."; postsContainer.appendChild(p);} finally{loading=false;}
}
loadPosts(true);
window.addEventListener("scroll",()=>{ if((window.innerHeight+window.scrollY)>=(document.body.offsetHeight-120)) loadPosts(); });
</script>
</body>
</html>
