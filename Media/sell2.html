<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia Marketplace — Buy & Sell</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root {
    --accent: #007bff;
    --accent-hover: #0056b3;
    --accent-muted: #3399ff;
    --bg-body: #f8f9fa;
    --bg-surface: #fff;
    --bg-surface-alt: #fafafa;
    --text-body: #212529;
    --text-muted: #6c757d;
    --radius: .5rem;
    --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
    --shadow-md: 0 2px 4px rgba(0,0,0,.1)
  }
  @media(prefers-color-scheme:dark) {
    :root {
      --bg-body: #181a1b;
      --bg-surface: #242628;
      --bg-surface-alt: #2b2e30;
      --text-body: #f1f3f5;
      --text-muted: #adb5bd;
      --shadow-sm: none;
      --shadow-md: none
    }
  }
  * {
    box-sizing: border-box;
    margin: 0;
  }
  body {
    font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-body);
    color: var(--text-body);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  a {
    color: inherit;
    text-decoration: none;
  }
  img,
  video {
    max-width: 100%;
    border-radius: var(--radius);
    background: #000;
    display: block;
    opacity: 0;
    transition: opacity .3s;
  }
  [data-loaded=true] {
    opacity: 1;
  }
  header {
    background: var(--accent);
    color: #fff;
    padding: .75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: .5rem;
    font-weight: 700;
  }
  .brand img {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: .25rem;
    background: #fff;
    padding: 2px;
  }
  #primaryNav {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  #primaryNav a {
    color: #fff;
    font-weight: 600;
    padding: .5rem .75rem;
    border-radius: var(--radius);
    transition: background-color 0.2s ease;
  }
  #primaryNav a:hover,
  #primaryNav a.active {
    background-color: var(--accent-hover);
  }
  #menuToggle {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.75rem;
    cursor: pointer;
    display: none;
    user-select: none;
  }
  @media (max-width: 600px) {
    #primaryNav {
      display: none;
      flex-direction: column;
      width: 100%;
      background: var(--accent);
      margin-top: 0.5rem;
      border-radius: var(--radius);
      padding: 0.5rem 0;
    }
    #primaryNav.show {
      display: flex;
    }
    #menuToggle {
      display: block;
    }
    #primaryNav a {
      padding: 0.75rem 1rem;
      font-size: 1.1rem;
      width: 100%;
      box-sizing: border-box;
    }
  }
  .btn {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    padding: .65rem 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: background .2s;
    font-size: 1rem;
  }
  .btn:hover {
    background: var(--accent-hover);
  }
  .btn:disabled {
    background: #adb5bd;
    cursor: not-allowed;
  }
  .container {
    width: min(100%, 700px);
    margin: 0 auto;
    padding: 1rem;
    flex-grow: 1;
  }
  #searchInput {
    width: 100%;
    padding: .65rem 1rem;
    margin: 1rem 0 1.5rem;
    border: 1px solid #ced4da;
    border-radius: var(--radius);
    background: var(--bg-surface);
    color: var(--text-body);
    font-size: 1rem;
  }
  #uploadForm input,
  #uploadForm button {
    width: 100%;
    margin-bottom: 1rem;
    font-size: 1rem;
    padding: 0.6rem 1rem;
    border-radius: var(--radius);
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  #uploadForm button {
    border: none;
    color: white;
  }
  #prog {
    background: #eee;
    height: 6px;
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 1rem;
  }
  #progBar {
    background: var(--accent);
    width: 0;
    height: 100%;
    transition: width 0.2s ease;
  }
  .post-item {
    background: var(--bg-surface-alt);
    border: 1px solid #dee2e6;
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
  }
  .post-owner {
    display: flex;
    align-items: center;
    gap: .6rem;
    font-weight: 700;
  }
  .avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #ccc;
  }
  .post-time {
    font-size: .8rem;
    color: var(--text-muted);
  }
  .post-caption {
    margin-top: .75rem;
    white-space: pre-wrap;
  }
  .product-info {
    margin-top: 0.75rem;
    font-weight: 600;
  }
  .product-price {
    color: var(--accent);
    font-size: 1.15rem;
    margin-top: 0.3rem;
  }
  .product-contact {
    margin-top: 0.5rem;
  }
  .buttons {
    margin-top: 0.75rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .buttons a,
  .buttons button {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    transition: background .2s;
    font-size: 1rem;
  }
  .buttons a:hover,
  .buttons button:hover {
    background: var(--accent-hover);
  }
  .disclaimer {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 1.5rem;
    border-top: 1px solid #ccc;
    padding-top: 1rem;
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="logo" />
    <span>DRFMedia Marketplace</span>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">☰</button>
  <nav id="primaryNav" role="navigation" aria-label="Primary navigation">
    <a href="sell.html" class="active">Marketplace</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Donate Ghaza</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" type="search" placeholder="Search products…" aria-label="Search products" />
  <button id="loginBtn" class="btn" type="button">Sign in with Google</button>
  <button id="logoutBtn" class="btn" type="button" style="display:none;background:#dc3545">Logout</button>

  <form id="uploadForm" style="display:none" autocomplete="off" novalidate>
    <input id="mediaFile" type="file" accept="image/*,video/*" required aria-required="true" aria-label="Upload product image or video" />
    <input id="productTitle" type="text" placeholder="Product Title" minlength="2" required aria-required="true" aria-label="Product title" />
    <input id="productPrice" type="number" min="0" step="0.01" placeholder="Price (MVR)" required aria-required="true" aria-label="Product price in Maldivian Rufiyaa" />
    <input id="productLocation" type="text" placeholder="Location (optional)" aria-label="Product location" />
    <input id="productContact" type="text" placeholder="WhatsApp or Phone Number" minlength="5" required aria-required="true" aria-label="Contact phone or WhatsApp number" />
    <input id="paymentLink" type="url" placeholder="DRF Wallet Payment Link (optional)" aria-label="Payment link" />
    <div id="prog" style="display:none"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post Product</button>
  </form>

  <section id="postContainer" aria-live="polite" aria-atomic="false"></section>

  <div class="disclaimer" role="contentinfo">
    ⚠️ DRFMedia is a marketplace platform only. We do not guarantee payment, delivery, or product authenticity. Always verify before buying or sending money.
  </div>
</main>

<script type="module">
  const menuToggle = document.getElementById("menuToggle");
  const primaryNav = document.getElementById("primaryNav");

  function closeMenu() {
    if (window.innerWidth <= 600) primaryNav.classList.remove("show");
  }
  function toggleMenu() {
    primaryNav.classList.toggle("show");
  }

  menuToggle.addEventListener("click", toggleMenu);
  primaryNav.querySelectorAll("a").forEach((a) => {
    a.addEventListener("click", closeMenu);
  });

  document.addEventListener("click", (e) => {
    if (
      window.innerWidth <= 600 &&
      !primaryNav.contains(e.target) &&
      e.target !== menuToggle
    ) {
      primaryNav.classList.remove("show");
    }
  });

  // Highlight active nav link
  [...primaryNav.querySelectorAll("a")].forEach((a) => {
    if (location.pathname.endsWith(a.getAttribute("href"))) {
      a.classList.add("active");
    } else {
      a.classList.remove("active");
    }
  });

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
    measurementId: "G-TBFQX80NRP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = (id) => document.getElementById(id);
  const login = $("loginBtn"),
    logout = $("logoutBtn");
  const upload = $("uploadForm"),
    fileIn = $("mediaFile"),
    titleIn = $("productTitle"),
    priceIn = $("productPrice"),
    locationIn = $("productLocation"),
    contactIn = $("productContact"),
    paymentLinkIn = $("paymentLink");
  const prog = $("prog"),
    bar = $("progBar");
  const posts = $("postContainer"),
    qIn = $("searchInput");

  let user = null,
    all = [];

  const escapeHTML = (s) =>
    s.replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[m]));

  async function getGatewayUrl(cid) {
    const gateways = [
      "https://gateway.pinata.cloud/ipfs/",
      "https://cloudflare-ipfs.com/ipfs/",
      "https://ipfs.io/ipfs/",
    ];
    for (const g of gateways) {
      try {
        const res = await fetch(g + cid, { method: "HEAD" });
        if (res.ok) return g + cid;
      } catch {}
    }
    return null;
  }

  function lazyLoadVideo(video) {
    video.dataset.loaded = false;
    video.oncanplay = () => (video.dataset.loaded = "true");
    video.onerror = () => {
      if (!video.retryCount) video.retryCount = 0;
      if (video.retryCount < 3) {
        setTimeout(() => {
          video.src = video.dataset.src; // retry loading
          video.load();
          video.retryCount++;
        }, 2 ** video.retryCount * 1000);
      }
    };
    video.src = video.dataset.src;
    video.load();
  }

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          lazyLoadVideo(entry.target);
          obs.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.25 }
  );

  async function render() {
    const term = qIn.value.trim().toLowerCase();
    posts.innerHTML = "";
    for (const p of all) {
      if (
        term &&
        !(p.caption || "")
          .toLowerCase()
          .includes(term) &&
        !(p.productTitle || "")
          .toLowerCase()
          .includes(term) &&
        !(p.productLocation || "")
          .toLowerCase()
          .includes(term)
      )
        continue;

      const card = document.createElement("article");
      card.className = "post-item";
      card.innerHTML = `
        <header class="post-owner">
          <img class="avatar" src="${p.photoURL || "https://via.placeholder.com/40"}" alt="User avatar" />
          <div>
            <div>${escapeHTML(p.displayName || "Anon")}</div>
            <time class="post-time" datetime="${new Date(
              p.timestamp
            ).toISOString()}">
              ${new Date(p.timestamp).toLocaleString()}
            </time>
          </div>
        </header>
        <div class="post-caption">${escapeHTML(p.caption || "")}</div>
        <div class="post-media" id="m-${p.id}"></div>
        <div class="product-info">
          <div><strong>Product:</strong> ${escapeHTML(p.productTitle || "")}</div>
          <div class="product-price">Price: MVR ${
            p.productPrice ? Number(p.productPrice).toFixed(2) : "0.00"
          }</div>
          ${
            p.productLocation
              ? `<div><strong>Location:</strong> ${escapeHTML(
                  p.productLocation
                )}</div>`
              : ""
          }
          <div class="product-contact"><strong>Contact:</strong> ${escapeHTML(
            p.productContact || ""
          )}</div>
        </div>
        <div class="buttons">
          <a href="https://wa.me/${encodeURIComponent(
            p.productContact.replace(/[^0-9]/g, "")
          )}" target="_blank" rel="noopener" aria-label="Contact Seller on WhatsApp">Contact Seller</a>
          ${
            p.paymentLink
              ? `<a href="${p.paymentLink}" target="_blank" rel="noopener" class="btn" aria-label="Pay Seller">Pay Seller</a>`
              : ""
          }
        </div>
      `;
      posts.append(card);

      const holder = card.querySelector(`#m-${p.id}`);

      if (p.mediaType === "video") {
        const url = await getGatewayUrl(p.ipfsHash);
        if (url) {
          const v = document.createElement("video");
          v.controls = true;
          v.playsInline = true;
          v.preload = "metadata";
          v.dataset.src = url;
          observer.observe(v);
          holder.replaceWith(v);
        } else {
          holder.textContent = "Video unavailable.";
        }
      } else {
        const img = document.createElement("img");
        img.src = "https://gateway.pinata.cloud/ipfs/" + p.ipfsHash;
        img.alt = "Product media";
        holder.replaceWith(img);
      }
    }
  }

  async function getPosts() {
    const snap = await get(ref(db, "posts"));
    const obj = snap.val() || {};
    all = Object.entries(obj)
      .map(([id, v]) => ({ id, ...v }))
      .sort((a, b) => b.timestamp - a.timestamp);
    render();
  }

  login.onclick = () => signInWithPopup(auth, provider);
  logout.onclick = () => signOut(auth);
  onAuthStateChanged(auth, (u) => {
    user = u;
    login.style.display = u ? "none" : "block";
    logout.style.display = u ? "block" : "none";
    upload.style.display = u ? "block" : "none";
    primaryNav.style.display = u ? "flex" : "none";
    getPosts();
  });
  qIn.oninput = render;

  upload.onsubmit = async (e) => {
    e.preventDefault();
    if (!fileIn.files[0]) return alert("Choose a product image/video");
    if (titleIn.value.trim().length < 2) return alert("Product Title too short");
    if (!priceIn.value || Number(priceIn.value) < 0)
      return alert("Invalid price");
    if (contactIn.value.trim().length < 5)
      return alert("Enter valid contact info");

    const file = fileIn.files[0];
    upload.querySelector("button").disabled = true;
    prog.style.display = "block";
    bar.style.width = "0";

    try {
      // Upload to Pinata IPFS
      const fd = new FormData();
      fd.append("file", file);
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "https://api.pinata.cloud/pinning/pinFileToIPFS");
      xhr.setRequestHeader("Authorization", pinataJWT);
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable)
          bar.style.width = (e.loaded / e.total) * 100 + "%";
      };
      const cid = await new Promise((res, rej) => {
        xhr.onload = () => {
          try {
            res(JSON.parse(xhr.responseText).IpfsHash);
          } catch {
            rej("Pinata error");
          }
        };
        xhr.onerror = () => rej("Upload failed");
        xhr.send(fd);
      });

      // Save post to Firebase DB
      const newRef = push(ref(db, "posts"));
      await set(newRef, {
        userId: user.uid,
        displayName: user.displayName || "Anon",
        photoURL: user.photoURL || "",
        caption: "", // no caption for products or keep empty
        ipfsHash: cid,
        mediaType: file.type.startsWith("video") ? "video" : "image",
        timestamp: Date.now(),
        productTitle: titleIn.value.trim(),
        productPrice: Number(priceIn.value),
        productLocation: locationIn.value.trim(),
        productContact: contactIn.value.trim(),
        paymentLink: paymentLinkIn.value.trim(),
      });

      // Reset form UI
      fileIn.value = "";
      titleIn.value = "";
      priceIn.value = "";
      locationIn.value = "";
      contactIn.value = "";
      paymentLinkIn.value = "";
      bar.style.width = "100%";
      setTimeout(() => (prog.style.display = "none"), 400);
      getPosts();
    } catch (e) {
      alert(e);
      prog.style.display = "none";
    } finally {
      upload.querySelector("button").disabled = false;
    }
  };
</script>
</body>
</html>
