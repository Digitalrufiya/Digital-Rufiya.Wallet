<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia Sell Products</title>
<style>
  :root {
    --accent: #007bff;
    --accent-hover: #0056b3;
    --accent-muted: #3399ff;
    --bg-body: #f8f9fa;
    --bg-surface: #fff;
    --bg-surface-alt: #fafafa;
    --text-body: #212529;
    --text-muted: #6c757d;
    --radius: .5rem;
    --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
    --shadow-md: 0 2px 4px rgba(0,0,0,.1);
  }
  @media(prefers-color-scheme:dark) {
    :root {
      --bg-body: #181a1b;
      --bg-surface: #242628;
      --bg-surface-alt: #2b2e30;
      --text-body: #f1f3f5;
      --text-muted: #adb5bd;
      --shadow-sm: none;
      --shadow-md: none;
    }
  }
  * {
    box-sizing: border-box;
    margin: 0;
  }
  body {
    font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg-body);
    color: var(--text-body);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  a {
    color: inherit;
    text-decoration: none;
  }
  header {
    background: var(--accent);
    color: #fff;
    padding: .75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: .5rem;
    font-weight: 700;
  }
  .brand img {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: .25rem;
    background: #fff;
    padding: 2px;
  }
  #primaryNav {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  #primaryNav a {
    color: #fff;
    font-weight: 600;
    padding: .5rem .75rem;
    border-radius: var(--radius);
    transition: background-color 0.2s ease;
  }
  #primaryNav a:hover,
  #primaryNav a.active {
    background-color: var(--accent-hover);
  }
  #menuToggle {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    display: none;
    user-select: none;
  }
  @media (max-width: 600px) {
    #primaryNav {
      display: none;
      flex-direction: column;
      width: 100%;
      background: var(--accent);
      margin-top: 0.5rem;
      border-radius: var(--radius);
    }
    #primaryNav.show {
      display: flex;
    }
    #menuToggle {
      display: block;
    }
  }
  .btn {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    padding: .5rem 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background .2s;
  }
  .btn:hover {
    background: var(--accent-hover);
  }
  .btn:disabled {
    background: #adb5bd;
    cursor: not-allowed;
  }
  .container {
    width: min(100%, 700px);
    margin: 0 auto;
    padding: 0 1rem 2rem;
  }
  #prog {
    width: 100%;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    display: none;
  }
  #progBar {
    height: 4px;
    width: 0;
    background: var(--accent);
  }

  /* Enhanced mobile-friendly form styles */
  #uploadForm {
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--bg-surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  #uploadForm label {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-body);
  }
  #uploadForm input[type="file"],
  #uploadForm input[type="text"],
  #uploadForm input[type="number"],
  #uploadForm textarea {
    width: 100%;
    padding: 0.85rem 1rem;
    font-size: 1.1rem;
    border: 1.5px solid #ced4da;
    border-radius: var(--radius);
    background: var(--bg-surface-alt);
    color: var(--text-body);
    transition: border-color 0.3s ease;
  }
  #uploadForm input[type="file"]:focus,
  #uploadForm input[type="text"]:focus,
  #uploadForm input[type="number"]:focus,
  #uploadForm textarea:focus {
    border-color: var(--accent);
    outline: none;
  }
  #uploadForm button {
    padding: 0.85rem 1rem;
    font-size: 1.2rem;
    font-weight: 700;
    border-radius: var(--radius);
  }
  #uploadForm input,
  #uploadForm textarea,
  #uploadForm button {
    min-height: 48px;
  }
  #uploadForm label + input,
  #uploadForm label + textarea {
    margin-top: 0.35rem;
  }
  @media (max-width: 600px) {
    #uploadForm {
      padding: 1.25rem;
      gap: 1.25rem;
    }
  }

  /* Post item styles */
  .post-item {
    background: var(--bg-surface-alt);
    border: 1px solid #dee2e6;
    border-radius: var(--radius);
    padding: 1rem;
    margin: 1.25rem 0;
    box-shadow: var(--shadow-sm);
  }
  .post-owner {
    display: flex;
    align-items: center;
    gap: .6rem;
    font-weight: 700;
  }
  .avatar {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid #ccc;
  }
  .post-time {
    font-size: .8rem;
    color: var(--text-muted);
  }
  .post-caption {
    margin-top: .75rem;
    white-space: pre-wrap;
  }
  video,
  img {
    border-radius: var(--radius);
    background: #000;
    display: block;
    opacity: 0;
    transition: opacity .3s;
    max-width: 100%;
    height: auto;
  }
  [data-loaded=true] {
    opacity: 1;
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="logo" />
    <span>DRFMedia Sell</span>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">â˜°</button>
  <nav id="primaryNav">
    <a href="sell.html" class="active">Sell</a>
    <a href="media.html">Timeline</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Donate Ghaza</a>
  </nav>
</header>

<main class="container">
  <button id="loginBtn" class="btn">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none; background:#dc3545;">Logout</button>

  <form id="uploadForm" style="display:none" autocomplete="off">
    <label for="mediaFile">Product Image/Video *</label>
    <input id="mediaFile" type="file" accept="image/*,video/*" required />

    <label for="title">Product Title *</label>
    <input id="title" type="text" minlength="2" required placeholder="Enter product title" />

    <label for="price">Price in USDT *</label>
    <input id="price" type="number" min="0" step="0.01" required placeholder="0.00" />

    <label for="location">Location</label>
    <input id="location" type="text" placeholder="City, Country" />

    <label for="contact">Contact Info *</label>
    <input id="contact" type="text" minlength="5" required placeholder="WhatsApp, Telegram, etc." />

    <label for="paymentLink">DRF Wallet Payment Link (Optional)</label>
    <input id="paymentLink" type="text" placeholder="https://drfwallet.example/payment/..." />

    <div id="prog"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post Product</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>
</main>

<script type="module">
  const menuToggle = document.getElementById("menuToggle");
  const primaryNav = document.getElementById("primaryNav");
  if(window.innerWidth <= 600) {
    primaryNav.style.display = "none";
  }
  menuToggle.addEventListener("click", () => {
    if (primaryNav.style.display === "flex") {
      primaryNav.style.display = "none";
    } else {
      primaryNav.style.display = "flex";
    }
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    a.addEventListener("click", () => {
      if (window.innerWidth <= 600) {
        primaryNav.style.display = "none";
      }
    });
  });
  document.addEventListener("click", (e) => {
    const target = e.target;
    if (
      window.innerWidth <= 600 &&
      !primaryNav.contains(target) &&
      target !== menuToggle
    ) {
      primaryNav.style.display = "none";
    }
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    if (location.pathname.endsWith(a.getAttribute("href"))) {
      a.classList.add("active");
    } else {
      a.classList.remove("active");
    }
  });

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
    measurementId: "G-TBFQX80NRP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = (id) => document.getElementById(id);
  const login = $("loginBtn"),
    logout = $("logoutBtn");
  const upload = $("uploadForm"),
    fileIn = $("mediaFile"),
    titleIn = $("title"),
    priceIn = $("price"),
    locationIn = $("location"),
    contactIn = $("contact"),
    paymentLinkIn = $("paymentLink");
  const prog = $("prog"),
    bar = $("progBar");
  const posts = $("postContainer"),
    nav = $("primaryNav");

  let user = null,
    all = [];

  const escapeHTML = (s) =>
    s.replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[m]));

  async function getGatewayUrl(cid) {
    const gateways = [
      "https://gateway.pinata.cloud/ipfs/",
      "https://cloudflare-ipfs.com/ipfs/",
      "https://ipfs.io/ipfs/",
    ];
    for (const g of gateways) {
      try {
        const res = await fetch(g + cid, { method: "HEAD" });
        if (res.ok) return g + cid;
      } catch {}
    }
    return null;
  }

  function lazyLoadVideo(video) {
    video.dataset.loaded = false;
    video.oncanplay = () => (video.dataset.loaded = "true");
    video.onerror = () => {
      if (!video.retryCount) video.retryCount = 0;
      if (video.retryCount < 3) {
        setTimeout(() => {
          video.src = video.dataset.src;
          video.load();
          video.retryCount++;
        }, 2 ** video.retryCount * 1000);
      }
    };
    video.src = video.dataset.src;
    video.load();
  }

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          lazyLoadVideo(entry.target);
          obs.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.25 }
  );

  async function render() {
    const term = $("searchInput")?.value.trim().toLowerCase() || "";
    posts.innerHTML = "";
    for (const p of all) {
      if (term && !(p.productTitle || "").toLowerCase().includes(term)) continue;

      const card = document.createElement("article");
      card.className = "post-item";

      card.innerHTML = `
        <header class="post-owner">
          <img class="avatar" src="${p.photoURL || "https://via.placeholder.com/40"}" alt="Seller avatar" />
          <div>
            <div>${escapeHTML(p.displayName || "Anon")}</div>
            <time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">
              ${new Date(p.timestamp).toLocaleString()}
            </time>
          </div>
        </header>
        <h2 style="margin:0.5rem 0 0.3rem;">${escapeHTML(p.productTitle || "")}</h2>
        <div class="post-caption">Price: <strong>${p.productPrice} USDT</strong></div>
        <div class="post-caption">Location: ${escapeHTML(p.productLocation || "N/A")}</div>
        <div class="post-caption">Contact: ${escapeHTML(p.productContact || "")}</div>
        <div class="post-media" id="m-${p.id}"></div>
        <div style="margin-top:0.5rem;">
          ${
            p.paymentLink
              ? `<a href="${p.paymentLink}" target="_blank" rel="noopener" class="btn" style="padding:0.35rem 0.75rem; font-weight:600;">Pay Seller</a>`
              : ""
          }
          ${
            p.productContact
              ? `<a href="https://wa.me/${encodeURIComponent(p.productContact.replace(/\D/g,''))}" target="_blank" rel="noopener" class="btn" style="padding:0.35rem 0.75rem; margin-left:0.5rem;">Chat</a>`
              : ""
          }
        </div>
      `;

      posts.appendChild(card);

      // Load media (image/video)
      const mediaDiv = card.querySelector(`#m-${p.id}`);
      if (p.mediaType === "video") {
        const video = document.createElement("video");
        video.controls = true;
        video.preload = "none";
        video.style.maxHeight = "300px";
        video.dataset.src = p.mediaURL;
        mediaDiv.appendChild(video);
        observer.observe(video);
      } else if (p.mediaType === "image") {
        const img = document.createElement("img");
        img.src = p.mediaURL;
        img.alt = escapeHTML(p.productTitle || "Product image");
        img.loading = "lazy";
        mediaDiv.appendChild(img);
      }
    }
  }

  async function uploadMedia(file) {
    prog.style.display = "block";
    bar.style.width = "0%";
    const data = new FormData();
    data.append("file", file);

    const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
      method: "POST",
      body: data,
      headers: {
        Authorization: pinataJWT,
      },
    });

    if (!res.ok) {
      throw new Error("Upload failed");
    }

    const json = await res.json();
    prog.style.display = "none";
    bar.style.width = "0%";
    return json.IpfsHash;
  }

  async function loadPosts() {
    const postsRef = ref(db, "products");
    const snapshot = await get(postsRef);
    all = [];
    if (snapshot.exists()) {
      snapshot.forEach((child) => {
        const p = child.val();
        p.id = child.key;
        all.push(p);
      });
      all.sort((a, b) => b.timestamp - a.timestamp);
    }
    await render();
  }

  function resetForm() {
    upload.reset();
    prog.style.display = "none";
    bar.style.width = "0%";
  }

  upload.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!user) {
      alert("Please sign in first!");
      return;
    }
    try {
      const file = fileIn.files[0];
      if (!file) {
        alert("Please select a file!");
        return;
      }
      const title = titleIn.value.trim();
      const price = parseFloat(priceIn.value);
      if (price < 0) {
        alert("Price must be positive!");
        return;
      }
      const contact = contactIn.value.trim();
      if (!contact) {
        alert("Please provide contact info!");
        return;
      }

      upload.querySelector("button[type=submit]").disabled = true;

      const ipfsHash = await uploadMedia(file);

      const mediaType = file.type.startsWith("video") ? "video" : "image";

      const productData = {
        uid: user.uid,
        displayName: user.displayName || "Anon",
        photoURL: user.photoURL || "",
        mediaURL: `https://gateway.pinata.cloud/ipfs/${ipfsHash}`,
        mediaType: mediaType,
        productTitle: title,
        productPrice: price.toFixed(2),
        productLocation: locationIn.value.trim(),
        productContact: contact,
        paymentLink: paymentLinkIn.value.trim(),
        timestamp: Date.now(),
      };

      const postsRef = ref(db, "products");
      await push(postsRef, productData);

      alert("Product posted successfully!");
      resetForm();
      await loadPosts();
    } catch (error) {
      alert("Upload failed: " + error.message);
    } finally {
      upload.querySelector("button[type=submit]").disabled = false;
    }
  });

  login.addEventListener("click", () => {
    signInWithPopup(auth, provider).catch((e) =>
      alert("Login failed: " + e.message)
    );
  });

  logout.addEventListener("click", () => {
    signOut(auth);
  });

  onAuthStateChanged(auth, (u) => {
    user = u;
    if (user) {
      login.style.display = "none";
      logout.style.display = "inline-block";
      upload.style.display = "flex";
      loadPosts();
    } else {
      login.style.display = "inline-block";
      logout.style.display = "none";
      upload.style.display = "none";
      posts.innerHTML = "";
    }
  });
</script>
</body>
</html>
