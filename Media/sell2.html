<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Glasp Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    nav {
      background: #333;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 10px;
      justify-content: space-between;
    }
    nav .menu {
      display: flex;
      list-style: none;
      margin: 0;
      padding: 0;
    }
    nav .menu li {
      margin-left: 20px;
    }
    nav .menu li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    .toggle-btn {
      display: none;
      cursor: pointer;
      font-size: 20px;
    }
    @media (max-width: 600px) {
      nav .menu {
        display: none;
        flex-direction: column;
        width: 100%;
        background: #444;
      }
      nav .menu.show {
        display: flex;
      }
      nav .menu li {
        margin: 10px 0;
        text-align: center;
      }
      .toggle-btn {
        display: block;
      }
    }
    .main {
      padding: 20px;
    }
    #posts {
      margin-top: 20px;
    }
    .post {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 15px;
    }
    .post img {
      max-width: 100%;
      height: auto;
    }
    .file-input-label {
      display: inline-block;
      background: #0066cc;
      color: white;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 10px;
    }
    #fileInput {
      display: none;
    }
    button {
      margin-top: 10px;
      padding: 8px 15px;
      cursor: pointer;
      background: #28a745;
      border: none;
      color: white;
      border-radius: 5px;
      font-size: 16px;
    }
    #userDetails {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <nav>
    <div class="toggle-btn" id="toggleBtn">&#9776;</div>
    <ul class="menu" id="menu">
      <li><a href="#">Glasp Admin</a></li>
      <li><a href="#">About</a></li>
      <li><a href="#" id="signInBtn">Sign in</a></li>
      <li><a href="#" id="signOutBtn" style="display:none;">Sign out</a></li>
    </ul>
  </nav>

  <main class="main">
    <input type="file" id="fileInput" />
    <label for="fileInput" class="file-input-label">Choose a file</label><br />
    <button id="uploadBtn" disabled>Upload to Pinata</button>

    <div id="userDetails"></div>

    <section id="posts"></section>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
    measurementId: "G-TBFQX80NRP"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    // Replace with your actual Pinata JWT token (generate on Pinata dashboard)
    const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

    // DOM Elements
    const toggleBtn = document.getElementById('toggleBtn');
    const menu = document.getElementById('menu');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userDetails = document.getElementById('userDetails');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const postsContainer = document.getElementById('posts');

    // Toggle menu on small screens
    toggleBtn.addEventListener('click', () => {
      menu.classList.toggle('show');
    });

    // Sign in
    signInBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await auth.signInWithPopup(provider);
      } catch (err) {
        alert('Sign-in failed: ' + err.message);
      }
    });

    // Sign out
    signOutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      await auth.signOut();
    });

    // Update UI based on auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        signInBtn.style.display = 'none';
        signOutBtn.style.display = 'inline';
        userDetails.textContent = `Hello, ${user.displayName} (${user.email})`;
        uploadBtn.disabled = !fileInput.files.length;
        loadPosts();
      } else {
        signInBtn.style.display = 'inline';
        signOutBtn.style.display = 'none';
        userDetails.textContent = '';
        uploadBtn.disabled = true;
        postsContainer.innerHTML = '';
      }
    });

    // Enable upload button only if a file is selected and user is signed in
    fileInput.addEventListener('change', () => {
      uploadBtn.disabled = !fileInput.files.length || !auth.currentUser;
    });

    // Upload to Pinata with JWT Auth
    uploadBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) {
        alert('Please select a file first.');
        return;
      }

      const file = fileInput.files[0];

      // Prepare form data for Pinata
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${PINATA_JWT}`
          },
          body: formData,
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error('Pinata upload failed: ' + errorText);
        }

        const data = await response.json();
        alert('File uploaded to IPFS with hash: ' + data.IpfsHash);

        // Reload posts or do something after successful upload
        loadPosts();

      } catch (error) {
        alert('Upload failed: ' + error.message);
      }
    });

    // Load posts from API and render
    async function loadPosts() {
      postsContainer.innerHTML = 'Loading posts...';

      try {
        const response = await fetch('https://sepolia-api.pulsechain.com/api/v1/posts');
        if (!response.ok) throw new Error('Failed to fetch posts');

        const posts = await response.json();

        if (!Array.isArray(posts) || posts.length === 0) {
          postsContainer.innerHTML = '<p>No posts available.</p>';
          return;
        }

        postsContainer.innerHTML = '';
        posts.forEach(post => {
          const postEl = document.createElement('article');
          postEl.className = 'post';

          const title = document.createElement('h3');
          title.textContent = post.title || 'Untitled';
          postEl.appendChild(title);

          if (post.thumbnail) {
            const img = document.createElement('img');
            img.src = post.thumbnail;
            img.alt = post.title || 'Post image';
            postEl.appendChild(img);
          }

          const content = document.createElement('p');
          content.textContent = post.content || '';
          postEl.appendChild(content);

          postsContainer.appendChild(postEl);
        });
      } catch (err) {
        postsContainer.innerHTML = '<p>Error loading posts: ' + err.message + '</p>';
      }
    }
  </script>
</body>
</html>
