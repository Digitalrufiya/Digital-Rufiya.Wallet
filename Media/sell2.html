<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia Marketplace — Buy & Sell</title>
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="light dark" />
<style>
:root {
  --accent: #007bff;
  --accent-hover: #0056b3;
  --accent-muted: #3399ff;
  --bg-body: #f8f9fa;
  --bg-surface: #fff;
  --bg-surface-alt: #fafafa;
  --text-body: #212529;
  --text-muted: #6c757d;
  --radius: .5rem;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
  --shadow-md: 0 2px 4px rgba(0,0,0,.1)
}
@media(prefers-color-scheme:dark) {
  :root {
    --bg-body: #181a1b;
    --bg-surface: #242628;
    --bg-surface-alt: #2b2e30;
    --text-body: #f1f3f5;
    --text-muted: #adb5bd;
    --shadow-sm: none;
    --shadow-md: none
  }
}
* {
  box-sizing: border-box;
  margin: 0
}
body {
  font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg-body);
  color: var(--text-body);
  min-height: 100vh;
  display: flex;
  flex-direction: column
}
a {
  color: inherit;
  text-decoration: none
}
img,
video {
  max-width: 100%;
  border-radius: var(--radius);
  background: #000;
  display: block;
  opacity: 0;
  transition: opacity .3s
}
[data-loaded=true] {
  opacity: 1
}
header {
  background: var(--accent);
  color: #fff;
  padding: .75rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
  position: sticky;
  top: 0;
  z-index: 1000
}
.brand {
  display: flex;
  align-items: center;
  gap: .5rem;
  font-weight: 700
}
.brand img {
  width: 2.25rem;
  height: 2.25rem;
  border-radius: .25rem;
  background: #fff;
  padding: 2px
}
#primaryNav {
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}
#primaryNav a {
  color: #fff;
  font-weight: 600;
  padding: .5rem .75rem;
  border-radius: var(--radius);
  transition: background-color 0.2s ease;
}
#primaryNav a:hover,
#primaryNav a.active {
  background-color: var(--accent-hover);
}
#menuToggle {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 1.5rem;
  cursor: pointer;
  display: none;
  user-select: none;
}
@media (max-width: 600px) {
  #primaryNav {
    display: none;
    flex-direction: column;
    width: 100%;
    background: var(--accent);
    margin-top: 0.5rem;
    border-radius: var(--radius);
  }
  #primaryNav.show {
    display: flex;
  }
  #menuToggle {
    display: block;
  }
}
.btn {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: .5rem 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background .2s
}
.btn:hover {
  background: var(--accent-hover)
}
.btn:disabled {
  background: #adb5bd;
  cursor: not-allowed
}
.container {
  width: min(100%, 700px);
  margin: 0 auto;
  padding: 0 1rem
}
#searchInput {
  width: 100%;
  padding: .55rem .85rem;
  margin: 1rem 0;
  border: 1px solid #ced4da;
  border-radius: var(--radius);
  background: var(--bg-surface);
  color: var(--text-body)
}
.post-item {
  background: var(--bg-surface-alt);
  border: 1px solid #dee2e6;
  border-radius: var(--radius);
  padding: 1rem;
  margin: 1.25rem 0;
  box-shadow: var(--shadow-sm)
}
.post-owner {
  display: flex;
  align-items: center;
  gap: .6rem;
  font-weight: 700
}
.avatar {
  width: 2.25rem;
  height: 2.25rem;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #ccc
}
.post-time {
  font-size: .8rem;
  color: var(--text-muted)
}
.post-caption {
  margin-top: .75rem;
  white-space: pre-wrap
}
.product-info {
  margin-top: 0.75rem;
  font-weight: 600;
}
.product-price {
  color: var(--accent);
  font-size: 1.1rem;
  margin-top: 0.3rem;
}
.product-contact {
  margin-top: 0.5rem;
}
.buttons {
  margin-top: 0.75rem;
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}
.buttons a,
.buttons button {
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: 0.5rem 1rem;
  cursor: pointer;
  font-weight: 600;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  transition: background .2s;
}
.buttons a:hover,
.buttons button:hover {
  background: var(--accent-hover);
}
.disclaimer {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 1rem;
  border-top: 1px solid #ccc;
  padding-top: 1rem;
}
video,
img {
  max-width: 100%;
  border-radius: var(--radius);
  background: #000;
  display: block;
  opacity: 0;
  transition: opacity .3s
}
[data-loaded=true] {
  opacity: 1
}

/* === UPLOAD FORM UI IMPROVEMENTS === */
.upload-form {
  background: var(--bg-surface);
  padding: 1.5rem 1.25rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  margin-top: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.upload-label {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text-body);
}

.upload-input {
  padding: 0.5rem 0.75rem;
  border: 1.5px solid #ced4da;
  border-radius: var(--radius);
  font-size: 1rem;
  background: var(--bg-surface-alt);
  color: var(--text-body);
  transition: border-color 0.2s ease;
}

.upload-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 5px var(--accent-muted);
  background: var(--bg-surface);
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="logo" />
    <span>DRFMedia Marketplace</span>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">☰</button>
  <nav id="primaryNav">
    <a href="sell.html" class="active">Marketplace</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Donate Ghaza</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search products…" />
  <button id="loginBtn" class="btn">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;background:#dc3545">Logout</button>

  <form id="uploadForm" style="display:none" autocomplete="off" class="upload-form">
    <label for="mediaFile" class="upload-label">Select Image/Video <span style="color:#007bff">*</span></label>
    <input id="mediaFile" type="file" accept="image/*,video/*" required class="upload-input" />

    <label for="productTitle" class="upload-label">Product Title <span style="color:#007bff">*</span></label>
    <input id="productTitle" type="text" placeholder="Enter product title" minlength="2" required class="upload-input" />

    <label for="productPrice" class="upload-label">Price (MVR) <span style="color:#007bff">*</span></label>
    <input id="productPrice" type="number" min="0" step="0.01" placeholder="0.00" required class="upload-input" />

    <label for="productLocation" class="upload-label">Location (Optional)</label>
    <input id="productLocation" type="text" placeholder="Where is product located?" class="upload-input" />

    <label for="productContact" class="upload-label">WhatsApp or Phone Number <span style="color:#007bff">*</span></label>
    <input id="productContact" type="text" placeholder="Contact info" minlength="5" required class="upload-input" />

    <label for="paymentLink" class="upload-label">DRF Wallet Payment Link (Optional)</label>
    <input id="paymentLink" type="url" placeholder="https://wallet.drfmedia/..." class="upload-input" />

    <div id="prog" style="display:none; margin: 10px 0; background:#e9ecef; border-radius: 0.25rem; overflow: hidden; height: 12px;">
      <div id="progBar" style="width: 0; height: 100%; background: var(--accent); transition: width 0.3s ease;"></div>
    </div>

    <button class="btn" type="submit" style="width: 100%; font-size: 1.1rem; padding: 0.75rem;">Post Product</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>

  <div class="disclaimer">
    ⚠️ DRFMedia is a marketplace platform only. We do not guarantee payment, delivery, or product authenticity. Always verify before buying or sending money.
  </div>
</main>

<script type="module">
  const menuToggle = document.getElementById("menuToggle");
  const primaryNav = document.getElementById("primaryNav");

  // Responsive menu toggle for mobile
  if(window.innerWidth <= 600) {
    primaryNav.style.display = "none";
  }
  menuToggle.addEventListener("click", () => {
    if (primaryNav.style.display === "flex") {
      primaryNav.style.display = "none";
    } else {
      primaryNav.style.display = "flex";
    }
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    a.addEventListener("click", () => {
      if (window.innerWidth <= 600) {
        primaryNav.style.display = "none";
      }
    });
  });
  document.addEventListener("click", (e) => {
    const target = e.target;
    if (
      window.innerWidth <= 600 &&
      !primaryNav.contains(target) &&
      target !== menuToggle
    ) {
      primaryNav.style.display = "none";
    }
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    if (location.pathname.endsWith(a.getAttribute("href"))) {
      a.classList.add("active");
    } else {
      a.classList.remove("active");
    }
  });

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
    measurementId: "G-TBFQX80NRP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = (id) => document.getElementById(id);
  const login = $("loginBtn"),
    logout = $("logoutBtn");
  const upload = $("uploadForm"),
    fileIn = $("mediaFile"),
    titleIn = $("productTitle"),
    priceIn = $("productPrice"),
    locationIn = $("productLocation"),
    contactIn = $("productContact"),
    paymentLinkIn = $("paymentLink");
  const prog = $("prog"),
    bar = $("progBar");
  const posts = $("postContainer"),
    qIn = $("searchInput"),
    nav = $("primaryNav");

  let user = null,
    all = [];

  const escapeHTML = (s) =>
    s.replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[m]));

  async function getGatewayUrl(cid) {
    const gateways = [
      "https://gateway.pinata.cloud/ipfs/",
      "https://cloudflare-ipfs.com/ipfs/",
      "https://ipfs.io/ipfs/",
    ];
    for (const g of gateways) {
      try {
        const res = await fetch(g + cid, { method: "HEAD" });
        if (res.ok) return g + cid;
      } catch {}
    }
    return null;
  }

  function lazyLoadVideo(video) {
    video.dataset.loaded = false;
    video.oncanplay = () => (video.dataset.loaded = "true");
    video.onerror = () => {
      if (!video.retryCount) video.retryCount = 0;
      if (video.retryCount < 3) {
        setTimeout(() => {
          video.src = video.dataset.src; // retry loading
          video.load();
          video.retryCount++;
        }, 2 ** video.retryCount * 1000);
      }
    };
    video.src = video.dataset.src;
    video.load();
  }

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          lazyLoadVideo(entry.target);
          obs.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.25 }
  );

  async function render() {
    const term = qIn.value.trim().toLowerCase();
    posts.innerHTML = "";
    for (const p of all) {
      if (term && !(p.caption || "").toLowerCase().includes(term)) continue;

      const isVideo = /\.(mp4|webm|ogg)$/i.test(p.mediaUrl);
      const mediaHTML = isVideo
        ? `<video controls preload="none" data-src="${p.mediaUrl}" muted playsinline loop poster="${p.thumb || ""}"></video>`
        : `<img src="${p.mediaUrl}" alt="Product Image" loading="lazy" />`;

      const locHTML = p.location ? `<div>📍 Location: ${escapeHTML(p.location)}</div>` : "";
      const payHTML = p.paymentLink
        ? `<div><a href="${escapeHTML(p.paymentLink)}" target="_blank" rel="noopener noreferrer" class="btn">Pay via DRF Wallet</a></div>`
        : "";

      const contactHTML = `<div class="product-contact">📱 Contact: ${escapeHTML(p.contact)}</div>`;

      posts.insertAdjacentHTML(
        "beforeend",
        `
      <article class="post-item" aria-label="Product posted by ${escapeHTML(p.ownerName)}">
        <div class="post-owner">
          <img src="${p.ownerPhoto}" alt="${escapeHTML(p.ownerName)}'s avatar" class="avatar" />
          <div>
            <div>${escapeHTML(p.ownerName)}</div>
            <div class="post-time">${new Date(p.createdAt).toLocaleString()}</div>
          </div>
        </div>
        <div class="post-caption">${escapeHTML(p.caption)}</div>
        <div class="product-info">
          <div class="product-price">Price: MVR ${Number(p.price).toFixed(2)}</div>
          ${locHTML}
          ${contactHTML}
          ${payHTML}
        </div>
        <div style="margin-top:0.75rem">${mediaHTML}</div>
      </article>`
      );
    }
    // Attach observer to all videos for lazy loading
    document.querySelectorAll("video[data-src]").forEach((video) =>
      observer.observe(video)
    );
  }

  async function fetchPosts() {
    const dbRef = ref(db, "products");
    const snap = await get(dbRef);
    if (snap.exists()) {
      const data = snap.val();
      all = Object.values(data).sort(
        (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
      );
      render();
    } else {
      all = [];
      render();
    }
  }

  // Upload function with Pinata IPFS & Firebase DB
  async function uploadMedia(e) {
    e.preventDefault();
    if (!fileIn.files.length) return alert("Please select a file!");
    if (!titleIn.value.trim()) return alert("Please enter product title!");
    if (!priceIn.value || Number(priceIn.value) < 0) return alert("Please enter valid price!");
    if (!contactIn.value.trim()) return alert("Please enter contact info!");

    const file = fileIn.files[0];
    const formData = new FormData();
    formData.append("file", file);

    prog.style.display = "block";
    bar.style.width = "0%";

    try {
      // Upload file to Pinata
      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        body: formData,
        headers: {
          Authorization: pinataJWT,
        },
      });

      if (!res.ok) throw new Error("IPFS upload failed!");

      const { IpfsHash } = await res.json();
      const ipfsUrl = `https://gateway.pinata.cloud/ipfs/${IpfsHash}`;

      // Save post metadata in Firebase Realtime Database
      const newPostRef = push(ref(db, "products"));
      await set(newPostRef, {
        mediaUrl: ipfsUrl,
        thumb: "", // No thumb generated currently
        caption: titleIn.value.trim(),
        price: Number(priceIn.value).toFixed(2),
        location: locationIn.value.trim() || "",
        contact: contactIn.value.trim(),
        paymentLink: paymentLinkIn.value.trim() || "",
        ownerId: user.uid,
        ownerName: user.displayName || "Unknown",
        ownerPhoto: user.photoURL || "default-avatar.png",
        createdAt: new Date().toISOString(),
      });

      alert("Product posted successfully!");

      upload.reset();
      upload.style.display = "none";
      fetchPosts();
    } catch (err) {
      alert("Upload failed: " + err.message);
    } finally {
      prog.style.display = "none";
      bar.style.width = "0%";
    }
  }

  // Authentication handling
  login.addEventListener("click", () => {
    signInWithPopup(auth, provider).catch((err) =>
      alert("Login failed: " + err.message)
    );
  });
  logout.addEventListener("click", () => {
    signOut(auth).catch((err) => alert("Logout failed: " + err.message));
  });

  onAuthStateChanged(auth, (u) => {
    user = u;
    if (user) {
      login.style.display = "none";
      logout.style.display = "inline-block";
      upload.style.display = "flex";
    } else {
      login.style.display = "inline-block";
      logout.style.display = "none";
      upload.style.display = "none";
    }
  });

  upload.addEventListener("submit", uploadMedia);

  qIn.addEventListener("input", () => render());

  fetchPosts();
</script>
</body>
</html>
