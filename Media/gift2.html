<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Timeline â€” Spread Kindness & Truth</title>
  <style>
    /* Reset and base styles */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .navbar-left img {
      height: 40px;
      width: 40px;
      border-radius: 4px;
      background: white;
      padding: 2px;
      object-fit: contain;
    }
    .navbar-left h1 {
      margin: 0;
      font-size: 1.4em;
      font-weight: 700;
    }
    #menuToggle {
      background: transparent;
      border: none;
      cursor: pointer;
      width: 30px;
      height: 25px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0;
      color: white;
    }
    #menuToggle span {
      display: block;
      height: 3.5px;
      background: white;
      border-radius: 3px;
    }
    #primaryNav {
      width: 100%;
      display: none;
      flex-direction: column;
      background: #0069d9;
      margin-top: 10px;
      border-radius: 4px;
    }
    #primaryNav.open {
      display: flex;
    }
    #primaryNav a {
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    #primaryNav a:first-child {
      border-top: none;
    }
    #primaryNav a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    @media (min-width: 768px) {
      #menuToggle {
        display: none;
      }
      #primaryNav {
        display: flex !important;
        flex-direction: row;
        width: auto;
        background: transparent;
        margin-top: 0;
        border-radius: 0;
      }
      #primaryNav a {
        border: none;
        padding: 10px 15px;
        color: white;
      }
      #primaryNav a:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.1);
    }
    #searchBar {
      max-width: 700px;
      margin: 10px auto 20px auto;
      padding: 0 15px;
    }
    #searchInput {
      width: 100%;
      padding: 8px 12px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #loginBtn,
    #logoutBtn {
      display: block;
      max-width: 700px;
      margin: 10px auto;
      padding: 12px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s;
      width: calc(100% - 40px);
    }
    #loginBtn:hover,
    #logoutBtn:hover {
      background-color: #0056b3;
    }
    #uploadForm {
      display: none;
      max-width: 700px;
      margin: 20px auto 40px auto;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f8f9fa;
    }
    #uploadForm input[type="file"] {
      width: 100%;
      font-size: 1em;
    }
    #uploadForm textarea {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #ccc;
      resize: vertical;
      min-height: 70px;
    }
    #uploadForm button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      font-weight: 600;
      transition: background-color 0.3s;
      width: 100%;
    }
    #uploadForm button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #uploadForm button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    #postContainer {
      max-width: 700px;
      margin: 0 auto 40px auto;
      padding: 0 15px;
      flex-grow: 1;
    }
    .post-item {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      gap: 12px;
      word-break: break-word;
    }
    .post-owner {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
    }
    .post-owner div {
      line-height: 1.1;
    }
    .post-time {
      font-size: 0.85em;
      color: #555;
      margin-top: 4px;
    }
    .post-caption {
      font-size: 1em;
      white-space: pre-wrap;
      margin-top: 4px;
    }
    .post-media {
      display: flex;
      justify-content: center;
      align-items: center;
      max-height: 350px;
      overflow: hidden;
      margin-top: 10px;
      border-radius: 6px;
      background: black;
    }
    .post-media video,
    .post-media img {
      max-width: 100%;
      max-height: 350px;
      object-fit: contain;
      border-radius: 6px;
    }
    .post-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.9em;
    }
    .post-actions button,
    .post-actions select {
      cursor: pointer;
      border: none;
      background: #007bff;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-weight: 600;
      transition: background-color 0.3s;
      min-width: 70px;
    }
    .post-actions button:hover,
    .post-actions select:hover {
      background: #0056b3;
    }
    .post-actions button.liked {
      background: #28a745 !important; /* green */
      color: #fff !important;
    }
    .post-actions button.boosted {
      background-color: gold !important;
      color: #000 !important;
    }
    .post-actions select {
      color: #000;
      background: white;
      border: 1px solid #007bff;
      padding: 5px 10px;
      min-width: 110px;
    }
    .post-actions select option {
      color: #000;
    }
    /* Comment section */
    .comments-section {
      border-top: 1px solid #ccc;
      padding-top: 10px;
      font-size: 0.9em;
      color: #333;
    }
    .comments-list {
      max-height: 120px;
      overflow-y: auto;
      margin-bottom: 8px;
    }
    .comment-item {
      border-bottom: 1px solid #eee;
      padding: 4px 0;
      word-wrap: break-word;
    }
    .comment-form {
      display: flex;
      gap: 8px;
    }
    .comment-form input {
      flex-grow: 1;
      padding: 6px 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 0.9em;
    }
    .comment-form button {
      padding: 6px 14px;
      border-radius: 5px;
      border: none;
      background: #007bff;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .comment-form button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <header>
    <div class="navbar-left">
      <img
        src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311"
        alt="DRFMedia Logo"
      />
      <h1>DRFMedia</h1>
    </div>
    <button id="menuToggle" aria-label="Toggle menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
    <nav id="primaryNav" aria-label="Primary navigation">
      <a href="timeline.html">Timeline</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="loginNavLink">Login</a>
      <a href="#" id="logoutNavLink" style="display:none;">Logout</a>
    </nav>
  </header>

  <div id="searchBar">
    <input
      type="search"
      id="searchInput"
      placeholder="Search posts..."
      aria-label="Search posts"
    />
  </div>

  <button id="loginBtn">
    Sign in with Google
  </button>
  <button id="logoutBtn" style="display:none;">
    Logout
  </button>

  <form
    id="uploadForm"
    enctype="multipart/form-data"
    aria-label="Upload a new post"
  >
    <input type="file" id="mediaFile" accept="image/*,video/*" required aria-required="true" />
    <textarea
      id="caption"
      placeholder="Write your caption..."
      required
      minlength="4"
      aria-required="true"
    ></textarea>
    <button type="submit">
      Post
    </button>
  </form>

  <div id="postContainer" aria-live="polite" aria-atomic="true"></div>

  <!-- Skrill Donation Form (hidden, will be dynamically populated) -->
  <form
    id="skrillForm"
    action="https://pay.skrill.com"
    method="POST"
    target="_blank"
    style="display:none;"
    aria-hidden="true"
  >
    <input type="hidden" name="pay_to_email" value="digitalrufiyacoin@gmail.com" />
    <input type="hidden" name="amount" id="skrillAmount" value="" />
    <input type="hidden" name="currency" value="USD" />
    <input type="hidden" name="detail1_description" value="Donation to DRFMedia" />
    <input type="hidden" name="detail1_text" id="skrillDetail" value="" />
    <input type="hidden" name="transaction_id" id="skrillTransactionId" value="" />
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      runTransaction,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import {
      getAuth,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.appspot.com",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:dc999df2c0c37241ff3f40",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // DOM elements
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const uploadForm = document.getElementById("uploadForm");
    const mediaFile = document.getElementById("mediaFile");
    const captionInput = document.getElementById("caption");
    const postContainer = document.getElementById("postContainer");
    const searchInput = document.getElementById("searchInput");
    const menuToggle = document.getElementById("menuToggle");
    const primaryNav = document.getElementById("primaryNav");

    const skrillForm = document.getElementById("skrillForm");
    const skrillAmount = document.getElementById("skrillAmount");
    const skrillDetail = document.getElementById("skrillDetail");
    const skrillTransactionId = document.getElementById("skrillTransactionId");

    let currentUser = null;
    let allPosts = [];

    // Hamburger menu toggle
    menuToggle.addEventListener("click", () => {
      const expanded = menuToggle.getAttribute("aria-expanded") === "true";
      menuToggle.setAttribute("aria-expanded", String(!expanded));
      primaryNav.classList.toggle("open");
    });

    // Escape to prevent XSS
    const escapeHTML = (str) =>
      str.replace(/[&<>"]/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
      }[c]));

    // Auth state changed
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      uploadForm.style.display = user ? "block" : "none";
      loginBtn.style.display = user ? "none" : "block";
      logoutBtn.style.display = user ? "block" : "none";
      renderPosts();
    });

    loginBtn.onclick = () =>
      signInWithPopup(auth, provider).catch((e) =>
        alert("Login failed: " + e.message)
      );
    logoutBtn.onclick = () =>
      signOut(auth).catch((e) => alert("Logout failed: " + e.message));

    // Upload handler - uploads file to Pinata, then saves post to Firebase Realtime DB
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Please login.");
      if (!mediaFile.files.length) return alert("Select a file.");
      if (captionInput.value.trim().length < 4)
        return alert("Caption too short.");

      uploadForm.querySelector("button").disabled = true;
      const file = mediaFile.files[0];
      const fd = new FormData();
      fd.append("file", file);

      try {
        // Put your actual Pinata JWT here
        const pinataJWT =
          "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.your_jwt_token_here";

        const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
          method: "POST",
          headers: { Authorization: pinataJWT },
          body: fd,
        });
        if (!res.ok) throw new Error("Pinata upload failed: " + res.statusText);
        const { IpfsHash } = await res.json();

        const newPostRef = push(ref(db, "posts"));
        await set(newPostRef, {
          userId: currentUser.uid,
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          caption: captionInput.value.trim(),
          ipfsHash: IpfsHash,
          mediaType: file.type.startsWith("video") ? "video" : "image",
          mediaMimeType: file.type,
          timestamp: Date.now(),
          likesCount: 0,
          commentsCount: 0,
          boostsCount: 0,
          boostedBy: {},
          likesBy: {},
          comments: {},
        });

        captionInput.value = "";
        mediaFile.value = "";
        alert("Post uploaded successfully.");
      } catch (err) {
        alert("Upload failed: " + err.message);
      } finally {
        uploadForm.querySelector("button").disabled = false;
      }
    });

    // Listen for posts updates
    const postsRef = ref(db, "posts");
    onValue(postsRef, (snapshot) => {
      const val = snapshot.val();
      allPosts = val ? Object.entries(val).map(([id, post]) => ({ id, ...post })) : [];
      renderPosts();
    });

    // Render posts filtered by search
    function renderPosts() {
      const filter = searchInput.value.trim().toLowerCase();
      postContainer.innerHTML = "";

      const filteredPosts = allPosts
        .filter((post) =>
          post.caption.toLowerCase().includes(filter) ||
          (post.displayName && post.displayName.toLowerCase().includes(filter))
        )
        .sort((a, b) => b.timestamp - a.timestamp);

      if (filteredPosts.length === 0) {
        postContainer.innerHTML = `<p style="text-align:center; color:#555;">No posts found.</p>`;
        return;
      }

      filteredPosts.forEach((post) => {
        const dateStr = new Date(post.timestamp).toLocaleString();

        // Likes, boosts counts safely fallback
        const likesCount = post.likesCount || 0;
        const boostsCount = post.boostsCount || 0;
        const likedClass = post.likesBy && currentUser && post.likesBy[currentUser.uid] ? "liked" : "";
        const boostedClass =
          post.boostedBy && currentUser && post.boostedBy[currentUser.uid] ? "boosted" : "";

        // Media HTML
        let mediaHTML = "";
        if (post.mediaType === "video") {
          mediaHTML = `<video controls preload="metadata" playsinline aria-label="Video post">
            <source src="https://ipfs.io/ipfs/${post.ipfsHash}" type="${post.mediaMimeType}" />
            Your browser does not support the video tag.
          </video>`;
        } else if (post.mediaType === "image") {
          mediaHTML = `<img
            src="https://ipfs.io/ipfs/${post.ipfsHash}"
            alt="Post media"
            loading="lazy"
          />`;
        }

        // Comments
        const comments = post.comments ? Object.values(post.comments) : [];
        const commentsList = comments.length
          ? comments
              .map(
                (comment) =>
                  `<div class="comment-item"><strong>${escapeHTML(
                    comment.displayName || "Anonymous"
                  )}:</strong> ${escapeHTML(comment.text)}</div>`
              )
              .join("")
          : `<i>No comments yet</i>`;

        const postEl = document.createElement("article");
        postEl.className = "post-item";
        postEl.innerHTML = `
          <div class="post-owner">
            <img src="${escapeHTML(post.photoURL || "")}" alt="User avatar" class="avatar" />
            <div>
              <div>${escapeHTML(post.displayName || "Unknown")}</div>
              <div class="post-time">${escapeHTML(dateStr)}</div>
            </div>
          </div>
          <div class="post-caption">${escapeHTML(post.caption)}</div>
          <div class="post-media">${mediaHTML}</div>
          <div class="post-actions">
            <button class="${likedClass}" aria-label="Like post" data-postid="${post.id}" data-action="like">
              Like (${likesCount})
            </button>
            <button class="${boostedClass}" aria-label="Boost post" data-postid="${post.id}" data-action="boost">
              Boost (${boostsCount})
            </button>
            <select aria-label="Donate amount" data-postid="${post.id}" onchange="donateToPost('${post.id}', '${post.userId}', this.value)">
              <option value="">Donate</option>
              <option value="1">1 USD</option>
              <option value="3">3 USD</option>
              <option value="5">5 USD</option>
              <option value="10">10 USD</option>
            </select>
          </div>
          <div class="comments-section" aria-live="polite" aria-atomic="true">
            <div class="comments-list" id="comments-list-${post.id}">
              ${commentsList}
            </div>
            ${
              currentUser
                ? `<form class="comment-form" data-postid="${post.id}">
                    <input type="text" name="commentText" placeholder="Write a comment..." required minlength="1" aria-label="Write a comment" />
                    <button type="submit">Comment</button>
                  </form>`
                : '<small><em>Login to comment.</em></small>'
            }
          </div>
        `;
        postContainer.appendChild(postEl);
      });

      // Attach like/boost button listeners
      postContainer.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.onclick = () => {
          if (!currentUser) return alert("Please login first.");
          const postId = btn.dataset.postid;
          if (btn.dataset.action === "like") toggleLike(postId);
          else if (btn.dataset.action === "boost") toggleBoost(postId);
        };
      });

      // Attach comment form listeners
      postContainer.querySelectorAll(".comment-form").forEach((form) => {
        form.onsubmit = (e) => {
          e.preventDefault();
          if (!currentUser) return alert("Please login to comment.");
          const postId = form.dataset.postid;
          const commentText = form.commentText.value.trim();
          if (!commentText) return alert("Comment cannot be empty.");
          addComment(postId, commentText);
          form.commentText.value = "";
        };
      });
    }

    // Toggle like on a post
    async function toggleLike(postId) {
      const postRef = ref(db, "posts/" + postId);
      try {
        await runTransaction(postRef, (post) => {
          if (post) {
            post.likesBy = post.likesBy || {};
            post.likesCount = post.likesCount || 0;
            if (post.likesBy[currentUser.uid]) {
              // Remove like
              delete post.likesBy[currentUser.uid];
              post.likesCount = Math.max(post.likesCount - 1, 0);
            } else {
              post.likesBy[currentUser.uid] = true;
              post.likesCount++;
            }
          }
          return post;
        });
      } catch (e) {
        alert("Error liking post: " + e.message);
      }
    }

    // Toggle boost on a post
    async function toggleBoost(postId) {
      const postRef = ref(db, "posts/" + postId);
      try {
        await runTransaction(postRef, (post) => {
          if (post) {
            post.boostedBy = post.boostedBy || {};
            post.boostsCount = post.boostsCount || 0;
            if (post.boostedBy[currentUser.uid]) {
              delete post.boostedBy[currentUser.uid];
              post.boostsCount = Math.max(post.boostsCount - 1, 0);
            } else {
              post.boostedBy[currentUser.uid] = true;
              post.boostsCount++;
            }
          }
          return post;
        });
      } catch (e) {
        alert("Error boosting post: " + e.message);
      }
    }

    // Add comment to post
    async function addComment(postId, text) {
      if (!text) return;
      const commentId = Date.now().toString() + Math.random().toString(36).substring(2, 8);
      const commentRef = ref(db, `posts/${postId}/comments/${commentId}`);
      try {
        await set(commentRef, {
          userId: currentUser.uid,
          displayName: currentUser.displayName || "Anonymous",
          text,
          timestamp: Date.now(),
        });
        // Also update comment count
        const postRef = ref(db, "posts/" + postId);
        await runTransaction(postRef, (post) => {
          if (post) {
            post.commentsCount = (post.commentsCount || 0) + 1;
            if (!post.comments) post.comments = {};
            post.comments[commentId] = {
              userId: currentUser.uid,
              displayName: currentUser.displayName || "Anonymous",
              text,
              timestamp: Date.now(),
            };
          }
          return post;
        });
      } catch (e) {
        alert("Error adding comment: " + e.message);
      }
    }

    // Donation via Skrill using form POST
    window.donateToPost = function (postId, postUserId, amount) {
      if (!currentUser) return alert("Please login to donate.");
      if (!amount) return;

      skrillAmount.value = amount;
      skrillDetail.value = `Post ID: ${postId}`.substring(0, 50);
      skrillTransactionId.value = `${postId}-${Date.now()}`;
      skrillForm.submit();

      // Reset dropdown after submit
      const selects = document.querySelectorAll("select");
      selects.forEach((sel) => (sel.value = ""));
    };

    // Search input event listener
    searchInput.addEventListener("input", renderPosts);
  </script>
</body>
</html>
