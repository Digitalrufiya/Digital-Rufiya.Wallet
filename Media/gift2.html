<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Timeline â€” Spread Kindness & Truth</title>
  <!-- (Your existing styles remain unchanged) -->
  <style>
    /* All your CSS remains unchanged here */
  </style>
</head>
<body>
  <!-- Header and Navigation -->
  <header>
    <!-- Your existing navbar code -->
  </header>

  <!-- Search Bar -->
  <div id="searchBar">
    <input
      type="search"
      id="searchInput"
      placeholder="Search posts..."
      aria-label="Search posts"
    />
  </div>

  <!-- Auth Buttons -->
  <button id="loginBtn" style="display: block; max-width: 700px; margin: 10px auto;">
    Sign in with Google
  </button>
  <button
    id="logoutBtn"
    style="display:none; max-width: 700px; margin: 10px auto;"
  >
    Logout
  </button>

  <!-- Upload Form -->
  <form
    id="uploadForm"
    style="display:none; max-width:700px; margin:20px auto;"
    enctype="multipart/form-data"
  >
    <input type="file" id="mediaFile" accept="image/*,video/*" required />
    <textarea
      id="caption"
      placeholder="Write your caption..."
      required
      minlength="4"
      style="width:100%; margin-top:10px; padding:8px; font-size:1em;"
    ></textarea>
    <button type="submit" style="margin-top:10px; padding: 10px 20px; font-size:1em;">
      Post
    </button>
  </form>

  <!-- Post Container -->
  <div id="postContainer" aria-live="polite"></div>

  <!-- Firebase and App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      get,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import {
      getAuth,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.appspot.com",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:dc999df2c0c37241ff3f40",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const uploadForm = document.getElementById("uploadForm");
    const mediaFile = document.getElementById("mediaFile");
    const captionInput = document.getElementById("caption");
    const postContainer = document.getElementById("postContainer");
    const searchInput = document.getElementById("searchInput");

    let currentUser = null;
    let allPosts = [];

    document.getElementById("menuToggle")?.addEventListener("click", () => {
      document.getElementById("primaryNav")?.classList.toggle("open");
    });

    const escapeHTML = (str) =>
      str.replace(/[&<>"]/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
      }[c]));

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      uploadForm.style.display = user ? "block" : "none";
      loginBtn.style.display = user ? "none" : "block";
      logoutBtn.style.display = user ? "block" : "none";
      renderPosts();
    });

    loginBtn.onclick = () => signInWithPopup(auth, provider).catch((e) => alert("Login failed: " + e.message));
    logoutBtn.onclick = () => signOut(auth).catch((e) => alert("Logout failed: " + e.message));

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Please login.");
      if (!mediaFile.files.length) return alert("Select a file.");
      if (captionInput.value.trim().length < 4)
        return alert("Caption too short.");

      uploadForm.querySelector("button").disabled = true;
      const file = mediaFile.files[0];
      const fd = new FormData();
      fd.append("file", file);

      try {
        const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.your_jwt_token_here";
        const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
          method: "POST",
          headers: { Authorization: pinataJWT },
          body: fd,
        });
        if (!res.ok) throw new Error("Pinata upload failed: " + res.statusText);
        const { IpfsHash } = await res.json();

        const newPostRef = push(ref(db, "posts"));
        await set(newPostRef, {
          userId: currentUser.uid,
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          caption: captionInput.value.trim(),
          ipfsHash: IpfsHash,
          mediaType: file.type.startsWith("video") ? "video" : "image",
          mediaMimeType: file.type,
          timestamp: Date.now(),
          likesCount: 0,
          commentsCount: 0,
          boostsCount: 0,
          boostedBy: {},
          likesBy: {},
        });

        captionInput.value = "";
        mediaFile.value = "";
        alert("Posted successfully!");
      } catch (err) {
        alert("Upload failed: " + err.message);
      } finally {
        uploadForm.querySelector("button").disabled = false;
      }
    });

    const postsRef = ref(db, "posts");
    onValue(postsRef, (snapshot) => {
      const posts = snapshot.val() || {};
      allPosts = Object.entries(posts).map(([id, post]) => ({ id, ...post }));
      allPosts.sort((a, b) => b.timestamp - a.timestamp);
      renderPosts();
    });

    function renderPosts() {
      const filter = searchInput.value.trim().toLowerCase();
      postContainer.innerHTML = "";
      for (const post of allPosts) {
        if (!post.caption.toLowerCase().includes(filter)) continue;

        const url1 = "https://gateway.pinata.cloud/ipfs/" + post.ipfsHash;
        const isBoosted = currentUser && post.boostedBy && post.boostedBy[currentUser.uid];
        const isLiked = currentUser && post.likesBy && post.likesBy[currentUser.uid];

        const dateStr = new Date(post.timestamp).toLocaleString();
        const mediaHTML = post.mediaType === "video"
          ? `<video src="${url1}" controls playsinline preload="metadata"></video>`
          : `<img src="${url1}" alt="Post media" loading="lazy" />`;

        const card = document.createElement("article");
        card.className = "post-item";
        card.innerHTML = `
          <header class="post-owner">
            <img src="${post.photoURL || "https://via.placeholder.com/40"}" alt="User avatar" class="avatar" />
            <div>
              <div>${escapeHTML(post.displayName || "Anonymous")}</div>
              <time class="post-time">${dateStr}</time>
            </div>
          </header>
          <div class="post-caption">${escapeHTML(post.caption)}</div>
          <div class="post-media">${mediaHTML}</div>
          <div class="post-actions">
            <button class="${isLiked ? "liked" : ""}" onclick="likePost('${post.id}')">ğŸ‘ Like (${post.likesCount || 0})</button>
            <button onclick="commentOnPost('${post.id}')">ğŸ’¬ Comment (${post.commentsCount || 0})</button>
            <button class="${isBoosted ? "boosted" : ""}" onclick="boostPost('${post.id}')">ğŸš€ Boost (${post.boostsCount || 0})</button>
            <button onclick="repost('${post.id}')">ğŸ”„ Repost</button>
            <select onchange="donateToPost('${post.id}', '${post.userId}', this.value)">
              <option value="">Donate ğŸ’–</option>
              <option value="1">ğŸŒ¹ $1</option>
              <option value="10">ğŸ¦ $10</option>
              <option value="20">ğŸ™ $20</option>
              <option value="30">âœ¨ $30</option>
            </select>
          </div>
        `;
        postContainer.appendChild(card);
      }
    }

    searchInput.addEventListener("input", () => renderPosts());

    window.likePost = async function (postId) {
      if (!currentUser) return alert("Please login to like posts.");
      const likeRef = ref(db, `posts/${postId}/likesBy/${currentUser.uid}`);
      const postLikesCountRef = ref(db, `posts/${postId}/likesCount`);
      const snapshot = await get(likeRef);
      if (snapshot.exists()) {
        await set(likeRef, null);
        await runTransaction(postLikesCountRef, (count) => (count || 1) - 1);
      } else {
        await set(likeRef, true);
        await runTransaction(postLikesCountRef, (count) => (count || 0) + 1);
      }
    };

    window.boostPost = async function (postId) {
      if (!currentUser) return alert("Please login to boost posts.");
      const boostRef = ref(db, `posts/${postId}/boostedBy/${currentUser.uid}`);
      const boostsCountRef = ref(db, `posts/${postId}/boostsCount`);
      const snapshot = await get(boostRef);
      if (snapshot.exists()) {
        await set(boostRef, null);
        await runTransaction(boostsCountRef, (count) => (count || 1) - 1);
      } else {
        await set(boostRef, true);
        await runTransaction(boostsCountRef, (count) => (count || 0) + 1);
      }
    };

    window.repost = function (postId) {
      alert("Repost feature coming soon!");
    };

    window.commentOnPost = function (postId) {
      alert("Comments are not implemented yet.");
    };

    // âœ… Skrill Payment Integration
    window.donateToPost = function (postId, postUserId, amount) {
      if (!currentUser) return alert("Please login to donate.");
      if (!amount) return;
      const skrillUrl = `https://pay.skrill.com/?pay_to_email=digitalrufiyacoin@gmail.com&amount=${amount}&currency=USD&detail1_description=Post%20ID&detail1_text=${postId}`;
      window.open(skrillUrl, "_blank");
      const selects = document.querySelectorAll("select");
      selects.forEach((sel) => (sel.value = ""));
    };
  </script>
</body>
</html>
