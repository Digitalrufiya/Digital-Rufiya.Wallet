<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #222;
    }
    header {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .navbar-left img {
      height: 40px;
      width: 40px;
      border-radius: 4px;
      background: white;
      padding: 2px;
    }
    .navbar-left h1 {
      margin: 0;
      font-size: 1.4em;
      font-weight: 700;
    }
    #menuToggle {
      background: transparent;
      border: none;
      cursor: pointer;
      width: 30px;
      height: 25px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0;
    }
    #menuToggle span {
      display: block;
      height: 3.5px;
      background: white;
      border-radius: 3px;
    }
    #primaryNav {
      width: 100%;
      display: none;
      flex-direction: column;
      background: #0069d9;
      margin-top: 10px;
      border-radius: 4px;
    }
    #primaryNav.open {
      display: flex;
    }
    #primaryNav a {
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    #primaryNav a:first-child {
      border-top: none;
    }
    #primaryNav a:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    @media (min-width: 768px) {
      #menuToggle {
        display: none;
      }
      #primaryNav {
        display: flex !important;
        flex-direction: row;
        width: auto;
        background: transparent;
        margin-top: 0;
        border-radius: 0;
      }
      #primaryNav a {
        border: none;
        padding: 10px 15px;
        color: white;
      }
      #primaryNav a:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.1);
    }
    #postContainer {
      max-width: 700px;
      margin: 20px auto;
      padding: 0 15px;
    }
    .post-item {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      background: #fafafa;
    }
    .post-owner {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
    }
    .post-owner div {
      line-height: 1.1;
    }
    .post-time {
      font-size: 0.85em;
      color: #555;
      margin-top: 4px;
    }
    .post-caption {
      margin-top: 10px;
      font-size: 1em;
      white-space: pre-wrap;
    }
    video,
    img {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 10px;
      background: black;
      display: block;
    }
    #searchBar {
      max-width: 700px;
      margin: 10px auto 20px auto;
      padding: 0 15px;
    }
    #searchInput {
      width: 100%;
      padding: 8px 12px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .post-actions button,
    .post-actions select {
      cursor: pointer;
      border: none;
      background: #007bff;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 0.9em;
      transition: background-color 0.3s;
      margin-right: 8px;
    }
    .post-actions button:hover,
    .post-actions select:hover {
      background: #0056b3;
    }
    .post-actions button.liked {
      background: #28a745 !important;
      color: #fff !important;
    }
    .post-actions button.boosted {
      background-color: gold !important;
      color: #000 !important;
    }
    .post-actions select {
      color: #000;
      background: white;
      border: 1px solid #007bff;
      padding: 5px 10px;
      min-width: 110px;
    }
    .post-actions select option {
      color: #000;
    }
    .comments-container {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
    }
    .comment {
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
      font-size: 0.9em;
    }
    .comment .avatar {
      width: 28px;
      height: 28px;
      margin-right: 8px;
    }
    .comment .comment-body {
      background: #f1f1f1;
      padding: 6px 10px;
      border-radius: 5px;
    }
    .comment-form {
      margin-top: 10px;
      display: flex;
      gap: 6px;
    }
    .comment-form input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9em;
    }
    .comment-form button {
      padding: 6px 10px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    set,
    onValue,
    get,
    runTransaction,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import {
    getAuth,
    signInWithPopup,
    signOut,
    GoogleAuthProvider,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0c37241ff3f40",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const uploadForm = document.getElementById("uploadForm");
  const mediaFile = document.getElementById("mediaFile");
  const captionInput = document.getElementById("caption");
  const postContainer = document.getElementById("postContainer");
  const searchInput = document.getElementById("searchInput");

  let currentUser = null;
  let allPosts = [];

  document.getElementById("menuToggle").addEventListener("click", () => {
    document.getElementById("primaryNav").classList.toggle("open");
  });

  const escapeHTML = (str) =>
    str.replace(/[&<>"]/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c]));

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    uploadForm.style.display = user ? "block" : "none";
    loginBtn.style.display = user ? "none" : "block";
    logoutBtn.style.display = user ? "block" : "none";
    renderPosts();
  });

  loginBtn.onclick = () => signInWithPopup(auth, provider).catch((e) => alert("Login failed: " + e.message));
  logoutBtn.onclick = () => signOut(auth).catch((e) => alert("Logout failed: " + e.message));

  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUser) return alert("Please login.");
    if (!mediaFile.files.length) return alert("Select a file.");
    if (captionInput.value.trim().length < 4) return alert("Caption too short.");

    uploadForm.querySelector("button").disabled = true;
    const file = mediaFile.files[0];
    const fd = new FormData();
    fd.append("file", file);

    try {
      const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.your_jwt_token_here";

      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        headers: { Authorization: pinataJWT },
        body: fd,
      });
      if (!res.ok) throw new Error("Pinata upload failed: " + res.statusText);
      const { IpfsHash } = await res.json();

      const newPostRef = push(ref(db, "posts"));
      await set(newPostRef, {
        userId: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        caption: captionInput.value.trim(),
        ipfsHash: IpfsHash,
        mediaType: file.type.startsWith("video") ? "video" : "image",
        mediaMimeType: file.type,
        timestamp: Date.now(),
        likesCount: 0,
        commentsCount: 0,
        boostsCount: 0,
        boostedBy: {},
        likesBy: {},
      });

      captionInput.value = "";
      mediaFile.value = "";
      alert("Posted successfully!");
    } catch (err) {
      alert("Upload failed: " + err.message);
    } finally {
      uploadForm.querySelector("button").disabled = false;
    }
  });

  const postsRef = ref(db, "posts");
  onValue(postsRef, (snapshot) => {
    const posts = snapshot.val() || {};
    allPosts = Object.entries(posts).map(([id, post]) => ({ id, ...post }));
    allPosts.sort((a, b) => b.timestamp - a.timestamp);
    renderPosts();
  });

  function renderPosts() {
    const filter = searchInput.value.trim().toLowerCase();
    postContainer.innerHTML = "";
    for (const post of allPosts) {
      if (!post.caption.toLowerCase().includes(filter)) continue;

      const url1 = "https://gateway.pinata.cloud/ipfs/" + post.ipfsHash;
      const isBoosted = currentUser && post.boostedBy && post.boostedBy[currentUser.uid];
      const isLiked = currentUser && post.likesBy && post.likesBy[currentUser.uid];
      const dateStr = new Date(post.timestamp).toLocaleString();

      const mediaHTML = post.mediaType === "video"
        ? `<video src="${url1}" controls playsinline preload="metadata"></video>`
        : `<img src="${url1}" alt="Post media" loading="lazy" />`;

      const card = document.createElement("article");
      card.className = "post-item";
      card.innerHTML = `
        <header class="post-owner">
          <img src="${post.photoURL || "https://via.placeholder.com/40"}" class="avatar" />
          <div>
            <div>${escapeHTML(post.displayName || "Anonymous")}</div>
            <time class="post-time">${dateStr}</time>
          </div>
        </header>
        <div class="post-caption">${escapeHTML(post.caption)}</div>
        <div class="post-media">${mediaHTML}</div>
        <div class="post-actions">
          <button class="${isLiked ? "liked" : ""}" onclick="likePost('${post.id}')">👍 Like (${post.likesCount || 0})</button>
          <button onclick="commentOnPost('${post.id}')">💬 Comment (${post.commentsCount || 0})</button>
          <button class="${isBoosted ? "boosted" : ""}" onclick="boostPost('${post.id}')">🚀 Boost (${post.boostsCount || 0})</button>
          <button onclick="repost('${post.id}')">🔄 Repost</button>
          <select onchange="donateToPost('${post.id}', '${post.userId}', this.value)">
            <option value="">Donate 💖</option>
            <option value="1">🌹 $1</option>
            <option value="10">🦁 $10</option>
            <option value="20">🙏 $20</option>
            <option value="30">✨ $30</option>
          </select>
        </div>
        <div class="comments-container" id="comments-${post.id}"></div>
        ${currentUser ? `
          <form class="comment-form" onsubmit="return submitComment(event, '${post.id}')">
            <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." required minlength="1" />
            <button type="submit">Post</button>
          </form>` : ""}
      `;
      postContainer.appendChild(card);

      loadComments(post.id);
    }
  }

  searchInput.addEventListener("input", () => renderPosts());

  window.likePost = async function (postId) {
    if (!currentUser) return alert("Please login to like posts.");
    const likeRef = ref(db, `posts/${postId}/likesBy/${currentUser.uid}`);
    const countRef = ref(db, `posts/${postId}/likesCount`);
    const snapshot = await get(likeRef);
    if (snapshot.exists()) {
      await set(likeRef, null);
      await runTransaction(countRef, (c) => (c || 1) - 1);
    } else {
      await set(likeRef, true);
      await runTransaction(countRef, (c) => (c || 0) + 1);
    }
  };

  window.boostPost = async function (postId) {
    if (!currentUser) return alert("Please login to boost posts.");
    const boostRef = ref(db, `posts/${postId}/boostedBy/${currentUser.uid}`);
    const countRef = ref(db, `posts/${postId}/boostsCount`);
    const snapshot = await get(boostRef);
    if (snapshot.exists()) {
      await set(boostRef, null);
      await runTransaction(countRef, (c) => (c || 1) - 1);
    } else {
      await set(boostRef, true);
      await runTransaction(countRef, (c) => (c || 0) + 1);
    }
  };

  window.repost = function (postId) {
    alert("Repost feature coming soon inshaAllah!");
  };

  window.commentOnPost = function (postId) {
    const input = document.getElementById("comment-input-" + postId);
    if (input) input.focus();
  };

  window.submitComment = async function (e, postId) {
    e.preventDefault();
    const input = document.getElementById("comment-input-" + postId);
    const comment = input.value.trim();
    if (!comment) return;

    const newRef = push(ref(db, `comments/${postId}`));
    await set(newRef, {
      userId: currentUser.uid,
      name: currentUser.displayName || "User",
      photo: currentUser.photoURL || "",
      text: comment,
      timestamp: Date.now(),
    });
    input.value = "";
  };

  function loadComments(postId) {
    const container = document.getElementById("comments-" + postId);
    const refPath = ref(db, `comments/${postId}`);
    onValue(refPath, (snapshot) => {
      const comments = snapshot.val() || {};
      const entries = Object.values(comments).sort((a, b) => a.timestamp - b.timestamp);
      container.innerHTML = entries.map(c => `
        <div class="comment">
          <img src="${c.photo || 'https://via.placeholder.com/28'}" class="avatar" />
          <div class="comment-body"><strong>${escapeHTML(c.name)}</strong><br>${escapeHTML(c.text)}</div>
        </div>
      `).join("");
    });
  }

  window.donateToPost = function (postId, userId, amount) {
    if (!currentUser) return alert("Please login to donate.");
    if (!amount) return;

    const skrillEmail = "digitalrufiyacoin@gmail.com";
    const message = `
You selected to donate $${amount} 💖

📧 Please send manually using Skrill:
Email: ${skrillEmail}
Amount: $${amount}

May Allah reward your generosity. 🤲
    `;
    alert(message);

    const selects = document.querySelectorAll("select");
    selects.forEach((sel) => (sel.value = ""));
  };
</script>
</body>
</html>
