<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>
  <style>
    /* Reset & base */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #fff;
      color: #222;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      background: #007bff;
      color: white;
      padding: 12px 24px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-left img {
      height: 44px;
      width: 44px;
      border-radius: 6px;
      background: white;
      padding: 3px;
      box-shadow: 0 0 5px rgba(255 255 255 / 0.6);
      object-fit: contain;
    }
    .navbar-left h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      user-select: none;
    }
    #menuToggle {
      background: transparent;
      border: none;
      cursor: pointer;
      width: 32px;
      height: 26px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 0;
      flex-shrink: 0;
    }
    #menuToggle span {
      display: block;
      height: 4px;
      background: white;
      border-radius: 3px;
      transition: background-color 0.3s;
    }
    #menuToggle:hover span {
      background: #d0e6ff;
    }
    #primaryNav {
      width: 100%;
      display: none;
      flex-direction: column;
      background: #0069d9;
      margin-top: 14px;
      border-radius: 6px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      user-select: none;
    }
    #primaryNav.open {
      display: flex;
    }
    #primaryNav a {
      padding: 14px 22px;
      color: white;
      text-decoration: none;
      font-weight: 600;
      border-top: 1px solid rgba(255, 255, 255, 0.25);
      transition: background-color 0.3s;
      font-size: 1.1rem;
    }
    #primaryNav a:first-child {
      border-top: none;
    }
    #primaryNav a:hover,
    #primaryNav a:focus {
      background: rgba(255, 255, 255, 0.3);
      outline: none;
    }
    @media (min-width: 768px) {
      #menuToggle {
        display: none;
      }
      #primaryNav {
        display: flex !important;
        flex-direction: row;
        width: auto;
        background: transparent;
        margin-top: 0;
        border-radius: 0;
        box-shadow: none;
      }
      #primaryNav a {
        border: none;
        padding: 10px 18px;
        color: white;
        font-size: 1rem;
      }
      #primaryNav a:hover,
      #primaryNav a:focus {
        background: rgba(255, 255, 255, 0.25);
      }
    }
    #loginBtn, #logoutBtn {
      background: #0056b3;
      color: white;
      border: none;
      padding: 8px 18px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 12px;
      transition: background-color 0.3s;
      user-select: none;
    }
    #loginBtn:hover, #logoutBtn:hover {
      background: #003d80;
    }
    #searchBar {
      max-width: 700px;
      margin: 18px auto 26px auto;
      padding: 0 20px;
    }
    #searchInput {
      width: 100%;
      padding: 12px 16px;
      font-size: 1.1rem;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      transition: border-color 0.3s;
      outline-offset: 2px;
    }
    #searchInput:focus {
      border-color: #007bff;
      outline: none;
    }
    #uploadForm {
      max-width: 700px;
      margin: 0 auto 28px auto;
      padding: 0 20px;
      display: none;
      background: #f5f8ff;
      border: 1px solid #cbdcff;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0, 123, 255, 0.1);
      user-select: none;
    }
    #uploadForm > * {
      display: block;
      width: 100%;
      margin: 10px 0;
    }
    #mediaFile {
      border-radius: 8px;
      padding: 6px;
      cursor: pointer;
      font-size: 1rem;
      color: #444;
    }
    #caption {
      padding: 12px 14px;
      font-size: 1.15rem;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      resize: vertical;
      min-height: 54px;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    #caption:focus {
      border-color: #007bff;
      outline: none;
    }
    #uploadForm button {
      background: #007bff;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    #uploadForm button:disabled {
      background: #a0c8ff;
      cursor: default;
    }
    #uploadForm button:hover:not(:disabled) {
      background: #0056b3;
    }
    #postContainer {
      max-width: 700px;
      margin: 0 auto 40px auto;
      padding: 0 20px;
    }
    .post-item {
      border: 1.5px solid #ddd;
      border-radius: 10px;
      padding: 20px 22px;
      margin-bottom: 28px;
      background: #fafafa;
      box-shadow: 0 1px 8px rgb(0 0 0 / 0.04);
      transition: box-shadow 0.3s ease;
    }
    .post-item:hover {
      box-shadow: 0 3px 15px rgba(0, 123, 255, 0.15);
    }
    .post-owner {
      display: flex;
      align-items: center;
      gap: 14px;
      font-weight: 700;
      user-select: none;
    }
    .post-owner div {
      line-height: 1.15;
    }
    .post-time {
      font-size: 0.87rem;
      color: #666;
      margin-top: 6px;
      user-select: none;
    }
    .post-caption {
      margin-top: 14px;
      font-size: 1.1rem;
      white-space: pre-wrap;
      word-break: break-word;
      color: #222;
      line-height: 1.5;
      min-height: 60px;
    }
    .post-media {
      margin-top: 16px;
    }
    video,
    img {
      max-width: 100%;
      border-radius: 12px;
      background: #000;
      display: block;
      box-shadow: 0 1px 12px rgb(0 0 0 / 0.15);
      cursor: pointer;
      transition: transform 0.25s ease;
      user-select: none;
    }
    video:hover,
    img:hover {
      transform: scale(1.02);
    }
    .post-actions {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
      user-select: none;
    }
    .post-actions button,
    .post-actions select {
      cursor: pointer;
      border: none;
      background: #007bff;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s, color 0.3s;
      min-width: 90px;
      text-align: center;
    }
    .post-actions button:hover,
    .post-actions select:hover {
      background: #0056b3;
      color: #fff;
    }
    .post-actions button.liked {
      background: #28a745 !important;
      color: #fff !important;
      box-shadow: 0 0 8px #28a745aa;
    }
    .post-actions button.boosted {
      background-color: gold !important;
      color: #000 !important;
      box-shadow: 0 0 8px #ffd700cc;
    }
    .post-actions select {
      color: #000;
      background: white;
      border: 2px solid #007bff;
      padding: 7px 12px;
      min-width: 120px;
    }
    .post-actions select option {
      color: #000;
    }
    .comments-container {
      margin-top: 18px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
      max-height: 240px;
      overflow-y: auto;
      user-select: none;
    }
    .comment {
      display: flex;
      align-items: flex-start;
      margin-bottom: 12px;
      font-size: 0.93rem;
      line-height: 1.25;
    }
    .comment .avatar {
      width: 30px;
      height: 30px;
      margin-right: 12px;
      border: 1px solid #ccc;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .comment .comment-body {
      background: #f1f1f1;
      padding: 8px 14px;
      border-radius: 8px;
      flex: 1;
      word-break: break-word;
      color: #222;
    }
    .comment .comment-body strong {
      display: block;
      margin-bottom: 4px;
      font-weight: 700;
      color: #007bff;
      user-select: text;
    }
    .comment-form {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      user-select: none;
    }
    .comment-form input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1.5px solid #ccc;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    .comment-form input:focus {
      border-color: #007bff;
      outline: none;
    }
    .comment-form button {
      padding: 10px 16px;
      font-size: 1rem;
      font-weight: 600;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
      min-width: 100px;
    }
    .comment-form button:hover {
      background: #0056b3;
    }
    /* Scrollbar for comments container */
    .comments-container::-webkit-scrollbar {
      width: 6px;
    }
    .comments-container::-webkit-scrollbar-thumb {
      background: #007bffaa;
      border-radius: 10px;
    }
    /* Responsive adjustments */
    @media (max-width: 480px) {
      #uploadForm, #searchBar, #postContainer {
        padding-left: 12px;
        padding-right: 12px;
      }
      .post-actions button,
      .post-actions select {
        flex: 1 1 45%;
        min-width: unset;
      }
      .comment-form button {
        min-width: unset;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="navbar-left">
    <img src="https://drfmedia.com/favicon.ico" alt="DRFMedia Logo" />
    <h1>DRFMedia Timeline</h1>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <nav id="primaryNav">
    <a href="#">Home</a>
    <a href="#">About</a>
    <a href="#">Contact</a>
  </nav>
  <div>
    <button id="loginBtn">Login with Google</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</header>

<div id="searchBar">
  <input type="text" id="searchInput" placeholder="Search posts..." />
</div>

<form id="uploadForm" autocomplete="off" novalidate>
  <input type="file" id="mediaFile" accept="image/*,video/*" required />
  <textarea id="caption" placeholder="Write a caption..." minlength="4" required rows="3"></textarea>
  <button type="submit">Post</button>
</form>

<main id="postContainer" aria-live="polite"></main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    set,
    onValue,
    get,
    runTransaction,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import {
    getAuth,
    signInWithPopup,
    signOut,
    GoogleAuthProvider,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0c37241ff3f40",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const uploadForm = document.getElementById("uploadForm");
  const mediaFile = document.getElementById("mediaFile");
  const captionInput = document.getElementById("caption");
  const postContainer = document.getElementById("postContainer");
  const searchInput = document.getElementById("searchInput");

  let currentUser = null;
  let allPosts = [];

  // Menu toggle safely
  const menuToggleBtn = document.getElementById("menuToggle");
  if (menuToggleBtn) {
    menuToggleBtn.addEventListener("click", () => {
      const nav = document.getElementById("primaryNav");
      if (nav) nav.classList.toggle("open");
    });
  }

  const escapeHTML = (str) =>
    String(str).replace(/[&<>"]/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c]));

  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    uploadForm.style.display = user ? "block" : "none";
    loginBtn.style.display = user ? "none" : "inline-block";
    logoutBtn.style.display = user ? "inline-block" : "none";
    renderPosts();
  });

  loginBtn.onclick = () => signInWithPopup(auth, provider).catch((e) => alert("Login failed: " + e.message));
  logoutBtn.onclick = () => signOut(auth).catch((e) => alert("Logout failed: " + e.message));

  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUser) return alert("Please login.");
    if (!mediaFile.files.length) return alert("Select a file.");
    if (captionInput.value.trim().length < 4) return alert("Caption too short.");

    uploadForm.querySelector("button").disabled = true;
    const file = mediaFile.files[0];
    const fd = new FormData();
    fd.append("file", file);

    try {
      // Replace your JWT token here
      const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        headers: { Authorization: pinataJWT },
        body: fd,
      });
      if (!res.ok) throw new Error("Pinata upload failed: " + res.statusText);
      const { IpfsHash } = await res.json();

      const newPostRef = push(ref(db, "posts"));
      await set(newPostRef, {
        userId: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        caption: captionInput.value.trim(),
        ipfsHash: IpfsHash,
        mediaType: file.type.startsWith("video") ? "video" : "image",
        mediaMimeType: file.type,
        timestamp: Date.now(),
        likesCount: 0,
        commentsCount: 0,
        boostsCount: 0,
        boostedBy: {},
        likesBy: {},
      });

      captionInput.value = "";
      mediaFile.value = "";
      alert("Posted successfully!");
    } catch (err) {
      alert("Upload failed: " + err.message);
    } finally {
      uploadForm.querySelector("button").disabled = false;
    }
  });

  const postsRef = ref(db, "posts");
  onValue(postsRef, (snapshot) => {
    const posts = snapshot.val() || {};
    allPosts = Object.entries(posts).map(([id, post]) => ({ id, ...post }));
    allPosts.sort((a, b) => b.timestamp - a.timestamp);
    renderPosts();
  });

  function renderPosts() {
    const filter = searchInput.value.trim().toLowerCase();
    postContainer.innerHTML = "";
    for (const post of allPosts) {
      if (!post.caption.toLowerCase().includes(filter)) continue;

      const url1 = "https://gateway.pinata.cloud/ipfs/" + post.ipfsHash;
      const isBoosted = currentUser && post.boostedBy && post.boostedBy[currentUser.uid];
      const isLiked = currentUser && post.likesBy && post.likesBy[currentUser.uid];
      const dateStr = new Date(post.timestamp).toLocaleString();

      const mediaHTML = post.mediaType === "video"
        ? `<video src="${url1}" controls playsinline preload="metadata" aria-label="Video post"></video>`
        : `<img src="${url1}" alt="Post media" loading="lazy" />`;

      const card = document.createElement("article");
      card.className = "post-item";
      card.innerHTML = `
        <header class="post-owner">
          <img src="${post.photoURL || "https://via.placeholder.com/40"}" class="avatar" alt="${escapeHTML(post.displayName)}'s avatar" />
          <div>
            <div>${escapeHTML(post.displayName || "Anonymous")}</div>
            <time class="post-time" datetime="${new Date(post.timestamp).toISOString()}">${dateStr}</time>
          </div>
        </header>
        <div class="post-caption">${escapeHTML(post.caption)}</div>
        <div class="post-media">${mediaHTML}</div>
        <div class="post-actions">
          <button class="${isLiked ? "liked" : ""}" onclick="likePost('${post.id}')" aria-pressed="${isLiked ? "true" : "false"}" aria-label="Like post">${isLiked ? "👍 Liked" : "👍 Like"} (${post.likesCount || 0})</button>
          <button onclick="commentOnPost('${post.id}')" aria-label="Comment on post">💬 Comment (${post.commentsCount || 0})</button>
          <button class="${isBoosted ? "boosted" : ""}" onclick="boostPost('${post.id}')" aria-pressed="${isBoosted ? "true" : "false"}" aria-label="Boost post">${isBoosted ? "🚀 Boosted" : "🚀 Boost"} (${post.boostsCount || 0})</button>
          <button onclick="repost('${post.id}')" aria-label="Repost post">🔄 Repost</button>
          <select onchange="donateToPost('${post.id}', '${post.userId}', this.value)" aria-label="Donate to post">
            <option value="">Donate 💖</option>
            <option value="1">🌹 $1</option>
            <option value="10">🦁 $10</option>
            <option value="20">🙏 $20</option>
            <option value="30">✨ $30</option>
          </select>
        </div>
        <div class="comments-container" id="comments-${post.id}" aria-live="polite" aria-atomic="true"></div>
        ${currentUser ? `
          <form class="comment-form" onsubmit="return submitComment(event, '${post.id}')" aria-label="Add comment form">
            <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." required minlength="1" aria-required="true" aria-describedby="commentHelp-${post.id}" />
            <button type="submit">Post</button>
            <small id="commentHelp-${post.id}" style="display:none;">Write your comment here</small>
          </form>` : ""}
      `;
      postContainer.appendChild(card);

      loadComments(post.id);
    }
  }

  searchInput.addEventListener("input", () => renderPosts());

  window.likePost = async function (postId) {
    if (!currentUser) return alert("Please login to like posts.");
    const likeRef = ref(db, `posts/${postId}/likesBy/${currentUser.uid}`);
    const countRef = ref(db, `posts/${postId}/likesCount`);
    const snapshot = await get(likeRef);
    if (snapshot.exists()) {
      await set(likeRef, null);
      await runTransaction(countRef, (c) => (c || 1) - 1);
    } else {
      await set(likeRef, true);
      await runTransaction(countRef, (c) => (c || 0) + 1);
    }
  };

  window.boostPost = async function (postId) {
    if (!currentUser) return alert("Please login to boost posts.");
    const boostRef = ref(db, `posts/${postId}/boostedBy/${currentUser.uid}`);
    const countRef = ref(db, `posts/${postId}/boostsCount`);
    const snapshot = await get(boostRef);
    if (snapshot.exists()) {
      await set(boostRef, null);
      await runTransaction(countRef, (c) => (c || 1) - 1);
    } else {
      await set(boostRef, true);
      await runTransaction(countRef, (c) => (c || 0) + 1);
    }
  };

  // Repost with alert placeholder
  window.repost = function (postId) {
    alert("Repost feature coming soon inshaAllah!");
  };

  window.commentOnPost = function (postId) {
    const input = document.getElementById("comment-input-" + postId);
    if (input) input.focus();
  };

  window.submitComment = async function (e, postId) {
    e.preventDefault();
    const input = document.getElementById("comment-input-" + postId);
    const comment = input.value.trim();
    if (!comment) return;

    const newRef = push(ref(db, `comments/${postId}`));
    await set(newRef, {
      userId: currentUser.uid,
      name: currentUser.displayName || "User",
      photo: currentUser.photoURL || "",
      text: comment,
      timestamp: Date.now(),
    });
    input.value = "";
  };

  function loadComments(postId) {
    const container = document.getElementById("comments-" + postId);
    const refPath = ref(db, `comments/${postId}`);
    onValue(refPath, (snapshot) => {
      const comments = snapshot.val() || {};
      const entries = Object.values(comments).sort((a, b) => a.timestamp - b.timestamp);
      container.innerHTML = entries.map(c => `
        <div class="comment">
          <img src="${c.photo || 'https://via.placeholder.com/28'}" class="avatar" alt="${escapeHTML(c.name)}'s avatar" />
          <div class="comment-body"><strong>${escapeHTML(c.name)}</strong><br>${escapeHTML(c.text)}</div>
        </div>
      `).join("");
    });
  }

  window.donateToPost = function (postId, userId, amount) {
    if (!currentUser) return alert("Please login to donate.");
    if (!amount) return;

    const skrillEmail = "digitalrufiyacoin@gmail.com";
    const message = `
You selected to donate $${amount} 💖

📧 Please send manually using Skrill:
Email: ${skrillEmail}
Amount: $${amount}

May Allah reward your generosity. 🤲
    `;
    alert(message);

    // Reset all selects to default
    document.querySelectorAll("select").forEach((sel) => (sel.value = ""));
  };
</script>

</body>
</html>
