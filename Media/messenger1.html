<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMessenger with Link Preview</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
    nav { background: #0066cc; color: white; padding: 15px; text-align: center; font-weight: bold; }
    #container { flex: 1; display: flex; overflow: hidden; }
    #usersList { width: 280px; background: white; border-right: 1px solid #ccc; overflow-y: auto; }
    #usersList h2 { margin: 0; padding: 15px; background: #0066cc; color: white; }
    .user-item { display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    .user-item:hover, .user-item.active { background: #e6f2ff; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #ccc; }
    .user-name { font-weight: 600; flex: 1; }
    #chatArea { flex: 1; display: flex; flex-direction: column; background: white; }
    #chatHeader { padding: 15px; background: #f7f7f7; border-bottom: 1px solid #ccc; font-weight: bold; }
    #messagesContainer { flex: 1; padding: 10px; overflow-y: auto; background: #f0f0f0; }
    .message { max-width: 75%; margin: 8px 0; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; }
    .sent { background: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .received { background: #e4e6eb; color: #222; align-self: flex-start; border-bottom-left-radius: 4px; }
    .preview { margin-top: 8px; padding: 8px; background: white; border: 1px solid #ccc; border-radius: 8px; }
    .preview img { max-width: 100%; border-radius: 4px; }
    .preview-title { font-weight: bold; margin-bottom: 4px; }
    .preview-url { font-size: 0.85rem; color: #555; }
    #inputArea { display: flex; padding: 10px; border-top: 1px solid #ccc; background: #f7f7f7; }
    #inputMessage { flex: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; resize: none; height: 42px; }
    #sendBtn { margin-left: 10px; background: #0066cc; color: white; border: none; padding: 0 20px; border-radius: 20px; cursor: pointer; }
    #sendBtn:disabled { background: #aaa; cursor: not-allowed; }
  </style>
</head>
<body>
  <nav>DRFMessenger</nav>
  <div id="container">
    <div id="usersList">
      <h2>Users</h2>
    </div>
    <div id="chatArea">
      <div id="chatHeader">Select a user to chat</div>
      <div id="messagesContainer"></div>
      <div id="inputArea">
        <textarea id="inputMessage" placeholder="Type a message..."></textarea>
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.appspot.com",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const usersListEl = document.getElementById('usersList');
    const chatHeaderEl = document.getElementById('chatHeader');
    const messagesContainerEl = document.getElementById('messagesContainer');
    const inputEl = document.getElementById('inputMessage');
    const sendBtn = document.getElementById('sendBtn');

    // Simulate logged-in wallet
    const me = localStorage.getItem('drf_active_wallet');
    if (!me) return alert('Please login to DRF Wallet.');

    let selected = null;
    let msgListener = null;

    // Load users
    db.ref('profiles').once('value').then(snap => {
      usersListEl.innerHTML = '<h2>Users</h2>';
      snap.forEach(c => {
        const wallet = c.key;
        const u = c.val();
        if (wallet.toLowerCase() === me.toLowerCase()) return;
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `<img src="${u.photoUrl}" class="user-avatar"/><div class="user-name">${u.name}</div>`;
        div.onclick = () => startChat(wallet, u.name);
        usersListEl.appendChild(div);
      });
    });

    // Start chat
    function startChat(wallet, name) {
      selected = wallet;
      chatHeaderEl.textContent = 'Chat with ' + name;
      inputEl.disabled = false;
      sendBtn.disabled = false;
      messagesContainerEl.innerHTML = '';
      listen();
    }

    // Listen messages
    function listen() {
      if (msgListener) msgListener.off();
      const chatId = [me, selected].sort().join('_').toLowerCase();
      const ref = db.ref('messages/' + chatId);
      msgListener = ref.on('value', s => {
        messagesContainerEl.innerHTML = '';
        s.forEach(c => {
          const m = c.val();
          const div = document.createElement('div');
          div.className = 'message ' + (m.sender === me ? 'sent' : 'received');
          // linkify
          const html = m.text.replace(/(https?:\/\/[^\s]+)/g, url => `<a href="${url}" target="_blank">${url}</a>`);
          div.innerHTML = html;
          messagesContainerEl.appendChild(div);

          // image preview if image URL
          const imgs = m.text.match(/(https?:\/\/.+\.(?:png|jpg|jpeg|gif))/i);
          if (imgs) {
            const p = document.createElement('div');
            p.className = 'preview';
            p.innerHTML = `<img src="${imgs[0]}"/>`;
            messagesContainerEl.appendChild(p);
          }
        });
        messagesContainerEl.scrollTop = messagesContainerEl.scrollHeight;
      });
    }

    // Send
    sendBtn.onclick = () => {
      const text = inputEl.value.trim(); if (!text) return;
      const chatId = [me, selected].sort().join('_').toLowerCase();
      db.ref('messages/' + chatId).push({ sender: me, text, timestamp: Date.now() });
      inputEl.value = '';
    };

    inputEl.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); sendBtn.click();
      }
    });
  </script>
</body>
</html>
