<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Admin Posts</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#fff; color:#222; max-width:700px; margin-left:auto; margin-right:auto; }
    header { background:#007bff; color:#fff; padding:10px; text-align:center; }
    #uploadForm, #postContainer, #loginBtn, #logoutBtn { margin-top:20px; }
    #uploadForm input, #uploadForm textarea, #uploadForm button { display:block; width:100%; margin-top:10px; padding:8px; font-size:1em; }
    .post-item { border:1px solid #ccc; padding:15px; margin-bottom:15px; border-radius:6px; position:relative; }
    .badge-boosted { position:absolute; top:10px; right:10px; background:#ff4500; color:#fff; padding:4px 8px; font-weight:bold; border-radius:4px; }
  </style>
</head>
<body>

<header><h1>DRFMedia Admin Posts</h1></header>

<button id="loginBtn">Sign in with Google</button>
<button id="logoutBtn" style="display:none;">Logout</button>

<form id="uploadForm" style="display:none;">
  <input type="text" id="postUserName" placeholder="User Name" required />
  <input type="email" id="postUserEmail" placeholder="User Email" required />
  <input type="text" id="postWalletAddress" placeholder="DRFM Wallet Address" required />
  <input type="url" id="postUrl" placeholder="Post URL (for boost)" required />
  <textarea id="postCaption" placeholder="Post details/caption..." required minlength="4"></textarea>
  <button type="submit">Upload Boosted Post</button>
</form>

<div id="postContainer">Please log in to see posts.</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    push,
    set,
    onValue
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import {
    getAuth,
    signInWithPopup,
    signOut,
    GoogleAuthProvider,
    onAuthStateChanged,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Enable persistence
  setPersistence(auth, browserLocalPersistence).catch(console.error);

  const admins = new Set([
    "digitalrufiyauniversity@gmail.com",
    "digitalrufiyacoin@gmail.com",
    "digitalrufiya@gmail.com"
  ]);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const uploadForm = document.getElementById("uploadForm");
  const postContainer = document.getElementById("postContainer");

  let currentUser = null;

  loginBtn.onclick = () => {
    signInWithPopup(auth, provider)
      .then(() => console.log("Login successful"))
      .catch(e => {
        console.error("Login failed:", e);
        alert("Login failed: " + e.message);
      });
  };

  logoutBtn.onclick = () => {
    signOut(auth)
      .then(() => console.log("Logged out"))
      .catch(e => console.error("Logout failed:", e));
  };

  onAuthStateChanged(auth, user => {
    currentUser = user;
    console.log("Auth state changed:", user);
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";

      if (admins.has(user.email)) {
        uploadForm.style.display = "block";
      } else {
        uploadForm.style.display = "none";
      }

      loadPosts();
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      uploadForm.style.display = "none";
      postContainer.innerHTML = "Please log in to see posts.";
    }
  });

  uploadForm.addEventListener("submit", async e => {
    e.preventDefault();
    if (!currentUser) return alert("Login required.");

    if (!admins.has(currentUser.email)) return alert("Not authorized.");

    const userName = document.getElementById("postUserName").value.trim();
    const userEmail = document.getElementById("postUserEmail").value.trim();
    const walletAddress = document.getElementById("postWalletAddress").value.trim();
    const postUrl = document.getElementById("postUrl").value.trim();
    const caption = document.getElementById("postCaption").value.trim();

    if (!userName || !userEmail || !walletAddress || !postUrl || caption.length < 4) {
      return alert("Please fill all fields properly.");
    }

    try {
      const newPostRef = push(ref(db, "posts"));
      await set(newPostRef, {
        userName,
        userEmail,
        walletAddress,
        postUrl,
        caption,
        boosted: true,
        likesCount: 0,
        timestamp: Date.now()
      });
      alert("Boosted post uploaded!");
      uploadForm.reset();
      loadPosts();
    } catch (err) {
      alert("Failed to upload: " + err.message);
    }
  });

  function loadPosts() {
    onValue(ref(db, "posts"), snapshot => {
      const posts = snapshot.val();
      postContainer.innerHTML = "";
      if (!posts) {
        postContainer.innerHTML = "No posts available.";
        return;
      }

      const postsArr = Object.entries(posts).map(([id, post]) => ({ id, ...post }));
      postsArr.sort((a, b) => {
        if (a.boosted && !b.boosted) return -1;
        if (!a.boosted && b.boosted) return 1;
        if ((b.likesCount || 0) !== (a.likesCount || 0)) return (b.likesCount || 0) - (a.likesCount || 0);
        return b.timestamp - a.timestamp;
      });

      postsArr.forEach(post => {
        const card = document.createElement("div");
        card.className = "post-item";

        let badgeHTML = "";
        if (post.boosted) {
          badgeHTML = `<div class="badge-boosted">BOOSTED</div>`;
        }

        card.innerHTML = `
          ${badgeHTML}
          <div><strong>${escapeHTML(post.userName || "Anonymous")}</strong></div>
          <div style="font-size:0.85em; color:#555;">${new Date(post.timestamp).toLocaleString()}</div>
          <div style="margin-top:10px;">${escapeHTML(post.caption)}</div>
          <div style="margin-top:5px;">
            <a href="${post.postUrl}" target="_blank" rel="noopener" style="color:#007bff; word-break: break-word;">${escapeHTML(post.postUrl)}</a>
          </div>
          <div style="font-size:0.85em; color:#555; margin-top:5px;">
            Email: ${escapeHTML(post.userEmail)}<br />
            Wallet: ${escapeHTML(post.walletAddress)}
          </div>
        `;

        postContainer.appendChild(card);
      });
    }, err => {
      console.error("Failed to load posts:", err);
      postContainer.innerHTML = "Error loading posts.";
    });
  }

  function escapeHTML(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>

</body>
</html>
