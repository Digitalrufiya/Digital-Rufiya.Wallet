<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Timeline - Search & Boost</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #fff; color: #222; }
    header {
      background: #007bff; color: white; padding: 10px 20px;
      position: sticky; top: 0; z-index: 1000;
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
    }
    .navbar-left { display: flex; align-items: center; gap: 10px; }
    .navbar-left img { height: 40px; width: 40px; border-radius: 4px; background: white; padding: 2px; }
    .navbar-left h1 { margin: 0; font-size: 1.4em; font-weight: 700; }
    #menuToggle { background: transparent; border: none; cursor: pointer; width: 30px; height: 25px; display: flex; flex-direction: column; justify-content: space-between; padding: 0; }
    #menuToggle span { display: block; height: 3.5px; background: white; border-radius: 3px; }
    #primaryNav { width: 100%; display: none; flex-direction: column; background: #0069d9; margin-top: 10px; border-radius: 4px; }
    #primaryNav.open { display: flex; }
    #primaryNav a { padding: 12px 20px; color: white; text-decoration: none; font-weight: 600; border-top: 1px solid rgba(255,255,255,0.2); }
    #primaryNav a:first-child { border-top: none; }
    #primaryNav a:hover { background: rgba(255,255,255,0.2); }
    @media (min-width: 768px) {
      #menuToggle { display: none; }
      #primaryNav { display: flex !important; flex-direction: row; width: auto; background: transparent; margin-top: 0; border-radius: 0; }
      #primaryNav a { border: none; padding: 10px 15px; color: white; }
      #primaryNav a:hover { background: rgba(255,255,255,0.3); }
    }
    .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #ccc; box-shadow: 0 0 3px rgba(0,0,0,0.1); }
    #postContainer { max-width: 700px; margin: 20px auto; padding: 0 15px; }
    .post-item { border: 1px solid #ccc; border-radius: 6px; padding: 15px; margin-bottom: 20px; background: #fafafa; }
    .post-owner { display: flex; align-items: center; gap: 10px; font-weight: 700; }
    .post-owner div { line-height: 1.1; }
    .post-time { font-size: 0.85em; color: #555; margin-top: 4px; }
    .post-caption { margin-top: 10px; font-size: 1em; white-space: pre-wrap; }
    video, img { max-width: 100%; border-radius: 6px; margin-top: 10px; background: black; display: block; }
    #searchBar {
      max-width: 700px;
      margin: 10px auto 10px auto;
      padding: 0 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    #searchInput {
      flex-grow: 1;
      min-width: 220px;
      padding: 8px 12px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #filterButtons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    #filterButtons button {
      padding: 8px 14px;
      border-radius: 5px;
      border: none;
      background: #007bff;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #filterButtons button.active, #filterButtons button:hover {
      background: #0056b3;
    }
    .post-actions button {
      cursor: pointer;
      border: none;
      background: #007bff;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 0.9em;
      transition: background-color 0.3s;
      margin-right: 6px;
      margin-top: 6px;
    }
    .post-actions button:hover {
      background: #0056b3;
    }
    .comment-box { margin-top: 10px; }
    .comment-box textarea { width: 100%; border-radius: 4px; padding: 6px; }
    .comment-box button { margin-top: 5px; }
    .comments-list { margin-top: 10px; background: #eee; padding: 10px; border-radius: 4px; max-height: 150px; overflow-y: auto; }
    .comments-list div { margin-bottom: 6px; }
    .boosted { background-color: gold !important; color: #000 !important; }
  </style>
</head>
<body>

<header>
  <div class="navbar-left">
    <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="DRFMedia Logo" />
    <h1>DRFMedia</h1>
  </div>
  <button id="menuToggle" aria-label="Toggle menu"><span></span><span></span><span></span></button>
  <nav id="primaryNav">
    <a href="timeline.html">Timeline</a>
    <a href="profile.html">Profile</a>
    <a href="#" id="loginNavLink">Login</a>
    <a href="#" id="logoutNavLink" style="display:none;">Logout</a>
  </nav>
</header>

<div id="searchBar" role="search">
  <input type="search" id="searchInput" placeholder="Search by user name, wallet address, post description or IPFS hash..." aria-label="Search posts and users" />
  <div id="filterButtons" role="group" aria-label="Filter posts">
    <button id="btnAll" class="active" aria-pressed="true">All Posts</button>
    <button id="btnMostLiked" aria-pressed="false">Most Liked</button>
    <button id="btnMostViewed" aria-pressed="false">Most Viewed</button>
  </div>
</div>

<div id="postContainer" aria-live="polite"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase, ref, push, set, onValue, get, update
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import {
    getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const searchInput = document.getElementById("searchInput");
  const btnAll = document.getElementById("btnAll");
  const btnMostLiked = document.getElementById("btnMostLiked");
  const btnMostViewed = document.getElementById("btnMostViewed");
  const postContainer = document.getElementById("postContainer");

  let currentUser = null;
  let allPosts = [];
  let currentFilter = "all"; // all, liked, viewed

  // Escape HTML to prevent XSS
  const escapeHTML = str => String(str).replace(/[&<>"]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" })[c]);

  // Auth state listener
  onAuthStateChanged(auth, user => {
    currentUser = user;
    updateNavLinks();
    renderPosts();
  });

  function updateNavLinks() {
    const loginNavLink = document.getElementById("loginNavLink");
    const logoutNavLink = document.getElementById("logoutNavLink");
    if (currentUser) {
      loginNavLink.style.display = "none";
      logoutNavLink.style.display = "inline-block";
      logoutNavLink.onclick = () => signOut(auth).catch(e => alert("Logout failed: " + e.message));
    } else {
      loginNavLink.style.display = "inline-block";
      logoutNavLink.style.display = "none";
      loginNavLink.onclick = () => signInWithPopup(auth, provider).catch(e => alert("Login failed: " + e.message));
    }
  }

  // Listen posts realtime
  const postsRef = ref(db, "posts");
  onValue(postsRef, snapshot => {
    const posts = snapshot.val() || {};
    allPosts = Object.entries(posts).map(([id, post]) => ({ id, ...post }));
    renderPosts();
  });

  // Filter buttons
  btnAll.onclick = () => setFilter("all");
  btnMostLiked.onclick = () => setFilter("liked");
  btnMostViewed.onclick = () => setFilter("viewed");

  function setFilter(filter) {
    currentFilter = filter;
    btnAll.classList.toggle("active", filter === "all");
    btnMostLiked.classList.toggle("active", filter === "liked");
    btnMostViewed.classList.toggle("active", filter === "viewed");
    btnAll.setAttribute("aria-pressed", filter === "all");
    btnMostLiked.setAttribute("aria-pressed", filter === "liked");
    btnMostViewed.setAttribute("aria-pressed", filter === "viewed");
    renderPosts();
  }

  // Render posts with search and filter
  function renderPosts() {
    const filterText = searchInput.value.trim().toLowerCase();
    let filteredPosts = allPosts.filter(post => {
      // Search filter matches user name, wallet address (userId), caption, or IPFS hash (post.ipfsHash)
      if (!filterText) return true;
      const matchUser = (post.displayName || "").toLowerCase().includes(filterText);
      const matchUserId = (post.userId || "").toLowerCase().includes(filterText);
      const matchCaption = (post.caption || "").toLowerCase().includes(filterText);
      const matchHash = (post.ipfsHash || "").toLowerCase().includes(filterText);
      return matchUser || matchUserId || matchCaption || matchHash;
    });

    // Sorting by filter type
    if (currentFilter === "liked") {
      filteredPosts.sort((a, b) => (b.likesCount || 0) - (a.likesCount || 0));
    } else if (currentFilter === "viewed") {
      filteredPosts.sort((a, b) => (b.viewsCount || 0) - (a.viewsCount || 0));
    } else {
      // default: sort by timestamp desc
      filteredPosts.sort((a, b) => b.timestamp - a.timestamp);
    }

    postContainer.innerHTML = "";
    filteredPosts.forEach(post => {
      renderPost(post);
      incrementViewCount(post.id, post.viewsCount || 0);
    });
  }

  // Increment views count once per page load per post
  // (for demo, no user-based deduplication)
  const viewedPosts = new Set();
  async function incrementViewCount(postId, currentViews) {
    if (viewedPosts.has(postId)) return;
    viewedPosts.add(postId);
    try {
      await set(ref(db, `posts/${postId}/viewsCount`), currentViews + 1);
    } catch (e) {
      console.warn("Failed to increment views count:", e);
    }
  }

  function renderPost(post) {
    const isBoosted = currentUser && post.boostedBy && post.boostedBy[currentUser.uid];
    const url1 = "https://gateway.pinata.cloud/ipfs/" + post.ipfsHash;
    const url2 = "https://cloudflare-ipfs.com/ipfs/" + post.ipfsHash;

    const card = document.createElement("div");
    card.className = "post-item";

    card.innerHTML = `
      <div class="post-owner" style="gap:10px;">
        <img src="${escapeHTML(post.photoURL || '')}" class="avatar" alt="User profile photo" />
        <div>
          <strong>${escapeHTML(post.displayName || "Anonymous")}</strong><br/>
          <small style="font-size:0.8em; color:#444;">Wallet: ${escapeHTML(post.userId || '')}</small><br/>
          <a href="profile.html?uid=${escapeHTML(post.userId || '')}" style="font-size:0.85em; color:#007bff;">View Profile</a>
        </div>
      </div>
      <div class="post-time">${new Date(post.timestamp).toLocaleString()}</div>
      ${post.mediaType === "video"
        ? `<video controls preload="metadata" style="border-radius:6px; max-height:320px;"><source src="${url1}" type="${escapeHTML(post.mediaMimeType || '')}" /></video>`
        : `<img src="${url1}" alt="Post media" onerror="this.onerror=null;this.src='${url2}'" />`
      }
      <div class="post-caption">${escapeHTML(post.caption || '')}</div>
      <div style="font-size:0.8em; color:#666; margin-top:4px;">
        <strong>Likes:</strong> ${post.likesCount || 0} |
        <strong>Views:</strong> ${post.viewsCount || 0} |
        <strong>Comments:</strong> ${post.commentsCount || 0} |
        <strong>Boosts:</strong> ${post.boostsCount || 0}
      </div>
      <div class="post-actions" style="margin-top:10px; display:flex; flex-wrap: wrap;">
        <button onclick="likePost('${post.id}')">👍 Like (${post.likesCount || 0})</button>
        <button onclick="sharePost('${post.id}')">🔗 Share</button>
        <button onclick="repost('${post.id}')">🔁 Repost</button>
        <button class="${isBoosted ? 'boosted' : ''}" onclick="boostPost('${post.id}')">🚀 Boost (${post.boostsCount || 0})</button>
      </div>
      <div class="comment-box" id="commentBox-${post.id}">
        <textarea placeholder="Write a comment..." rows="2" id="commentInput-${post.id}"></textarea>
        <button onclick="addComment('${post.id}')">Add Comment</button>
      </div>
      <div class="comments-list" id="commentsList-${post.id}"></div>
    `;

    postContainer.appendChild(card);
    renderComments(post.id);
  }

  // Like a post
  window.likePost = async function(postId) {
    if (!currentUser) return alert("Login required to like posts.");
    try {
      const postRef = ref(db, "posts/" + postId);
      const snapshot = await get(postRef);
      if (!snapshot.exists()) return alert("Post not found.");
      const post = snapshot.val();
      // For simplicity, no user like tracking to prevent multi-likes (can add if needed)
      const newLikes = (post.likesCount || 0) + 1;
      await set(ref(db, `posts/${postId}/likesCount`), newLikes);
    } catch (e) {
      alert("Failed to like post: " + e.message);
    }
  };

  // Share post link
  window.sharePost = function(postId) {
    const link = window.location.href.split("#")[0] + "#post-" + postId;
    navigator.clipboard.writeText(link).then(() => alert("Post link copied to clipboard."));
  };

  // Repost: clones post to timeline with new timestamp, same media and caption, from current user
  window.repost = async function(postId) {
    if (!currentUser) return alert("Login required to repost posts.");
    try {
      const postSnap = await get(ref(db, "posts/" + postId));
      if (!postSnap.exists()) return alert("Original post not found.");
      const post = postSnap.val();

      const newPostRef = push(ref(db, "posts"));
      await set(newPostRef, {
        userId: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        caption: post.caption,
        ipfsHash: post.ipfsHash,
        mediaType: post.mediaType,
        mediaMimeType: post.mediaMimeType || "",
        timestamp: Date.now(),
        likesCount: 0,
        commentsCount: 0,
        boostsCount: 0,
        boostedBy: {},
        viewsCount: 0
      });
      alert("Reposted successfully!");
    } catch(e) {
      alert("Repost failed: " + e.message);
    }
  };

  // Boost post - admin only (for demo, admin = logged user with email ending with @yourdomain.com, replace with your rule)
  window.boostPost = async function(postId) {
    if (!currentUser) return alert("Login required to boost posts.");
    if (!currentUser.email?.endsWith("@yourdomain.com")) return alert("Only admins can boost posts.");

    try {
      const postRef = ref(db, "posts/" + postId);
      const snapshot = await get(postRef);
      if (!snapshot.exists()) return alert("Post not found.");
      const post = snapshot.val();

      const boostedBy = post.boostedBy || {};
      if (boostedBy[currentUser.uid]) {
        alert("You already boosted this post.");
        return;
      }
      boostedBy[currentUser.uid] = Date.now();
      const newBoostCount = (post.boostsCount || 0) + 1;

      await update(postRef, {
        boostedBy,
        boostsCount: newBoostCount
      });

      alert("Post boosted successfully!");
    } catch(e) {
      alert("Boost failed: " + e.message);
    }
  };

  // Comments

  window.addComment = async function(postId) {
    if (!currentUser) return alert("Login required to comment.");
    const textarea = document.getElementById(`commentInput-${postId}`);
    const text = textarea.value.trim();
    if (!text) return alert("Comment cannot be empty.");
    try {
      const commentsRef = ref(db, `posts/${postId}/comments`);
      const newCommentRef = push(commentsRef);
      await set(newCommentRef, {
        userId: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        comment: text,
        timestamp: Date.now()
      });
      textarea.value = "";

      // Update comments count
      const postRef = ref(db, "posts/" + postId);
      const snapshot = await get(postRef);
      const post = snapshot.val();
      const newCommentsCount = (post.commentsCount || 0) + 1;
      await set(ref(db, `posts/${postId}/commentsCount`), newCommentsCount);

      renderComments(postId);
    } catch(e) {
      alert("Failed to add comment: " + e.message);
    }
  };

  async function renderComments(postId) {
    const commentsList = document.getElementById(`commentsList-${postId}`);
    const commentsRef = ref(db, `posts/${postId}/comments`);
    try {
      const snapshot = await get(commentsRef);
      const comments = snapshot.exists() ? Object.values(snapshot.val()) : [];
      commentsList.innerHTML = "";
      comments
        .sort((a, b) => a.timestamp - b.timestamp)
        .forEach(c => {
          const div = document.createElement("div");
          div.innerHTML = `<strong>${escapeHTML(c.displayName || "Anon")}:</strong> ${escapeHTML(c.comment)}`;
          commentsList.appendChild(div);
        });
    } catch (e) {
      commentsList.innerHTML = `<em>Failed to load comments.</em>`;
    }
  }

  // Search input event
  searchInput.addEventListener("input", () => renderPosts());

  // Responsive menu toggle
  const menuToggle = document.getElementById("menuToggle");
  const primaryNav = document.getElementById("primaryNav");
  menuToggle.addEventListener("click", () => primaryNav.classList.toggle("open"));
</script>

</body>
</html>
