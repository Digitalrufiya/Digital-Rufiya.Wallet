<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>

  <link rel="stylesheet" href="style.css" />

  <style>
    :root {
      --accent: #007bff;
      --accent-hover: #0056b3;
      --accent-muted: #0069d9;
      --bg-body: #f8f9fa;
      --bg-surface: #fff;
      --bg-surface-alt: #fafafa;
      --text-body: #212529;
      --text-muted: #6c757d;
      --radius: 0.5rem;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #181a1b;
        --bg-surface: #242628;
        --bg-surface-alt: #2b2e30;
        --text-body: #f1f3f5;
        --text-muted: #adb5bd;
        --shadow-sm: none;
        --shadow-md: none;
      }
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-body);
      color: var(--text-body);
      display: flex;
      flex-direction: column;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    img, video {
      max-width: 100%;
      border-radius: var(--radius);
      background: #000;
      display: block;
    }

    header {
      background: var(--accent);
      color: #fff;
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      box-shadow: var(--shadow-md);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: clamp(1rem, 2vw, 1.3rem);
    }

    .brand img {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.25rem;
      background: #fff;
      padding: 2px;
    }

    #menuToggle {
      display: inline-flex;
      flex-direction: column;
      width: 2rem;
      height: 1.3rem;
      justify-content: space-between;
      background: none;
      border: none;
      cursor: pointer;
    }

    #menuToggle span {
      display: block;
      height: 3px;
      background: #fff;
      border-radius: 3px;
    }

    #primaryNav {
      display: none;
      flex-direction: column;
      width: 100%;
      background: var(--accent-muted);
      border-radius: var(--radius);
    }

    #primaryNav.open {
      display: flex;
    }

    #primaryNav a {
      padding: 0.75rem 1.25rem;
      font-weight: 600;
      border-top: 1px solid rgb(255 255 255 / 0.15);
    }

    #primaryNav a:first-child {
      border-top: none;
    }

    #primaryNav a:hover,
    #primaryNav a.active {
      background: rgb(255 255 255 / 0.25);
    }

    @media (min-width: 768px) {
      #menuToggle {
        display: none;
      }

      #primaryNav {
        display: flex !important;
        flex-direction: row;
        gap: 0.25rem;
        background: transparent;
        width: auto;
      }

      #primaryNav a {
        border: none;
        padding: 0.5rem 0.9rem;
      }
    }

    .btn {
      display: inline-block;
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 0.45rem 0.9rem;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      max-width: 700px;
      margin: 1rem auto;
      width: 100%;
    }

    .btn:hover {
      background: var(--accent-hover);
    }

    .btn:disabled {
      background: #adb5bd;
      cursor: not-allowed;
    }

    #logoutBtn {
      background: #dc3545;
    }

    #pageWrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .container {
      width: min(100%, 700px);
      margin-inline: auto;
      padding-inline: 1rem;
    }

    #searchBar {
      margin: 1rem auto 0;
    }

    #searchInput {
      width: 100%;
      padding: 0.55rem 0.85rem;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: var(--radius);
      background: var(--bg-surface);
      color: var(--text-body);
    }

    #uploadForm {
      margin-top: 1.25rem;
    }

    #uploadForm textarea {
      width: 100%;
      margin-top: 0.75rem;
      padding: 0.65rem 0.85rem;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: var(--radius);
      resize: vertical;
      min-height: 6rem;
      background: var(--bg-surface);
      color: var(--text-body);
    }

    .post-item {
      background: var(--bg-surface-alt);
      border: 1px solid #dee2e6;
      border-radius: var(--radius);
      padding: 1rem;
      margin-block: 1.25rem;
      box-shadow: var(--shadow-sm);
    }

    .post-owner {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 700;
    }

    .avatar {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ced4da;
      box-shadow: var(--shadow-sm);
    }

    .post-time {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .post-caption {
      margin-top: 0.75rem;
      white-space: pre-wrap;
    }

    .post-media {
      margin-top: 0.75rem;
      position: relative;
      min-height: 200px;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video,
    img {
      max-height: 400px;
      border-radius: var(--radius);
      background: #000;
      display: block;
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    .fallback-media {
      color: #fff;
      text-align: center;
      padding: 1rem;
    }

    .post-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .post-actions button {
      flex: 1 1 auto;
    }

    .post-actions button.liked {
      background: #28a745 !important;
    }

    .post-actions button.boosted {
      background: gold !important;
      color: #000 !important;
    }

    .post-actions button.delete-btn {
      background: #dc3545 !important;
      color: #fff;
    }

    .post-actions button.delete-btn:hover {
      background: #b52a3b !important;
    }

    .comments-list {
      margin-top: 0.75rem;
      background: var(--bg-surface);
      padding: 0.65rem;
      border-radius: var(--radius);
      max-height: 10rem;
      overflow-y: auto;
      font-size: 0.9rem;
      color: var(--text-body);
    }

    .comment-box textarea {
      width: 100%;
      border-radius: var(--radius);
      padding: 0.6rem 0.8rem;
      resize: vertical;
      font-size: 1rem;
    }

    button:focus-visible,
    #menuToggle:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img
        src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311"
        alt="DRFMedia Logo"
      />
      <span>DRFMedia</span>
    </div>
    <button
      id="menuToggle"
      aria-label="Toggle navigation"
      aria-controls="primaryNav"
      aria-expanded="false"
    >
      <span></span><span></span><span></span>
    </button>
    <nav id="primaryNav">
      <a href="media.html" class="active">Timeline</a>
      <a href="profile.html">Profile</a>
      <a href="gift.html">Donation</a>
      <a href="chat.html">Chat</a>
    </nav>
  </header>

  <div id="pageWrapper">
    <section id="searchBar" class="container">
      <input
        id="searchInput"
        type="search"
        placeholder="Search posts…"
        aria-label="Search posts"
      />
    </section>

    <button id="loginBtn" class="btn" style="display:block;">Sign in with Google</button>
    <button id="logoutBtn" class="btn" style="display:none; background:#dc3545;">
      Logout
    </button>

    <form id="uploadForm" class="container" style="display:none;">
      <input id="mediaFile" type="file" accept="image/*,video/*" required />
      <textarea
        id="caption"
        placeholder="Write your caption…"
        minlength="4"
        required
      ></textarea>
      <button class="btn" type="submit" style="margin-top: 0.75rem;">Post</button>
    </form>

    <section id="postContainer" class="container" aria-live="polite"></section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      get,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import {
      getAuth,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const pinataJWT =
      "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.appspot.com",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:dc999df2c0c37241ff3f40",
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const uploadForm = document.getElementById("uploadForm");
    const mediaFile = document.getElementById("mediaFile");
    const captionIn = document.getElementById("caption");
    const postWrap = document.getElementById("postContainer");
    const searchIn = document.getElementById("searchInput");
    const menuTog = document.getElementById("menuToggle");
    const primaryNav = document.getElementById("primaryNav");

    let currentUser = null,
      isAdmin = false,
      allPosts = [];

    const esc = (s) =>
      s.replace(/[&<>"]/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
      }[c]));

    loginBtn.onclick = () =>
      signInWithPopup(auth, provider).catch((e) => alert(e.message));
    logoutBtn.onclick = () =>
      signOut(auth).catch((e) => alert(e.message));

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      uploadForm.style.display = user ? "block" : "none";
      loginBtn.style.display = user ? "none" : "block";
      logoutBtn.style.display = user ? "block" : "none";

      if (user) {
        try {
          const adSnap = await get(ref(db, `admin/${user.uid}`));
          isAdmin = adSnap.exists();
        } catch {
          isAdmin = false;
        }
      } else isAdmin = false;
      renderPosts();
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return alert("Login first");
      if (!mediaFile.files[0]) return alert("Select a file");
      if (captionIn.value.trim().length < 4) return alert("Caption too short");

      uploadForm.querySelector("button").disabled = true;

      try {
        // Pinata upload
        const fd = new FormData();
        fd.append("file", mediaFile.files[0]);

        const up = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
          method: "POST",
          headers: {
            Authorization: pinataJWT,
          },
          body: fd,
        });

        if (!up.ok)
          throw new Error(
            `Pinata upload failed with status ${up.status} ${up.statusText}`
          );

        const { IpfsHash } = await up.json();
        if (!IpfsHash || typeof IpfsHash !== "string") throw new Error("Invalid IPFS hash returned.");

        const newRef = push(ref(db, "posts"));
        await set(newRef, {
          userId: currentUser.uid,
          displayName: currentUser.displayName,
          photoURL: currentUser.photoURL,
          caption: captionIn.value.trim(),
          ipfsHash: IpfsHash,
          mediaType: mediaFile.files[0].type.startsWith("video") ? "video" : "image",
          mediaMimeType: mediaFile.files[0].type,
          timestamp: Date.now(),
          likesCount: 0,
          commentsCount: 0,
          boostsCount: 0,
          likedBy: {},
          boostedBy: {},
        });

        captionIn.value = "";
        mediaFile.value = "";
      } catch (err) {
        alert("Upload error: " + err.message);
      } finally {
        uploadForm.querySelector("button").disabled = false;
      }
    });

    onValue(ref(db, "posts"), (snap) => {
      const p = snap.val() || {};
      allPosts = Object.entries(p)
        .map(([id, v]) => ({ id, ...v }))
        .sort((a, b) => b.timestamp - a.timestamp);
      renderPosts();
    });

    // Generate thumbnail for videos client side for preview
    async function generateVideoThumbnail(file) {
      return new Promise((resolve) => {
        const video = document.createElement("video");
        video.preload = "metadata";
        video.muted = true;
        video.src = URL.createObjectURL(file);
        video.currentTime = 1;

        video.onloadeddata = () => {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          URL.revokeObjectURL(video.src);
          resolve(canvas.toDataURL("image/png"));
        };

        video.onerror = () => resolve(null);
      });
    }

    function createMediaElement(post) {
      if (!post.ipfsHash) return fallbackElement("Missing media");

      const url = "https://gateway.pinata.cloud/ipfs/" + post.ipfsHash;

      if (post.mediaType === "video") {
        const video = document.createElement("video");
        video.controls = true;
        video.playsInline = true;
        video.preload = "metadata";
        video.src = url;

        // On error fallback
        video.onerror = () => {
          video.replaceWith(fallbackElement("Video load failed"));
        };

        return video;
      } else {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "media";
        img.loading = "lazy";

        img.onerror = () => {
          img.replaceWith(fallbackElement("Image load failed"));
        };

        return img;
      }
    }

    function fallbackElement(text) {
      const div = document.createElement("div");
      div.className = "fallback-media";
      div.textContent = text;
      return div;
    }

    function renderPosts() {
      const q = searchIn.value.trim().toLowerCase();
      postWrap.innerHTML = "";

      for (const p of allPosts) {
        if (!p.caption.toLowerCase().includes(q)) continue;

        const owner = currentUser && p.userId === currentUser.uid;
        const liked = currentUser && p.likedBy && p.likedBy[currentUser.uid];
        const boosted = currentUser && p.boostedBy && p.boostedBy[currentUser.uid];

        const card = document.createElement("article");
        card.className = "post-item";

        card.innerHTML = `
          <header class="post-owner">
            <img class="avatar" src="${p.photoURL || "https://via.placeholder.com/40"}" alt="avatar" />
            <div>
              <div>${esc(p.displayName || "Anon")}</div>
              <time class="post-time" datetime="${new Date(
                p.timestamp
              ).toISOString()}">${new Date(p.timestamp).toLocaleString()}</time>
            </div>
          </header>
          <div class="post-caption">${esc(p.caption)}</div>
          <div class="post-media" id="media-${p.id}">
            <div class="loading-placeholder">Loading media...</div>
          </div>
          <div class="post-actions">
            <button class="${liked ? "liked" : ""}" onclick="likePost('${p.id}')">👍 Like (${p.likesCount || 0})</button>
            <button onclick="commentOnPost('${p.id}')">💬 Comment (${p.commentsCount || 0})</button>
            <button class="${boosted ? "boosted" : ""}" onclick="boostPost('${p.id}')">🚀 Boost (${p.boostsCount || 0})</button>
            <button onclick="repost('${p.id}')">🔄 Repost</button>
          </div>
          <div id="comments-${p.id}" class="comments-list" aria-live="polite"></div>
          <div id="comment-box-${p.id}" class="comment-box" style="display:none">
            <textarea id="comment-input-${p.id}" rows="2" placeholder="Write a comment…"></textarea>
            <button onclick="submitComment('${p.id}')">Submit</button>
            <button onclick="cancelComment('${p.id}')">Cancel</button>
          </div>`;

        postWrap.appendChild(card);

        // Add Delete button if owner or admin
        if (isAdmin || owner) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "🗑️ Delete";
          delBtn.className = "delete-btn";
          delBtn.onclick = () => deletePost(p.id);
          card.querySelector(".post-actions").appendChild(delBtn);
        }

        // Replace media placeholder with actual media element asynchronously
        const mediaContainer = document.getElementById(`media-${p.id}`);
        mediaContainer.innerHTML = "";
        const mediaEl = createMediaElement(p);
        mediaContainer.appendChild(mediaEl);

        loadComments(p.id);
      }
    }

    window.likePost = async (id) => {
      if (!currentUser) return alert("Login required");
      const snap = await get(ref(db, "posts/" + id));
      if (!snap.exists()) return;
      const post = snap.val();
      const list = post.likedBy || {};
      if (list[currentUser.uid]) delete list[currentUser.uid];
      else list[currentUser.uid] = true;
      await set(ref(db, `posts/${id}/likedBy`), list);
      await set(ref(db, `posts/${id}/likesCount`), Object.keys(list).length);
    };

    window.boostPost = async (id) => {
      if (!currentUser) return alert("Login required");
      const snap = await get(ref(db, "posts/" + id));
      if (!snap.exists()) return;
      const post = snap.val();
      const list = post.boostedBy || {};
      if (list[currentUser.uid]) delete list[currentUser.uid];
      else list[currentUser.uid] = true;
      await set(ref(db, `posts/${id}/boostedBy`), list);
      await set(ref(db, `posts/${id}/boostsCount`), Object.keys(list).length);
    };

    window.repost = async (id) => {
      if (!currentUser) return alert("Login required");
      const osnap = await get(ref(db, "posts/" + id));
      if (!osnap.exists()) return;
      const o = osnap.val();
      await set(push(ref(db, "posts")), {
        userId: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        caption: `[Reposted by ${currentUser.displayName || "Anon"}]\n\n${o.caption}`,
        ipfsHash: o.ipfsHash,
        mediaType: o.mediaType,
        mediaMimeType: o.mediaMimeType,
        timestamp: Date.now(),
        likesCount: 0,
        commentsCount: 0,
        boostsCount: 0,
        likedBy: {},
        boostedBy: {},
      });
    };

    window.deletePost = async (id) => {
      if (!currentUser) return alert("Login required");
      const ownerSnap = await get(ref(db, `posts/${id}/userId`));
      if (!(isAdmin || (ownerSnap.exists() && ownerSnap.val() === currentUser.uid)))
        return alert("No permission");
      if (!confirm("Delete this post permanently?")) return;
      await set(ref(db, `posts/${id}`), null);
      await set(ref(db, `comments/${id}`), null);
      alert("Deleted");
    };

    window.commentOnPost = (id) =>
      (document.getElementById(`comment-box-${id}`).style.display = "block");
    window.cancelComment = (id) =>
      (document.getElementById(`comment-box-${id}`).style.display = "none");

    window.submitComment = async (id) => {
      if (!currentUser) return alert("Login required");
      const txt = document.getElementById(`comment-input-${id}`).value.trim();
      if (!txt) return;
      await set(push(ref(db, `comments/${id}`)), {
        userId: currentUser.uid,
        displayName: currentUser.displayName,
        photoURL: currentUser.photoURL,
        text: txt,
        timestamp: Date.now(),
      });
      const psnap = await get(ref(db, "posts/" + id));
      if (psnap.exists()) {
        await set(ref(db, `posts/${id}/commentsCount`), (psnap.val().commentsCount || 0) + 1);
      }
      document.getElementById(`comment-input-${id}`).value = "";
      window.cancelComment(id);
    };

    async function loadComments(id) {
      const cSnap = await get(ref(db, `comments/${id}`));
      const box = document.getElementById(`comments-${id}`);
      if (!box) return;
      box.innerHTML = "";
      if (!cSnap.exists()) return;
      Object.values(cSnap.val())
        .sort((a, b) => a.timestamp - b.timestamp)
        .forEach((c) => {
          box.insertAdjacentHTML(
            "beforeend",
            `<div><strong>${esc(c.displayName || "Anon")}</strong>: ${esc(
              c.text
            )}<br><small>${new Date(c.timestamp).toLocaleString()}</small></div>`
          );
        });
    }

    searchIn.addEventListener("input", renderPosts);
    menuTog.addEventListener("click", () => {
      primaryNav.classList.toggle("open");
      menuTog.setAttribute("aria-expanded", primaryNav.classList.contains("open"));
    });
  </script>
</body>
</html>
