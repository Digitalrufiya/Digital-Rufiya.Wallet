<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--accent:#007bff;--accent-hover:#0056b3;--accent-muted:#3399ff;--bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;--text-body:#212529;--text-muted:#6c757d;--radius:.5rem;--shadow-sm:0 1px 2px rgba(0,0,0,.06);--shadow-md:0 2px 4px rgba(0,0,0,.1)}
    @media(prefers-color-scheme:dark){:root{--bg-body:#181a1b;--bg-surface:#242628;--bg-surface-alt:#2b2e30;--text-body:#f1f3f5;--text-muted:#adb5bd;--shadow-sm:none;--shadow-md:none}}
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg-body);color:var(--text-body);display:flex;flex-direction:column}
    img,video{max-width:100%;border-radius:var(--radius);display:block;background:#000}
    header{background:var(--accent);color:#fff;padding:.75rem 1rem;position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;box-shadow:var(--shadow-md)}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700;font-size:clamp(1rem,2vw,1.3rem)}
    .brand img{width:2.25rem;height:2.25rem;border-radius:.25rem;background:#fff;padding:2px}
    #menuToggle{display:inline-flex;flex-direction:column;width:2rem;height:1.3rem;justify-content:space-between;background:none;border:none;cursor:pointer}
    #menuToggle span{display:block;height:3px;background:#fff;border-radius:3px}
    #primaryNav{display:none;flex-direction:column;width:100%;background:var(--accent-muted);border-radius:var(--radius)}
    #primaryNav.open{display:flex}
    #primaryNav a{padding:.75rem 1.25rem;font-weight:600;border-top:1px solid rgb(255 255 255/.15);color:#fff}
    #primaryNav a:first-child{border-top:none}
    #primaryNav a:hover{background:rgb(255 255 255/.18)}
    @media(min-width:768px){#menuToggle{display:none}#primaryNav{display:flex!important;flex-direction:row;gap:.25rem;background:transparent;width:auto}#primaryNav a{border:none;padding:.5rem .9rem;color:inherit}#primaryNav a:hover{background:rgb(255 255 255/.25)}}
    .btn{display:inline-block;border:none;background:var(--accent);color:#fff;padding:.45rem .9rem;border-radius:var(--radius);font-size:.95rem;font-weight:600;cursor:pointer;transition:background-color .2s}
    .btn:hover{background:var(--accent-hover)}.btn:disabled{background:#adb5bd;cursor:not-allowed}
    #pageWrapper{flex:1;display:flex;flex-direction:column}
    .container{width:min(100%,700px);margin-inline:auto;padding-inline:1rem}
    #searchBar{margin:1rem auto 0}
    #searchInput{width:100%;padding:.55rem .85rem;font-size:1rem;border:1px solid #ced4da;border-radius:var(--radius);background:var(--bg-surface);color:var(--text-body)}
    #uploadForm{margin-top:1.25rem}
    #uploadForm textarea{width:100%;margin-top:.75rem;padding:.65rem .85rem;font-size:1rem;border:1px solid #ced4da;border-radius:var(--radius);resize:vertical;min-height:6rem;background:var(--bg-surface);color:var(--text-body)}
    .post-item{background:var(--bg-surface-alt);border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;margin-block:1.25rem;box-shadow:var(--shadow-sm)}
    .post-owner{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:1px solid #ced4da;box-shadow:var(--shadow-sm)}
    .post-time{font-size:.85rem;color:var(--text-muted);margin-top:2px}
    .post-caption{margin-top:.75rem;white-space:pre-wrap}
    .loading-spinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:.9rem;pointer-events:none}
    .media-wrapper{position:relative;background:#000;border-radius:var(--radius)}
    #livePreview{margin-top:1rem;max-width:700px;margin-inline:auto;border:1px solid #ced4da;border-radius:var(--radius);padding:.5rem;background:var(--bg-surface-alt)}
  </style>
</head>
<body>
<header>
  <div class="brand"><img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="DRFMedia Logo" /><span>DRFMedia</span></div>
  <button id="menuToggle" aria-label="Toggle navigation" aria-controls="primaryNav" aria-expanded="false"><span></span><span></span><span></span></button>
  <nav id="primaryNav"><a href="media.html">Timeline</a><a href="profile.html" class="active">Profile</a><a href="media.html">Posts</a><a href="gift.html">Donation</a><a href="chat.html">Chat</a></nav>
</header>
<div id="pageWrapper">
  <section id="searchBar" class="container"><input id="searchInput" type="search" placeholder="Search posts…" aria-label="Search posts" /></section>
  <button id="loginBtn" class="btn" style="display:block;max-width:700px;margin:1rem auto;">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;max-width:700px;margin:1rem auto;background:#dc3545;">Logout</button>
  <form id="uploadForm" class="container" style="display:none;"><input id="mediaFile" type="file" accept="image/*,video/*" required /><textarea id="caption" placeholder="Write your caption…" minlength="4" required></textarea><button class="btn" type="submit" style="margin-top:.75rem;">Post</button></form>
  <section id="livePreview" class="container" aria-live="polite" style="display:none;"></section>
  <section id="postContainer" class="container" aria-live="polite"></section>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, query, orderByChild, limitToLast, onChildAdded, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

/* ===== CONFIG ===== */
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA"; // <-- replace
const firebaseConfig = { apiKey:"AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8", authDomain:"drfsocial-23a06.firebaseapp.com", databaseURL:"https://drfsocial-23a06-default-rtdb.firebaseio.com", projectId:"drfsocial-23a06", storageBucket:"drfsocial-23a06.appspot.com", messagingSenderId:"608135115201", appId:"1:608135115201:web:dc999df2c0c37241ff3f40" };

/* ===== INIT ===== */
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const auth= getAuth(app);
const provider = new GoogleAuthProvider();

/* ===== DOM ===== */
const loginBtn=document.getElementById("loginBtn"), logoutBtn=document.getElementById("logoutBtn"), uploadForm=document.getElementById("uploadForm"), mediaFile=document.getElementById("mediaFile"), captionIn=document.getElementById("caption"), postWrap=document.getElementById("postContainer"), searchIn=document.getElementById("searchInput"), menuTog=document.getElementById("menuToggle"), primaryNav=document.getElementById("primaryNav"), livePreview=document.getElementById("livePreview");

/* ===== UI HELPERS ===== */
const esc = s=>s? s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])):"";
const createVideo = url=>{
  const w=document.createElement("div");w.className="media-wrapper";
  const sp=document.createElement("div");sp.className="loading-spinner";sp.textContent="Loading video...";
  const v=document.createElement("video");v.src=url;v.controls=true;v.playsInline=true;v.preload="metadata";v.style.width="100%";
  v.onloadedmetadata=()=>sp.style.display="none";
  v.onerror=()=>{sp.style.display="block";setTimeout(()=>v.load(),3000)};
  w.append(v,sp);return w;
};

/* ===== MENU ===== */
menuTog.onclick=()=>{const x=menuTog.getAttribute("aria-expanded")==="true";menuTog.setAttribute("aria-expanded",!x);primaryNav.classList.toggle("open")};

/* ===== AUTH ===== */
loginBtn.onclick=()=>signInWithPopup(auth,provider).catch(e=>alert(e.message));
logoutBtn.onclick=()=>signOut(auth);
onAuthStateChanged(auth,user=>{if(user){loginBtn.style.display="none";logoutBtn.style.display="block";uploadForm.style.display="block";initListeners();}else{loginBtn.style.display="block";logoutBtn.style.display="none";uploadForm.style.display="none";postWrap.innerHTML="";livePreview.style.display="none";detachListeners();}});

/* ===== FAST LISTENERS ===== */
let postsQuery, addedCB, changedCB, removedCB;
function initListeners(){
  if(postsQuery) return; // already init
  postsQuery=query(ref(db,"posts"),orderByChild("timestamp"),limitToLast(30));
  addedCB=onChildAdded(postsQuery,snap=>updatePost(snap.key,snap.val()));
  changedCB=onChildChanged(postsQuery,snap=>updatePost(snap.key,snap.val()));
  removedCB=onChildRemoved(postsQuery,snap=>{delete postsMap[snap.key];renderPosts();});
}
function detachListeners(){if(addedCB){addedCB();changedCB();removedCB();postsQuery=null;postsMap={};}}

const postsMap={};
function updatePost(id,data){postsMap[id]=data;renderPosts();}
function renderPosts(){const q=searchIn.value.trim().toLowerCase();postWrap.innerHTML="";Object.values(postsMap).sort((a,b)=>b.timestamp-a.timestamp).forEach(p=>{if(p.caption&&p.caption.toLowerCase().includes(q)){const url="https://cloudflare-ipfs.com/ipfs/"+p.ipfsHash;const card=document.createElement("article");card.className="post-item";card.innerHTML=`<header class="post-owner"><img class="avatar" src="${p.photoURL||"https://via.placeholder.com/40"}" alt="avatar"><div><div>${esc(p.displayName||"Anon")}</div><time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">${new Date(p.timestamp).toLocaleString()}</time></div></header><div class="post-caption">${esc(p.caption)}</div><div class="post-media"></div>`;const m=card.querySelector(".post-media");p.mediaType==="video"?m.appendChild(createVideo(url)):(m.innerHTML=`<img src="${url}" alt="media" loading="lazy">`);postWrap.appendChild(card);} });}
searchIn.oninput=renderPosts;

/* ===== UPLOAD ===== */
uploadForm.onsubmit=async e=>{e.preventDefault();const user=auth.currentUser;if(!user) return alert("Login first");const file=mediaFile.files[0];if(!file) return alert("Choose a file");if(captionIn.value.trim().length<4) return alert("Caption too short");uploadForm.querySelector("button").disabled=true;try{livePreview.style.display="block";livePreview.innerHTML="";let prev=file.type.startsWith("video/")?createVideo(URL.createObjectURL(file)):Object.assign(document.createElement("img"),{src:URL.createObjectURL(file),style:"width:100%;border-radius:var(--radius)"});livePreview.appendChild(prev);
  const fd=new FormData();fd.append("file",file);
  const res=await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS",{method:"POST",headers:{Authorization:pinataJWT},body:fd});if(!res.ok) throw new Error("Pinata upload failed");const {IpfsHash}=await res.json();await push(ref(db,"posts"),{userId:user.uid,displayName:user.displayName||"Anon",photoURL:user.photoURL||"",caption:captionIn.value.trim(),ipfsHash:IpfsHash,mediaType:file.type.startsWith("video")?"video":"image",timestamp:Date.now()});uploadForm.reset();livePreview.style.display="none";}catch(err){alert(err.message);}finally{uploadForm.querySelector("button").disabled=false;}};
</script>
</body>
</html>
