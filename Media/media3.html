<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia ‚Äî Post & View</title>
<link rel="stylesheet" href="style.css" />
<style>
/* same styles as before */
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-header">
      <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,_202025,_01_10_55%20PM.png" alt="DRFMedia logo" />
      <span id="userName">DRFMedia</span>
    </div>
    <button id="rewardBtn">Share & Get Rewards</button>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">‚ò∞</button>
  <nav id="primaryNav">
    <a href="media.html" class="active">posts</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Timelines</a>
    <a href="market.html">Market Place</a>
    <a href="ADS/ads.html">Ads Maker</a>
    <a href="Charity/charity.html">Charity Request</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search posts‚Ä¶" />

  <form id="uploadForm">
    <div id="previewContainer"></div>
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <textarea id="caption" minlength="4" placeholder="Write your caption‚Ä¶" required></textarea>
    <div id="prog"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>
  <p id="feedHint" class="helper" style="display:none">Scroll for more‚Ä¶</p>
  <div id="sentinel" aria-hidden="true"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, get, onChildAdded } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

// --- PINATA JWT ---
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR... (same as yours)";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
  measurementId: "G-TBFQX80NRP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $ = id => document.getElementById(id);
const upload = $("uploadForm"), fileIn = $("mediaFile"), capIn = $("caption");
const prog = $("prog"), bar = $("progBar");
const posts = $("postContainer"), qIn = $("searchInput"), preview = $("previewContainer");
const sentinel = $("sentinel"), feedHint = $("feedHint");

let all=[], view=[], index=0;
const PAGE_SIZE=10;

const escapeHTML = s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

const gw = cid => ({g1:`https://gateway.pinata.cloud/ipfs/${cid}`,g2:`https://cloudflare-ipfs.com/ipfs/${cid}`,g3:`https://ipfs.io/ipfs/${cid}`});
function createImage(cid){const {g1,g2,g3}=gw(cid); const img=document.createElement('img'); img.loading='lazy'; img.src=g1; img.onerror=()=>{if(img.src===g1) img.src=g2; else if(img.src===g2) img.src=g3;}; return img;}
function createVideo(cid){const {g1,g2,g3}=gw(cid); const v=document.createElement('video'); v.controls=true; v.playsInline=true; v.preload='metadata'; v.muted=true; v.src=g1; return v;}

function renderReset(){posts.innerHTML=''; index=0; feedHint.style.display='none';}
function renderCard(p){
  const card=document.createElement('article');
  card.className='post-item';
  card.innerHTML=`
    <header class="post-owner">
      <img class="avatar" src="${p.photoURL||'https://via.placeholder.com/40'}" alt="User avatar" />
      <div>
        <div>${escapeHTML(p.displayName||'DRFMedia')}</div>
        <time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">${new Date(p.timestamp).toLocaleString()}</time>
      </div>
      <span class="post-badge">${p.mediaType==='video'?'Video':'Image'}</span>
    </header>
    <div class="post-caption">${escapeHTML(p.caption||'')}</div>
    <div class="post-media" id="m-${p.id}"></div>
    <div class="post-actions">
      <button data-id="${p.id}" class="likeBtn">‚ù§Ô∏è Like <span class="likeCount">(0)</span></button>
      <button data-id="${p.id}" class="commentBtn">üí¨ Comment</button>
      <button data-id="${p.id}" class="shareBtn">üîó Share</button>
    </div>
    <div class="comments-container" id="comments-${p.id}"></div>
    <div class="comment-input">
      <input type="text" placeholder="Add a comment‚Ä¶" id="input-${p.id}" />
      <button data-id="${p.id}">Post</button>
    </div>
  `;
  const holder=card.querySelector(`#m-${p.id}`);
  if(p.mediaType==='video') holder.appendChild(createVideo(p.ipfsHash)); 
  else holder.appendChild(createImage(p.ipfsHash));

  // Likes
  const likeRef = ref(db,'posts/'+p.id+'/likes');
  get(likeRef).then(snap=>{const likes=snap.val()||[]; card.querySelector('.likeBtn .likeCount').textContent=`(${likes.length})`;});

  // Comments
  const commentsRef = ref(db,'posts/'+p.id+'/comments');
  onChildAdded(commentsRef, snap=>{const c=snap.val(); const container=card.querySelector(`#comments-${p.id}`); const div=document.createElement('div'); div.innerHTML=`<b>${escapeHTML(c.name)}:</b> ${escapeHTML(c.text)}`; container.appendChild(div);});

  return card;
}

function renderNextBatch(){
  if(index>=view.length) return;
  const end=Math.min(index+PAGE_SIZE,view.length);
  const frag=document.createDocumentFragment();
  for(let i=index;i<end;i++) frag.appendChild(renderCard(view[i]));
  posts.appendChild(frag);
  index=end;
  feedHint.style.display=index<view.length?'block':'none';
  setupPostActions();
}

function applySearch(){const term=(qIn.value||'').trim().toLowerCase(); view=all.filter(p=>(p.caption||'').toLowerCase().includes(term)); renderReset(); renderNextBatch(); }

async function getPosts(){const snap=await get(ref(db,'posts')); const obj=snap.val()||{}; all=Object.entries(obj).map(([id,v])=>({id,...v})).sort((a,b)=>b.timestamp-a.timestamp); applySearch(); }
qIn.oninput=()=>applySearch();
getPosts();

// --- Upload Post ---
fileIn.onchange=()=>{preview.innerHTML=''; if(fileIn.files[0]){const f=fileIn.files[0]; let elem=f.type.startsWith('video')?createVideo(URL.createObjectURL(f)):createImage(URL.createObjectURL(f)); elem.style.maxHeight='200px'; preview.appendChild(elem);}};
upload.onsubmit=async(e)=>{e.preventDefault(); if(!fileIn.files[0]) return alert('Choose a file'); if(capIn.value.trim().length<4) return alert('Caption too short'); const file=fileIn.files[0]; upload.querySelector('button').disabled=true; prog.style.display='block'; bar.style.width='0'; try{ const fd=new FormData(); fd.append('file',file); const xhr=new XMLHttpRequest(); xhr.open('POST','https://api.pinata.cloud/pinning/pinFileToIPFS'); xhr.setRequestHeader('Authorization',pinataJWT); xhr.upload.onprogress=(e)=>{if(e.lengthComputable) bar.style.width=(e.loaded/e.total)*100+'%';}; const cid=await new Promise((res,rej)=>{xhr.onload=()=>{try{res(JSON.parse(xhr.responseText).IpfsHash);}catch{rej('Upload failed');}};xhr.onerror=()=>rej('Upload failed'); xhr.send(fd);}); const id=push(ref(db,'posts')).key; await set(ref(db,'posts/'+id),{caption:capIn.value,ipfsHash:cid,mediaType:file.type.startsWith('video')?'video':'image',displayName:'DRFMedia',photoURL:'https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,_202025,_01_10_55%20PM.png',timestamp:Date.now()}); fileIn.value=''; capIn.value=''; preview.innerHTML=''; prog.style.display='none'; upload.querySelector('button').disabled=false; getPosts(); alert('Posted successfully!'); }catch(err){alert(err); upload.querySelector('button').disabled=false; prog.style.display='none';}}
document.getElementById('menuToggle').onclick=()=>$('primaryNav').classList.toggle('show');

// --- Likes, Comments, Share ---
function setupPostActions(){
  document.querySelectorAll('.likeBtn').forEach(btn=>{const postId=btn.dataset.id; btn.onclick=async()=>{ const postRef=ref(db,'posts/'+postId+'/likes'); const snap=await get(postRef); let likes=snap.val()||[]; if(!likes.includes('DRFMedia')) likes.push('DRFMedia'); else likes=likes.filter(uid=>uid!=='DRFMedia'); await set(postRef,likes); btn.querySelector('.likeCount').textContent=`(${likes.length})`;};});
  document.querySelectorAll('.commentBtn').forEach(btn=>{btn.onclick=()=>document.getElementById('input-'+btn.dataset.id).focus();});
  document.querySelectorAll('.shareBtn').forEach(btn=>{btn.onclick=()=>{const url=`${location.origin}${location.pathname}?post=${btn.dataset.id}`; navigator.clipboard.writeText(url).then(()=>alert('Post link copied!')).catch(()=>alert('Copy failed'));}});
  document.querySelectorAll('.comment-input button').forEach(btn=>{const postId=btn.dataset.id; const input=document.getElementById('input-'+postId); btn.onclick=async()=>{const text=input.value.trim(); if(!text) return; const newRef=push(ref(db,'posts/'+postId+'/comments')); await set(newRef,{name:'DRFMedia',text,timestamp:Date.now()}); input.value='';};});
}
</script>
</body>
</html>
