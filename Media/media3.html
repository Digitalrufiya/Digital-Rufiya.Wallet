// --- Likes toggle ---
async function toggleLike(post) {
  if (!currentUser) return alert("Please login to like.");
  const postRef = ref(db, `posts/${post.id}/likedBy/${currentUser.uid}`);
  const likesCountRef = ref(db, `posts/${post.id}/likesCount`);
  const likedNow = post.likedBy && post.likedBy[currentUser.uid];

  try {
    if (likedNow) {
      // Remove like
      await set(postRef, null);
      await updateCount(likesCountRef, -1);
    } else {
      // Add like
      await set(postRef, true);
      await updateCount(likesCountRef, 1);
    }
  } catch (e) {
    alert("Error toggling like: " + e.message);
  }
}

// --- Boost toggle (like super like) ---
async function toggleBoost(post) {
  if (!currentUser) return alert("Please login to boost.");
  const boostRef = ref(db, `posts/${post.id}/boostedBy/${currentUser.uid}`);
  const boostsCountRef = ref(db, `posts/${post.id}/boostsCount`);
  const boostedNow = post.boostedBy && post.boostedBy[currentUser.uid];

  try {
    if (boostedNow) {
      await set(boostRef, null);
      await updateCount(boostsCountRef, -1);
    } else {
      await set(boostRef, true);
      await updateCount(boostsCountRef, 1);
    }
  } catch (e) {
    alert("Error toggling boost: " + e.message);
  }
}

// --- Update count helper ---
async function updateCount(refPath, delta) {
  await get(refPath).then(snapshot => {
    let current = snapshot.val() || 0;
    current += delta;
    if (current < 0) current = 0;
    return set(refPath, current);
  });
}

// --- Delete post ---
async function deletePost(post) {
  if (!confirm("Delete this post?")) return;
  if (!currentUser || currentUser.uid !== post.userId) return alert("Not authorized.");
  try {
    await set(ref(db, `posts/${post.id}`), null);
    allPosts = allPosts.filter(p => p.id !== post.id);
    renderPosts();
  } catch (e) {
    alert("Error deleting post: " + e.message);
  }
}

// --- Post a comment ---
async function postComment(post, commentText, commentList, commentInput, commentForm) {
  if (!currentUser) return alert("Please login to comment.");
  try {
    const commentRef = push(ref(db, `posts/${post.id}/comments`));
    await set(commentRef, {
      userId: currentUser.uid,
      displayName: currentUser.displayName || "Anon",
      photoURL: currentUser.photoURL || "",
      text: commentText,
      timestamp: Date.now()
    });
    // Update comment count
    const commentsCountRef = ref(db, `posts/${post.id}/commentsCount`);
    await updateCount(commentsCountRef, 1);

    commentInput.value = "";
    commentForm.style.display = "none";

    // Refresh post comments in UI
    await fetchPostComments(post.id, commentList);
  } catch (e) {
    alert("Error posting comment: " + e.message);
  }
}

// --- Fetch and render comments ---
async function fetchPostComments(postId, commentList) {
  const commentsRef = ref(db, `posts/${postId}/comments`);
  const snapshot = await get(commentsRef);
  const comments = snapshot.val() || {};
  const sortedComments = Object.entries(comments)
    .map(([id, c]) => ({ id, ...c }))
    .sort((a, b) => a.timestamp - b.timestamp);

  commentList.innerHTML = '';
  if (sortedComments.length === 0) {
    commentList.innerHTML = "<em>No comments yet.</em>";
    return;
  }

  for (const c of sortedComments) {
    const commentEl = document.createElement('div');
    commentEl.style.padding = '0.3rem 0';
    commentEl.style.borderBottom = '1px solid #ddd';
    commentEl.innerHTML = `
      <strong>${esc(c.displayName)}</strong>: ${esc(c.text)}
      <div style="font-size:0.75rem;color:var(--text-muted);">
        ${new Date(c.timestamp).toLocaleString()}
      </div>
    `;
    commentList.appendChild(commentEl);
  }
}

// --- Render comments UI ---
function renderComments(post, commentList) {
  fetchPostComments(post.id, commentList);
}

// --- Share button ---
function sharePost(post) {
  const url = `${window.location.origin}${window.location.pathname}#post-${post.id}`;
  if (navigator.share) {
    navigator.share({
      title: `Check out this post by ${post.displayName}`,
      text: post.caption,
      url
    }).catch(e => alert("Share failed: " + e.message));
  } else {
    // fallback copy to clipboard
    navigator.clipboard.writeText(url).then(() => {
      alert("Post link copied to clipboard!");
    }).catch(() => {
      alert("Copy failed. Here's the link: " + url);
    });
  }
}
