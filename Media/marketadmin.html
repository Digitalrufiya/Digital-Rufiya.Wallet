<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Verification Panel â€” DRF</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #007bff; color: white; }
    button { padding: 6px 12px; margin: 0 4px; cursor: pointer; }
    .approved { background-color: #28a745; color: white; }
    .rejected { background-color: #dc3545; color: white; }
    .pending { background-color: #ffc107; color: black; }
    a { color: #007bff; text-decoration: none; }
  </style>
</head>
<body>
  <h2>Admin - User Verification Requests</h2>

  <table>
    <thead>
      <tr>
        <th>User ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Country</th>
        <th>Age</th>
        <th>Wallet</th>
        <th>Delivery</th>
        <th>ID Photo</th>
        <th>Passport Photo</th>
        <th>Real Photo</th>
        <th>Status</th>
        <th>Submitted At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="requestsBody">
      <tr><td colspan="14">Loading requests...</td></tr>
    </tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      update
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import {
      getAuth,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    // Firebase config - REPLACE with your actual config
    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.appspot.com",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const requestsBody = document.getElementById("requestsBody");

    // Admin login required
    onAuthStateChanged(auth, user => {
      if (user) {
        // Optional: You can check if user.uid is admin UID here for extra security
        loadRequests();
      } else {
        requestsBody.innerHTML = `<tr><td colspan="14">Please <button id="loginBtn">Login with Google</button> to view.</td></tr>`;
        document.getElementById("loginBtn").onclick = () => signInWithPopup(auth, provider);
      }
    });

    function loadRequests() {
      onValue(ref(db, "userVerifications"), snapshot => {
        const data = snapshot.val();
        if (!data) {
          requestsBody.innerHTML = `<tr><td colspan="14">No verification requests found.</td></tr>`;
          return;
        }

        requestsBody.innerHTML = "";

        for (const [uid, v] of Object.entries(data)) {
          const idPhotoLink = `https://gateway.pinata.cloud/ipfs/${v.idPhotoHash}`;
          const passportPhotoLink = `https://gateway.pinata.cloud/ipfs/${v.passportPhotoHash}`;
          const realPhotoLink = `https://gateway.pinata.cloud/ipfs/${v.realPhotoHash}`;
          const submittedDate = new Date(v.submittedAt).toLocaleString();

          requestsBody.innerHTML += `
            <tr>
              <td>${uid}</td>
              <td>${escapeHTML(v.name)}</td>
              <td>${escapeHTML(v.email)}</td>
              <td>${escapeHTML(v.phone)}</td>
              <td>${escapeHTML(v.country)}</td>
              <td>${v.age}</td>
              <td>${escapeHTML(v.walletAddress)}</td>
              <td>${escapeHTML(v.deliveryMethod)}</td>
              <td><a href="${idPhotoLink}" target="_blank">View</a></td>
              <td><a href="${passportPhotoLink}" target="_blank">View</a></td>
              <td><a href="${realPhotoLink}" target="_blank">View</a></td>
              <td class="${v.verificationStatus}">${v.verificationStatus}</td>
              <td>${submittedDate}</td>
              <td>
                <button onclick="updateStatus('${uid}', 'approved')" class="approved">Approve</button>
                <button onclick="updateStatus('${uid}', 'rejected')" class="rejected">Reject</button>
              </td>
            </tr>
          `;
        }
      });
    }

    // Sanitize output
    function escapeHTML(str) {
      if (!str) return "";
      return str.replace(/[&<>"]/g, c => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;"
      })[c]);
    }

    window.updateStatus = async function(uid, status) {
      if (!confirm(`Are you sure you want to mark this verification as ${status}?`)) return;
      try {
        await update(ref(db, `userVerifications/${uid}`), { verificationStatus: status });
        alert(`Verification ${status}.`);
      } catch (e) {
        alert("Failed to update status: " + e.message);
      }
    };
  </script>
</body>
</html>
