<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Donations</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .post { background: white; padding: 15px; margin-bottom: 20px; border-radius: 6px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .donation-buttons { margin-top: 10px; }
    .donation-buttons button {
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 0.9em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .rose { background-color: pink; }
    .lion { background-color: orange; color: white; }
    .dua { background-color: teal; color: white; }
    .star { background-color: gold; color: black; }
  </style>
</head>
<body>

<h2>DRFMedia Posts</h2>
<div id="postContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, onValue, set, push, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const app = initializeApp({
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
});

const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

let currentUser = null;
onAuthStateChanged(auth, user => {
  currentUser = user;
  if (!user) signInWithPopup(auth, provider).catch(console.error);
});

const postContainer = document.getElementById('postContainer');
const donationTypes = {
  rose: { label: "ðŸŒ¹ Rose ($1)", value: 1 },
  lion: { label: "ðŸ¦ Lion ($10)", value: 10 },
  dua:  { label: "ðŸ™ Dua ($20)", value: 20 },
  star: { label: "âœ¨ Star ($30)", value: 30 },
};

onValue(ref(db, 'posts'), snapshot => {
  const data = snapshot.val();
  postContainer.innerHTML = '';
  if (!data) return;

  Object.entries(data).forEach(([postId, post]) => {
    const postEl = document.createElement('div');
    postEl.className = 'post';
    postEl.innerHTML = `
      <strong>${post.displayName || 'Anonymous'}</strong>
      <p>${post.caption}</p>
      <div class="donation-buttons">
        ${Object.entries(donationTypes).map(([key, d]) => 
          `<button class="${key}" onclick="window.donate('${postId}', '${post.userId}', '${key}')">${d.label}</button>`
        ).join('')}
      </div>
    `;
    postContainer.appendChild(postEl);
  });
});

window.donate = async (postId, toUserId, type) => {
  if (!currentUser) return alert("Please sign in first.");
  const { uid } = currentUser;
  const donation = donationTypes[type];
  if (!donation) return;

  try {
    const coinRef = ref(db, `coins/${toUserId}/balance`);
    const snapshot = await get(coinRef);
    const current = snapshot.exists() ? snapshot.val() : 0;
    await set(coinRef, current + donation.value);

    const logRef = push(ref(db, `donations/${uid}`));
    await set(logRef, {
      type,
      amount: donation.value,
      toUserId,
      postId,
      timestamp: Date.now()
    });
    alert("Donation sent successfully!");
  } catch (err) {
    alert("Donation failed: " + err.message);
  }
};
</script>

</body>
</html>
