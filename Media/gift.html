<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia ‚Äî Donation Timeline</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #fff; color: #222; }
    header {
      background: #007bff; color: white; padding: 12px 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    h1 { margin: 0; font-size: 1.4em; }
    #walletInfo { background: #f1f1f1; padding: 10px 15px; display: none; }
    .post-card {
      border: 1px solid #ccc; border-radius: 8px; padding: 15px;
      margin: 15px auto; max-width: 700px; background: #fafafa;
    }
    .donate-btns button {
      margin: 5px 8px 5px 0; padding: 8px 14px;
      border: none; border-radius: 5px; font-size: 1em;
      cursor: pointer; font-weight: 600;
    }
    .rose { background: #e91e63; color: white; }
    .lion { background: #f39c12; color: white; }
    .dua  { background: #009688; color: white; }
    .star { background: #673ab7; color: white; }
    .highlight-btn {
      background: gold; color: black; font-weight: bold; margin-top: 10px;
    }
  </style>
</head>
<body>

<header>
  <h1>DRFMedia ‚Äî Donation Timeline</h1>
  <div>
    <button id="loginBtn">Sign in</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</header>

<div id="walletInfo">
  Welcome <span id="username"></span> | Coins: <strong id="coinBalance">0</strong>
</div>

<div id="postList"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase, ref, get, set
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import {
    getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const walletInfo = document.getElementById("walletInfo");
  const username = document.getElementById("username");
  const coinBalance = document.getElementById("coinBalance");

  let currentUser = null;

  onAuthStateChanged(auth, async user => {
    currentUser = user;
    loginBtn.style.display = user ? "none" : "inline-block";
    logoutBtn.style.display = user ? "inline-block" : "none";
    walletInfo.style.display = user ? "block" : "none";

    if (user) {
      username.textContent = user.displayName || "User";
      const coinsRef = ref(db, `coins/${user.uid}`);
      const snapshot = await get(coinsRef);
      coinBalance.textContent = snapshot.exists() ? snapshot.val() : 0;
    }

    renderPosts();
  });

  loginBtn.onclick = () => signInWithPopup(auth, provider).catch(err => alert(err.message));
  logoutBtn.onclick = () => signOut(auth);

  const dummyPosts = [
    { id: "p1", name: "Ahmad from Gaza", uid: "user1" },
    { id: "p2", name: "Fatima from Syria", uid: "user2" }
  ];

  async function donate(postId, value) {
    if (!currentUser) return alert("Login required");

    const post = dummyPosts.find(p => p.id === postId);
    if (!post) return alert("Post not found");

    const userCoinsRef = ref(db, `coins/${post.uid}`);
    const userSnap = await get(userCoinsRef);
    const currentCoins = userSnap.exists() ? userSnap.val() : 0;

    const coinMap = { rose: 1, lion: 10, dua: 20, star: 30 };
    const coins = coinMap[value];

    await set(userCoinsRef, currentCoins + coins);
    alert(`Donated ${coins} coins to ${post.name}`);

    // Update current user's own coin balance view if donating to self
    if (post.uid === currentUser.uid) {
      coinBalance.textContent = currentCoins + coins;
    }
  }

  function renderPosts() {
    const postList = document.getElementById("postList");
    postList.innerHTML = "";

    for (let post of dummyPosts) {
      const card = document.createElement("div");
      card.className = "post-card";
      card.innerHTML = `
        <h3>${post.name}</h3>
        <div class="donate-btns">
          <button class="rose" onclick="donate('${post.id}', 'rose')">üåπ Rose ($1)</button>
          <button class="lion" onclick="donate('${post.id}', 'lion')">ü¶Å Lion ($10)</button>
          <button class="dua"  onclick="donate('${post.id}', 'dua')">üôè Dua ($20)</button>
          <button class="star" onclick="donate('${post.id}', 'star')">‚ú® Star ($30)</button>
        </div>
        <button class="highlight-btn" disabled>üîí Only admin can highlight verified posts</button>
      `;
      postList.appendChild(card);
    }
  }

  window.donate = donate;
</script>

</body>
</html>
