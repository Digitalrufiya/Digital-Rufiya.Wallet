<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>DRFMedia â€” Post & View</title>

  <!-- keep external sheet if you have one -->
  <link rel="stylesheet" href="style.css" />

  <style>
    :root{
      --accent:#007bff;--accent-hover:#0056b3;--accent-muted:#3399ff;
      --bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;
      --text-body:#212529;--text-muted:#6c757d;--radius:.5rem;
      --shadow-sm:0 1px 2px rgba(0,0,0,.06);
    }
    @media(prefers-color-scheme:dark){
      :root{--bg-body:#181a1b;--bg-surface:#242628;--bg-surface-alt:#2b2e30;
            --text-body:#f1f3f5;--text-muted:#adb5bd;--shadow-sm:none;}
    }
    *{box-sizing:border-box;margin:0}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg-body);color:var(--text-body);min-height:100vh;
         display:flex;flex-direction:column}
    a{color:inherit;text-decoration:none}
    img,video{max-width:100%}
    /* header */
    header{background:var(--accent);color:#fff;padding:.75rem 1rem;display:flex;
           align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;
           position:sticky;top:0;z-index:100}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .brand img{width:2.25rem;height:2.25rem;border-radius:.25rem;background:#fff;padding:2px}
    #primaryNav{display:none;gap:.75rem;flex-wrap:wrap}
    #primaryNav a{font-weight:600}
    /* basic buttons */
    .btn{background:var(--accent);color:#fff;border:none;border-radius:var(--radius);
        padding:.5rem 1rem;font-weight:600;cursor:pointer;transition:background .2s}
    .btn:hover{background:var(--accent-hover)}
    .btn:disabled{background:#adb5bd;cursor:not-allowed}
    /* layout helpers */
    .container{width:min(100%,700px);margin:0 auto;padding:0 1rem}
    #pageWrapper{flex:1}
    #searchInput{width:100%;padding:.55rem .85rem;margin:1rem 0;
                 border:1px solid #ced4da;border-radius:var(--radius);
                 background:var(--bg-surface);color:var(--text-body)}
    /* post card */
    .post-item{background:var(--bg-surface-alt);border:1px solid #dee2e6;
               border-radius:var(--radius);padding:1rem;margin:1.25rem 0;
               box-shadow:var(--shadow-sm)}
    .post-owner{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;
            border:1px solid #ccc}
    .post-time{font-size:.8rem;color:var(--text-muted)}
    .post-caption{margin-top:.75rem;white-space:pre-wrap}
    /* media */
    video,img{border-radius:var(--radius);background:#000;display:block;
              opacity:0;transition:opacity .3s}
    [data-loaded="true"]{opacity:1}
    /* upload area */
    #uploadForm{margin-top:1.5rem}
    #uploadForm textarea{width:100%;min-height:6rem;margin:.75rem 0;
                         padding:.65rem .85rem;border:1px solid #ced4da;
                         border-radius:var(--radius);resize:vertical}
    /* tiny progress */
    #prog{width:100%;height:4px;background:#e9ecef;border-radius:2px;overflow:hidden;display:none}
    #progBar{height:4px;width:0;background:var(--accent)}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png" alt="logo" />
    <span>DRFMedia</span>
  </div>
  <!-- nav only when loggedâ€‘in -->
  <nav id="primaryNav"><a href="media.html">ðŸ“œ Go to Timeline</a></nav>
</header>

<div id="pageWrapper" class="container">
  <input id="searchInput" type="search" placeholder="Search postsâ€¦" aria-label="Search">
  <!-- auth buttons -->
  <button id="loginBtn"  class="btn" style="display:block;margin:.75rem 0;">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;margin:.75rem 0;background:#dc3545;">Logout</button>

  <!-- upload (hidden until login) -->
  <form id="uploadForm" style="display:none;">
    <input id="mediaFile" type="file" accept="image/*,video/*" required>
    <textarea id="caption" placeholder="Write your captionâ€¦" minlength="4" required></textarea>
    <div id="prog"><div id="progBar"></div></div>
    <button class="btn" type="submit" style="margin-top:.75rem;">Post</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

/* ==== CONFIG ==== */
const pinataJWT = "Bearer <YOURâ€‘PINATAâ€‘JWT>";
const firebaseConfig = {/* your firebase keys */};

/* ==== INIT ==== */
const app  = initializeApp(firebaseConfig);
const db   = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ==== DOM ==== */
const loginBtn   = document.getElementById("loginBtn");
const logoutBtn  = document.getElementById("logoutBtn");
const uploadForm = document.getElementById("uploadForm");
const fileInput  = document.getElementById("mediaFile");
const captionInp = document.getElementById("caption");
const postWrap   = document.getElementById("postContainer");
const searchInp  = document.getElementById("searchInput");
const nav        = document.getElementById("primaryNav");
const prog       = document.getElementById("prog");
const progBar    = document.getElementById("progBar");

let currentUser = null;
let allPosts    = [];

/* ==== UTILITIES ==== */
const esc = s => s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));

/* IPFS gateway fallback */
const gateways = ["https://gateway.pinata.cloud/ipfs/","https://cloudflare-ipfs.com/ipfs/","https://ipfs.io/ipfs/"];
const gwCache  = new Map();
async function gw(cid){
  if(gwCache.has(cid)) return gwCache.get(cid);
  for(const g of gateways){
    try{ if((await fetch(g+cid,{method:"HEAD"})).ok ){gwCache.set(cid,g+cid);return g+cid;} }catch{}
  }
  return null;
}

/* video lazy loader */
function loadVideo(v,url,max=3){
  let t=0;
  const tryLoad=()=>{v.src=url;v.load();};
  v.oncanplay=()=>{v.dataset.loaded="true";};
  v.onerror=()=>{ if(t<max){ setTimeout(tryLoad,2**++t*1e3);} };
  tryLoad();
}
const obs=new IntersectionObserver(es=>{
  es.filter(e=>e.isIntersecting).forEach(e=>{
    const v=e.target;
    loadVideo(v,v.dataset.src);
    obs.unobserve(v);
  });
},{threshold:.25});

/* ==== RENDER ==== */
async function renderPosts(){
  const q = searchInp.value.trim().toLowerCase();
  postWrap.innerHTML="";
  for(const p of allPosts){
    if(p.caption && !p.caption.toLowerCase().includes(q)) continue;
    const card=document.createElement("article");
    card.className="post-item";
    card.innerHTML=`
      <header class="post-owner">
        <img class="avatar" src="${p.photoURL||"https://via.placeholder.com/40"}" alt="">
        <div>
          <div>${esc(p.displayName||"Anon")}</div>
          <time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">
            ${new Date(p.timestamp).toLocaleString()}
          </time>
        </div>
      </header>
      <div class="post-caption">${esc(p.caption)}</div>
      <div class="post-media" id="m-${p.id}"></div>`;
    postWrap.append(card);

    const mWrap=card.querySelector(`#m-${p.id}`);
    if(p.mediaType==="video"){
      const url=await gw(p.ipfsHash);
      if(url){
        const v=document.createElement("video");
        v.controls=true;v.playsInline=true;v.preload="metadata";
        v.dataset.src=url;obs.observe(v);mWrap.replaceWith(v);
      }else mWrap.textContent="Video unavailable";
    }else{
      const img=document.createElement("img");
      img.src=`https://gateway.pinata.cloud/ipfs/${p.ipfsHash}`;
      img.alt="media";img.dataset.loaded="true";mWrap.replaceWith(img);
    }
  }
}

/* ==== AUTH ==== */
loginBtn.onclick = ()=>signInWithPopup(auth,provider);
logoutBtn.onclick= ()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  currentUser=u;
  const logged=!!u;
  loginBtn.style.display=logged?"none":"block";
  logoutBtn.style.display=logged?"block":"none";
  uploadForm.style.display=logged?"block":"none";
  nav.style.display=logged?"flex":"none";
  fetchPosts();
});

/* ==== FETCH POSTS ==== */
async function fetchPosts(){
  const snap = await get(ref(db,"posts"));
  const obj  = snap.val()||{};
  allPosts   = Object.entries(obj).map(([id,v])=>({id,...v})).sort((a,b)=>b.timestamp-a.timestamp);
  renderPosts();
}
searchInp.oninput=renderPosts;

/* ==== UPLOAD ==== */
uploadForm.onsubmit = async e =>{
  e.preventDefault();
  if(!fileInput.files[0]) return alert("Choose a file");
  if(captionInp.value.trim().length<4) return alert("Caption too short");

  uploadForm.querySelector("button").disabled=true;
  prog.style.display="block";progBar.style.width="0";

  try{
    /* progress via XMLHttpRequest (fetch doesnâ€™t expose) */
    const fd=new FormData();fd.append("file",fileInput.files[0]);
    const xhr=new XMLHttpRequest();
    xhr.open("POST","https://api.pinata.cloud/pinning/pinFileToIPFS");
    xhr.setRequestHeader("Authorization",pinataJWT);
    xhr.upload.onprogress=e=>{
      if(e.lengthComputable){
        const pct=(e.loaded/e.total)*100;
        progBar.style.width=pct+"%";
      }
    };
    const ipfsHash = await new Promise((res,rej)=>{
      xhr.onload=()=>{ try{res(JSON.parse(xhr.responseText).IpfsHash);}catch{rej("Bad Pinata response");} };
      xhr.onerror=()=>rej("Upload failed");
      xhr.send(fd);
    });

    const newRef=push(ref(db,"posts"));
    await set(newRef,{
      userId:currentUser.uid,displayName:currentUser.displayName||"Anon",
      photoURL:currentUser.photoURL||"",caption:captionInp.value.trim(),
      ipfsHash,mediaType:fileInput.files[0].type.startsWith("video")?"video":"image",
      timestamp:Date.now()
    });

    fileInput.value="";captionInp.value="";
    progBar.style.width="100%"; setTimeout(()=>{prog.style.display="none";},500);
    fetchPosts(); // refresh
  }catch(err){alert(err);}
  finally{uploadForm.querySelector("button").disabled=false;}
};
</script>
</body>
</html>
