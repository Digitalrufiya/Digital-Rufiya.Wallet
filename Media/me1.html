<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRFMedia Wallet</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<style>
  body { text-align:center; font-family:sans-serif; background:#f0fcf9; margin:0; }
  .container { margin-top:20px; }
  img.logo { width:100px; margin-bottom:10px; }
  h1 { margin:10px 0; }
  button { margin:5px; padding:10px 20px; border:none; border-radius:5px; background:#0baf9a; color:#fff; cursor:pointer; }
  button:hover { background:#08806f; }
  #walletAddress { margin-top:20px; font-weight:bold; }
  .loader { margin:auto; border:4px solid #f3f3f3; border-top:4px solid #0baf9a; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
</style>
</head>
<body>

<div class="container" id="mainContent">
  <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT_DRFMEDIA_Logo.png" alt="DRFMedia Logo" class="logo">
  <h1>Welcome to Islamic Social Media</h1>
  <p>Secure, Private, Decentralized</p>

  <button onclick="createAccount()">Create Account</button>
  <button onclick="login()">Login</button>
  <button onclick="recoverAccount()">Recover Account</button>

  <p id="walletAddress"></p>
</div>

<script>
  const $ = id => document.getElementById(id);

  function showLoading(message) {
    const container = $('mainContent');
    container.innerHTML = `
      <div style="margin-top:100px;">
        <div class="loader"></div>
        <p style="margin-top:20px;">${message}</p>
      </div>
    `;
  }

  async function createAccount() {
    const username = prompt("Choose a unique username:");
    if (!username) return alert("Username is required.");

    const password = prompt("Set a password to encrypt your wallet:");
    if (!password) return alert("Password is required.");

    showLoading("Creating your DRF Wallet...");
    await new Promise(res => setTimeout(res, 500));

    const wallet = ethers.Wallet.createRandom();
    const encryptedJson = await wallet.encrypt(password);

    localStorage.setItem("drf_user_data", JSON.stringify({ username, encryptedJson }));
    localStorage.setItem("drf_encrypted_wallet", encryptedJson);

    const secretPhrase = wallet.mnemonic.phrase;
    alert("Wallet created! Secret phrase:\n\n" + secretPhrase + "\n\nSave it securely!");
    
    $('mainContent').innerHTML = `
      <h2>Welcome, ${username}!</h2>
      <p>Your wallet address: ${wallet.address}</p>
      <p>Redirecting to media page...</p>
    `;

    setTimeout(() => window.location.href = "media.html", 2000);
  }

  async function login() {
    const userData = localStorage.getItem("drf_user_data");
    const encryptedWallet = localStorage.getItem("drf_encrypted_wallet");

    if (!userData && !encryptedWallet) return alert("No wallet found. Please create or recover one.");

    const password = prompt("Enter your wallet password:");
    showLoading("Logging in...");
    await new Promise(res => setTimeout(res, 500));

    try {
      let encryptedJson, username;
      if (userData) {
        const parsed = JSON.parse(userData);
        encryptedJson = parsed.encryptedJson;
        username = parsed.username;
      } else {
        encryptedJson = encryptedWallet;
        username = "Legacy User";
      }

      const wallet = await ethers.Wallet.fromEncryptedJson(encryptedJson, password);
      localStorage.setItem("drf_active_wallet", wallet.address);
      localStorage.setItem("drf_username", username);

      $('mainContent').innerHTML = `
        <h2>Welcome back, ${username}!</h2>
        <p>Your wallet address: ${wallet.address}</p>
        <p>Redirecting to media page...</p>
      `;

      setTimeout(() => window.location.href = "media.html", 2000);
    } catch (err) {
      alert("Login failed. Incorrect password or wallet corrupted.");
      location.reload();
    }
  }

  async function recoverAccount() {
    const phrase = prompt("Enter your 12-word secret phrase:");
    if (!phrase || phrase.trim().split(" ").length !== 12) return alert("Invalid secret phrase.");

    const username = prompt("Enter a username to recover your profile:");
    if (!username) return alert("Username is required.");

    const password = prompt("Set a password to encrypt your recovered wallet:");
    if (!password) return alert("Password is required.");

    showLoading("Recovering your wallet...");
    await new Promise(res => setTimeout(res, 500));

    try {
      const wallet = ethers.Wallet.fromMnemonic(phrase.trim());
      const encryptedJson = await wallet.encrypt(password);

      localStorage.setItem("drf_user_data", JSON.stringify({ username, encryptedJson }));
      localStorage.setItem("drf_encrypted_wallet", encryptedJson);

      $('mainContent').innerHTML = `
        <h2>Welcome, ${username}!</h2>
        <p>Your wallet address: ${wallet.address}</p>
        <p>Redirecting to media page...</p>
      `;

      setTimeout(() => window.location.href = "media.html", 2000);
    } catch (err) {
      alert("Failed to recover wallet. Please check your phrase.");
      location.reload();
    }
  }
</script>

</body>
</html>
