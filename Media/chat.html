<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DRFMessenger</title>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Emoji picker -->
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.8.2/index.js" type="module"></script>

  <style>
    *{box-sizing:border-box;}
    body{font-family:Arial,sans-serif;margin:0;height:100vh;display:flex;flex-direction:column;background:#f0f2f5;}

    /* ===== Top Menu ===== */
    nav.topmenu{
      display:flex;
      justify-content:space-around;
      align-items:center;
      background:#0066cc;
      color:#fff;
      padding:12px;
      font-size:1rem;
      font-weight:600;
    }
    nav.topmenu a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:6px;}
    nav.topmenu a.active,
    nav.topmenu a:hover{background:rgba(255,255,255,0.2);}

    nav.titlebar{
      background:#004a99;
      color:#fff;
      padding:14px;
      text-align:center;
      font-weight:bold;
      font-size:1.2rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    #toggleUsersBtn{background:none;border:none;color:#fff;font-size:22px;cursor:pointer;display:none;}

    #loginBtn{margin-top:10px;padding:12px 22px;font-size:1rem;cursor:pointer;border:none;border-radius:6px;background:#fff;color:#0066cc;font-weight:bold;}

    #container{display:none;flex:1;overflow:hidden;display:flex;position:relative;}

    /* ===== User list (hidden on mobile) ===== */
    #usersList{
      width:260px;background:#fff;border-right:1px solid #ccc;
      overflow-y:auto;display:flex;flex-direction:column;
      transition:transform 0.3s ease;
    }
    #usersList h2{margin:0;padding:15px;background:#0066cc;color:#fff;font-size:1.1rem;}
    #searchUserInput{margin:12px;padding:10px 14px;border-radius:10px;border:1px solid #bbb;font-size:1rem;outline:none;}

    #userListContent{flex:1;overflow-y:auto;padding-bottom:10px;}
    .user-item{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid #eee;cursor:pointer;font-size:1.05rem;}
    .user-item:hover{background:#e6f2ff;}
    .user-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid #ccc;}
    .user-name{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    /* ===== Chat area ===== */
    #chatArea{flex:1;display:flex;flex-direction:column;background:#fff;}
    #chatHeader{padding:15px;border-bottom:1px solid #ccc;background:#f7f7f7;font-weight:bold;font-size:1.1rem;}
    #messagesContainer{flex:1;padding:12px;overflow-y:auto;background:#f0f0f0;display:flex;flex-direction:column;}
    .message{max-width:75%;padding:10px 14px;margin:8px 0;border-radius:16px;word-break:break-word;font-size:1rem;line-height:1.4;}
    .sent{background:#007bff;color:#fff;align-self:flex-end;border-bottom-right-radius:4px;}
    .received{background:#e4e6eb;color:#000;align-self:flex-start;border-bottom-left-radius:4px;}
    .preview{margin-top:6px;padding:6px;border:1px solid #ccc;border-radius:8px;background:#fff;}
    .preview img{max-width:100%;border-radius:4px;}

    /* ===== Input area ===== */
    #inputArea{display:flex;padding:10px;border-top:1px solid #ccc;background:#f7f7f7;align-items:center;}
    #inputMessage{flex:1;border:1px solid #ccc;padding:10px 14px;border-radius:20px;height:44px;resize:none;font-size:1rem;}
    #sendBtn{margin-left:8px;padding:0 18px;height:44px;border:none;border-radius:20px;background:#0066cc;color:#fff;cursor:pointer;font-weight:600;}
    #sendBtn:disabled{background:#aaa;cursor:not-allowed;}
    #emojiBtn{background:none;border:none;font-size:22px;margin-left:8px;cursor:pointer;}
    emoji-picker{position:absolute;bottom:60px;right:20px;display:none;z-index:10;}

    #loginNotice{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;}

    /* ===== Mobile view ===== */
    @media(max-width:768px){
      #usersList{position:absolute;left:0;top:0;bottom:0;width:80%;max-width:300px;z-index:100;background:#fff;transform:translateX(-100%);}
      #usersList.show{transform:translateX(0);}
      #toggleUsersBtn{display:block;}
    }
  </style>
</head>
<body>
  <!-- Top menu -->
  <nav class="topmenu">
    <a href="media.html">Timeline</a>
    <a href="profile.html">Profile</a>
    <a href="media.html">Posts</a>
    <a href="gift.html">Donation</a>
    <a href="chat.html" class="active">Chat</a>
  </nav>

  <nav class="titlebar">
    <span>DRFMessenger</span>
    <button id="toggleUsersBtn">â˜°</button>
  </nav>

  <!-- Login -->
  <div id="loginNotice">
    <p>Please sign in with Google to use the chat.</p>
    <button id="loginBtn">Sign in with Google</button>
  </div>

  <!-- Messenger -->
  <div id="container">
    <div id="usersList">
      <h2>Users</h2>
      <input id="searchUserInput" type="text" placeholder="Search by name or wallet address" />
      <div id="userListContent"></div>
    </div>
    <div id="chatArea">
      <div id="chatHeader">Select a user to chat</div>
      <div id="messagesContainer"></div>
      <div id="inputArea">
        <textarea id="inputMessage" placeholder="Type a messageâ€¦" disabled></textarea>
        <button id="emojiBtn">ðŸ˜Š</button>
        <button id="sendBtn" disabled>Send</button>
        <emoji-picker id="picker"></emoji-picker>
      </div>
    </div>
  </div>

<script>
/* ---------- Firebase init ---------- */
const firebaseConfig = {
  apiKey:  "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket:"drfsocial-23a06.appspot.com",
  messagingSenderId:"608135115201",
  appId:"1:608135115201:web:dc999df2c0c37241ff3f40"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ---------- DOM refs ---------- */
const loginNotice = document.getElementById('loginNotice');
const loginBtn = document.getElementById('loginBtn');
const container = document.getElementById('container');
const userListContent = document.getElementById('userListContent');
const searchUserInput = document.getElementById('searchUserInput');
const chatHeaderEl = document.getElementById('chatHeader');
const messagesContainer = document.getElementById('messagesContainer');
const inputMessageEl = document.getElementById('inputMessage');
const sendBtnEl = document.getElementById('sendBtn');
const emojiBtn = document.getElementById('emojiBtn');
const emojiPicker = document.getElementById('picker');
const toggleUsersBtn = document.getElementById('toggleUsersBtn');
const usersListEl = document.getElementById('usersList');

/* ---------- State ---------- */
let currentUser  = null;
let selectedUser = null;
let messagesRef  = null;
let allUsers     = [];

/* ---------- Toggle users panel ---------- */
toggleUsersBtn.onclick = () => {
  usersListEl.classList.toggle("show");
};

/* ---------- Auth flow ---------- */
loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message));
auth.onAuthStateChanged(user=>{
  if(!user){
    currentUser = null;
    loginNotice.style.display='flex';
    container.style.display='none';
    return;
  }
  currentUser = user;
  loginNotice.style.display='none';
  container.style.display='flex';
  loadUsers();
});

/* ---------- Load users ---------- */
function loadUsers(){
  db.ref('profiles').once('value').then(snap=>{
    allUsers = [];
    snap.forEach(child=>{
      const uid = child.key;
      const u = child.val();
      if(uid === currentUser.uid) return;
      allUsers.push({ uid, name: u.name || uid, photoUrl: u.photoUrl });
    });
    renderUserList('');
  });
}
searchUserInput.addEventListener('input', ()=>{
  const filter = searchUserInput.value.trim().toLowerCase();
  renderUserList(filter);
});
function renderUserList(filter){
  userListContent.innerHTML = '';
  const filtered = allUsers.filter(u =>
    u.name.toLowerCase().includes(filter) || u.uid.toLowerCase().includes(filter)
  );
  if(filtered.length === 0){
    userListContent.innerHTML = "<p style='padding:10px;color:#888'>No users found</p>";
    return;
  }
  for(const u of filtered){
    const div = document.createElement('div');
    div.className = 'user-item';
    div.innerHTML = `<img src="${u.photoUrl || 'https://i.pravatar.cc/40'}" class="user-avatar"><div class="user-name">${u.name}</div>`;
    div.onclick = () => {
      selectUser(u.uid, u.name);
      usersListEl.classList.remove("show"); // hide list on mobile
    };
    userListContent.appendChild(div);
  }
}

/* ---------- Select chat partner ---------- */
function selectUser(uid,name){
  selectedUser = {uid,name};
  chatHeaderEl.textContent = 'Chat with ' + name;
  inputMessageEl.disabled = false;
  sendBtnEl.disabled = true;
  inputMessageEl.value = '';
  messagesContainer.innerHTML = '';
  if(messagesRef) messagesRef.off();
  messagesRef = db.ref(chatPath(currentUser.uid, uid));
  messagesRef.off();
  messagesRef.on('child_added', snap => renderMessage(snap.val()));
}
const chatPath = (uidA, uidB) => {
  const [u1,u2] = [uidA, uidB].sort();
  return `messages/${u1}/${u2}`;
};

/* ---------- Render message ---------- */
function renderMessage(m){
  const div = document.createElement('div');
  div.className = 'message ' + (m.sender === currentUser.uid ? 'sent' : 'received');
  div.innerHTML = m.text;
  messagesContainer.appendChild(div);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

/* ---------- Sending ---------- */
inputMessageEl.oninput = () => sendBtnEl.disabled = inputMessageEl.value.trim().length === 0;
sendBtnEl.onclick = () => {
  const txt = inputMessageEl.value.trim();
  if (!txt || !selectedUser) return;
  sendBtnEl.disabled = true;
  db.ref(chatPath(currentUser.uid, selectedUser.uid)).push({
    sender: currentUser.uid,
    text: txt,
    timestamp: Date.now()
  }).then(() => {
    inputMessageEl.value = '';
    sendBtnEl.disabled = true;
  });
};
inputMessageEl.onkeydown = e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtnEl.click();
  }
};

/* ---------- Emoji ---------- */
emojiBtn.onclick = () => {
  emojiPicker.style.display = (emojiPicker.style.display === 'block') ? 'none' : 'block';
};
emojiPicker.addEventListener('emoji-click', e => {
  inputMessageEl.value += e.detail.unicode;
  inputMessageEl.dispatchEvent(new Event('input'));
  inputMessageEl.focus();
});
</script>
</body>
</html>
