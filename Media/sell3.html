<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia Marketplace — Buy & Sell</title>
<style>
  /* Your full CSS here (same as you shared) */
  /* For brevity, I’m not repeating the whole style, but it’s the exact same */
</style>
</head>
<body>
<header>
  <div class="brand">
    <img src="logo.png" alt="logo" />
    <span>DRFMedia Marketplace</span>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">☰</button>
  <nav id="primaryNav">
    <a href="media.html" class="active">timeline</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Donate Ghaza</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search products…" />
  <button id="loginBtn" class="btn">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;background:#dc3545">Logout</button>

  <form id="uploadForm" style="display:none" autocomplete="off">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <input id="productTitle" type="text" placeholder="Product Title" minlength="2" required />
    <input id="productPrice" type="number" min="0" step="0.01" placeholder="Price (MVR)" required />
    <input id="productLocation" type="text" placeholder="Location (optional)" />
    <input id="productContact" type="text" placeholder="WhatsApp or Phone Number" minlength="5" required />
    <input id="paymentLink" type="url" placeholder="DRF Wallet Payment Link (optional)" />
    <div id="prog" style="display:none"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post Product</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>

  <div class="disclaimer">
    ⚠️ DRFMedia is a marketplace platform only. We do not guarantee payment, delivery, or product authenticity. Always verify before buying or sending money.
  </div>
</main>

<script type="module">
  const menuToggle = document.getElementById("menuToggle");
  const primaryNav = document.getElementById("primaryNav");

  if(window.innerWidth <= 600) primaryNav.style.display = "none";

  menuToggle.addEventListener("click", () => {
    primaryNav.style.display = (primaryNav.style.display === "flex") ? "none" : "flex";
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    a.addEventListener("click", () => {
      if (window.innerWidth <= 600) primaryNav.style.display = "none";
    });
  });
  document.addEventListener("click", (e) => {
    const target = e.target;
    if (window.innerWidth <= 600 && !primaryNav.contains(target) && target !== menuToggle) {
      primaryNav.style.display = "none";
    }
  });
  [...primaryNav.querySelectorAll("a")].forEach(a => {
    if (location.pathname.endsWith(a.getAttribute("href"))) {
      a.classList.add("active");
    } else {
      a.classList.remove("active");
    }
  });

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
    measurementId: "G-TBFQX80NRP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const $ = (id) => document.getElementById(id);
  const login = $("loginBtn"),
        logout = $("logoutBtn");
  const upload = $("uploadForm"),
        fileIn = $("mediaFile"),
        titleIn = $("productTitle"),
        priceIn = $("productPrice"),
        locationIn = $("productLocation"),
        contactIn = $("productContact"),
        paymentLinkIn = $("paymentLink");
  const prog = $("prog"),
        bar = $("progBar");
  const posts = $("postContainer"),
        qIn = $("searchInput"),
        nav = $("primaryNav");

  let user = null, all = [];

  const escapeHTML = (s) =>
    s.replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    }[m]));

  async function getGatewayUrl(cid) {
    const gateways = [
      "https://gateway.pinata.cloud/ipfs/",
      "https://cloudflare-ipfs.com/ipfs/",
      "https://ipfs.io/ipfs/",
    ];
    for (const g of gateways) {
      try {
        const res = await fetch(g + cid, { method: "HEAD" });
        if (res.ok) return g + cid;
      } catch {}
    }
    return null;
  }

  function lazyLoadVideo(video) {
    video.dataset.loaded = false;
    video.oncanplay = () => (video.dataset.loaded = "true");
    video.onerror = () => {
      if (!video.retryCount) video.retryCount = 0;
      if (video.retryCount < 3) {
        setTimeout(() => {
          video.src = video.dataset.src;
          video.load();
          video.retryCount++;
        }, 2 ** video.retryCount * 1000);
      }
    };
    video.src = video.dataset.src;
    video.load();
  }

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          lazyLoadVideo(entry.target);
          obs.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.5 }
  );

  function createPostHTML(post) {
    const { cid, title, price, location, contact, paymentLink } = post;
    let mediaURL = `https://gateway.pinata.cloud/ipfs/${cid}`;
    const ext = cid.split(".").pop().toLowerCase();
    let html = `<article class="product">`;
    if (/\.(mp4|webm)$/i.test(cid)) {
      html += `<video controls playsinline muted loop preload="metadata" data-src="${mediaURL}"></video>`;
    } else {
      html += `<img src="${mediaURL}" loading="lazy" alt="${escapeHTML(title)}" />`;
    }
    html += `
      <div class="title">${escapeHTML(title)}</div>
      <div class="price">Price: ${escapeHTML(price)} MVR</div>
      <div class="location">Location: ${escapeHTML(location || "N/A")}</div>
      <div class="contact">Contact: ${escapeHTML(contact)}</div>
    `;
    if (paymentLink) {
      html += `<a href="${escapeHTML(paymentLink)}" target="_blank" rel="noopener" class="payment">Pay Here</a>`;
    }
    html += `</article>`;
    return html;
  }

  function renderPosts(postsArr) {
    posts.innerHTML = "";
    postsArr.forEach(post => {
      const div = document.createElement("div");
      div.innerHTML = createPostHTML(post);
      posts.appendChild(div.firstElementChild);
    });

    // Observe all videos for lazy loading
    posts.querySelectorAll("video").forEach(video => observer.observe(video));
  }

  async function fetchPosts() {
    try {
      const snapshot = await get(ref(db, "posts"));
      if (snapshot.exists()) {
        all = Object.values(snapshot.val());
        renderPosts(all);
      }
    } catch (e) {
      console.error("Failed to fetch posts:", e);
    }
  }

  qIn.addEventListener("input", () => {
    const query = qIn.value.toLowerCase();
    const filtered = all.filter(p =>
      p.title.toLowerCase().includes(query) ||
      (p.location && p.location.toLowerCase().includes(query)) ||
      (p.contact && p.contact.toLowerCase().includes(query))
    );
    renderPosts(filtered);
  });

  login.addEventListener("click", () => {
    signInWithPopup(auth, provider).catch(console.error);
  });

  logout.addEventListener("click", () => {
    signOut(auth).catch(console.error);
  });

  onAuthStateChanged(auth, (u) => {
    user = u;
    if (user) {
      login.style.display = "none";
      logout.style.display = "inline-block";
      upload.style.display = "block";
    } else {
      login.style.display = "inline-block";
      logout.style.display = "none";
      upload.style.display = "none";
    }
  });

  upload.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!user) {
      alert("Please sign in to post.");
      return;
    }
    const file = fileIn.files[0];
    if (!file) {
      alert("Please select a media file.");
      return;
    }
    const title = titleIn.value.trim();
    const price = priceIn.value.trim();
    const location = locationIn.value.trim();
    const contact = contactIn.value.trim();
    const paymentLink = paymentLinkIn.value.trim();

    prog.style.display = "block";
    bar.style.width = "0%";

    try {
      const formData = new FormData();
      formData.append("file", file);
      // Pinata upload
      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        headers: {
          Authorization: pinataJWT,
        },
        body: formData,
      });
      if (!res.ok) throw new Error("Pinata upload failed");
      const data = await res.json();
      const cid = data.IpfsHash;

      // Save metadata in Firebase DB
      const postRef = push(ref(db, "posts"));
      await set(postRef, {
        cid,
        title,
        price,
        location,
        contact,
        paymentLink,
        timestamp: Date.now(),
        userId: user.uid,
      });

      alert("Product posted successfully!");
      upload.reset();
      prog.style.display = "none";
      bar.style.width = "0%";

      await fetchPosts();
    } catch (err) {
      alert("Upload failed: " + err.message);
      prog.style.display = "none";
      bar.style.width = "0%";
    }
  });

  fetchPosts();
</script>
</body>
</html>
