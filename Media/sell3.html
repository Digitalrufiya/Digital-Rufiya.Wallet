<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced Marketplace with IPFS + Firebase + Infinite Scroll</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0; background: #f9f9f9;
    }
    header {
      background: #0046d5;
      color: white;
      padding: 20px;
      text-align: center;
    }
    main {
      max-width: 700px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    form > * {
      display: block;
      width: 100%;
      margin-bottom: 15px;
    }
    input[type="text"], textarea {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      background: #0046d5;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #0035a0;
    }
    .post {
      border-bottom: 1px solid #ddd;
      padding: 15px 0;
    }
    .post:last-child {
      border-bottom: none;
    }
    .post h3 {
      margin: 0 0 5px;
    }
    .post small {
      color: #666;
    }
    #loading {
      text-align: center;
      padding: 20px;
      font-size: 18px;
      color: #666;
    }
  </style>
</head>
<body>

<header>
  <h1>Global Marketplace - Upload & Browse</h1>
</header>

<main>
  <form id="uploadForm">
    <input type="text" id="title" placeholder="Post Title" required />
    <textarea id="description" placeholder="Description" rows="3" required></textarea>
    <input type="file" id="fileInput" accept="image/*,video/*" required />
    <button type="submit">Upload & Post</button>
  </form>

  <div id="posts"></div>
  <div id="loading">Loading...</div>
</main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // ====== Firebase Setup =======
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
    measurementId: "G-TBFQX80NRP"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ====== Pinata Upload =======
  async function uploadToPinata(file) {
    const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
    const formData = new FormData();
    formData.append('file', file);

  const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";
  const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";


    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer YOUR_PINATA_JWT` // OR use key & secret in headers
      },
      body: formData
    });

    if (!response.ok) {
      throw new Error('Failed to upload to Pinata');
    }

    const data = await response.json();
    return data.IpfsHash;  // The IPFS hash for your file
  }

  // ====== UI & Upload Logic =======
  const uploadForm = document.getElementById('uploadForm');
  const postsContainer = document.getElementById('posts');
  const loadingIndicator = document.getElementById('loading');

  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    loadingIndicator.textContent = 'Uploading...';
    loadingIndicator.style.display = 'block';

    try {
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const fileInput = document.getElementById('fileInput');
      if (fileInput.files.length === 0) throw new Error('No file selected');

      const file = fileInput.files[0];
      const ipfsHash = await uploadToPinata(file);

      // Save post data in Firestore
      await db.collection('uploads').add({
        title,
        description,
        ipfsHash,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Clear form
      uploadForm.reset();
      loadingIndicator.textContent = 'Upload successful!';

      // Reload posts from top (optional: reload or prepend new post)
      resetAndLoadPosts();

    } catch (error) {
      loadingIndicator.textContent = 'Upload failed: ' + error.message;
      console.error(error);
    }
  });

  // ====== Render Posts =======
  function renderPost(doc) {
    const data = doc.data();
    const postDiv = document.createElement('div');
    postDiv.className = 'post';

    // File URL on IPFS gateway
    const fileUrl = `https://gateway.pinata.cloud/ipfs/${data.ipfsHash}`;

    // Check if image or video based on file extension
    let mediaHtml = '';
    if (/\.(mp4|webm|ogg)$/i.test(fileUrl)) {
      mediaHtml = `<video controls width="100%" style="max-height:300px;">
        <source src="${fileUrl}" type="video/mp4" />
        Your browser does not support video.
      </video>`;
    } else {
      mediaHtml = `<img src="${fileUrl}" alt="${data.title}" style="max-width:100%; max-height:300px; border-radius:6px;" />`;
    }

    postDiv.innerHTML = `
      <h3>${data.title || 'No Title'}</h3>
      <p>${data.description || ''}</p>
      ${mediaHtml}
      <small>Posted on: ${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'Loading...'}</small>
    `;

    postsContainer.appendChild(postDiv);
  }

  // ====== Infinite Scroll Logic =======
  const pageSize = 10;
  let lastVisible = null;
  let loading = false;
  let noMorePosts = false;

  async function loadPosts() {
    if (loading || noMorePosts) return;
    loading = true;
    loadingIndicator.style.display = 'block';
    loadingIndicator.textContent = 'Loading posts...';

    let query = db.collection('uploads').orderBy('timestamp', 'desc').limit(pageSize);
    if (lastVisible) {
      query = query.startAfter(lastVisible);
    }

    try {
      const snapshot = await query.get();

      if (snapshot.empty) {
        noMorePosts = true;
        loadingIndicator.textContent = "No more posts";
        return;
      }

      snapshot.forEach(doc => {
        renderPost(doc);
      });

      lastVisible = snapshot.docs[snapshot.docs.length - 1];
      loadingIndicator.style.display = 'none';
      loading = false;
    } catch (error) {
      console.error("Error loading posts:", error);
      loadingIndicator.textContent = "Error loading posts.";
      loading = false;
    }
  }

  // Reset posts & reload from first page (called after upload)
  function resetAndLoadPosts() {
    postsContainer.innerHTML = '';
    lastVisible = null;
    noMorePosts = false;
    loadPosts();
  }

  // Scroll event to trigger load more
  window.addEventListener('scroll', () => {
    if (noMorePosts || loading) return;

    const scrollPosition = window.innerHeight + window.scrollY;
    const threshold = document.body.offsetHeight - 150;

    if (scrollPosition >= threshold) {
      loadPosts();
    }
  });

  // Initial posts load
  loadPosts();

</script>

</body>
</html>
