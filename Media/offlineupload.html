<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia ‚Äî Offline Upload PWA</title>

<!-- service‚Äëworker registration -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js")
    .then(() => console.log("SW registered ‚úÖ"))
    .catch(e  => console.error("SW registration failed ‚ùå", e));
}
</script>

<link rel="stylesheet" href="style.css" />
<style>
/* super‚Äësimple demo styles */
body{font-family:Arial,sans-serif;margin:2rem auto;max-width:600px}
input,textarea{width:100%;margin-top:1rem;padding:.5rem}
.btn{display:inline-block;background:#007bff;color:#fff;border:none;
     padding:.6rem 1rem;margin-top:1rem;border-radius:4px;cursor:pointer}
.btn:disabled{background:#aaa}
</style>
</head>
<body>
<h1>Offline Upload Demo</h1>

<input type="file" id="mediaFile" />
<textarea id="caption" placeholder="Write caption‚Ä¶"></textarea>
<button class="btn" id="uploadBtn">Upload</button>

<script type="module">
/* ---------- CONFIG: put your real keys here ---------- */
const pinataJWT = "Bearer YOUR_REAL_PINATA_JWT_HERE";
const firebaseConfig = {
  apiKey:            "YOUR_KEY",
  authDomain:        "your-project.firebaseapp.com",
  databaseURL:       "https://your-project-default-rtdb.firebaseio.com",
  projectId:         "your-project",
  storageBucket:     "your-project.appspot.com",
  messagingSenderId: "000000000000",
  appId:             "1:000000000000:web:abcdef123456"
};
/* ------------------------------------------------------ */

import { initializeApp }     from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set }  from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* --------- IndexedDB helpers --------- */
function openDB(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open("drfmedia",1);
    r.onupgradeneeded = ()=>r.result.createObjectStore("uploads",{keyPath:"id",autoIncrement:true});
    r.onsuccess = ()=>res(r.result);
    r.onerror   = ()=>rej(r.error);
  });
}
async function queueUpload(file,caption){
  const db = await openDB();
  await db.transaction("uploads","readwrite").objectStore("uploads")
           .add({file,caption,ts:Date.now()});
  db.close();
}

/* --------- DOM --------- */
const fileIn = document.getElementById("mediaFile");
const capIn  = document.getElementById("caption");
const btn    = document.getElementById("uploadBtn");

btn.onclick = async ()=>{
  if(!fileIn.files[0])      return alert("Choose file");
  if(capIn.value.trim().length<3) return alert("Write caption");

  btn.disabled=true;

  try{
    if(!navigator.onLine){
      await queueUpload(fileIn.files[0],capIn.value.trim());
      if("SyncManager" in window){
        const reg = await navigator.serviceWorker.ready;
        await reg.sync.register("upload-posts");
      }
      alert("üì• Queued offline. Will upload when online.");
    }else{
      await uploadNow(fileIn.files[0],capIn.value.trim());
      alert("Uploaded immediately ‚úÖ");
    }
    fileIn.value=\"\";capIn.value=\"\";
  }catch(e){alert(e.message);}
  finally{btn.disabled=false;}
};

/* immediate upload helper */
async function uploadNow(file,caption){
  const fd = new FormData(); fd.append(\"file\",file);
  const up = await fetch(\"https://api.pinata.cloud/pinning/pinFileToIPFS\",{
    method:\"POST\",headers:{Authorization:pinataJWT},body:fd});
  if(!up.ok) throw new Error(\"Pinata upload failed\");
  const {IpfsHash}=await up.json();
  const newRef=push(ref(db,\"posts\"));      // public demo location
  await set(newRef,{caption,ipfsHash:IpfsHash,timestamp:Date.now()});
}
</script>
</body>
</html>
