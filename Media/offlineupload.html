<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Offline Upload Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f2f2f2; }
    .container { max-width: 600px; margin: auto; background: white; padding: 2rem; border-radius: 8px; }
    h1 { text-align: center; }
    .btn { display: inline-block; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .btn:disabled { background: #ccc; }
    input, textarea { width: 100%; padding: 0.5rem; margin-top: 1rem; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
<div class="container">
  <h1>Offline Upload</h1>
  <input type="file" id="mediaFile" required />
  <textarea id="caption" placeholder="Enter caption..." required></textarea>
  <button class="btn" id="uploadBtn">Upload</button>
</div>

<script>
const uploadBtn = document.getElementById("uploadBtn");
const mediaFile = document.getElementById("mediaFile");
const captionIn = document.getElementById("caption");

const userId = "anonymous"; // simulate auth for demo

uploadBtn.onclick = async () => {
  if (!mediaFile.files[0]) return alert("Select a file");
  if (captionIn.value.trim().length < 3) return alert("Enter a caption");
  uploadBtn.disabled = true;

  try {
    if (!navigator.onLine) {
      await saveUploadToQueue(mediaFile.files[0], captionIn.value.trim(), userId);
      const reg = await navigator.serviceWorker.ready;
      await reg.sync.register("upload-posts");
      alert("Offline: upload queued. Will upload automatically later.");
    } else {
      alert("Online mode: here you'd do the upload to Pinata");
    }
    mediaFile.value = "";
    captionIn.value = "";
  } catch (err) {
    alert(err.message);
  } finally {
    uploadBtn.disabled = false;
  }
};

async function saveUploadToQueue(file, caption, userId) {
  const db = await openIndexedDB();
  const tx = db.transaction("uploads", "readwrite");
  const store = tx.objectStore("uploads");
  await store.add({ file, caption, userId, timestamp: Date.now() });
  await tx.done;
  db.close();
}

function openIndexedDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("drfmediaDB", 1);
    request.onupgradeneeded = () => {
      const db = request.result;
      if (!db.objectStoreNames.contains("uploads")) {
        db.createObjectStore("uploads", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(() => console.log("Service Worker registered"))
    .catch(err => console.error("SW registration failed", err));
}
</script>
</body>
</html>
