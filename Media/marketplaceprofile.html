<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seller Profile | DRF Marketplace</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 12px 0 4px;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      margin-top: 20px;
      background: #007BFF;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled {
      background: #888;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Seller Verification Form</h2>
  <label>Name</label>
  <input id="name" type="text" required />

  <label>Phone Number</label>
  <input id="phone" type="tel" required />

  <label>Email (from Auth)</label>
  <input id="email" type="email" readonly />

  <label>Age</label>
  <input id="age" type="number" min="16" required />

  <label>Country</label>
  <input id="country" type="text" required />

  <label>Full Address</label>
  <textarea id="address" required></textarea>

  <label>Wallet Address</label>
  <input id="wallet" type="text" required maxlength="42" />

  <label>Delivery Method</label>
  <select id="delivery">
    <option value="courier">Courier</option>
    <option value="local pickup">Local Pickup</option>
    <option value="post office">Post Office</option>
  </select>

  <label>Government ID Photo</label>
  <input id="govID" type="file" accept="image/*" required />

  <label><input type="checkbox" id="agree" /> I agree to follow all DRF Marketplace rules.</label>

  <button id="submitBtn" disabled>Submit Verification</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
};

const PINATA_JWT = "Bearer YOUR_PINATA_JWT";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const nameInput = document.getElementById("name");
const phoneInput = document.getElementById("phone");
const emailInput = document.getElementById("email");
const ageInput = document.getElementById("age");
const countryInput = document.getElementById("country");
const addressInput = document.getElementById("address");
const walletInput = document.getElementById("wallet");
const deliveryInput = document.getElementById("delivery");
const govIDInput = document.getElementById("govID");
const agreeInput = document.getElementById("agree");
const submitBtn = document.getElementById("submitBtn");

let currentUser = null;

agreeInput.addEventListener("change", () => {
  submitBtn.disabled = !agreeInput.checked;
});

onAuthStateChanged(auth, user => {
  if (!user) return alert("Please log in first.");
  currentUser = user;
  emailInput.value = user.email;
});

submitBtn.addEventListener("click", async () => {
  if (!currentUser) return;

  const govIDFile = govIDInput.files[0];
  if (!govIDFile) return alert("Upload your government ID");

  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  try {
    const idImageUrl = await uploadToPinata(govIDFile);
    const sellerRef = ref(db, `marketUsers/${currentUser.uid}/sellerProfile`);
    await update(sellerRef, {
      name: nameInput.value.trim(),
      phone: phoneInput.value.trim(),
      email: currentUser.email,
      age: ageInput.value.trim(),
      country: countryInput.value.trim(),
      address: addressInput.value.trim(),
      wallet: walletInput.value.trim(),
      deliveryMethod: deliveryInput.value,
      governmentIDURL: idImageUrl,
      agreedToTerms: true,
      verified: false
    });
    alert("Submitted for review. We will contact you soon.");
  } catch (err) {
    alert("Error: " + err.message);
  }

  submitBtn.textContent = "Submit Verification";
  submitBtn.disabled = false;
});

async function uploadToPinata(file) {
  const fd = new FormData();
  fd.append("file", file);
  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
    method: "POST",
    headers: { Authorization: PINATA_JWT },
    body: fd
  });
  if (!res.ok) throw new Error("Failed to upload ID to Pinata");
  const data = await res.json();
  return `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;
}
</script>

</body>
</html>
