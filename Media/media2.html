<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia — Post & View (Admin Delete + Auto Unpin)</title>
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="light dark" />
<style>
/* === Styles kept same as your design === */
:root{--accent:#007bff;--accent-hover:#0056b3;--bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;--text-body:#212529;--text-muted:#6c757d;--radius:.5rem;--shadow-sm:0 1px 2px rgba(0,0,0,.06)}
@media(prefers-color-scheme:dark){:root{--bg-body:#181a1b;--bg-surface:#242628;--bg-surface-alt:#2b2e30;--text-body:#f1f3f5;--text-muted:#adb5bd;--shadow-sm:none}}
*{box-sizing:border-box;margin:0}body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg-body);color:var(--text-body);min-height:100vh;display:flex;flex-direction:column}
a{color:inherit;text-decoration:none}img,video{max-width:100%}
header{background:var(--accent);color:#fff;padding:.75rem 1rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;position:sticky;top:0;z-index:1000}
.brand{display:flex;flex-direction:column;align-items:flex-start;gap:.5rem;font-weight:700}
.brand-header{display:flex;align-items:center;gap:.5rem}
.brand img{width:2.25rem;height:2.25rem;border-radius:.25rem;background:#fff;padding:2px}
#rewardBtn{background:#ffc107;color:#212529;border:none;border-radius:var(--radius);padding:.4rem .75rem;font-weight:600;cursor:pointer;transition:background .2s;margin-top:.5rem}
#rewardBtn:hover{background:#e0a800}
#primaryNav{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
#primaryNav a{color:#fff;font-weight:600;padding:.5rem .75rem;border-radius:var(--radius);transition:background-color .2s}
#primaryNav a:hover,#primaryNav a.active{background-color:var(--accent-hover)}
#menuToggle{background:transparent;border:none;color:#fff;font-size:1.5rem;cursor:pointer;display:none;user-select:none}
@media(max-width:600px){#primaryNav{display:none;flex-direction:column;width:100%;background:var(--accent);margin-top:.5rem;border-radius:var(--radius)}#primaryNav.show{display:flex}#menuToggle{display:block}}
.btn{background:var(--accent);color:#fff;border:none;border-radius:var(--radius);padding:.5rem 1rem;font-weight:600;cursor:pointer;transition:background .2s}
.btn:hover{background:var(--accent-hover)}.btn:disabled{background:#adb5bd;cursor:not-allowed}
.container{width:min(100%,700px);margin:0 auto;padding:0 1rem}
#searchInput{width:100%;padding:.55rem .85rem;margin:1rem 0;border:1px solid #ced4da;border-radius:var(--radius);background:var(--bg-surface);color:var(--text-body)}
.post-item{background:var(--bg-surface-alt);border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;margin:1.25rem 0;box-shadow:var(--shadow-sm)}
.post-owner{display:flex;align-items:center;gap:.6rem;font-weight:700}
.avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:1px solid #ccc}
.post-time{font-size:.8rem;color:var(--text-muted)}
.post-caption{margin-top:.75rem;white-space:pre-wrap}
video,img{border-radius:var(--radius);background:#000;display:block;opacity:0;transition:opacity .3s}
[data-loaded="true"]{opacity:1}
#uploadForm{margin-top:1.25rem}
#uploadForm textarea{width:100%;min-height:6rem;padding:.65rem .85rem;margin:.75rem 0;border:1px solid #ced4da;border-radius:var(--radius);resize:vertical}
#prog{width:100%;height:4px;background:#e9ecef;border-radius:2px;overflow:hidden;display:none}
#progBar{height:4px;width:0;background:var(--accent)}
.delete-btn{background:#dc3545;padding:.35rem .6rem;border-radius:.4rem;font-weight:700;border:none;color:#fff;cursor:pointer}
.admin-badge{font-size:.75rem;padding:.15rem .4rem;border-radius:.35rem;background:rgba(255,255,255,0.12);margin-left:.5rem}
.helper{color:var(--text-muted);text-align:center;margin:.5rem 0}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-header">
      <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png" alt="DRFMedia logo" />
      <span>DRFMedia<span id="adminTag" class="admin-badge" style="display:none">Admin</span></span>
    </div>
    <button id="rewardBtn">Share & Get Rewards</button>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">☰</button>
  <nav id="primaryNav">
    <a href="media.html" class="active">posts</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Timelines</a>
    <a href="market.html">Market Place</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search posts…" />
  <div style="display:flex;gap:.5rem;align-items:center;">
    <button id="loginBtn" class="btn">Sign in with Google</button>
    <button id="logoutBtn" class="btn" style="display:none;background:#dc3545">Logout</button>
  </div>

  <form id="uploadForm" style="display:none">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <textarea id="caption" minlength="4" placeholder="Write your caption…" required></textarea>
    <div id="prog"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>
  <p id="feedHint" class="helper" style="display:none">Scroll for more…</p>
  <div id="sentinel" aria-hidden="true"></div>
</main>

<script type="module">
/* ============================
   CONFIG - put your JWT here
   ============================ */

/*
  ⚠️ SECURITY NOTE:
  Placing the JWT in frontend is convenient but insecure for production.
  Make sure you rotate or revoke keys if they leak.
*/
const PINATA_JWT = "Bearer <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia — Post & View (Admin Delete + Auto Unpin)</title>
<link rel="stylesheet" href="style.css" />
<meta name="color-scheme" content="light dark" />
<style>
/* === Styles kept same as your design === */
:root{--accent:#007bff;--accent-hover:#0056b3;--bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;--text-body:#212529;--text-muted:#6c757d;--radius:.5rem;--shadow-sm:0 1px 2px rgba(0,0,0,.06)}
@media(prefers-color-scheme:dark){:root{--bg-body:#181a1b;--bg-surface:#242628;--bg-surface-alt:#2b2e30;--text-body:#f1f3f5;--text-muted:#adb5bd;--shadow-sm:none}}
*{box-sizing:border-box;margin:0}body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg-body);color:var(--text-body);min-height:100vh;display:flex;flex-direction:column}
a{color:inherit;text-decoration:none}img,video{max-width:100%}
header{background:var(--accent);color:#fff;padding:.75rem 1rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;position:sticky;top:0;z-index:1000}
.brand{display:flex;flex-direction:column;align-items:flex-start;gap:.5rem;font-weight:700}
.brand-header{display:flex;align-items:center;gap:.5rem}
.brand img{width:2.25rem;height:2.25rem;border-radius:.25rem;background:#fff;padding:2px}
#rewardBtn{background:#ffc107;color:#212529;border:none;border-radius:var(--radius);padding:.4rem .75rem;font-weight:600;cursor:pointer;transition:background .2s;margin-top:.5rem}
#rewardBtn:hover{background:#e0a800}
#primaryNav{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
#primaryNav a{color:#fff;font-weight:600;padding:.5rem .75rem;border-radius:var(--radius);transition:background-color .2s}
#primaryNav a:hover,#primaryNav a.active{background-color:var(--accent-hover)}
#menuToggle{background:transparent;border:none;color:#fff;font-size:1.5rem;cursor:pointer;display:none;user-select:none}
@media(max-width:600px){#primaryNav{display:none;flex-direction:column;width:100%;background:var(--accent);margin-top:.5rem;border-radius:var(--radius)}#primaryNav.show{display:flex}#menuToggle{display:block}}
.btn{background:var(--accent);color:#fff;border:none;border-radius:var(--radius);padding:.5rem 1rem;font-weight:600;cursor:pointer;transition:background .2s}
.btn:hover{background:var(--accent-hover)}.btn:disabled{background:#adb5bd;cursor:not-allowed}
.container{width:min(100%,700px);margin:0 auto;padding:0 1rem}
#searchInput{width:100%;padding:.55rem .85rem;margin:1rem 0;border:1px solid #ced4da;border-radius:var(--radius);background:var(--bg-surface);color:var(--text-body)}
.post-item{background:var(--bg-surface-alt);border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;margin:1.25rem 0;box-shadow:var(--shadow-sm)}
.post-owner{display:flex;align-items:center;gap:.6rem;font-weight:700}
.avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:1px solid #ccc}
.post-time{font-size:.8rem;color:var(--text-muted)}
.post-caption{margin-top:.75rem;white-space:pre-wrap}
video,img{border-radius:var(--radius);background:#000;display:block;opacity:0;transition:opacity .3s}
[data-loaded="true"]{opacity:1}
#uploadForm{margin-top:1.25rem}
#uploadForm textarea{width:100%;min-height:6rem;padding:.65rem .85rem;margin:.75rem 0;border:1px solid #ced4da;border-radius:var(--radius);resize:vertical}
#prog{width:100%;height:4px;background:#e9ecef;border-radius:2px;overflow:hidden;display:none}
#progBar{height:4px;width:0;background:var(--accent)}
.delete-btn{background:#dc3545;padding:.35rem .6rem;border-radius:.4rem;font-weight:700;border:none;color:#fff;cursor:pointer}
.admin-badge{font-size:.75rem;padding:.15rem .4rem;border-radius:.35rem;background:rgba(255,255,255,0.12);margin-left:.5rem}
.helper{color:var(--text-muted);text-align:center;margin:.5rem 0}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-header">
      <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png" alt="DRFMedia logo" />
      <span>DRFMedia<span id="adminTag" class="admin-badge" style="display:none">Admin</span></span>
    </div>
    <button id="rewardBtn">Share & Get Rewards</button>
  </div>
  <button id="menuToggle" aria-label="Toggle menu">☰</button>
  <nav id="primaryNav">
    <a href="media.html" class="active">posts</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Timelines</a>
    <a href="market.html">Market Place</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search posts…" />
  <div style="display:flex;gap:.5rem;align-items:center;">
    <button id="loginBtn" class="btn">Sign in with Google</button>
    <button id="logoutBtn" class="btn" style="display:none;background:#dc3545">Logout</button>
  </div>

  <form id="uploadForm" style="display:none">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <textarea id="caption" minlength="4" placeholder="Write your caption…" required></textarea>
    <div id="prog"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>
  <p id="feedHint" class="helper" style="display:none">Scroll for more…</p>
  <div id="sentinel" aria-hidden="true"></div>
</main>

<script type="module">
/* ============================
   CONFIG - put your JWT here
   ============================ */

/*
  ⚠️ SECURITY NOTE:
  Placing the JWT in frontend is convenient but insecure for production.
  Make sure you rotate or revoke keys if they leak.
*/
const PINATA_JWT = "Bearer YOUR_PINATA_JWT_HERE"; // <-- REPLACE with your Pinata JWT

/* Admin email (from you) */
const ADMIN_EMAIL = "digitalrufiya@gmail.com";

/* ============================
   Firebase imports & init
   ============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, get, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
  measurementId: "G-TBFQX80NRP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ============================
   DOM refs + state
   ============================ */
const $ = id => document.getElementById(id);
const login = $("loginBtn"), logout = $("logoutBtn");
const upload = $("uploadForm"), fileIn = $("mediaFile"), capIn = $("caption");
const prog = $("prog"), bar = $("progBar");
const posts = $("postContainer"), qIn = $("searchInput");
const sentinel = $("sentinel"), feedHint = $("feedHint");
const adminTag = $("adminTag");

let user = null;
let all = [];
let view = [];
let index = 0;
const PAGE_SIZE = 10;

/* ============================
   Helpers: escape + gateways
   ============================ */
const escapeHTML = (s = "") => (""+s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

const gw = cid => ({
  g1: `https://gateway.pinata.cloud/ipfs/${cid}`,
  g2: `https://cloudflare-ipfs.com/ipfs/${cid}`,
  g3: `https://ipfs.io/ipfs/${cid}`
});

/* create elements for media */
function createImage(cid){
  const {g1,g2,g3} = gw(cid || '');
  const img = document.createElement('img');
  img.loading = 'lazy';
  img.src = g1;
  img.alt = 'Post media';
  img.onerror = () => { if(img.src===g1) img.src=g2; else if(img.src===g2) img.src=g3; else img.onerror=null; };
  img.addEventListener('load', ()=> img.setAttribute('data-loaded','true'));
  return img;
}

function createVideo(cid){
  const {g1,g2,g3} = gw(cid || '');
  const v = document.createElement('video');
  v.controls = true;
  v.playsInline = true;
  v.preload = 'metadata';
  v.muted = true;
  v.dataset.g1 = g1; v.dataset.g2 = g2; v.dataset.g3 = g3; v.dataset.idx = '0';
  v.onerror = () => switchGateway(v);
  v.oncanplay = () => v.setAttribute('data-loaded','true');
  return v;
}

window.switchGateway = function(video){
  let idx = parseInt(video.dataset.idx || '0', 10) + 1;
  const g1 = video.dataset.g1, g2 = video.dataset.g2, g3 = video.dataset.g3;
  const arr = [g1, g2, g3];
  if (idx >= arr.length) { video.onerror = null; return; }
  video.dataset.idx = String(idx);
  if (video.src !== arr[idx]) { video.src = arr[idx]; video.load(); }
}

/* video visibility observer */
const videoObserver = new IntersectionObserver(entries=>{
  entries.forEach(entry=>{
    const v = entry.target;
    if (entry.isIntersecting) {
      if (!v.getAttribute('src')) switchGateway(v);
      v.play && v.play().catch(()=>{});
    } else v.pause && v.pause();
  });
}, { threshold: 0.5 });

/* pagination sentinel observer */
const pagingObserver = new IntersectionObserver(entries=>{
  entries.forEach(e => { if (e.isIntersecting) renderNextBatch(); });
}, { rootMargin: '800px 0px' });
pagingObserver.observe(sentinel);

/* ===============
   Render helpers
   =============== */
function renderReset(){ posts.innerHTML = ''; index = 0; feedHint.style.display='none'; }
function renderCard(p){
  const card = document.createElement('article');
  card.className = 'post-item';

  // delete button visibility: owner or admin
  const canDelete = user && (user.uid === p.userId || (user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()));
  const deleteBtnHtml = canDelete ? `<button class="delete-btn" data-id="${p.id}" data-cid="${p.ipfsHash}" data-owner="${p.userId}">Delete</button>` : '';

  card.innerHTML = `
    <header class="post-owner">
      <img class="avatar" src="${p.photoURL||'https://via.placeholder.com/40'}" alt="User avatar" />
      <div>
        <div>${escapeHTML(p.displayName || 'Anon')} ${p.userId && (user && user.email && user.email.toLowerCase()===ADMIN_EMAIL.toLowerCase() ? '<span class="admin-badge">admin</span>' : '')}</div>
        <time class="post-time" datetime="${new Date(p.timestamp || 0).toISOString()}">
          ${p.timestamp ? new Date(p.timestamp).toLocaleString() : ''}
        </time>
      </div>
    </header>
    <div class="post-caption">${escapeHTML(p.caption || '')}</div>
    <div class="post-media" id="m-${p.id}"></div>
    <div style="margin-top:.6rem">${deleteBtnHtml}</div>
  `;

  const holder = card.querySelector(`#m-${p.id}`);
  if ((p.mediaType || '').startsWith('video')) {
    const v = createVideo(p.ipfsHash);
    holder.appendChild(v);
    videoObserver.observe(v);
  } else {
    holder.appendChild(createImage(p.ipfsHash));
  }

  // wire delete button (if present)
  const delBtn = card.querySelector('.delete-btn');
  if (delBtn) {
    delBtn.addEventListener('click', async (ev)=>{
      const id = delBtn.dataset.id;
      const cid = delBtn.dataset.cid;
      const owner = delBtn.dataset.owner;
      const confirmMsg = (user && user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase())
        ? `Admin: delete this post? This will remove it for everyone and unpin file ${cid}.`
        : 'Are you sure you want to delete your post? This will unpin the image/video.';
      if (!confirm(confirmMsg)) return;
      await handleDeletePost(id, cid, owner);
    });
  }

  return card;
}

function renderNextBatch(){
  if (index >= view.length) return;
  const end = Math.min(index + PAGE_SIZE, view.length);
  const frag = document.createDocumentFragment();
  for (let i = index; i < end; i++) frag.appendChild(renderCard(view[i]));
  posts.appendChild(frag);
  index = end;
  feedHint.style.display = index < view.length ? 'block' : 'none';
}

/* search */
function applySearch(){
  const term = (qIn.value || '').trim().toLowerCase();
  view = all.filter(p => (p.caption || '').toLowerCase().includes(term));
  renderReset(); renderNextBatch();
}

/* get posts */
async function getPosts(){
  try{
    const snap = await get(ref(db, 'posts'));
    const obj = snap.val() || {};
    all = Object.entries(obj).map(([id, v]) => ({ id, ...v })).sort((a,b)=>b.timestamp - a.timestamp);
    applySearch();
  }catch(err){
    console.error('getPosts error', err);
    posts.innerHTML = '<p class="helper">Unable to load posts. Check console.</p>';
  }
}

/* ===========================
   Auth & UI wiring
   =========================== */
login.onclick = () => signInWithPopup(auth, provider);
logout.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (u) => {
  user = u;
  login.style.display = u ? 'none' : 'block';
  logout.style.display = u ? 'block' : 'none';
  upload.style.display = u ? 'block' : 'none';
  // show admin tag if admin
  if (u && u.email && u.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) adminTag.style.display = 'inline-block';
  else adminTag.style.display = 'none';
  await getPosts();
});

qIn.oninput = () => applySearch();

/* ===========================
   Upload (Pinata) with progress
   =========================== */

async function safePinataUpload(file){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://api.pinata.cloud/pinning/pinFileToIPFS');
    xhr.setRequestHeader('Authorization', PINATA_JWT);
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        bar.style.width = Math.round((e.loaded / e.total) * 100) + '%';
      }
    };
    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const json = JSON.parse(xhr.responseText || '{}');
          if (json && json.IpfsHash) return resolve(json.IpfsHash);
          return reject(new Error('Pinata did not return IpfsHash: ' + xhr.responseText));
        } catch (err) {
          return reject(err);
        }
      } else {
        return reject(new Error('Pinata upload failed: ' + xhr.status + ' ' + xhr.responseText));
      }
    };
    xhr.onerror = () => reject(new Error('Network error during Pinata upload'));
    const fd = new FormData();
    fd.append('file', file);
    xhr.send(fd);
  });
}

/* upload form submit */
upload.onsubmit = async (e) => {
  e.preventDefault();
  if (!fileIn.files[0]) return alert('Choose a file');
  if (capIn.value.trim().length < 4) return alert('Caption too short');
  const file = fileIn.files[0];
  upload.querySelector('button').disabled = true;
  prog.style.display = 'block';
  bar.style.width = '0%';
  try{
    const cid = await safePinataUpload(file);
    if (!cid) throw new Error('No CID returned');
    const newRef = push(ref(db, 'posts'));
    await set(newRef, {
      userId: user.uid,
      displayName: user.displayName || 'Anon',
      photoURL: user.photoURL || '',
      caption: capIn.value.trim(),
      ipfsHash: cid,
      mediaType: file.type.startsWith('video') ? 'video' : 'image',
      timestamp: Date.now()
    });
    fileIn.value = ''; capIn.value = '';
    bar.style.width = '100%';
    setTimeout(()=> prog.style.display = 'none', 400);
    await getPosts();
    window.scrollTo({top:0, behavior:'smooth'});
  }catch(err){
    console.error('Upload error', err);
    alert('Upload error: ' + (err.message || err));
    prog.style.display = 'none';
  }finally{
    upload.querySelector('button').disabled = false;
  }
};

/* ===========================
   Delete + Unpin logic
   =========================== */

/* Unpin from Pinata */
async function unpinFromPinata(cid){
  if(!cid) return;
  try{
    const res = await fetch(`https://api.pinata.cloud/pinning/unpin/${cid}`, {
      method: 'DELETE',
      headers: { Authorization: PINATA_JWT }
    });
    if (!res.ok) {
      const text = await res.text().catch(()=> '');
      console.warn('Unpin returned non-ok', res.status, text);
      return false;
    }
    return true;
  }catch(e){
    console.error('Unpin error', e);
    return false;
  }
}

/* Handle delete post (checks permissions) */
async function handleDeletePost(postId, cid, ownerId){
  try{
    // Re-check current user
    const cur = auth.currentUser;
    if(!cur) { alert('Please sign in'); return; }
    const isAdmin = cur.email && cur.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
    const isOwner = cur.uid === ownerId;
    if(!isAdmin && !isOwner){
      alert('You do not have permission to delete this post.');
      return;
    }

    // Delete from DB
    await remove(ref(db, `posts/${postId}`));

    // Try to unpin (best effort)
    const unpinned = await unpinFromPinata(cid);
    if (unpinned) {
      console.log('Unpinned:', cid);
    } else {
      console.warn('Unpin failed (it might still be pinned or token invalid):', cid);
    }

    // Refresh feed
    await getPosts();
    alert('Post deleted successfully.');
  }catch(err){
    console.error('Delete error', err);
    alert('Delete failed: ' + (err.message || err));
  }
}

/* ===========================
   Navigation (mobile toggle)
   =========================== */
const menuToggle = document.getElementById('menuToggle');
menuToggle.addEventListener('click', ()=> primaryNav.classList.toggle('show'));
[...primaryNav.querySelectorAll('a')].forEach(a => a.addEventListener('click', ()=> primaryNav.classList.remove('show')));
document.addEventListener('click', (e)=>{ if(window.innerWidth<=600 && !primaryNav.contains(e.target) && e.target!==menuToggle) primaryNav.classList.remove('show'); });

/* initial load */
getPosts();

</script>
</body>
</html>
"; // <-- REPLACE with your Pinata JWT

/* Admin email (from you) */
const ADMIN_EMAIL = "digitalrufiya@gmail.com";

/* ============================
   Firebase imports & init
   ============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, get, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
  measurementId: "G-TBFQX80NRP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ============================
   DOM refs + state
   ============================ */
const $ = id => document.getElementById(id);
const login = $("loginBtn"), logout = $("logoutBtn");
const upload = $("uploadForm"), fileIn = $("mediaFile"), capIn = $("caption");
const prog = $("prog"), bar = $("progBar");
const posts = $("postContainer"), qIn = $("searchInput");
const sentinel = $("sentinel"), feedHint = $("feedHint");
const adminTag = $("adminTag");

let user = null;
let all = [];
let view = [];
let index = 0;
const PAGE_SIZE = 10;

/* ============================
   Helpers: escape + gateways
   ============================ */
const escapeHTML = (s = "") => (""+s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

const gw = cid => ({
  g1: `https://gateway.pinata.cloud/ipfs/${cid}`,
  g2: `https://cloudflare-ipfs.com/ipfs/${cid}`,
  g3: `https://ipfs.io/ipfs/${cid}`
});

/* create elements for media */
function createImage(cid){
  const {g1,g2,g3} = gw(cid || '');
  const img = document.createElement('img');
  img.loading = 'lazy';
  img.src = g1;
  img.alt = 'Post media';
  img.onerror = () => { if(img.src===g1) img.src=g2; else if(img.src===g2) img.src=g3; else img.onerror=null; };
  img.addEventListener('load', ()=> img.setAttribute('data-loaded','true'));
  return img;
}

function createVideo(cid){
  const {g1,g2,g3} = gw(cid || '');
  const v = document.createElement('video');
  v.controls = true;
  v.playsInline = true;
  v.preload = 'metadata';
  v.muted = true;
  v.dataset.g1 = g1; v.dataset.g2 = g2; v.dataset.g3 = g3; v.dataset.idx = '0';
  v.onerror = () => switchGateway(v);
  v.oncanplay = () => v.setAttribute('data-loaded','true');
  return v;
}

window.switchGateway = function(video){
  let idx = parseInt(video.dataset.idx || '0', 10) + 1;
  const g1 = video.dataset.g1, g2 = video.dataset.g2, g3 = video.dataset.g3;
  const arr = [g1, g2, g3];
  if (idx >= arr.length) { video.onerror = null; return; }
  video.dataset.idx = String(idx);
  if (video.src !== arr[idx]) { video.src = arr[idx]; video.load(); }
}

/* video visibility observer */
const videoObserver = new IntersectionObserver(entries=>{
  entries.forEach(entry=>{
    const v = entry.target;
    if (entry.isIntersecting) {
      if (!v.getAttribute('src')) switchGateway(v);
      v.play && v.play().catch(()=>{});
    } else v.pause && v.pause();
  });
}, { threshold: 0.5 });

/* pagination sentinel observer */
const pagingObserver = new IntersectionObserver(entries=>{
  entries.forEach(e => { if (e.isIntersecting) renderNextBatch(); });
}, { rootMargin: '800px 0px' });
pagingObserver.observe(sentinel);

/* ===============
   Render helpers
   =============== */
function renderReset(){ posts.innerHTML = ''; index = 0; feedHint.style.display='none'; }
function renderCard(p){
  const card = document.createElement('article');
  card.className = 'post-item';

  // delete button visibility: owner or admin
  const canDelete = user && (user.uid === p.userId || (user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()));
  const deleteBtnHtml = canDelete ? `<button class="delete-btn" data-id="${p.id}" data-cid="${p.ipfsHash}" data-owner="${p.userId}">Delete</button>` : '';

  card.innerHTML = `
    <header class="post-owner">
      <img class="avatar" src="${p.photoURL||'https://via.placeholder.com/40'}" alt="User avatar" />
      <div>
        <div>${escapeHTML(p.displayName || 'Anon')} ${p.userId && (user && user.email && user.email.toLowerCase()===ADMIN_EMAIL.toLowerCase() ? '<span class="admin-badge">admin</span>' : '')}</div>
        <time class="post-time" datetime="${new Date(p.timestamp || 0).toISOString()}">
          ${p.timestamp ? new Date(p.timestamp).toLocaleString() : ''}
        </time>
      </div>
    </header>
    <div class="post-caption">${escapeHTML(p.caption || '')}</div>
    <div class="post-media" id="m-${p.id}"></div>
    <div style="margin-top:.6rem">${deleteBtnHtml}</div>
  `;

  const holder = card.querySelector(`#m-${p.id}`);
  if ((p.mediaType || '').startsWith('video')) {
    const v = createVideo(p.ipfsHash);
    holder.appendChild(v);
    videoObserver.observe(v);
  } else {
    holder.appendChild(createImage(p.ipfsHash));
  }

  // wire delete button (if present)
  const delBtn = card.querySelector('.delete-btn');
  if (delBtn) {
    delBtn.addEventListener('click', async (ev)=>{
      const id = delBtn.dataset.id;
      const cid = delBtn.dataset.cid;
      const owner = delBtn.dataset.owner;
      const confirmMsg = (user && user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase())
        ? `Admin: delete this post? This will remove it for everyone and unpin file ${cid}.`
        : 'Are you sure you want to delete your post? This will unpin the image/video.';
      if (!confirm(confirmMsg)) return;
      await handleDeletePost(id, cid, owner);
    });
  }

  return card;
}

function renderNextBatch(){
  if (index >= view.length) return;
  const end = Math.min(index + PAGE_SIZE, view.length);
  const frag = document.createDocumentFragment();
  for (let i = index; i < end; i++) frag.appendChild(renderCard(view[i]));
  posts.appendChild(frag);
  index = end;
  feedHint.style.display = index < view.length ? 'block' : 'none';
}

/* search */
function applySearch(){
  const term = (qIn.value || '').trim().toLowerCase();
  view = all.filter(p => (p.caption || '').toLowerCase().includes(term));
  renderReset(); renderNextBatch();
}

/* get posts */
async function getPosts(){
  try{
    const snap = await get(ref(db, 'posts'));
    const obj = snap.val() || {};
    all = Object.entries(obj).map(([id, v]) => ({ id, ...v })).sort((a,b)=>b.timestamp - a.timestamp);
    applySearch();
  }catch(err){
    console.error('getPosts error', err);
    posts.innerHTML = '<p class="helper">Unable to load posts. Check console.</p>';
  }
}

/* ===========================
   Auth & UI wiring
   =========================== */
login.onclick = () => signInWithPopup(auth, provider);
logout.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (u) => {
  user = u;
  login.style.display = u ? 'none' : 'block';
  logout.style.display = u ? 'block' : 'none';
  upload.style.display = u ? 'block' : 'none';
  // show admin tag if admin
  if (u && u.email && u.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) adminTag.style.display = 'inline-block';
  else adminTag.style.display = 'none';
  await getPosts();
});

qIn.oninput = () => applySearch();

/* ===========================
   Upload (Pinata) with progress
   =========================== */

async function safePinataUpload(file){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://api.pinata.cloud/pinning/pinFileToIPFS');
    xhr.setRequestHeader('Authorization', PINATA_JWT);
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        bar.style.width = Math.round((e.loaded / e.total) * 100) + '%';
      }
    };
    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          const json = JSON.parse(xhr.responseText || '{}');
          if (json && json.IpfsHash) return resolve(json.IpfsHash);
          return reject(new Error('Pinata did not return IpfsHash: ' + xhr.responseText));
        } catch (err) {
          return reject(err);
        }
      } else {
        return reject(new Error('Pinata upload failed: ' + xhr.status + ' ' + xhr.responseText));
      }
    };
    xhr.onerror = () => reject(new Error('Network error during Pinata upload'));
    const fd = new FormData();
    fd.append('file', file);
    xhr.send(fd);
  });
}

/* upload form submit */
upload.onsubmit = async (e) => {
  e.preventDefault();
  if (!fileIn.files[0]) return alert('Choose a file');
  if (capIn.value.trim().length < 4) return alert('Caption too short');
  const file = fileIn.files[0];
  upload.querySelector('button').disabled = true;
  prog.style.display = 'block';
  bar.style.width = '0%';
  try{
    const cid = await safePinataUpload(file);
    if (!cid) throw new Error('No CID returned');
    const newRef = push(ref(db, 'posts'));
    await set(newRef, {
      userId: user.uid,
      displayName: user.displayName || 'Anon',
      photoURL: user.photoURL || '',
      caption: capIn.value.trim(),
      ipfsHash: cid,
      mediaType: file.type.startsWith('video') ? 'video' : 'image',
      timestamp: Date.now()
    });
    fileIn.value = ''; capIn.value = '';
    bar.style.width = '100%';
    setTimeout(()=> prog.style.display = 'none', 400);
    await getPosts();
    window.scrollTo({top:0, behavior:'smooth'});
  }catch(err){
    console.error('Upload error', err);
    alert('Upload error: ' + (err.message || err));
    prog.style.display = 'none';
  }finally{
    upload.querySelector('button').disabled = false;
  }
};

/* ===========================
   Delete + Unpin logic
   =========================== */

/* Unpin from Pinata */
async function unpinFromPinata(cid){
  if(!cid) return;
  try{
    const res = await fetch(`https://api.pinata.cloud/pinning/unpin/${cid}`, {
      method: 'DELETE',
      headers: { Authorization: PINATA_JWT }
    });
    if (!res.ok) {
      const text = await res.text().catch(()=> '');
      console.warn('Unpin returned non-ok', res.status, text);
      return false;
    }
    return true;
  }catch(e){
    console.error('Unpin error', e);
    return false;
  }
}

/* Handle delete post (checks permissions) */
async function handleDeletePost(postId, cid, ownerId){
  try{
    // Re-check current user
    const cur = auth.currentUser;
    if(!cur) { alert('Please sign in'); return; }
    const isAdmin = cur.email && cur.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
    const isOwner = cur.uid === ownerId;
    if(!isAdmin && !isOwner){
      alert('You do not have permission to delete this post.');
      return;
    }

    // Delete from DB
    await remove(ref(db, `posts/${postId}`));

    // Try to unpin (best effort)
    const unpinned = await unpinFromPinata(cid);
    if (unpinned) {
      console.log('Unpinned:', cid);
    } else {
      console.warn('Unpin failed (it might still be pinned or token invalid):', cid);
    }

    // Refresh feed
    await getPosts();
    alert('Post deleted successfully.');
  }catch(err){
    console.error('Delete error', err);
    alert('Delete failed: ' + (err.message || err));
  }
}

/* ===========================
   Navigation (mobile toggle)
   =========================== */
const menuToggle = document.getElementById('menuToggle');
menuToggle.addEventListener('click', ()=> primaryNav.classList.toggle('show'));
[...primaryNav.querySelectorAll('a')].forEach(a => a.addEventListener('click', ()=> primaryNav.classList.remove('show')));
document.addEventListener('click', (e)=>{ if(window.innerWidth<=600 && !primaryNav.contains(e.target) && e.target!==menuToggle) primaryNav.classList.remove('show'); });

/* initial load */
getPosts();

</script>
</body>
</html>
