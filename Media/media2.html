<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia — Optimized</title>
<meta name="color-scheme" content="light dark" />
<style>
/* ===== Basic Styles ===== */
:root{--accent:#007bff;--accent-hover:#0056b3;--bg-body:#f8f9fa;--bg-surface:#fff;--text-body:#212529;--radius:.5rem}
body{margin:0;font-family:sans-serif;background:var(--bg-body);color:var(--text-body)}
header{background:var(--accent);color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
.brand{font-weight:700}
.container{width:min(100%,700px);margin:0 auto;padding:1rem}
.post-item{background:var(--bg-surface);border-radius:var(--radius);padding:1rem;margin:1rem 0;box-shadow:0 1px 2px rgba(0,0,0,.1)}
.post-owner{display:flex;align-items:center;gap:.5rem;font-weight:700}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
.post-caption{margin:0.5rem 0}
video,img{max-width:100%;border-radius:var(--radius);background:#000;display:block;opacity:0;transition:opacity .3s}
[data-loaded=true]{opacity:1}
#loader{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:flex;align-items:center;justify-content:center;font-size:1.5rem;z-index:2000}
#uploadForm{margin:1rem 0}
</style>
</head>
<body>
<div id="loader">Loading...</div>

<header>
  <div class="brand">DRFMedia</div>
  <button id="menuToggle">☰</button>
  <nav id="primaryNav" style="display:flex;gap:1rem">
    <a href="#" class="active">Posts</a>
    <a href="#">Chat</a>
    <a href="#">Profile</a>
  </nav>
</header>

<main class="container">
  <input id="searchInput" placeholder="Search posts…" style="width:100%;padding:.5rem;margin:1rem 0"/>
  <button id="loginBtn">Sign in with Google</button>
  <button id="logoutBtn" style="display:none;background:#dc3545;color:#fff">Logout</button>

  <form id="uploadForm" style="display:none">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <textarea id="caption" placeholder="Write caption…" required></textarea>
    <div id="prog" style="width:100%;height:4px;background:#eee;margin:.5rem 0">
      <div id="progBar" style="height:4px;width:0;background:var(--accent)"></div>
    </div>
    <button type="submit">Post</button>
  </form>

  <section id="postContainer"></section>
  <div id="sentinel"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

// ====== ADD YOUR OWN KEYS ======
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:b3d1f368e0c09ac4400f43",
    measurementId: "G-TBFQX80NRP"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const $ = id => document.getElementById(id);
const login = $("loginBtn"), logout = $("logoutBtn");
const upload = $("uploadForm"), fileIn = $("mediaFile"), capIn = $("caption");
const prog = $("prog"), bar = $("progBar");
const posts = $("postContainer"), qIn = $("searchInput");
const loader = $("loader");
const sentinel = $("sentinel");

let user=null, all=[], view=[], index=0, PAGE_SIZE=10;

// ===== Helper =====
const escapeHTML = s => s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

const createImage = (cid)=>{
  const img=document.createElement('img');
  img.loading='lazy';
  img.src=`https://gateway.pinata.cloud/ipfs/${cid}`;
  img.alt='Post media';
  img.onload=()=>img.setAttribute('data-loaded','true');
  return img;
};

const createVideo = (cid)=>{
  const v=document.createElement('video');
  v.controls=true; v.playsInline=true; v.preload='none';
  v.dataset.src=`https://gateway.pinata.cloud/ipfs/${cid}`;
  v.onerror=()=>{ v.src=v.dataset.src; v.load(); };
  v.oncanplay=()=>v.setAttribute('data-loaded','true');
  return v;
};

const observer = new IntersectionObserver((entries)=>{
  entries.forEach(entry=>{
    if(entry.isIntersecting){
      const v=entry.target;
      if(v.tagName==='VIDEO' && !v.src){
        v.src=v.dataset.src; v.load(); v.play().catch(()=>{});
      }
    }
  });
},{threshold:0.5});

function renderCard(p){
  const card=document.createElement('article'); card.className='post-item';
  card.innerHTML=`
    <header class="post-owner">
      <img class="avatar" src="${p.photoURL||'https://via.placeholder.com/40'}" />
      <div>
        <div>${escapeHTML(p.displayName||'Anon')}</div>
        <time>${new Date(p.timestamp).toLocaleString()}</time>
      </div>
    </header>
    <div class="post-caption">${escapeHTML(p.caption||'')}</div>
    <div class="post-media" id="m-${p.id}"></div>
  `;
  const holder=card.querySelector(`#m-${p.id}`);
  if(p.mediaType==='video'){
    const v=createVideo(p.ipfsHash);
    holder.appendChild(v);
    observer.observe(v);
  } else {
    holder.appendChild(createImage(p.ipfsHash));
  }
  return card;
}

function renderNextBatch(){
  const end=Math.min(index+PAGE_SIZE,view.length);
  for(let i=index;i<end;i++) posts.appendChild(renderCard(view[i]));
  index=end;
}
const pagingObserver=new IntersectionObserver((entries)=>{
  entries.forEach(e=>{if(e.isIntersecting) renderNextBatch();});
},{rootMargin:'200px'});
pagingObserver.observe(sentinel);

function applySearch(){ 
  const term=(qIn.value||'').trim().toLowerCase();
  view=all.filter(p=>(p.caption||'').toLowerCase().includes(term));
  posts.innerHTML=''; index=0;
  renderNextBatch();
}

// ===== Firebase fetch =====
async function getPosts(){
  const snap=await get(ref(db,'posts'));
  all=Object.entries(snap.val()||{}).map(([id,v])=>({id,...v})).sort((a,b)=>b.timestamp-a.timestamp);
  applySearch();
  loader.style.display='none';
}

// ===== Auth =====
login.onclick=()=>signInWithPopup(auth,provider);
logout.onclick=()=>signOut(auth);
onAuthStateChanged(auth,u=>{
  user=u;
  login.style.display=u?'none':'block';
  logout.style.display=u?'block':'none';
  upload.style.display=u?'block':'none';
  getPosts();
});

// ===== Upload =====
upload.onsubmit=async e=>{
  e.preventDefault();
  if(!fileIn.files[0]) return alert('Choose file');
  if(capIn.value.trim().length<4) return alert('Caption too short');
  const file=fileIn.files[0];
  upload.querySelector('button').disabled=true;
  prog.style.display='block'; bar.style.width='0';
  try{
    const fd=new FormData(); fd.append('file',file);
    const xhr=new XMLHttpRequest();
    xhr.open('POST','https://api.pinata.cloud/pinning/pinFileToIPFS');
    xhr.setRequestHeader('Authorization',pinataJWT);
    xhr.upload.onprogress=e=>{if(e.lengthComputable) bar.style.width=(e.loaded/e.total*100)+'%';};
    const cid=await new Promise((res,rej)=>{
      xhr.onload=()=>{ try{res(JSON.parse(xhr.responseText).IpfsHash);}catch{rej('Pinata error');}};
      xhr.onerror=()=>rej('Upload failed');
      xhr.send(fd);
    });
    const newRef=push(ref(db,'posts'));
    await set(newRef,{userId:user.uid,displayName:user.displayName||'Anon',photoURL:user.photoURL||'',caption:capIn.value.trim(),ipfsHash:cid,mediaType:file.type.startsWith('video')?'video':'image',timestamp:Date.now()});
    fileIn.value=''; capIn.value='';
    bar.style.width='100%';
    setTimeout(()=>prog.style.display='none',400);
    await getPosts(); window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){alert(e); prog.style.display='none';}finally{upload.querySelector('button').disabled=false;}
};
</script>
</body>
</html>
