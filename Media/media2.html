<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>

  <!-- optional external CSS if you keep style.css -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ===== design tokens ===== */
    :root {
      --accent: #007bff;
      --accent-hover: #0056b3;
      --accent-muted: #3399ff; /* changed from #0069d9 */
      --bg-body: #f8f9fa;
      --bg-surface: #fff;
      --bg-surface-alt: #fafafa;
      --text-body: #212529;
      --text-muted: #6c757d;
      --radius: 0.5rem;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-body: #181a1b;
        --bg-surface: #242628;
        --bg-surface-alt: #2b2e30;
        --text-body: #f1f3f5;
        --text-muted: #adb5bd;
        --shadow-sm: none;
        --shadow-md: none;
      }
    }
    /* ===== base reset ===== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-body);
      color: var(--text-body);
      display: flex;
      flex-direction: column;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    img,
    video {
      max-width: 100%;
    }
    /* ===== header / nav ===== */
    header {
      background: var(--accent);
      color: #fff;
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      box-shadow: var(--shadow-md);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: clamp(1rem, 2vw, 1.3rem);
    }
    .brand img {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.25rem;
      background: #fff;
      padding: 2px;
    }
    /* ===== MENU TOGGLE BUTTON FIX ===== */
    #menuToggle {
      display: inline-flex;
      flex-direction: column;
      justify-content: space-around;
      width: 30px;
      height: 24px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      box-sizing: border-box;
      z-index: 1100; /* ensure on top */
    }
    #menuToggle span {
      width: 30px;
      height: 3px;
      background-color: white;  /* white bars always visible */
      border-radius: 2px;
      transition: all 0.3s linear;
      position: relative;
      transform-origin: 1px;
    }
    /* NAV MENU */
    #primaryNav {
      display: none;
      flex-direction: column;
      width: 100%;
      background: var(--accent-muted);
      border-radius: var(--radius);
      margin-top: 0.5rem;
    }
    #primaryNav.open {
      display: flex;
    }
    #primaryNav a {
      padding: 0.75rem 1.25rem;
      font-weight: 600;
      border-top: 1px solid rgba(255 255 255 / 0.15);
      color: #fff;
    }
    #primaryNav a:first-child {
      border-top: none;
    }
    #primaryNav a:hover {
      background: rgba(255 255 255 / 0.18);
    }
    @media (min-width: 768px) {
      #menuToggle {
        display: none;
      }
      #primaryNav {
        display: flex !important;
        flex-direction: row;
        gap: 0.25rem;
        background: transparent;
        width: auto;
        margin-top: 0;
        border-radius: 0;
      }
      #primaryNav a {
        border: none;
        padding: 0.5rem 0.9rem;
        color: inherit;
      }
      #primaryNav a:hover {
        background: rgba(255 255 255 / 0.25);
      }
    }
    /* ===== utility buttons ===== */
    .btn {
      display: inline-block;
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 0.45rem 0.9rem;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background: var(--accent-hover);
    }
    .btn:disabled {
      background: #adb5bd;
      cursor: not-allowed;
    }
    /* ===== layout ===== */
    #pageWrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .container {
      width: min(100%, 700px);
      margin-inline: auto;
      padding-inline: 1rem;
    }
    /* search */
    #searchBar {
      margin: 1rem auto 0;
    }
    #searchInput {
      width: 100%;
      padding: 0.55rem 0.85rem;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: var(--radius);
      background: var(--bg-surface);
      color: var(--text-body);
    }
    /* upload */
    #uploadForm {
      margin-top: 1.25rem;
    }
    #uploadForm textarea {
      width: 100%;
      margin-top: 0.75rem;
      padding: 0.65rem 0.85rem;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: var(--radius);
      resize: vertical;
      min-height: 6rem;
      background: var(--bg-surface);
      color: var(--text-body);
    }
    /* post card */
    .post-item {
      background: var(--bg-surface-alt);
      border: 1px solid #dee2e6;
      border-radius: var(--radius);
      padding: 1rem;
      margin-block: 1.25rem;
      box-shadow: var(--shadow-sm);
    }
    .post-owner {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 700;
    }
    .avatar {
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ced4da;
      box-shadow: var(--shadow-sm);
    }
    .post-time {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .post-caption {
      margin-top: 0.75rem;
      white-space: pre-wrap;
    }
    .post-media {
      margin-top: 0.75rem;
    }
    video,
    img {
      border-radius: var(--radius);
      background: #000;
      display: block;
    }
    .post-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .post-actions button {
      flex: 1 1 auto;
    }
    .post-actions button.liked {
      background: #28a745 !important;
    }
    .post-actions button.boosted {
      background: gold !important;
      color: #000 !important;
    }
    .post-actions button.delete-btn {
      background: #dc3545 !important;
      color: #fff;
    }
    .post-actions button.delete-btn:hover {
      background: #b52a3b !important;
    }
    /* comments */
    .comments-list {
      margin-top: 0.75rem;
      background: var(--bg-surface);
      padding: 0.65rem;
      border-radius: var(--radius);
      max-height: 10rem;
      overflow-y: auto;
    }
    .comment-box textarea {
      width: 100%;
      border-radius: var(--radius);
      padding: 0.6rem 0.8rem;
    }
    /* focus */
    button:focus-visible,
    #menuToggle:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="DRFMedia Logo" />
      <span>DRFMedia</span>
    </div>
    <button id="menuToggle" aria-label="Toggle navigation" aria-controls="primaryNav" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav id="primaryNav">
      <a href="media.html">Timeline</a>
      <a href="profile.html" class="active">Profile</a>
      <a href="media.html">Posts</a>
      <a href="gift.html">Donation</a>
      <a href="chat.html">Chat</a>
    </nav>
  </header>

  <div id="pageWrapper">
    <section id="searchBar" class="container">
      <input id="searchInput" type="search" placeholder="Search posts…" aria-label="Search posts" />
    </section>

    <button id="loginBtn" class="btn" style="display: block; max-width: 700px; margin: 1rem auto;">
      Sign in with Google
    </button>
    <button id="logoutBtn" class="btn" style="display: none; max-width: 700px; margin: 1rem auto; background: #dc3545;">
      Logout
    </button>

    <form id="uploadForm" class="container" style="display: none;">
      <input id="mediaFile" type="file" accept="image/*,video/*" required />
      <textarea id="caption" placeholder="Write your caption…" minlength="4" required></textarea>
      <button class="btn" type="submit" style="margin-top: 0.75rem;">Post</button>
    </form>

    <section id="postContainer" class="container" aria-live="polite"></section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      get,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import {
      getAuth,
      signInWithPopup,
      signOut,
      GoogleAuthProvider,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    /* replace with your own JWT */
    const pinataJWT =
      "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.appspot.com",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:dc999df2c0c37241ff3f40",
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    /* dom refs */
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const uploadForm = document.getElementById("uploadForm");
    const mediaFile = document.getElementById("mediaFile");
    const captionIn = document.getElementById("caption");
    const postWrap = document.getElementById("postContainer");
    const searchIn = document.getElementById("searchInput");
    const menuTog = document.getElementById("menuToggle");
    const primaryNav = document.getElementById("primaryNav");

    /* state */
    let currentUser = null,
      isAdmin = false,
      allPosts = [];

    /* utils */
    const esc = (s) =>
      s.replace(/[&<>"]/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c]));

    /* auth */
    loginBtn.onclick = () => signInWithPopup(auth, provider).catch((e) => alert(e.message));
    logoutBtn.onclick = () => signOut(auth).catch((e) => alert(e.message));

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      uploadForm.style.display = user ? "block" : "none";
      loginBtn.style.display = user ? "none" : "block";
      logoutBtn.style.display = user ? "block" : "none";
      if (user) {
        const adSnap = await get(ref(db, `admin/${user.uid}`));
        isAdmin = adSnap.exists();
      } else isAdmin = false;
      renderPosts();
    });

    /* upload */
    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!mediaFile.files.length) return alert("Please select a media file.");
      if (captionIn.value.length < 4) return alert("Caption must be at least 4 characters.");

      const file = mediaFile.files[0];
      const caption = captionIn.value.trim();

      /* pinata upload */
      try {
        const formData = new FormData();
        formData.append("file", file);

        // Upload file to Pinata
        const pinRes = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
          method: "POST",
          headers: { Authorization: pinataJWT },
          body: formData,
        });
        if (!pinRes.ok) throw new Error("Failed to upload file to IPFS");
        const pinData = await pinRes.json();
        const ipfsHash = pinData.IpfsHash;

        // Prepare post data
        const postData = {
          uid: currentUser.uid,
          authorName: currentUser.displayName,
          authorPhoto: currentUser.photoURL,
          caption,
          ipfsHash,
          type: file.type.startsWith("video") ? "video" : "image",
          createdAt: Date.now(),
          likes: {},
          boosts: {},
          comments: {},
        };

        // Save post to Firebase Realtime DB
        await push(ref(db, "posts"), postData);

        // Clear form
        mediaFile.value = "";
        captionIn.value = "";

        alert("Post uploaded successfully!");
      } catch (err) {
        alert(err.message);
      }
    });

    /* fetch posts */
    const loadPosts = () =>
      onValue(ref(db, "posts"), (snapshot) => {
        allPosts = [];
        snapshot.forEach((child) => {
          const post = child.val();
          post.key = child.key;
          allPosts.push(post);
        });
        renderPosts();
      });

    loadPosts();

    /* render posts */
    function renderPosts() {
      if (!allPosts.length) {
        postWrap.innerHTML = "<p>No posts found.</p>";
        return;
      }
      // Filter posts by search query
      const query = searchIn.value.toLowerCase();
      const filteredPosts = allPosts.filter((p) =>
        p.caption.toLowerCase().includes(query) ||
        p.authorName.toLowerCase().includes(query)
      );
      if (!filteredPosts.length) {
        postWrap.innerHTML = "<p>No posts match your search.</p>";
        return;
      }
      // Render filtered posts
      postWrap.innerHTML = filteredPosts
        .map((p) => {
          const liked = currentUser && p.likes && p.likes[currentUser.uid];
          const boosted = currentUser && p.boosts && p.boosts[currentUser.uid];
          return `
          <article class="post-item" data-key="${p.key}">
            <div class="post-owner">
              <img src="${esc(p.authorPhoto)}" alt="${esc(p.authorName)} avatar" class="avatar" />
              <div>
                <div>${esc(p.authorName)}</div>
                <time class="post-time" datetime="${new Date(p.createdAt).toISOString()}">
                  ${new Date(p.createdAt).toLocaleString()}
                </time>
              </div>
            </div>
            <div class="post-caption">${esc(p.caption)}</div>
            <div class="post-media">
              ${
                p.type === "video"
                  ? `<video controls preload="metadata" playsinline>
                      <source src="https://ipfs.io/ipfs/${p.ipfsHash}" type="video/mp4" />
                      Your browser does not support video.
                    </video>`
                  : `<img src="https://ipfs.io/ipfs/${p.ipfsHash}" alt="Post media" />`
              }
            </div>
            <div class="post-actions">
              <button class="${liked ? "liked" : ""}" data-action="like">
                👍 Like (${p.likes ? Object.keys(p.likes).length : 0})
              </button>
              <button class="${boosted ? "boosted" : ""}" data-action="boost">
                🚀 Boost (${p.boosts ? Object.keys(p.boosts).length : 0})
              </button>
              ${
                isAdmin
                  ? `<button class="delete-btn" data-action="delete">🗑️ Delete</button>`
                  : ""
              }
            </div>
            <details class="comments-list">
              <summary>Comments (${p.comments ? Object.keys(p.comments).length : 0})</summary>
              <ul>
                ${
                  p.comments
                    ? Object.entries(p.comments)
                        .map(([cid, comment]) => `<li>${esc(comment.author)}: ${esc(comment.text)}</li>`)
                        .join("")
                    : "<li>No comments yet</li>"
                }
              </ul>
              ${
                currentUser
                  ? `<form class="comment-box" data-post-key="${p.key}">
                      <textarea rows="2" placeholder="Write a comment…" required></textarea>
                      <button type="submit" class="btn">Comment</button>
                    </form>`
                  : ""
              }
            </details>
          </article>
        `;
        })
        .join("");
    }

    /* like, boost, delete, comment event delegation */
    postWrap.addEventListener("click", async (e) => {
      if (!currentUser) return;

      const btn = e.target.closest("button");
      if (!btn) return;

      const article = btn.closest("article.post-item");
      if (!article) return;

      const key = article.dataset.key;
      if (!key) return;

      const action = btn.dataset.action;
      if (!action) return;

      if (action === "like") {
        const likeRef = ref(db, `posts/${key}/likes/${currentUser.uid}`);
        const snap = await get(likeRef);
        if (snap.exists()) {
          await set(likeRef, null);
        } else {
          await set(likeRef, true);
        }
      } else if (action === "boost") {
        const boostRef = ref(db, `posts/${key}/boosts/${currentUser.uid}`);
        const snap = await get(boostRef);
        if (snap.exists()) {
          await set(boostRef, null);
        } else {
          await set(boostRef, true);
        }
      } else if (action === "delete" && isAdmin) {
        if (confirm("Are you sure you want to delete this post?")) {
          await set(ref(db, `posts/${key}`), null);
        }
      }
    });

    /* comment submit */
    postWrap.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentUser) return;

      const form = e.target;
      if (!form.classList.contains("comment-box")) return;

      const textarea = form.querySelector("textarea");
      if (!textarea.value.trim()) return alert("Comment cannot be empty");

      const postKey = form.dataset.postKey;
      if (!postKey) return;

      const commentData = {
        author: currentUser.displayName,
        text: textarea.value.trim(),
        createdAt: Date.now(),
      };

      try {
        await push(ref(db, `posts/${postKey}/comments`), commentData);
        textarea.value = "";
      } catch (err) {
        alert("Failed to add comment: " + err.message);
      }
    });

    /* search */
    searchIn.addEventListener("input", renderPosts);

    /* menu toggle */
    menuTog.addEventListener("click", () => {
      const expanded = menuTog.getAttribute("aria-expanded") === "true";
      menuTog.setAttribute("aria-expanded", !expanded);
      primaryNav.classList.toggle("open");
    });
  </script>
</body>
</html>
