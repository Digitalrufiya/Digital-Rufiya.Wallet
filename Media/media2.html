<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>

  <!-- ───── OPTIONAL external stylesheet, leave if you still use style.css ───── -->
  <link rel="stylesheet" href="style.css" />

  <!-- ──────────────── INLINE RESPONSIVE STYLES ──────────────── -->
  <style>
    /* ---------- Design tokens ---------- */
    :root{
      --accent:#007bff;
      --accent-hover:#0056b3;
      --accent-muted:#0069d9;
      --bg-body:#f8f9fa;
      --bg-surface:#ffffff;
      --bg-surface-alt:#fafafa;
      --text-body:#212529;
      --text-muted:#6c757d;
      --radius:.5rem;
      --shadow-sm:0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 2px 4px rgba(0,0,0,.1);
    }
    @media (prefers-color-scheme:dark){
      :root{
        --bg-body:#181a1b;
        --bg-surface:#242628;
        --bg-surface-alt:#2b2e30;
        --text-body:#f1f3f5;
        --text-muted:#adb5bd;
        --shadow-sm:none;
        --shadow-md:none;
      }
    }

    /* ---------- Base reset ---------- */
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg-body);
      color:var(--text-body);
      display:flex;
      flex-direction:column;
    }
    a{color:inherit;text-decoration:none}
    img,video{max-width:100%}

    /* ---------- Header / Nav ---------- */
    header{
      background:var(--accent);
      color:#fff;
      padding:.75rem 1rem;
      position:sticky;top:0;z-index:1000;
      display:flex;align-items:center;justify-content:space-between;
      gap:1rem;flex-wrap:wrap;
      box-shadow:var(--shadow-md);
    }
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700;font-size:clamp(1rem,2vw,1.3rem)}
    .brand img{width:2.25rem;height:2.25rem;border-radius:.25rem;background:#fff;padding:2px}
    #menuToggle{display:inline-flex;flex-direction:column;width:2rem;height:1.3rem;justify-content:space-between;background:none;border:none;cursor:pointer}
    #menuToggle span{display:block;height:3px;background:#fff;border-radius:3px}
    #primaryNav{display:none;flex-direction:column;width:100%;background:var(--accent-muted);border-radius:var(--radius)}
    #primaryNav.open{display:flex}
    #primaryNav a{padding:.75rem 1.25rem;font-weight:600;border-top:1px solid rgb(255 255 255 /.15)}
    #primaryNav a:first-child{border-top:none}
    #primaryNav a:hover{background:rgb(255 255 255 /.18)}

    @media(min-width:768px){
      #menuToggle{display:none}
      #primaryNav{display:flex!important;flex-direction:row;gap:.25rem;background:transparent;width:auto}
      #primaryNav a{border:none;padding:.5rem .9rem}
      #primaryNav a:hover{background:rgb(255 255 255 /.25)}
    }

    /* ---------- Utility buttons ---------- */
    .btn{display:inline-block;border:none;background:var(--accent);color:#fff;padding:.45rem .9rem;border-radius:var(--radius);font-size:.95rem;font-weight:600;cursor:pointer;transition:background-color .2s}
    .btn:hover{background:var(--accent-hover)}
    .btn:disabled{background:#adb5bd;cursor:not-allowed}

    /* ---------- Layout wrappers ---------- */
    #pageWrapper{flex:1;display:flex;flex-direction:column}
    .container{width:min(100%,700px);margin-inline:auto;padding-inline:1rem}

    /* Search */
    #searchBar{margin:1rem auto 0 auto}
    #searchInput{width:100%;padding:.55rem .85rem;font-size:1rem;border:1px solid #ced4da;border-radius:var(--radius);background:var(--bg-surface);color:var(--text-body)}

    /* Upload form */
    #uploadForm{margin-top:1.25rem}
    #uploadForm textarea{width:100%;margin-top:.75rem;padding:.65rem .85rem;font-size:1rem;border:1px solid #ced4da;border-radius:var(--radius);resize:vertical;min-height:6rem;background:var(--bg-surface);color:var(--text-body)}

    /* Post card */
    .post-item{background:var(--bg-surface-alt);border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;margin-block:1.25rem;box-shadow:var(--shadow-sm)}
    .post-owner{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:1px solid #ced4da;box-shadow:var(--shadow-sm)}
    .post-time{font-size:.85rem;color:var(--text-muted);margin-top:2px}
    .post-caption{margin-top:.75rem;white-space:pre-wrap;word-wrap:break-word}
    .post-media{margin-top:.75rem}
    video,img{border-radius:var(--radius);background:#000;display:block}
    .post-actions{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
    .post-actions button{flex:1 1 auto}
    .post-actions button.liked{background:#28a745!important}
    .post-actions button.boosted{background:gold!important;color:#000!important}

    /* Comments */
    .comments-list{margin-top:.75rem;background:var(--bg-surface);padding:.65rem;border-radius:var(--radius);max-height:10rem;overflow-y:auto}
    .comments-list div{margin-bottom:.5rem}
    .comment-box textarea{width:100%;border-radius:var(--radius);padding:.6rem .8rem}

    /* A11y focus */
    button:focus-visible,#menuToggle:focus-visible{outline:2px solid #fff;outline-offset:2px}
  </style>
</head>

<body>
<!-- ──────────────── NAV / HEADER ──────────────── -->
<header>
  <div class="brand">
    <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="DRFMedia Logo" />
    <span>DRFMedia</span>
  </div>

  <button id="menuToggle" aria-label="Toggle navigation" aria-controls="primaryNav" aria-expanded="false">
    <span></span><span></span><span></span>
  </button>

  <nav id="primaryNav">
    <a href="media.html">Timeline</a>
    <a href="profile.html" class="active">Profile</a>
    <a href="media.html">Posts</a>
    <a href="gift.html">Donation</a>
    <a href="chat.html">Chat</a>
  </nav>
</header>

<!-- ──────────────── MAIN PAGE CONTENT ──────────────── -->
<div id="pageWrapper">

  <!-- Search -->
  <section id="searchBar" class="container">
    <input type="search" id="searchInput" placeholder="Search posts…" aria-label="Search posts" />
  </section>

  <!-- Auth buttons -->
  <button id="loginBtn"  class="btn" style="display:block;max-width:700px;margin:1rem auto;">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;max-width:700px;margin:1rem auto;background:#dc3545;">Logout</button>

  <!-- Upload -->
  <form id="uploadForm" class="container" style="display:none;">
    <input type="file" id="mediaFile" accept="image/*,video/*" required />
    <textarea id="caption" placeholder="Write your caption…" required minlength="4"></textarea>
    <button type="submit" class="btn" style="margin-top:.75rem;">Post</button>
  </form>

  <!-- Posts -->
  <section id="postContainer" class="container" aria-live="polite"></section>

</div>


<!-- ──────────────── APP LOGIC ──────────────── -->
<script type="module">
/* ---------------- Firebase & Pinata setup ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, get  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

/*  Replace with your own JWT if needed  */
const pinataJWT = "Bearer <YOUR‑PINATA‑JWT‑HERE>";

const firebaseConfig = {
  apiKey:            "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain:        "drfsocial-23a06.firebaseapp.com",
  databaseURL:       "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId:         "drfsocial-23a06",
  storageBucket:     "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId:             "1:608135115201:web:dc999df2c0c37241ff3f40"
};

const app   = initializeApp(firebaseConfig);
const db    = getDatabase(app);
const auth  = getAuth(app);
const provider = new GoogleAuthProvider();

/* ---------------- DOM refs ---------------- */
const loginBtn        = document.getElementById("loginBtn");
const logoutBtn       = document.getElementById("logoutBtn");
const uploadForm      = document.getElementById("uploadForm");
const mediaFile       = document.getElementById("mediaFile");
const captionInput    = document.getElementById("caption");
const postContainer   = document.getElementById("postContainer");
const searchInput     = document.getElementById("searchInput");
const menuToggle      = document.getElementById("menuToggle");
const primaryNav      = document.getElementById("primaryNav");

/* ---------------- State ---------------- */
let currentUser = null;
let allPosts    = [];

/* Quick XSS escape */
const escapeHTML = s => s.replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));

/* ---------------- Auth Flow ---------------- */
loginBtn.onclick  = () => signInWithPopup(auth, provider).catch(e => alert("Login failed: "+e.message));
logoutBtn.onclick = () => signOut(auth).catch(e => alert("Logout failed: "+e.message));

onAuthStateChanged(auth, user=>{
  currentUser = user;
  uploadForm.style.display = user ? "block":"none";
  loginBtn .style.display   = user ? "none" :"block";
  logoutBtn.style.display   = user ? "block":"none";
  renderPosts();
});

/* ---------------- Upload handler ---------------- */
uploadForm.addEventListener("submit", async e=>{
  e.preventDefault();
  if(!currentUser)         return alert("Please login.");
  if(!mediaFile.files[0])  return alert("Select a file.");
  if(captionInput.value.trim().length<4) return alert("Caption too short.");
  uploadForm.querySelector("button").disabled = true;

  const file = mediaFile.files[0];
  const fd   = new FormData();
  fd.append("file", file);

  try{
    /* Pin to IPFS via Pinata */
    const up = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS",{
      method:"POST",
      headers:{ Authorization: pinataJWT },
      body:fd
    });
    if(!up.ok) throw new Error("Pinata upload failed: "+up.statusText);
    const { IpfsHash } = await up.json();

    /* Save post record */
    const newRef = push(ref(db,"posts"));
    await set(newRef,{
      userId:      currentUser.uid,
      displayName: currentUser.displayName,
      photoURL:    currentUser.photoURL,
      caption:     captionInput.value.trim(),
      ipfsHash:    IpfsHash,
      mediaType:   file.type.startsWith("video") ? "video":"image",
      mediaMimeType:file.type,
      timestamp:   Date.now(),
      likesCount:0, commentsCount:0, boostsCount:0,
      likedBy:{},  boostedBy:{}
    });

    captionInput.value=""; mediaFile.value="";
    alert("Posted!");
  }catch(err){ alert(err.message) }
  finally{ uploadForm.querySelector("button").disabled=false }
});

/* ---------------- Load posts ---------------- */
onValue(ref(db,"posts"), snap=>{
  const posts = snap.val() || {};
  allPosts = Object.entries(posts).map(([id, p])=>({id,...p})).sort((a,b)=>b.timestamp-a.timestamp);
  renderPosts();
});

/* ---------------- Render ---------------- */
function renderPosts(){
  const term = searchInput.value.trim().toLowerCase();
  postContainer.innerHTML="";
  for(const post of allPosts){
    if(!post.caption.toLowerCase().includes(term)) continue;

    const url1 = "https://gateway.pinata.cloud/ipfs/"+post.ipfsHash;
    const date = new Date(post.timestamp).toLocaleString();

    const liked   = currentUser && post.likedBy   && post.likedBy  [currentUser.uid];
    const boosted = currentUser && post.boostedBy && post.boostedBy[currentUser.uid];

    const card = document.createElement("article");
    card.className="post-item";
    card.innerHTML = `
      <header class="post-owner">
        <img src="${post.photoURL || "https://via.placeholder.com/40"}" alt="avatar" class="avatar">
        <div>
          <div>${escapeHTML(post.displayName||"Anon")}</div>
          <time class="post-time" datetime="${new Date(post.timestamp).toISOString()}">${date}</time>
        </div>
      </header>
      <div class="post-caption">${escapeHTML(post.caption)}</div>
      <div class="post-media">
        ${ post.mediaType==="video"
            ? `<video src="${url1}" controls playsinline preload="metadata"></video>`
            : `<img src="${url1}" alt="media">` }
      </div>
      <div class="post-actions">
        <button class="${liked?'liked':''}"   onclick="likePost('${post.id}')">👍 Like (${post.likesCount||0})</button>
        <button                        onclick="commentOnPost('${post.id}')">💬 Comment (${post.commentsCount||0})</button>
        <button class="${boosted?'boosted':''}" onclick="boostPost('${post.id}')">🚀 Boost (${post.boostsCount||0})</button>
        <button                        onclick="repost('${post.id}')">🔄 Repost</button>
      </div>
      <div id="comments-${post.id}"     class="comments-list" aria-live="polite"></div>
      <div id="comment-box-${post.id}"  class="comment-box" style="display:none">
        <textarea id="comment-input-${post.id}" rows="2" placeholder="Write a comment…"></textarea>
        <button onclick="submitComment('${post.id}')">Submit</button>
        <button onclick="cancelComment('${post.id}')">Cancel</button>
      </div>`;
    postContainer.appendChild(card);
    loadComments(post.id);
  }
}

/* ---------------- Actions ---------------- */
window.likePost = async id=>{
  if(!currentUser) return alert("Login to like.");
  const pRef = ref(db,"posts/"+id);
  const snap = await get(pRef);
  if(!snap.exists()) return;
  const p = snap.val();
  const list = p.likedBy || {};
  list[currentUser.uid] ? delete list[currentUser.uid] : list[currentUser.uid]=true;
  await set(ref(db,`posts/${id}/likedBy`), list);
  await set(ref(db,`posts/${id}/likesCount`), Object.keys(list).length);
};

window.boostPost = async id=>{
  if(!currentUser) return alert("Login to boost.");
  const pRef = ref(db,"posts/"+id);
  const snap = await get(pRef);
  if(!snap.exists()) return;
  const p = snap.val();
  const list = p.boostedBy || {};
  list[currentUser.uid] ? delete list[currentUser.uid] : list[currentUser.uid]=true;
  await set(ref(db,`posts/${id}/boostedBy`), list);
  await set(ref(db,`posts/${id}/boostsCount`), Object.keys(list).length);
};

window.repost = async id=>{
  if(!currentUser) return alert("Login to repost.");
  const oSnap = await get(ref(db,"posts/"+id));
  if(!oSnap.exists()) return;
  const o = oSnap.val();
  const newRef = push(ref(db,"posts"));
  await set(newRef,{
    userId:currentUser.uid,
    displayName:currentUser.displayName,
    photoURL:currentUser.photoURL,
    caption:`[Reposted by ${currentUser.displayName||"Anon"}]\n\n${o.caption}`,
    ipfsHash:o.ipfsHash,
    mediaType:o.mediaType,
    mediaMimeType:o.mediaMimeType,
    timestamp:Date.now(),
    likesCount:0,commentsCount:0,boostsCount:0,
    likedBy:{},boostedBy:{}
  });
  alert("Reposted!");
};

/* Comments */
window.commentOnPost = id=>document.getElementById(`comment-box-${id}`).style.display="block";
window.cancelComment = id=>document.getElementById(`comment-box-${id}`).style.display="none";
window.submitComment = async id=>{
  if(!currentUser) return alert("Login to comment.");
  const txt = document.getElementById(`comment-input-${id}`).value.trim();
  if(!txt) return alert("Empty comment.");
  const cRef = push(ref(db,`comments/${id}`));
  await set(cRef,{
    userId:currentUser.uid,
    displayName:currentUser.displayName,
    photoURL:currentUser.photoURL,
    text:txt,
    timestamp:Date.now()
  });
  /* increment count */
  const pSnap = await get(ref(db,"posts/"+id));
  if(pSnap.exists()){
    const n = (pSnap.val().commentsCount||0)+1;
    await set(ref(db,`posts/${id}/commentsCount`),n);
  }
  document.getElementById(`comment-input-${id}`).value="";
  window.cancelComment(id);
};

/* Load comments */
async function loadComments(id){
  const cSnap = await get(ref(db,`comments/${id}`));
  const box = document.getElementById(`comments-${id}`);
  if(!box) return;
  box.innerHTML="";
  if(!cSnap.exists()) return;
  const arr = Object.values(cSnap.val()).sort((a,b)=>a.timestamp-b.timestamp);
  for(const c of arr){
    const t = new Date(c.timestamp).toLocaleString();
    const d = document.createElement("div");
    d.innerHTML = `<strong>${escapeHTML(c.displayName||"Anon")}:</strong> ${escapeHTML(c.text)}<br><small>${t}</small>`;
    box.appendChild(d);
  }
}

/* Search filter */
searchInput.addEventListener("input", renderPosts);

/* Mobile nav toggle */
menuToggle.addEventListener("click", ()=>{
  primaryNav.classList.toggle("open");
  const open = primaryNav.classList.contains("open");
  menuToggle.setAttribute("aria-expanded", open);
});
</script>
</body>
</html>
