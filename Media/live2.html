<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DRFChain Media - Go Live</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; text-align: center; padding: 20px; }
    video { width: 90%; max-width: 600px; border-radius: 12px; margin-top: 20px; background: #000; }
    button { margin: 15px; padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; }
    #goLiveBtn { background: #28a745; color: white; }
    #stopBtn { background: #dc3545; color: white; }
    #status { margin-top: 15px; font-weight: bold; }
    a.playback { color: #1e90ff; display: block; margin-top: 20px; }
  </style>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
      authDomain: "drfsocial-23a06.firebaseapp.com",
      databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
      projectId: "drfsocial-23a06",
      storageBucket: "drfsocial-23a06.firebasestorage.app",
      messagingSenderId: "608135115201",
      appId: "1:608135115201:web:b37dffeb550941ffff3f40",
      measurementId: "G-TPT7QMWDYE"
    };

    const app = initializeApp(firebaseConfig);
    const functions = getFunctions(app);

    // Expose functions globally
    window.firebaseFunctions = functions;
  </script>
</head>
<body>
  <h1>üé• DRFChain Media - Go Live</h1>
  <video id="preview" autoplay muted playsinline></video><br>
  <button id="goLiveBtn">üöÄ Go Live</button>
  <button id="stopBtn" disabled>‚èπ Stop</button>
  <p id="status">Not live</p>
  <a id="playbackLink" class="playback" href="#" target="_blank"></a>

  <!-- Livepeer WebRTC SDK -->
  <script src="https://unpkg.com/@livepeer/webrtmp-sdk"></script>

  <script type="module">
    const goLiveBtn = document.getElementById("goLiveBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const preview = document.getElementById("preview");
    const playbackLink = document.getElementById("playbackLink");

    // Your Livepeer stream info
    const STREAM_ID = "71f601e4-3d7b-4428-9bc5-23c1049d9e61";
    const PLAYBACK_URL = "https://livepeercdn.studio/hls/71f6n2n0h31cgvn1/index.m3u8";

    let session;
    let mediaStream;

    async function startLive() {
      try {
        statusEl.innerText = "Requesting camera/mic...";
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        preview.srcObject = mediaStream;

        statusEl.innerText = "Fetching Livepeer token...";
        // Call Firebase Cloud Function to get temporary token
        const getToken = httpsCallable(window.firebaseFunctions, 'getLivepeerToken');
        const res = await getToken({ streamId: STREAM_ID });
        const token = res.data.token;

        statusEl.innerText = "Starting live stream...";

        const client = new Livepeer.WebRTMP.Client({ token });
        session = client.cast(mediaStream, { streamKey: STREAM_ID });
        await session.start();

        statusEl.innerText = "‚úÖ You are LIVE!";
        playbackLink.href = PLAYBACK_URL;
        playbackLink.innerText = "üì∫ Watch playback here";
        goLiveBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error("Failed to start live stream:", err);
        statusEl.innerText = "‚ùå Failed to start live stream. Check console.";
      }
    }

    function stopLive() {
      if (session) {
        session.close();
        session = null;
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        preview.srcObject = null;
      }
      statusEl.innerText = "Stopped";
      goLiveBtn.disabled = false;
      stopBtn.disabled = true;
    }

    goLiveBtn.addEventListener("click", startLive);
    stopBtn.addEventListener("click", stopLive);
  </script>
</body>
</html>
