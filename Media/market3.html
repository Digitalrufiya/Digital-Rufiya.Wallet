<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DRF Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 text-center text-2xl font-bold">
    DRF Marketplace
  </header>

  <!-- Payment Section -->
  <section id="paymentSection" class="p-4 text-center">
    <h2 class="text-xl mb-2">Pay 1 USDC to Post</h2>
    <button id="payBtn" class="bg-green-600 text-white px-4 py-2 rounded">Pay with MetaMask</button>
    <p id="paymentStatus" class="mt-2 text-gray-700"></p>
  </section>

  <!-- Post Form -->
  <section id="postSection" class="p-4 hidden">
    <h2 class="text-xl mb-4">Create a Post</h2>
    <textarea id="postText" class="w-full border rounded p-2 mb-2" placeholder="Write something..."></textarea>
    <input type="file" id="mediaUpload" accept="image/*,video/*" class="mb-2">
    <button id="postBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Post</button>
  </section>

  <!-- Posts Feed -->
  <section id="feed" class="p-4">
    <h2 class="text-xl mb-4">Latest Posts</h2>
    <div id="posts" class="space-y-4"></div>
  </section>

<script>
const PINATA_JWT = "YOUR_PINATA_JWT"; // keep safe later
const BSC_USDC = "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d"; // USDC on BSC
const ADMIN_WALLET = "YOUR_WALLET_HERE"; // where payments go
let web3, accounts;

// Connect to MetaMask
async function connectWallet() {
  if (window.ethereum) {
    web3 = new Web3(window.ethereum);
    accounts = await ethereum.request({ method: "eth_requestAccounts" });
    return accounts[0];
  } else {
    alert("Install MetaMask!");
  }
}

// Pay 1 USDC
document.getElementById("payBtn").onclick = async () => {
  const user = await connectWallet();
  const usdc = new web3.eth.Contract([
    {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"},
    {"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"}
  ], BSC_USDC);

  const amount = web3.utils.toWei("1", "mwei"); // USDC = 6 decimals
  try {
    await usdc.methods.transfer(ADMIN_WALLET, amount).send({ from: user });
    document.getElementById("paymentStatus").innerText = "✅ Payment complete! You can post now.";
    document.getElementById("postSection").classList.remove("hidden");
    document.getElementById("paymentSection").classList.add("hidden");
  } catch (err) {
    document.getElementById("paymentStatus").innerText = "❌ Payment failed.";
  }
};

// Upload to Pinata
async function uploadToPinata(file) {
  const formData = new FormData();
  formData.append("file", file);
  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
    method: "POST",
    headers: { Authorization: `Bearer ${PINATA_JWT}` },
    body: formData
  });
  const data = await res.json();
  return `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;
}

// Save post
document.getElementById("postBtn").onclick = async () => {
  const text = document.getElementById("postText").value;
  const file = document.getElementById("mediaUpload").files[0];
  let mediaUrl = null;
  if (file) mediaUrl = await uploadToPinata(file);

  const post = { text, mediaUrl, user: accounts[0], time: new Date().toISOString() };
  const posts = JSON.parse(localStorage.getItem("posts") || "[]");
  posts.unshift(post);
  localStorage.setItem("posts", JSON.stringify(posts));
  loadPosts();
};

// Load posts
function loadPosts() {
  const posts = JSON.parse(localStorage.getItem("posts") || "[]");
  const container = document.getElementById("posts");
  container.innerHTML = "";
  posts.forEach(p => {
    const div = document.createElement("div");
    div.className = "bg-white p-3 rounded shadow";
    div.innerHTML = `
      <p class="mb-2"><b>${p.user}</b> <span class="text-gray-500 text-sm">${new Date(p.time).toLocaleString()}</span></p>
      <p>${p.text}</p>
      ${p.mediaUrl ? (p.mediaUrl.match(/.mp4|.webm/) ? `<video src="${p.mediaUrl}" controls class="mt-2 max-h-64 w-full"></video>` : `<img src="${p.mediaUrl}" class="mt-2 max-h-64 w-full rounded">`) : ""}
    `;
    container.appendChild(div);
  });
}
loadPosts();
</script>
</body>
</html>
