<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRF Marketplace — Free Uploads</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:18px; background:#fff; color:#111; }
#upload-section { background:#f3f4f6; padding:16px; border-radius:10px; max-width:1000px; margin:18px auto; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
input, textarea, button { box-sizing:border-box; width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #d1d5db; }
button{ background:#2563eb; color:#fff; border:none; padding:10px; cursor:pointer; }
button:disabled{ background:#9ca3af; cursor:default; }
#posts{ max-width:1000px; margin:18px auto; }
.post{ background:#f3f4f6; padding:14px; border-radius:8px; margin-bottom:14px; box-shadow:0 4px 12px rgba(0,0,0,0.04); position:relative; }
.badge{ position:absolute; top:12px; right:12px; background:#2563eb; color:#fff; padding:4px 8px; font-size:12px; border-radius:6px; }
.buttons{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
.small{ font-size:13px; color:#6b7280; }
img, video { max-width:100%; border-radius:8px; margin-top:8px; }
.header { text-align:center; margin-bottom:10px; }
.comment-box { margin-top:10px; }
.comment { background:#fff; padding:6px; border-radius:4px; margin-top:4px; font-size:14px; }
</style>
</head>
<body>

<div class="header">
  <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="DRFMedia Logo" style="width:120px;margin-bottom:10px;" />
  <h1>DRF Marketplace — Upload & Listings</h1>
  <p class="small">Free users can post images and videos up to 1 minute. All uploads are free!</p>
</div>

<section id="upload-section">
  <h2>Upload Product</h2>
  <input type="file" id="mediaInput" accept="image/*,video/*" />
  <input type="text" id="titleInput" placeholder="Title" />
  <textarea id="descriptionInput" placeholder="Description" rows="3"></textarea>
  <input type="number" id="priceInput" placeholder="Price (USD)" />
  <input type="text" id="locationInput" placeholder="Location (City or Country)" />
  <input type="text" id="whatsappInput" placeholder="WhatsApp Number" />
  <input type="text" id="paymentLinkInput" placeholder="Seller Payment Link" />
  <div style="margin-top:12px">
    <button id="uploadBtn">Upload Product</button>
  </div>
  <p id="uploadStatus" class="small"></p>
</section>

<section id="posts"></section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp, limit, startAfter, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebaseapp.com",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUser = null;
onAuthStateChanged(auth, user => { if(user) currentUser=user; else signInAnonymously(auth).catch(console.error); });

// Pinata upload
async function uploadToPinata(file){
  const form = new FormData(); form.append("file", file);
  const PINATA_JWT = "Bearer YOUR_PINATA_JWT"; // replace with yours
  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", { method:"POST", headers:{Authorization:PINATA_JWT}, body:form });
  if(!res.ok) throw new Error("Pinata upload failed");
  const js = await res.json(); 
  return js.IpfsHash;
}

const uploadBtn = document.getElementById("uploadBtn");
const uploadStatus = document.getElementById("uploadStatus");
const postsContainer = document.getElementById("posts");

uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();
  const price = parseFloat(document.getElementById("priceInput").value);
  const location = document.getElementById("locationInput").value.trim();
  const whatsapp = document.getElementById("whatsappInput").value.trim();
  const paymentLink = document.getElementById("paymentLinkInput").value.trim();

  if(!fileInput.files[0] || !title || !description || isNaN(price) || !location || !whatsapp || !paymentLink){
    alert("All fields required"); return;
  }

  uploadBtn.disabled = true;
  uploadStatus.textContent = "Uploading media to IPFS...";

  try{
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video") ? "video" : "image";

    await addDoc(collection(db,"posts"),{
      title, description, price, location, whatsapp, paymentLink,
      ipfsHash, mediaType, createdAt: serverTimestamp(), likes:[], comments:[]
    });

    uploadStatus.textContent = "✅ Upload successful!";
    fileInput.value=""; document.getElementById("titleInput").value="";
    document.getElementById("descriptionInput").value=""; document.getElementById("priceInput").value="";
    document.getElementById("locationInput").value=""; document.getElementById("whatsappInput").value="";
    document.getElementById("paymentLinkInput").value="";
    loadPosts(true);
  } catch(err){ console.error(err); alert("Upload failed: "+err.message); } finally{uploadBtn.disabled=false;}
};

// Try next video gateway
function tryNextGateway(video){
  let gateways = JSON.parse(video.getAttribute("data-gateways"));
  if(!video.currentFallback) video.currentFallback = 0;
  video.currentFallback++;
  if(video.currentFallback < gateways.length){
    video.src = gateways[video.currentFallback];
    video.load();
    video.play().catch(()=>{});
  }
}

// Load posts
let lastVisible=null, loading=false;
async function loadPosts(reset=false){
  if(loading) return; loading=true;
  if(reset){ postsContainer.innerHTML=""; lastVisible=null; }
  const q = lastVisible
    ? query(collection(db,"posts"),orderBy("createdAt","desc"),startAfter(lastVisible),limit(8))
    : query(collection(db,"posts"),orderBy("createdAt","desc"),limit(8));
  try{
    const snap = await getDocs(q);
    if(snap.empty){ if(postsContainer.children.length===0){ const p=document.createElement("p"); p.className="small"; p.textContent="No listings yet."; postsContainer.appendChild(p); } loading=false; return; }
    snap.forEach(docSnap=>{
      const d = docSnap.data(); const docId = docSnap.id;
      const div = document.createElement("div"); div.className="post";
      div.innerHTML=`<div class="badge">Free</div>
        <h3>${d.title||''}</h3>
        <p>${d.description||''}</p>
        <p><b>Price:</b> $${d.price||''} | <b>Location:</b> ${d.location||''}</p>
        <p><b>WhatsApp:</b> <a href="https://wa.me/${encodeURIComponent(d.whatsapp||'')}" target="_blank">${d.whatsapp||''}</a></p>
      `;
      if(d.mediaType==="video" && d.ipfsHash){
        const gateways = [
          `https://gateway.pinata.cloud/ipfs/${d.ipfsHash}`,
          `https://cloudflare-ipfs.com/ipfs/${d.ipfsHash}`,
          `https://ipfs.io/ipfs/${d.ipfsHash}`
        ];
        const vid = document.createElement("video");
        vid.controls=true; vid.preload="auto"; vid.playsInline=true;
        vid.dataset.gateways = JSON.stringify(gateways); vid.src=gateways[0];
        vid.onerror = ()=>tryNextGateway(vid);
        div.appendChild(vid);
      } else if(d.ipfsHash){
        const img = document.createElement("img"); img.src=`https://gateway.pinata.cloud/ipfs/${d.ipfsHash}`;
        div.appendChild(img);
      }
      // Like + Comments
      const likesCount = d.likes ? d.likes.length : 0;
      const likeBtn = document.createElement("button"); likeBtn.textContent=`❤️ Like (${likesCount})`;
      likeBtn.onclick = async ()=>{
        const ref = doc(db,"posts",docId);
        if(d.likes && d.likes.includes(currentUser.uid)){
          await updateDoc(ref,{likes:arrayRemove(currentUser.uid)});
          d.likes = d.likes.filter(l=>l!==currentUser.uid);
        } else {
          await updateDoc(ref,{likes:arrayUnion(currentUser.uid)});
          d.likes = [...(d.likes||[]),currentUser.uid];
        }
        likeBtn.textContent=`❤️ Like (${d.likes.length})`;
      };

      const commentToggle = document.createElement("button"); commentToggle.textContent="💬 Comments";
      const commentsDiv = document.createElement("div"); commentsDiv.style.display="none"; commentsDiv.className="comment-box";
      if(d.comments && d.comments.length){
        d.comments.forEach(c=>{ const cc=document.createElement("div"); cc.className="comment"; cc.textContent=c; commentsDiv.appendChild(cc); });
      }
      const commentInput = document.createElement("input"); commentInput.placeholder="Write a comment";
      const commentSubmit = document.createElement("button"); commentSubmit.textContent="Post";
      commentSubmit.onclick=async()=>{
        if(!commentInput.value.trim()) return;
        await updateDoc(doc(db,"posts",docId),{comments:arrayUnion(commentInput.value.trim())});
        const cc=document.createElement("div"); cc.className="comment"; cc.textContent=commentInput.value.trim();
        commentsDiv.appendChild(cc); commentInput.value="";
      };
      commentsDiv.appendChild(commentInput); commentsDiv.appendChild(commentSubmit);

      commentToggle.onclick=()=>{ commentsDiv.style.display = commentsDiv.style.display==="none" ? "block" : "none"; };

      const buttonsDiv = document.createElement("div"); buttonsDiv.className="buttons";
      const payBtn = document.createElement("a"); payBtn.href=d.paymentLink||"#"; payBtn.target="_blank"; payBtn.innerHTML="<button>Pay Seller</button>";
      buttonsDiv.appendChild(payBtn); buttonsDiv.appendChild(likeBtn); buttonsDiv.appendChild(commentToggle);

      div.appendChild(buttonsDiv); div.appendChild(commentsDiv);
      postsContainer.appendChild(div);
    });
    lastVisible=snap.docs[snap.docs.length-1];
  } catch(err){ console.error("Load posts error:",err);} finally{loading=false;}
}

loadPosts(true);
window.addEventListener("scroll",()=>{ if((window.innerHeight+window.scrollY)>=(document.body.offsetHeight-120)) loadPosts(); });
</script>
</body>
</html>
