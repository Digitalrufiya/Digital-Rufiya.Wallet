<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DRF Marketplace</title>
<style>
body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:0; }
header { background:#007bff; color:#fff; padding:1rem; text-align:center; font-size:1.5rem; }
.container { max-width:700px; margin:2rem auto; padding:1rem; background:#fff; border-radius:.5rem; box-shadow:0 2px 6px rgba(0,0,0,.1); }
input, textarea, button { width:100%; margin:.5rem 0; padding:.5rem; font-size:1rem; }
button { cursor:pointer; background:#007bff; color:#fff; border:none; border-radius:.25rem; }
button:hover { background:#0056b3; }
#prog { width:100%; height:6px; background:#e9ecef; border-radius:3px; overflow:hidden; display:none; margin-top:.5rem; }
#progBar { height:6px; width:0; background:#007bff; }
.product { margin:1rem 0; border:1px solid #ddd; border-radius:.25rem; padding:.75rem; background:#fefefe; }
.product img, .product video { max-width:100%; border-radius:.25rem; display:block; margin-top:.5rem; }
</style>
</head>
<body>

<header>DRF Marketplace</header>
<div class="container">
  <h2>Upload Product</h2>
  <form id="uploadForm">
    <input type="text" id="title" placeholder="Product Title" required />
    <textarea id="description" placeholder="Product Description"></textarea>
    <input type="file" id="mediaFile" accept="image/*,video/*" required />
    <button type="submit">Upload Product</button>
    <div id="prog"><div id="progBar"></div></div>
  </form>

  <h2>Products</h2>
  <div id="productList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

// === Firebase config ===
const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  databaseURL: "https://drfmarket-place-default-rtdb.firebaseio.com",
  projectId: "drfmarket-place",
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const PINATA_JWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI0MjA3ZmYxYS05MDU2LTRkZTktOGE2Yi1lM2JiZTA1YmY0YmEiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWF1bml2ZXJzaXR5QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiIyYjA3YjEyOWJkYTA0YTY2YmE0YSIsInNjb3BlZEtleVNlY3JldCI6IjYxZDdhMGVhYzVmNjAyNzhhNjQyODNlMjdmMTM2YjkxMjQ3YjM4NDg5MjA4YTUzNGYxNWFlMTE2Njc3ZGNkZGQiLCJleHAiOjE3ODYyNzUyNDJ9.BFUeEjlCR0jtpr1vylWYd5VkKVtDkNDhEuC2-3IFW1w";

const form = document.getElementById("uploadForm");
const fileIn = document.getElementById("mediaFile");
const titleIn = document.getElementById("title");
const descIn = document.getElementById("description");
const prog = document.getElementById("prog");
const bar = document.getElementById("progBar");
const productList = document.getElementById("productList");

let user = null;

// === Anonymous login ===
signInAnonymously(auth).catch(err => alert("Anonymous login failed: " + err.message));
onAuthStateChanged(auth, u => { user = u; loadProducts(); });

// === Upload to Pinata ===
async function uploadToPinata(file, onProgress){
  return new Promise((resolve,reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open("POST","https://api.pinata.cloud/pinning/pinFileToIPFS");
    xhr.setRequestHeader("Authorization",PINATA_JWT);
    xhr.upload.onprogress = e => {
      if(e.lengthComputable && onProgress){
        onProgress(Math.round((e.loaded/e.total)*100));
      }
    };
    xhr.onload = () => {
      if(xhr.status === 200){
        const hash = JSON.parse(xhr.responseText).IpfsHash;
        resolve("https://gateway.pinata.cloud/ipfs/" + hash);
      } else reject(new Error("Pinata upload failed"));
    };
    xhr.onerror = () => reject(new Error("XHR error"));
    const data = new FormData(); data.append("file", file); xhr.send(data);
  });
}

// === Form submit ===
form.onsubmit = async e => {
  e.preventDefault();
  if(!user) return alert("Please wait for login...");
  if(!fileIn.files[0]) return alert("Select a file");
  const file = fileIn.files[0];
  const title = titleIn.value.trim();
  const desc = descIn.value.trim();

  prog.style.display = "block"; bar.style.width = "0%";

  try{
    const mediaURL = await uploadToPinata(file, pct => { bar.style.width = pct+"%"; });
    const newRef = push(ref(db,"products"));
    await set(newRef, {
      uid: user.uid,
      title, description: desc, mediaURL,
      mediaType: file.type.startsWith("video")?"video":"image",
      timestamp: Date.now()
    });
    fileIn.value = ""; titleIn.value = ""; descIn.value = "";
    bar.style.width = "0%"; prog.style.display = "none";
    loadProducts();
  } catch(err){
    alert("Upload failed: "+err.message);
    bar.style.width = "0%"; prog.style.display = "none";
  }
};

// === Load products ===
async function loadProducts(){
  const snap = await get(ref(db,"products"));
  const obj = snap.val()||{};
  productList.innerHTML = "";
  Object.values(obj).sort((a,b)=>b.timestamp-a.timestamp).forEach(p=>{
    const div = document.createElement("div");
    div.className = "product";
    div.innerHTML = `<strong>${p.title}</strong><p>${p.description||""}</p>`;
    if(p.mediaType==="video"){
      const v = document.createElement("video");
      v.src = p.mediaURL; v.controls=true; v.width=300; div.appendChild(v);
    } else {
      const img = document.createElement("img");
      img.src = p.mediaURL; div.appendChild(img);
    }
    productList.appendChild(div);
  });
}
</script>

</body>
</html>
