<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DRF Marketplace</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
  #upload-section { background: white; padding: 15px; margin: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 720px; }
  input, textarea, button { display: block; width: 100%; margin: 10px 0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
  button { cursor: pointer; background-color: #007bff; color: white; border: none; font-weight: 600; }
  button:disabled { background: #aaa; cursor: default; }
  #wrap { max-width: 900px; margin: 0 auto; padding: 10px; }
  #posts { max-width: 720px; margin: 20px auto; padding: 10px; }
  .post { background: white; margin-bottom: 20px; border-radius: 12px; padding: 15px; box-shadow: 0 0 6px rgba(0,0,0,0.08); }
  .post h3 { margin: 0 0 6px; }
  .post video, .post img { width: 100%; max-height: 480px; object-fit: cover; border-radius: 10px; margin-top: 10px; background:#000; }
  .meta { color:#555; font-size: 14px; margin:6px 0 8px; }
  .buttons { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
  .buttons button { flex: 1; }
  #loading { text-align: center; padding: 20px; font-size: 16px; color: #555; }
  #uploadStatus { min-height: 20px; font-size: 14px; color:#444; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div id="wrap">
  <section id="upload-section">
    <h2>Upload your Listing</h2>

    <input type="file" id="mediaInput" accept="image/*,video/*" />
    <div class="row">
      <input type="text" id="titleInput" placeholder="Title" required />
      <input type="number" id="priceInput" placeholder="Price (USD)" required />
    </div>
    <textarea id="descriptionInput" placeholder="Description" rows="3" required></textarea>
    <div class="row">
      <input type="text" id="locationInput" placeholder="Location" required />
      <input type="text" id="whatsappInput" placeholder="WhatsApp Number" required />
    </div>

    <div class="row">
      <button id="payBtn">Pay 1 USDC</button>
      <button id="uploadBtn" disabled>Upload Listing</button>
    </div>

    <label><input type="checkbox" id="testMode" /> Test mode (skip payment)</label>
    <div id="uploadStatus"></div>
  </section>

  <section id="posts"></section>
  <div id="loading">Loading posts...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, startAfter, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.appspot.com",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ---------------- Pinata JWT (yours) ---------------- */
const PINATA_JWT = `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI0MjA3ZmYxYS05MDU2LTRkZTktOGE2Yi1lM2JiZTA1YmY0YmEiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWF1bml2ZXJzaXR5QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiIyYjA3YjEyOWJkYTA0YTY2YmE0YSIsInNjb3BlZEtleVNlY3JldCI6IjYxZDdhMGVhYzVmNjAyNzhhNjQyODNlMjdmMTM2YjkxMjQ3YjM4NDg5MjA4YTUzNGYxNWFlMTE2Njc3ZGNkZGQiLCJleHAiOjE3ODYyNzUyNDJ9.BFUeEjlCR0jtpr1vylWYd5VkKVtDkNDhEuC2-3IFW1w`;

async function uploadToPinata(file) {
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const data = new FormData();
  data.append("file", file);

  const res = await fetch(url, {
    method: "POST",
    headers: { Authorization: PINATA_JWT },
    body: data
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error("Pinata upload failed: " + txt);
  }
  const result = await res.json();
  return result.IpfsHash;
}

/* ---------------- Upload form ---------------- */
const uploadBtn = document.getElementById("uploadBtn");
const payBtn = document.getElementById("payBtn");
const testMode = document.getElementById("testMode");
const statusEl = document.getElementById("uploadStatus");

payBtn.onclick = () => {
  alert("Simulating payment. Now you can upload.");
  uploadBtn.disabled = false;
  payBtn.disabled = true;
};
testMode.onchange = () => {
  uploadBtn.disabled = !testMode.checked;
};

uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();
  const price = parseFloat(document.getElementById("priceInput").value);
  const location = document.getElementById("locationInput").value.trim();
  const whatsapp = document.getElementById("whatsappInput").value.trim();

  if (!fileInput.files[0] || !title || !description || isNaN(price) || !location || !whatsapp) {
    alert("All fields are required");
    return;
  }

  uploadBtn.disabled = true;
  statusEl.textContent = "Uploading to IPFS...";

  try {
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video") ? "video" : "image";

    await addDoc(collection(db, "posts"), {
      title, description, price, location, whatsapp,
      ipfsHash, mediaType, createdAt: serverTimestamp()
    });

    statusEl.textContent = "Upload successful!";
    fileInput.value = "";
    loadPosts(true);
  } catch (err) {
    console.error(err);
    statusEl.textContent = "Upload failed: " + err.message;
  } finally {
    uploadBtn.disabled = false;
  }
};

/* ---------------- Load posts ---------------- */
let lastVisible = null;
let loadingPosts = false;
const postsContainer = document.getElementById("posts");
const loadingEl = document.getElementById("loading");

function createPostElement(postData, postId) {
  const div = document.createElement("div");
  div.classList.add("post");
  div.dataset.id = postId;
  div.innerHTML = `
    <h3>${postData.title}</h3>
    <p>${postData.description}</p>
    <p><strong>Price:</strong> $${postData.price}</p>
    <p><strong>Location:</strong> ${postData.location}</p>
    <p><strong>WhatsApp:</strong> <a href="https://wa.me/${postData.whatsapp}" target="_blank">${postData.whatsapp}</a></p>
    <div>
      ${postData.mediaType === "video"
        ? `<video width="100%" controls src="https://gateway.pinata.cloud/ipfs/${postData.ipfsHash}"></video>`
        : `<img src="https://gateway.pinata.cloud/ipfs/${postData.ipfsHash}" alt="${postData.title}" />`}
    </div>
  `;
  return div;
}

async function loadPosts(reset=false) {
  if (loadingPosts) return;
  loadingPosts = true;
  if (reset) { postsContainer.innerHTML = ""; lastVisible = null; }

  try {
    let q = lastVisible
      ? query(collection(db, "posts"), orderBy("createdAt", "desc"), startAfter(lastVisible), limit(5))
      : query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(5));

    const snap = await getDocs(q);
    snap.forEach(doc => {
      const data = doc.data();
      postsContainer.appendChild(createPostElement(data, doc.id));
    });
    if (!snap.empty) lastVisible = snap.docs[snap.docs.length-1];
  } catch (err) {
    console.error(err);
  }
  loadingPosts = false;
}

window.addEventListener("scroll", () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) loadPosts();
});

onAuthStateChanged(auth, user => { if (!user) signInAnonymously(auth); });

loadPosts();
</script>
</body>
</html>
