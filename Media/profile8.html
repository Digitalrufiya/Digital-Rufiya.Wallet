<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Profile | DRFMedia</title>
  <style>
    /* ---------- GLOBAL / NAV ---------- */
    body{font-family:Arial,sans-serif;margin:0;background:#f4f4f4;color:#222}
    nav{background:#0066cc;display:flex;justify-content:center;gap:20px;padding:15px 0;flex-wrap:wrap}
    nav a,nav button.logout-btn{color:#fff;text-decoration:none;font-weight:700;font-size:1.1rem;padding:8px 16px;border-radius:6px;transition:background .3s;cursor:pointer;border:none;background:none}
    nav a:hover,nav a.active,nav button.logout-btn:hover{background:#004999}
    nav button.logout-btn{background:#cc3300}
    nav a:focus,nav button.logout-btn:focus{outline:2px solid #fff;outline-offset:2px}

    /* ---------- PROFILE CARD ---------- */
    #profile{max-width:700px;margin:20px auto;background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    #coverPhoto{width:100%;height:180px;object-fit:cover;border-radius:10px 10px 0 0;background:#ddd;cursor:pointer;margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.2rem;color:#fff;background:linear-gradient(135deg,#007bff 0%,#0056b3 100%)}
    #profilePhotoWrapper{position:relative;width:120px;height:120px;margin:-70px auto 10px;border-radius:50%;border:4px solid #fff;overflow:hidden;cursor:pointer;background:#eee}
    #profilePhoto{width:100%;height:100%;object-fit:cover;display:block}
    input[type=file]{display:none}

    #editName,#editBio,#editToken{width:100%;border-radius:6px;padding:8px;margin-bottom:12px;border:1px solid #ccc;font-family:inherit}
    #editName{font-weight:700;font-size:1.5rem}
    #editBio{min-height:60px;resize:vertical}
    #editToken{font-family:monospace}
    #saveProfileBtn{display:block;margin:0 auto 20px;background:#0066cc;color:#fff;border:none;padding:12px 30px;font-size:1rem;border-radius:8px;cursor:pointer;transition:background .3s}
    #saveProfileBtn:disabled{background:#999;cursor:not-allowed}

    /* ---------- POSTS ---------- */
    #userPosts{max-width:700px;margin:30px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .post-item{border:1px solid #ccc;border-radius:6px;padding:15px;margin-bottom:20px;background:#fafafa}
    .post-owner{display:flex;align-items:center;gap:10px;font-weight:700}
    .post-time{font-size:.85em;color:#555;margin-top:4px}
    .post-caption{margin-top:10px;white-space:pre-wrap}
    video,img{max-width:100%;border-radius:6px;margin-top:10px;background:#000;display:block}
    .avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid #ccc;box-shadow:0 0 3px rgba(0,0,0,.1)}

    /* wallet badge */
    .drfm-wallet{font-weight:600;font-family:monospace;color:#007bff;margin-top:6px;font-size:.9rem}
    .drfm-wallet.missing{color:#d9534f;font-style:italic}

    /* post actions */
    .post-actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .post-actions button{cursor:pointer;border:none;background:#007bff;color:#fff;padding:6px 14px;border-radius:6px;font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:6px;transition:background .3s}
    .post-actions button:hover{background:#0056b3}
    .post-actions button.liked{background:#28a745!important;box-shadow:0 0 8px #28a745aa}
    /* comments */
    .comments-container{margin-top:10px;max-height:160px;overflow-y:auto;border-top:1px solid #ccc;padding-top:8px;font-size:.9rem}
    .comment{display:flex;align-items:flex-start;gap:8px;margin-bottom:8px}
    .comment img.avatar{width:28px;height:28px;border-radius:50%;background:#eee}
    .comment-body{background:#f5f5f5;padding:6px 12px;border-radius:8px;flex:1}
    .comment-body strong{display:block;color:#007bff;margin-bottom:4px}
    .comment-form{margin-top:10px;display:flex;gap:8px}
    .comment-form input{flex:1;padding:8px 12px;border-radius:6px;border:1.5px solid #ccc;font-size:1rem}
    .comment-form input:focus{border-color:#007bff}
    .comment-form button{background:#007bff;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-weight:600;cursor:pointer}
    .comment-form button:hover{background:#0056b3}

    /* mobile tweaks */
    @media(max-width:480px){#profile,#userPosts{margin:10px;padding:15px}#profilePhotoWrapper{width:90px;height:90px;margin:-55px auto 10px}#editName{font-size:1.2rem}nav{gap:10px}nav a,nav button.logout-btn{font-size:1rem;padding:6px 12px}}
  </style>
</head>
<body>
<nav>
  <a href="media.html">Timeline</a>
  <a href="profile.html" class="active">Profile</a>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</nav>

<div id="profile">
  <img id="coverPhoto" src="" alt="Cover Photo (click to change)" tabindex="0"/>
  <div id="profilePhotoWrapper" tabindex="0">
    <img id="profilePhoto" src="" alt="Profile Photo"/>
  </div>
  <input type="file" id="coverPhotoInput" accept="image/*"/>
  <input type="file" id="profilePhotoInput" accept="image/*"/>

  <input id="editName" type="text" maxlength="50" placeholder="Your name"/>
  <textarea id="editBio" maxlength="250" placeholder="Your bio (optional)"></textarea>
  <input id="editToken" type="text" maxlength="42" placeholder="Your DRFM Wallet Address (for donations/charity)"/>
  <button id="saveProfileBtn" disabled>Save Profile</button>
</div>

<div id="userPosts" aria-live="polite"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js';
import { getDatabase, ref, onValue, get, update } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js';
import { getAuth, onAuthStateChanged, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js';
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:dc999df2c0c37241ff3f40"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

const coverPhoto = document.getElementById('coverPhoto');
const profilePhoto = document.getElementById('profilePhoto');
const coverInput = document.getElementById('coverPhotoInput');
const profileInput = document.getElementById('profilePhotoInput');
const editName = document.getElementById('editName');
const editBio = document.getElementById('editBio');
const editToken = document.getElementById('editToken');
const saveBtn = document.getElementById('saveProfileBtn');
const postsBox = document.getElementById('userPosts');
const logoutBtn = document.getElementById('logoutBtn');

let me = null, profileData = {};
const esc = s => String(s).replace(/[&<>"]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;" })[c]);
const timeAgo = t => {
  const s = Math.floor((Date.now() - t) / 1000);
  const r = [[31536e3, 'year'], [2592e3, 'month'], [86400, 'day'], [3600, 'hour'], [60, 'minute']];
  for (const [sec, l] of r) {
    const v = Math.floor(s / sec);
    if (v >= 1) return `${v} ${l}${v > 1 ? 's' : ''} ago`;
  }
  return 'Just now';
};

function changed() {
  saveBtn.disabled = !(
    editName.value.trim() !== (me?.displayName || "") ||
    editBio.value.trim() !== (profileData.bio || "") ||
    editToken.value.trim() !== (profileData.drfmToken || "") ||
    coverPhoto.src.startsWith('blob:') ||
    profilePhoto.src.startsWith('blob:')
  );
}

// Upload image to Firebase Storage and get download URL
async function uploadImage(file, path) {
  const imageRef = storageRef(storage, path);
  await uploadBytes(imageRef, file);
  const url = await getDownloadURL(imageRef);
  return url;
}

// Handle cover photo upload
coverInput.onchange = async e => {
  const f = e.target.files[0];
  if (f) {
    coverPhoto.src = URL.createObjectURL(f); // temporary preview
    changed();
    try {
      const url = await uploadImage(f, `users/${me.uid}/coverPhoto_${Date.now()}`);
      coverPhoto.src = url;
      profileData.coverPhoto = url;
      changed();
    } catch (err) {
      alert('Error uploading cover photo: ' + err.message);
    }
  }
};

// Handle profile photo upload
profileInput.onchange = async e => {
  const f = e.target.files[0];
  if (f) {
    profilePhoto.src = URL.createObjectURL(f); // temporary preview
    changed();
    try {
      const url = await uploadImage(f, `users/${me.uid}/profilePhoto_${Date.now()}`);
      profilePhoto.src = url;
      profileData.photoURL = url;
      changed();
    } catch (err) {
      alert('Error uploading profile photo: ' + err.message);
    }
  }
};

coverPhoto.onclick = () => coverInput.click();
profilePhoto.parentElement.onclick = () => profileInput.click();
coverPhoto.onkeydown = e => ['Enter', ' '].includes(e.key) && coverInput.click();
profilePhoto.parentElement.onkeydown = e => ['Enter', ' '].includes(e.key) && profileInput.click();
[editName, editBio, editToken].forEach(i => i.oninput = changed);

logoutBtn.onclick = async () => {
  await signOut(auth);
  location.href = 'timeline.html';
};

saveBtn.onclick = async () => {
  if (!me) return;
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving…';
  try {
    const uRef = ref(db, 'users/' + me.uid);
    const up = {};
    if (profileData.coverPhoto) up.coverPhoto = profileData.coverPhoto;
    if (profileData.photoURL) up.photoURL = profileData.photoURL;
    if (editName.value.trim() !== (me.displayName || "")) {
      await updateProfile(me, { displayName: editName.value.trim() });
    }
    up.bio = editBio.value.trim();
    up.drfmToken = editToken.value.trim();
    await update(uRef, up);
    profileData = { ...profileData, ...up };
    alert('Profile saved!');
  } catch (e) {
    alert('Save error: ' + e.message);
  }
  saveBtn.textContent = 'Save Profile';
  changed();
};

onAuthStateChanged(auth, async user => {
  if (!user) {
    alert('Please login');
    location.href = 'timeline.html';
    return;
  }
  me = user;
  const snap = await get(ref(db, 'users/' + user.uid));
  profileData = snap.exists() ? snap.val() : {};
  profilePhoto.src = profileData.photoURL || user.photoURL || 'https://via.placeholder.com/120';
  coverPhoto.src = profileData.coverPhoto || 'https://via.placeholder.com/700x180?text=Cover+Photo';
  editName.value = user.displayName || '';
  editBio.value = profileData.bio || '';
  editToken.value = profileData.drfmToken || '';
  changed();
  loadPosts(user.uid);
});

function loadPosts(uid) {
  postsBox.textContent = 'Loading posts…';
  onValue(ref(db, 'posts'), snap => {
    const posts = snap.val() || {};
    const list = Object.entries(posts)
      .filter(([id, p]) => p.userId === uid)
      .sort((a, b) => b[1].timestamp - a[1].timestamp);
    if (!list.length) {
      postsBox.textContent = 'No posts yet.';
      return;
    }
    postsBox.innerHTML = '';
    list.forEach(([id, p]) => renderPost(id, p));
  });
}

function renderPost(id, p) {
  const url1 = `https://gateway.pinata.cloud/ipfs/${p.ipfsHash}`;
  const url2 = `https://cloudflare-ipfs.com/ipfs/${p.ipfsHash}`;
  const walletAddr = p.drfAddress || profileData.drfmToken || '';
  const walletHTML = walletAddr ? `<div class='drfm-wallet' title='DRFM Wallet Address'>DRFM Wallet: ${esc(walletAddr)}</div>` : `<div class='drfm-wallet missing'>⚠️ DRFM Wallet Address not set</div>`;
  const el = document.createElement('div');
  el.className = 'post-item';
  el.dataset.id = id;
  el.innerHTML = `
    <div class='post-owner'>
      <img class='avatar' src='${p.photoURL}' alt='avatar'/>
      <div>
        <strong>${esc(p.displayName || 'Anonymous')}</strong>
        ${walletHTML}
      </div>
    </div>
    <div class='post-time' title='${new Date(p.timestamp).toLocaleString()}'>${timeAgo(p.timestamp)}</div>
    ${p.mediaType === 'video' ? `<video controls><source src='${url1}' type='${p.mediaMimeType}'/></video>` : `<img src='${url1}' onerror="this.src='${url2}'" alt='media'/>`}
    <div class='post-caption'>${esc(p.caption)}</div>
    <div class='post-actions'>
      <button class='like-btn' aria-pressed='false'>❤️ <span class='likes-count'>0</span></button>
      <button class='comment-toggle-btn' aria-expanded='false'>💬 Comments (0)</button>
      <button class='share-btn'>🔗 Share</button>
    </div>
    <div class='comments-container' hidden>
      <div class='comments-list'></div>
      <form class='comment-form'>
        <input placeholder='Write a comment…' required/>
        <button>Send</button>
      </form>
    </div>`;
  postsBox.appendChild(el);
  setupPost(id, el);
}

function setupPost(id, el) {
  const likeBtn = el.querySelector('.like-btn');
  const likesSpan = likeBtn.querySelector('.likes-count');
  const ctBtn = el.querySelector('.comment-toggle-btn');
  const cBox = el.querySelector('.comments-container');
  const cList = cBox.querySelector('.comments-list');
  const cForm = cBox.querySelector('.comment-form');
  const shareBtn = el.querySelector('.share-btn');

  onValue(ref(db, `posts/${id}/likes`), snap => {
    const data = snap.val() || {};
    likesSpan.textContent = Object.keys(data).length;
    const liked = !!data[me?.uid];
    likeBtn.classList.toggle('liked', liked);
    likeBtn.ariaPressed = liked;
  });

  likeBtn.onclick = async () => {
    if (!me) return alert('Login first');
    const lRef = ref(db, `posts/${id}/likes/${me.uid}`);
    const ex = (await get(lRef)).exists();
    await update(lRef, ex ? null : true);
  };

  ctBtn.onclick = () => {
    const h = cBox.hasAttribute('hidden');
    if (h) {
      cBox.removeAttribute('hidden');
      ctBtn.ariaExpanded = 'true';
      loadComments(id, cList, ctBtn);
    } else {
      cBox.hidden = true;
      ctBtn.ariaExpanded = 'false';
    }
  };

  cForm.onsubmit = async e => {
    e.preventDefault();
    if (!me) return alert('Login first');
    const inp = cForm.querySelector('input');
    const t = inp.value.trim();
    if (!t) return;
    const cRef = ref(db, `posts/${id}/comments/${Date.now().toString(36) + Math.random().toString(36).slice(2, 7)}`);
    await update(cRef, { displayName: me.displayName || 'Anon', photoURL: me.photoURL || '', text: esc(t), timestamp: Date.now() });
    inp.value = '';
  };

  shareBtn.onclick = () => {
    const url = `${location.origin}/post.html?id=${id}`;
    navigator.clipboard?.writeText(url).then(() => alert('URL copied!')).catch(() => prompt('Copy URL:', url));
  };
}

function loadComments(id, list, btn) {
  onValue(ref(db, `posts/${id}/comments`), snap => {
    const d = snap.val() || {};
    list.innerHTML = '';
    Object.entries(d).sort((a, b) => a[1].timestamp - b[1].timestamp).forEach(([cid, c]) => {
      const e = document.createElement('div');
      e.className = 'comment';
      e.innerHTML = `<img class='avatar' src='${c.photoURL || 'https://via.placeholder.com/28'}' alt='avatar'/><div class='comment-body'><strong>${esc(c.displayName)}</strong>${esc(c.text)}<br><small>${new Date(c.timestamp).toLocaleString()}</small></div>`;
      list.appendChild(e);
    });
    btn.textContent = `💬 Comments (${Object.keys(d).length})`;
  });
}
</script>
</body>
</html>
