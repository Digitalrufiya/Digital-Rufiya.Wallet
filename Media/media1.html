<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia â€” Post & View (Optimized)</title>
<meta name="color-scheme" content="light dark" />
<style>
/* Same styles as before */
:root {
  --accent:#007bff;--accent-hover:#0056b3;--accent-muted:#3399ff;
  --bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;
  --text-body:#212529;--text-muted:#6c757d;--radius:.5rem;
}
body{font-family:sans-serif;background:var(--bg-body);color:var(--text-body);margin:0}
header{background:var(--accent);color:#fff;padding:.75rem 1rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.brand{display:flex;flex-direction:column}
.brand-header{display:flex;align-items:center;gap:.5rem}
.brand img{width:2.25rem;height:2.25rem;background:#fff;padding:2px;border-radius:.25rem}
#rewardBtn{background:#ffc107;border:none;padding:.4rem .75rem;border-radius:.5rem;cursor:pointer;margin-top:.5rem}
.container{width:min(100%,700px);margin:auto;padding:1rem}
.post-item{background:var(--bg-surface-alt);border-radius:.5rem;padding:1rem;margin:1rem 0}
video,img{max-width:100%;border-radius:.5rem;background:#000;opacity:0;transition:opacity .3s}
[data-loaded="true"]{opacity:1}
#prog{width:100%;height:4px;background:#ddd;display:none;margin:.5rem 0}
#progBar{height:4px;width:0;background:var(--accent)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-header">
      <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png" alt="DRFMedia logo"/>
      <span>DRFMedia</span>
    </div>
    <button id="rewardBtn">Share & Get Rewards</button>
  </div>
  <button id="loginBtn">Sign in with Google</button>
  <button id="logoutBtn" style="display:none;background:#dc3545;color:#fff">Logout</button>
</header>

<main class="container">
  <form id="uploadForm" style="display:none">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <textarea id="caption" minlength="4" placeholder="Write your captionâ€¦" required></textarea>
    <div id="prog"><div id="progBar"></div></div>
    <button type="submit">Post</button>
  </form>

  <section id="postContainer"></section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA"; // ðŸ”´ Replace with your JWT

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:b3d1f368e0c09ac4400f43"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const $ = id => document.getElementById(id);
const login = $("loginBtn"), logout = $("logoutBtn");
const upload = $("uploadForm"), fileIn = $("mediaFile"), capIn = $("caption");
const prog = $("prog"), bar = $("progBar");
const posts = $("postContainer");

let user=null;

function createImage(cid){
  const img=document.createElement("img");
  img.src=`https://gateway.pinata.cloud/ipfs/${cid}`;
  img.onload=()=>img.setAttribute("data-loaded","true");
  return img;
}
function createVideo(cid){
  const v=document.createElement("video");
  v.controls=true;v.preload="metadata";
  v.src=`https://gateway.pinata.cloud/ipfs/${cid}`;
  v.oncanplay=()=>v.setAttribute("data-loaded","true");
  return v;
}
function renderCard(p){
  const div=document.createElement("div");
  div.className="post-item";
  div.innerHTML=`<div><b>${p.displayName||"Anon"}</b> â€” ${new Date(p.timestamp).toLocaleString()}</div>
  <p>${p.caption}</p>`;
  if(p.mediaType==="video") div.appendChild(createVideo(p.ipfsHash));
  else div.appendChild(createImage(p.ipfsHash));
  return div;
}
async function getPosts(){
  const snap=await get(ref(db,"posts"));
  const obj=snap.val()||{};
  posts.innerHTML="";
  Object.entries(obj).reverse().forEach(([id,v])=>{
    posts.appendChild(renderCard({id,...v}));
  });
}

login.onclick=()=>signInWithPopup(auth,provider);
logout.onclick=()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  user=u;
  login.style.display=u?"none":"inline-block";
  logout.style.display=u?"inline-block":"none";
  upload.style.display=u?"block":"none";
  if(u) getPosts();
});

upload.onsubmit=async e=>{
  e.preventDefault();
  const file=fileIn.files[0];
  if(!file) return alert("Choose a file");
  if(capIn.value.trim().length<4) return alert("Caption too short");
  upload.querySelector("button").disabled=true;
  prog.style.display="block";bar.style.width="0";

  try{
    const fd=new FormData();fd.append("file",file);
    const xhr=new XMLHttpRequest();
    xhr.open("POST","https://api.pinata.cloud/pinning/pinFileToIPFS");
    xhr.setRequestHeader("Authorization",pinataJWT);
    xhr.upload.onprogress=(e)=>{if(e.lengthComputable) bar.style.width=(e.loaded/e.total)*100+"%";};

    const cid=await new Promise((res,rej)=>{
      xhr.onload=()=>{
        try{
          const resp=JSON.parse(xhr.responseText);
          if(resp.IpfsHash) res(resp.IpfsHash);
          else rej("Pinata error: "+xhr.responseText);
        }catch(err){rej("Parse error: "+err.message);}
      };
      xhr.onerror=()=>rej("Upload failed");
      xhr.send(fd);
    });

    const newRef=push(ref(db,"posts"));
    await set(newRef,{
      userId:user.uid,
      displayName:user.displayName||"Anon",
      photoURL:user.photoURL||"",
      caption:capIn.value.trim(),
      ipfsHash:cid,
      mediaType:file.type.startsWith("video")?"video":"image",
      timestamp:Date.now(),
    });

    fileIn.value="";capIn.value="";
    bar.style.width="100%";
    setTimeout(()=>prog.style.display="none",400);
    await getPosts();
    window.scrollTo({top:0,behavior:"smooth"});
  }catch(e){alert(e);}
  finally{upload.querySelector("button").disabled=false;}
};
</script>
</body>
</html>
