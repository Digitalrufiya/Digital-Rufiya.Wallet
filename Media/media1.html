<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia - Upload</title>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: #fff;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    h1 { color: #0af; text-align: center; }
    label { margin-top: 10px; display: block; font-weight: bold; }
    input, textarea, button {
      width: 100%; margin-top: 5px; padding: 10px;
      background: #1f1f1f; color: #fff; border: none; border-radius: 6px;
    }
    button { background: #0af; font-weight: bold; cursor: pointer; }
    #postList video, #postList img {
      width: 100%; margin-top: 10px; border-radius: 10px;
    }
    .post { border: 1px solid #333; padding: 15px; border-radius: 8px; margin-top: 20px; background: #1a1a1a; }
    .avatar { width: 32px; height: 32px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
  </style>
</head>
<body>

<h1>ðŸŽ¥ DRFMedia Upload</h1>

<button id="loginBtn">Login with Google</button>
<button id="logoutBtn" style="display:none;">Logout</button>

<form id="uploadForm" style="display:none; margin-top: 20px;">
  <label>Caption *</label>
  <input id="caption" type="text" placeholder="Enter caption..." required />
  
  <label>Choose file (image/video) *</label>
  <input id="fileInput" type="file" accept="image/*,video/*" required />
  
  <button type="submit">Upload</button>
</form>

<div id="status" style="margin-top:15px;color:#0f6;"></div>
<div id="postList"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import {
    getDatabase, ref, push, set, onValue
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
  import {
    getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...YOUR_JWT_ENDS_HERE"; // Replace with your full JWT

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const uploadForm = document.getElementById("uploadForm");
  const fileInput = document.getElementById("fileInput");
  const captionInput = document.getElementById("caption");
  const statusEl = document.getElementById("status");
  const postList = document.getElementById("postList");

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    currentUser = user;
    uploadForm.style.display = user ? "block" : "none";
    loginBtn.style.display = user ? "none" : "block";
    logoutBtn.style.display = user ? "block" : "none";
    if (user) loadPosts();
  });

  loginBtn.onclick = () => signInWithPopup(auth, provider).catch(console.error);
  logoutBtn.onclick = () => signOut(auth);

  uploadForm.onsubmit = async e => {
    e.preventDefault();
    const file = fileInput.files[0];
    if (!file || !captionInput.value.trim()) return;

    statusEl.textContent = "Uploading to IPFS...";
    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
        method: "POST",
        headers: { Authorization: pinataJWT },
        body: formData
      });
      if (!res.ok) throw new Error("Pinata upload failed");
      const data = await res.json();
      const ipfsUrl = `https://gateway.pinata.cloud/ipfs/${data.IpfsHash}`;

      const mediaType = file.type.startsWith("video") ? "video" : "image";
      await push(ref(db, "posts"), {
        uid: currentUser.uid,
        name: currentUser.displayName,
        photo: currentUser.photoURL,
        caption: captionInput.value.trim(),
        mediaUrl: ipfsUrl,
        mediaType,
        timestamp: Date.now()
      });

      captionInput.value = "";
      fileInput.value = "";
      statusEl.textContent = "âœ… Uploaded successfully";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "âŒ Upload failed";
    }
  };

  function loadPosts() {
    onValue(ref(db, "posts"), snapshot => {
      postList.innerHTML = "";
      const data = snapshot.val();
      if (!data) return;
      Object.values(data).reverse().forEach(post => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <div><img class="avatar" src="${post.photo||''}"/> <strong>${post.name||'Unknown'}</strong></div>
          <div style="margin-top:5px;">${post.caption}</div>
          ${post.mediaType === 'video'
            ? `<video controls preload="metadata" style="margin-top:10px;"><source src="${post.mediaUrl}" type="video/mp4"></video>`
            : `<img src="${post.mediaUrl}" alt="Media"/>`}
          <div style="font-size:0.8em; color:#aaa;">${new Date(post.timestamp).toLocaleString()}</div>
        `;
        postList.appendChild(div);
      });
    });
  }
</script>

</body>
</html>
