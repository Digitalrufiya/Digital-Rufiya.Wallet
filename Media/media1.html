<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFMedia Social - Post & Like</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 0 15px; background: #f0f2f5; }
    h1 { color: #0066cc; }
    input, textarea, select, button {
      font-size: 1rem; padding: 8px; margin: 5px 0 15px 0; width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 5px;
    }
    button {
      background: #0066cc; color: white; border: none; cursor: pointer;
      max-width: 150px;
    }
    button:disabled { background: #999; cursor: not-allowed; }
    .post-card {
      background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      margin-bottom: 20px; padding: 15px;
    }
    .post-header { display: flex; justify-content: space-between; font-weight: bold; color: #333; }
    .post-actions button { margin-right: 10px; }
    .post-ipfs { font-family: monospace; font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>

<h1>DRFMedia Social</h1>

<section id="connectWalletSection">
  <button id="connectWalletBtn">Connect Wallet</button>
  <p id="walletAddress"></p>
</section>

<section id="postSection" style="display:none;">
  <h2>Create Post</h2>
  <label>IPFS Hash (Qm...):</label>
  <input type="text" id="ipfsHashInput" placeholder="Qm..." />
  <label>Media Type:</label>
  <select id="mediaTypeSelect">
    <option value="0">Video</option>
    <option value="1">Image</option>
  </select>
  <button id="postBtn" disabled>Post & Earn DRFM</button>
</section>

<hr/>

<section>
  <h2>Recent Posts</h2>
  <div id="postsContainer">Loading posts...</div>
</section>

<script src="https://cdn.ethers.io/lib/ethers-5.6.umd.min.js"></script>
<script>
  const contractAddress = "0x9CF972437e17927C1114F44D2D38aA77c4845d01";
  const contractABI = [
    // Add minimal ABI pieces for post, getPost, totalPosts, likePost, getComments, commentOnPost
    {
      "inputs": [
        { "internalType": "string", "name": "ipfsHash", "type": "string" },
        { "internalType": "uint8", "name": "mediaType", "type": "uint8" }
      ],
      "name": "post",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [{ "internalType": "uint256", "name": "index", "type": "uint256" }],
      "name": "getPost",
      "outputs": [
        { "internalType": "address", "name": "author", "type": "address" },
        { "internalType": "string", "name": "ipfsHash", "type": "string" },
        { "internalType": "uint8", "name": "mediaType", "type": "uint8" },
        { "internalType": "uint256", "name": "likes", "type": "uint256" },
        { "internalType": "bool", "name": "flagged", "type": "bool" }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "totalPosts",
      "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [{ "internalType": "uint256", "name": "postId", "type": "uint256" }],
      "name": "likePost",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];

  let provider;
  let signer;
  let contract;
  let walletAddress = null;

  const connectWalletBtn = document.getElementById("connectWalletBtn");
  const walletAddressP = document.getElementById("walletAddress");
  const postSection = document.getElementById("postSection");
  const postBtn = document.getElementById("postBtn");
  const ipfsHashInput = document.getElementById("ipfsHashInput");
  const mediaTypeSelect = document.getElementById("mediaTypeSelect");
  const postsContainer = document.getElementById("postsContainer");

  connectWalletBtn.onclick = async () => {
    try {
      // Detect provider - supports metamask or standalone wallets injecting ethereum provider
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        walletAddress = await signer.getAddress();
      } else if (window.myStandaloneWallet) {
        // If you have a standalone wallet object
        provider = new ethers.providers.Web3Provider(window.myStandaloneWallet.provider);
        signer = window.myStandaloneWallet.getSigner();
        walletAddress = await signer.getAddress();
      } else {
        alert("No wallet detected! Please install MetaMask or use your standalone wallet.");
        return;
      }

      contract = new ethers.Contract(contractAddress, contractABI, signer);
      walletAddressP.textContent = "Connected Wallet: " + walletAddress;
      connectWalletBtn.style.display = "none";
      postSection.style.display = "block";
      loadPosts();

      // Enable post button only when IPFS hash input is valid
      ipfsHashInput.addEventListener("input", () => {
        postBtn.disabled = !ipfsHashInput.value.trim().startsWith("Qm");
      });
    } catch (err) {
      alert("Failed to connect wallet: " + err.message);
    }
  };

  postBtn.onclick = async () => {
    const ipfsHash = ipfsHashInput.value.trim();
    const mediaType = parseInt(mediaTypeSelect.value);

    if (!ipfsHash || !ipfsHash.startsWith("Qm")) {
      alert("Enter valid IPFS hash starting with Qm...");
      return;
    }

    postBtn.disabled = true;
    postBtn.textContent = "Posting...";

    try {
      const tx = await contract.post(ipfsHash, mediaType);
      await tx.wait();
      alert("Post created and DRFM tokens rewarded!");
      ipfsHashInput.value = "";
      postBtn.disabled = true;
      postBtn.textContent = "Post & Earn DRFM";
      loadPosts();
    } catch (err) {
      alert("Failed to post: " + err.message);
      postBtn.disabled = false;
      postBtn.textContent = "Post & Earn DRFM";
    }
  };

  async function loadPosts() {
    postsContainer.innerHTML = "Loading posts...";

    try {
      const total = await contract.totalPosts();
      if (total.toNumber() === 0) {
        postsContainer.innerHTML = "<p>No posts yet.</p>";
        return;
      }

      let html = "";
      for (let i = total.toNumber() - 1; i >= 0; i--) {
        const post = await contract.getPost(i);

        html += `
          <div class="post-card">
            <div class="post-header">
              <span>Author: ${post.author}</span>
              <span>Likes: ${post.likes.toString()}</span>
            </div>
            <div class="post-ipfs">IPFS: ${post.ipfsHash}</div>
            <div>
              Media Type: ${post.mediaType == 0 ? "Video" : "Image"}
            </div>
            <div class="post-actions" style="margin-top:10px;">
              <button onclick="likePost(${i})">üëç Like</button>
            </div>
          </div>
        `;
      }
      postsContainer.innerHTML = html;
    } catch (err) {
      postsContainer.innerHTML = "Failed to load posts: " + err.message;
    }
  }

  window.likePost = async function(postId) {
    try {
      const tx = await contract.likePost(postId);
      await tx.wait();
      alert("You liked the post and earned DRFM tokens!");
      loadPosts();
    } catch (err) {
      alert("Failed to like post: " + err.message);
    }
  }
</script>
</body>
</html>
