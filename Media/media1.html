<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>DRFMedia Timeline ‚Äî Spread Kindness & Truth</title>

  <!-- keep your optional external css -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /*  =====  YOUR ORIGINAL CSS (unchanged, shortened here)  ===== */
    :root{--accent:#007bff;--accent-hover:#0056b3;--accent-muted:#0069d9;
          --bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;
          --text-body:#212529;--text-muted:#6c757d;--radius:.5rem;
          --shadow-sm:0 1px 2px rgba(0,0,0,.06);--shadow-md:0 2px 4px rgba(0,0,0,.1)}
    @media(prefers-color-scheme:dark){
      :root{--bg-body:#181a1b;--bg-surface:#242628;--bg-surface-alt:#2b2e30;
            --text-body:#f1f3f5;--text-muted:#adb5bd;--shadow-sm:none;--shadow-md:none}}
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg-body);color:var(--text-body);display:flex;flex-direction:column}
    a{color:inherit;text-decoration:none}
    img,video{max-width:100%}
    /* header / nav, buttons, layout, cards ‚Ä¶ unchanged */
    .post-media video{width:100%;border-radius:var(--radius);background:#000}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="DRFMedia Logo">
    <span>DRFMedia</span>
  </div>
  <button id="menuToggle" aria-label="Toggle navigation" aria-controls="primaryNav" aria-expanded="false">
    <span></span><span></span><span></span></button>
  <nav id="primaryNav">
    <a href="media.html">Timeline</a>
    <a href="profile.html" class="active">Profile</a>
    <a href="media.html">Posts</a>
    <a href="gift.html">Donation</a>
    <a href="chat.html">Chat</a>
  </nav>
</header>

<div id="pageWrapper">
  <section id="searchBar" class="container">
    <input id="searchInput" type="search" placeholder="Search posts‚Ä¶" aria-label="Search posts">
  </section>

  <button id="loginBtn"  class="btn" style="display:block;max-width:700px;margin:1rem auto;">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;max-width:700px;margin:1rem auto;background:#dc3545;">Logout</button>

  <form id="uploadForm" class="container" style="display:none;">
    <input id="mediaFile" type="file" accept="image/*,video/*" required>
    <textarea id="caption" placeholder="Write your caption‚Ä¶" minlength="4" required></textarea>
    <button class="btn" type="submit" style="margin-top:.75rem;">Post</button>
  </form>

  <section id="postContainer" class="container" aria-live="polite"></section>
</div>

<!-- ‚òÖ helper that swaps gateways when a <video> errors -->
<script>
const _gw = [
  "https://ipfs.io/ipfs/",
  "https://gateway.pinata.cloud/ipfs/",
  "https://cloudflare-ipfs.com/ipfs/"
];
window.tryNextGateway = vid=>{
  const hash = vid.dataset.hash;
  let idx = (+vid.dataset.gw||0)+1;
  if(idx>=_gw.length) idx = 0;
  vid.dataset.gw = idx;
  vid.querySelector("source").src = _gw[idx]+hash;
  vid.load();
};
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

/* ----------  YOUR ORIGINAL CONFIG & JWT  ---------- */
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";
const firebaseConfig = {
  apiKey:"AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain:"drfsocial-23a06.firebaseapp.com",
  databaseURL:"https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId:"drfsocial-23a06",
  storageBucket:"drfsocial-23a06.appspot.com",
  messagingSenderId:"608135115201",
  appId:"1:608135115201:web:dc999df2c0c37241ff3f40"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const auth= getAuth(app);
const provider = new GoogleAuthProvider();

/* ----------  DOM refs & state (unchanged) ---------- */
const loginBtn  = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const uploadForm= document.getElementById("uploadForm");
const mediaFile = document.getElementById("mediaFile");
const captionIn = document.getElementById("caption");
const postWrap  = document.getElementById("postContainer");
const searchIn  = document.getElementById("searchInput");
const menuTog   = document.getElementById("menuToggle");
const primaryNav= document.getElementById("primaryNav");

let currentUser=null, isAdmin=false, allPosts=[];

/* escape util */
const esc = s=>String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));

/* ----------  auth, upload logic UNCHANGED ---------- */
loginBtn.onclick  = ()=>signInWithPopup(auth,provider).catch(e=>alert(e.message));
logoutBtn.onclick = ()=>signOut(auth).catch(e=>alert(e.message));

onAuthStateChanged(auth,async user=>{
  currentUser=user;
  uploadForm.style.display=user?"block":"none";
  loginBtn .style.display=user?"none":"block";
  logoutBtn.style.display=user?"block":"none";
  if(user){
    const adSnap = await get(ref(db,`admin/${user.uid}`));
    isAdmin = adSnap.exists();
  } else isAdmin=false;
  renderPosts();
});

/* ----------  posts listener ---------- */
onValue(ref(db,"posts"),snap=>{
  const p=snap.val()||{};
  allPosts = Object.entries(p).map(([id,v])=>({id,...v}))
            .sort((a,b)=>b.timestamp-a.timestamp);
  renderPosts();
});

/* ----------  RENDER POSTS (video fix inside) ---------- */
function renderPosts(){
  const q = searchIn.value.trim().toLowerCase();
  postWrap.innerHTML = "";
  for(const p of allPosts){
    if(!p.caption.toLowerCase().includes(q)) continue;

    /* media markup with multi‚Äëgateway fallback for videos */
    const media = p.mediaType==="video"
      ? `<video controls preload="none" playsinline
               data-hash="${p.ipfsHash}" data-gw="0"
               poster="https://ipfs.io/ipfs/${p.ipfsHash}#t=0.5"
               onerror="tryNextGateway(this)">
           <source src="https://ipfs.io/ipfs/${p.ipfsHash}" type="${p.mediaMimeType||'video/mp4'}">
         </video>`
      : `<img src="https://ipfs.io/ipfs/${p.ipfsHash}"
              loading="lazy"
              onerror="this.onerror=null;this.src='https://cloudflare-ipfs.com/ipfs/${p.ipfsHash}'"
              alt="media">`;

    const liked   = currentUser && p.likedBy   && p.likedBy  [currentUser.uid];
    const boosted = currentUser && p.boostedBy && p.boostedBy[currentUser.uid];
    const owner   = currentUser && p.userId===currentUser.uid;

    postWrap.insertAdjacentHTML("beforeend",`
      <article class="post-item" id="post-${p.id}">
        <header class="post-owner">
          <img class="avatar" src="${p.photoURL||'https://via.placeholder.com/40'}" alt="">
          <div>
            <div>${esc(p.displayName||"Anon")}</div>
            <time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">
              ${new Date(p.timestamp).toLocaleString()}
            </time>
          </div>
        </header>
        <div class="post-caption">${esc(p.caption)}</div>
        <div class="post-media">${media}</div>
        <div class="post-actions">
          <button class="${liked?'liked':''}"  onclick="likePost('${p.id}')">üëç Like (${p.likesCount||0})</button>
          <button                     onclick="commentOnPost('${p.id}')">üí¨ Comment (${p.commentsCount||0})</button>
          <button class="${boosted?'boosted':''}" onclick="boostPost('${p.id}')">üöÄ Boost (${p.boostsCount||0})</button>
          <button                     onclick="repost('${p.id}')">üîÑ Repost</button>
        </div>
        <div id="comments-${p.id}"    class="comments-list" aria-live="polite"></div>
        <div id="comment-box-${p.id}" class="comment-box" style="display:none">
          <textarea id="comment-input-${p.id}" rows="2" placeholder="Write a comment‚Ä¶"></textarea>
          <button onclick="submitComment('${p.id}')">Submit</button>
          <button onclick="cancelComment('${p.id}')">Cancel</button>
        </div>
      </article>`);

    /* owner/admin delete (unchanged) */
    if(isAdmin||owner){
      const btn=document.createElement("button");
      btn.textContent="üóëÔ∏è Delete";
      btn.className="delete-btn";
      btn.onclick=()=>deletePost(p.id);
      postWrap.lastElementChild.querySelector(".post-actions").appendChild(btn);
    }
    loadComments(p.id);
  }
}

/* ----------  likes / boosts / comments / delete ‚Äì UNCHANGED ---------- */
window.likePost=async id=>{/* ‚Ä¶ unchanged ‚Ä¶ */};
window.boostPost=async id=>{/* ‚Ä¶ unchanged ‚Ä¶ */};
window.repost   =async id=>{/* ‚Ä¶ unchanged ‚Ä¶ */};
window.deletePost=async id=>{/* ‚Ä¶ unchanged ‚Ä¶ */};

window.commentOnPost=id=>document.getElementById(`comment-box-${id}`).style.display="block";
window.cancelComment=id=>document.getElementById(`comment-box-${id}`).style.display="none";
window.submitComment =async id=>{/* ‚Ä¶ unchanged ‚Ä¶ */};
async function loadComments(id){/* ‚Ä¶ unchanged ‚Ä¶ */}

/* search + nav toggle */
searchIn.addEventListener("input",renderPosts);
menuTog.addEventListener("click",()=>{
  primaryNav.classList.toggle("open");
  menuTog.setAttribute("aria-expanded",primaryNav.classList.contains("open"));
});
</script>
</body>
</html>
