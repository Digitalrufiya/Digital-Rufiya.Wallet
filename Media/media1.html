<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRF Media Post</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>Post to DRFMedia</h2>
  <input type="file" id="mediaFile" accept="image/*,video/*" />
  <textarea id="caption" placeholder="Enter caption..."></textarea>
  <button onclick="handlePost()">Post</button>

  <script>
    const PINATA_JWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

    const CONTRACT_ADDRESS = "0x9CF972437e17927C1114F44D2D38aA77c4845d01";
    const ABI = [
      {
        "inputs": [
          { "internalType": "string", "name": "ipfsHash", "type": "string" },
          { "internalType": "uint8", "name": "mediaType", "type": "uint8" }
        ],
        "name": "post",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    async function uploadToPinata(file) {
      const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
      const formData = new FormData();
      formData.append("file", file);
      const res = await fetch(url, {
        method: "POST",
        headers: {
          Authorization: PINATA_JWT
        },
        body: formData
      });
      const data = await res.json();
      console.log("Pinata IPFS Hash:", data.IpfsHash);
      return data.IpfsHash;
    }

    async function handlePost() {
      try {
        const fileInput = document.getElementById("mediaFile");
        const caption = document.getElementById("caption").value;
        if (!fileInput.files.length) return alert("Select a media file");

        const file = fileInput.files[0];
        const ipfsHash = await uploadToPinata(file);

        const provider = new ethers.providers.Web3Provider(window.drfwallet || window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        const isVideo = file.type.startsWith("video") ? 1 : 0;
        const tx = await contract.post(ipfsHash, isVideo);
        await tx.wait();

        alert("Posted successfully to DRFChain!");
      } catch (e) {
        console.error("Post failed:", e);
        alert("Failed to post. Check console for details.");
      }
    }
  </script>
</body>
</html>
