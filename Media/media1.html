<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>DRFMedia Timeline — Spread Kindness & Truth</title>

  <!-- optional external CSS if you keep style.css -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ===== design tokens ===== */
    :root{--accent:#007bff;--accent-hover:#0056b3;--accent-muted:#0069d9;
          --bg-body:#f8f9fa;--bg-surface:#fff;--bg-surface-alt:#fafafa;
          --text-body:#212529;--text-muted:#6c757d;--radius:.5rem;
          --shadow-sm:0 1px 2px rgba(0,0,0,.06);--shadow-md:0 2px 4px rgba(0,0,0,.1)}
    @media(prefers-color-scheme:dark){
      :root{--bg-body:#181a1b;--bg-surface:#242628;--bg-surface-alt:#2b2e30;
            --text-body:#f1f3f5;--text-muted:#adb5bd;--shadow-sm:none;--shadow-md:none}
    }
    /* ===== base reset ===== */
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
         background:var(--bg-body);color:var(--text-body);
         display:flex;flex-direction:column}
    a{color:inherit;text-decoration:none}
    img,video{max-width:100%}
    /* ===== header / nav ===== */
    header{background:var(--accent);color:#fff;padding:.75rem 1rem;
           position:sticky;top:0;z-index:1000;
           display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;
           box-shadow:var(--shadow-md)}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700;font-size:clamp(1rem,2vw,1.3rem)}
    .brand img{width:2.25rem;height:2.25rem;border-radius:.25rem;background:#fff;padding:2px}
    #menuToggle{display:inline-flex;flex-direction:column;width:2rem;height:1.3rem;justify-content:space-between;background:none;border:none;cursor:pointer;transition:filter 0.3s ease}
    #menuToggle span{display:block;height:3px;background:#fff;border-radius:3px;transition:background-color 0.3s ease}
    #primaryNav{
      display:none;
      flex-direction:column;
      width:100%;
      background:var(--accent-muted);
      border-radius:var(--radius);
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
    }
    #primaryNav.open {
      display: flex;
      max-height: 500px; /* enough height to show menu */
      opacity: 1;
    }
    #primaryNav a{
      padding:.75rem 1.25rem;font-weight:600;
      border-top:1px solid rgb(255 255 255 / 0.15);
      transition: background-color 0.3s ease;
    }
    #primaryNav a:first-child{border-top:none}
    #primaryNav a:hover{background:rgb(255 255 255 / 0.18)}
    @media(min-width:768px){
      #menuToggle{display:none}
      #primaryNav{
        display:flex !important;
        flex-direction:row;
        gap:.25rem;
        background:transparent;
        width:auto;
        max-height:none;
        opacity:1;
        overflow: visible;
      }
      #primaryNav a{border:none;padding:.5rem .9rem}
      #primaryNav a:hover{background:rgb(255 255 255 / 0.25)}
    }

    /* Mobile menu background color fix */
    @media (max-width: 767px) {
      #primaryNav {
        background: #0056b3 !important;
      }
    }

    /* ===== utility buttons ===== */
    .btn{display:inline-block;border:none;background:var(--accent);color:#fff;
         padding:.45rem .9rem;border-radius:var(--radius);
         font-size:.95rem;font-weight:600;cursor:pointer;transition:background-color .2s}
    .btn:hover{background:var(--accent-hover)}.btn:disabled{background:#adb5bd;cursor:not-allowed}
    /* ===== layout ===== */
    #pageWrapper{flex:1;display:flex;flex-direction:column}

    /* Smooth fade-in for posts container */
    #postContainer {
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    #postContainer.loaded {
      opacity: 1;
    }

    .container{width:min(100%,700px);margin-inline:auto;padding-inline:1rem}
    /* search */
    #searchBar{margin:1rem auto 0}
    #searchInput{width:100%;padding:.55rem .85rem;font-size:1rem;border:1px solid #ced4da;border-radius:var(--radius);background:var(--bg-surface);color:var(--text-body)}
    /* upload */
    #uploadForm{margin-top:1.25rem}
    #uploadForm textarea{width:100%;margin-top:.75rem;padding:.65rem .85rem;font-size:1rem;border:1px solid #ced4da;border-radius:var(--radius);resize:vertical;min-height:6rem;background:var(--bg-surface);color:var(--text-body)}
    /* post card */
    .post-item{background:var(--bg-surface-alt);border:1px solid #dee2e6;border-radius:var(--radius);padding:1rem;margin-block:1.25rem;box-shadow:var(--shadow-sm)}
    .post-owner{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .avatar{width:2.25rem;height:2.25rem;border-radius:50%;object-fit:cover;border:1px solid #ced4da;box-shadow:var(--shadow-sm)}
    .post-time{font-size:.85rem;color:var(--text-muted);margin-top:2px}
    .post-caption{margin-top:.75rem;white-space:pre-wrap}
    .post-media{margin-top:.75rem}
    video,img{border-radius:var(--radius);background:#000;display:block}
    .post-actions{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
    .post-actions button{flex:1 1 auto}
    .post-actions button.liked{background:#28a745!important}
    .post-actions button.boosted{background:gold!important;color:#000!important}
    .post-actions button.delete-btn{background:#dc3545!important;color:#fff}
    .post-actions button.delete-btn:hover{background:#b52a3b!important}
    /* comments */
    .comments-list{margin-top:.75rem;background:var(--bg-surface);padding:.65rem;border-radius:var(--radius);max-height:10rem;overflow-y:auto}
    .comment-box textarea{width:100%;border-radius:var(--radius);padding:.6rem .8rem}
    /* focus */
    button:focus-visible,#menuToggle:focus-visible{outline:2px solid #fff;outline-offset:2px}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="DRFMedia Logo" />
    <span>DRFMedia</span>
  </div>
  <button id="menuToggle" aria-label="Toggle navigation" aria-controls="primaryNav" aria-expanded="false"><span></span><span></span><span></span></button>
  <nav id="primaryNav">
    <a href="media.html">Timeline</a>
    <a href="profile.html" class="active">Profile</a>
    <a href="media.html">Posts</a>
    <a href="gift.html">Donation</a>
    <a href="chat.html">Chat</a>
  </nav>
</header>

<div id="pageWrapper">
  <section id="searchBar" class="container">
    <input id="searchInput" type="search" placeholder="Search posts…" aria-label="Search posts" />
  </section>

  <button id="loginBtn"  class="btn" style="display:block;max-width:700px;margin:1rem auto;">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;max-width:700px;margin:1rem auto;background:#dc3545;">Logout</button>

  <form id="uploadForm" class="container" style="display:none;">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <textarea id="caption" placeholder="Write your caption…" minlength="4" required></textarea>
    <button class="btn" type="submit" style="margin-top:.75rem;">Post</button>
  </form>

  <section id="postContainer" class="container" aria-live="polite"></section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
import { getAuth, signInWithPopup, signOut, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

/* replace with your own JWT */
const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

const firebaseConfig = {
  apiKey:            "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain:        "drfsocial-23a06.firebaseapp.com",
  databaseURL:       "https://drfsocial-23a06-default-rtdb.firebaseio.com",
  projectId:         "drfsocial-23a06",
  storageBucket:     "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId:             "1:608135115201:web:dc999df2c0c37241ff3f40"
};
const app   = initializeApp(firebaseConfig);
const db    = getDatabase(app);
const auth  = getAuth(app);
const provider = new GoogleAuthProvider();

/* dom refs */
const loginBtn  = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const uploadForm= document.getElementById("uploadForm");
const mediaFile = document.getElementById("mediaFile");
const captionIn = document.getElementById("caption");
const postWrap  = document.getElementById("postContainer");
const searchIn  = document.getElementById("searchInput");
const menuTog   = document.getElementById("menuToggle");
const primaryNav= document.getElementById("primaryNav");

/* state */
let currentUser=null, isAdmin=false, allPosts=[];

/* utils */
const esc = s=>s.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));

/* auth */
loginBtn.onclick = ()=>signInWithPopup(auth,provider).catch(e=>alert(e.message));
logoutBtn.onclick= ()=>signOut(auth).catch(e=>alert(e.message));

onAuthStateChanged(auth,async user=>{
  currentUser=user;
  uploadForm.style.display=user?"block":"none";
  loginBtn .style.display=user?"none" :"block";
  logoutBtn.style.display=user?"block":"none";
  if(user){
    const adSnap = await get(ref(db,`admin/${user.uid}`));
    isAdmin = adSnap.exists();
  }else isAdmin=false;
  renderPosts();
});

/* upload */
uploadForm.addEventListener("submit",async e=>{
  e.preventDefault();
  if(!currentUser)return alert("Login first");
  if(!mediaFile.files[0])return alert("Select a file");
  if(captionIn.value.trim().length<4)return alert("Caption too short");
  uploadForm.querySelector("button").disabled=true;

  /* pinata */
  try{
    const fd=new FormData();fd.append("file",mediaFile.files[0]);
    const up=await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS",{method:"POST",headers:{Authorization:pinataJWT},body:fd});
    if(!up.ok)throw new Error("Pinata upload failed");
    const {IpfsHash}=await up.json();
    const newRef=push(ref(db,"posts"));
    await set(newRef,{
      userId:currentUser.uid,displayName:currentUser.displayName,photoURL:currentUser.photoURL,
      caption:captionIn.value.trim(),ipfsHash:IpfsHash,
      mediaType:mediaFile.files[0].type.startsWith("video")?"video":"image",
      mediaMimeType:mediaFile.files[0].type,timestamp:Date.now(),
      likesCount:0,commentsCount:0,boostsCount:0,likedBy:{},boostedBy:{}});

    captionIn.value="";
    mediaFile.value="";
  }catch(err){alert(err.message)}
  finally{uploadForm.querySelector("button").disabled=false}
});

/* live posts */
onValue(ref(db,"posts"),snap=>{
  const p=snap.val()||{};
  allPosts=Object.entries(p).map(([id,v])=>({id,...v})).sort((a,b)=>b.timestamp-a.timestamp);
  renderPosts();
});

/* render */
function renderPosts(){
  const q = searchIn.value.trim().toLowerCase();
  postWrap.style.opacity = 0; // fade out for smooth effect before rendering
  postWrap.innerHTML = "";
  for(const p of allPosts){
    const captionLower = p.caption ? p.caption.toLowerCase() : "";
    if(!captionLower.includes(q)) continue;
    const url = "https://gateway.pinata.cloud/ipfs/" + p.ipfsHash;
    const owner = currentUser && p.userId === currentUser.uid;
    const liked = currentUser && p.likedBy && p.likedBy[currentUser.uid];
    const boosted = currentUser && p.boostedBy && p.boostedBy[currentUser.uid];
    
    const card = document.createElement("article");
    card.className = "post-item";
    card.innerHTML = `
      <header class="post-owner">
        <img class="avatar" src="${p.photoURL || "https://via.placeholder.com/40"}" alt="avatar">
        <div>
          <div>${esc(p.displayName || "Anon")}</div>
          <time class="post-time" datetime="${new Date(p.timestamp).toISOString()}">${new Date(p.timestamp).toLocaleString()}</time>
        </div>
      </header>
      <div class="post-caption">${esc(p.caption)}</div>
      <div class="post-media">${p.mediaType === "video"
          ? `<video src="${url}" controls playsinline preload="metadata"></video>`
          : `<img src="${url}" alt="media">`}</div>
      <div class="post-actions">
        <button class="${liked ? 'liked' : ''} like-btn">👍 Like (${p.likesCount || 0})</button>
        <button class="comment-btn">💬 Comment (${p.commentsCount || 0})</button>
        <button class="${boosted ? 'boosted' : ''} boost-btn">⭐ Boost (${p.boostsCount || 0})</button>
        ${owner ? '<button class="delete-btn">🗑️ Delete</button>' : ''}
      </div>
      <div class="comments-list" style="display:none;"></div>
      <div class="comment-box" style="display:none;">
        <textarea placeholder="Write a comment…" rows="2" minlength="1"></textarea>
        <button class="btn submit-comment-btn">Post Comment</button>
      </div>
    `;

    /* event listeners */
    const likeBtn = card.querySelector(".like-btn");
    likeBtn.onclick = async () => {
      if(!currentUser) return alert("Login to like posts");
      const likedRef = ref(db,`posts/${p.id}/likedBy/${currentUser.uid}`);
      const likesCountRef = ref(db,`posts/${p.id}/likesCount`);
      if(liked){
        await set(likedRef, null);
        await set(likesCountRef, (p.likesCount || 1) - 1);
      } else {
        await set(likedRef, true);
        await set(likesCountRef, (p.likesCount || 0) + 1);
      }
    };

    const boostBtn = card.querySelector(".boost-btn");
    boostBtn.onclick = async () => {
      if(!currentUser) return alert("Login to boost posts");
      const boostedRef = ref(db,`posts/${p.id}/boostedBy/${currentUser.uid}`);
      const boostsCountRef = ref(db,`posts/${p.id}/boostsCount`);
      if(boosted){
        await set(boostedRef, null);
        await set(boostsCountRef, (p.boostsCount || 1) - 1);
      } else {
        await set(boostedRef, true);
        await set(boostsCountRef, (p.boostsCount || 0) + 1);
      }
    };

    const deleteBtn = card.querySelector(".delete-btn");
    if(deleteBtn){
      deleteBtn.onclick = async () => {
        if(confirm("Delete this post?")){
          await set(ref(db,`posts/${p.id}`), null);
        }
      };
    }

    const commentBtn = card.querySelector(".comment-btn");
    const commentsList = card.querySelector(".comments-list");
    const commentBox = card.querySelector(".comment-box");

    commentBtn.onclick = () => {
      const isVisible = commentsList.style.display === "block";
      commentsList.style.display = isVisible ? "none" : "block";
      commentBox.style.display = isVisible ? "none" : "block";
      if (!isVisible) loadComments();
    };

    const submitCommentBtn = card.querySelector(".submit-comment-btn");
    const commentTextarea = card.querySelector("textarea");

    async function loadComments() {
      const commentsRef = ref(db, `comments/${p.id}`);
      onValue(commentsRef, snap => {
        const comments = snap.val() || {};
        commentsList.innerHTML = "";
        Object.entries(comments).forEach(([cid, c]) => {
          const div = document.createElement("div");
          div.style.borderTop = "1px solid #eee";
          div.style.padding = "4px 0";
          div.textContent = `${c.displayName || "Anon"}: ${c.text}`;
          commentsList.appendChild(div);
        });
      }, {onlyOnce: true});
    }

    submitCommentBtn.onclick = async () => {
      if(!currentUser) return alert("Login to comment");
      const text = commentTextarea.value.trim();
      if(text.length < 1) return alert("Comment too short");
      const commentRef = push(ref(db, `comments/${p.id}`));
      await set(commentRef, {
        userId: currentUser.uid,
        displayName: currentUser.displayName,
        text,
        timestamp: Date.now()
      });
      // Increment commentsCount in posts
      await set(ref(db, `posts/${p.id}/commentsCount`), (p.commentsCount || 0) + 1);
      commentTextarea.value = "";
      loadComments();
    };

    postWrap.appendChild(card);
  }
  // Fade in posts container after rendering
  setTimeout(() => postWrap.classList.add('loaded'), 10);
  postWrap.style.opacity = 1;
}

/* search input */
searchIn.addEventListener("input", () => {
  postWrap.classList.remove('loaded');
  renderPosts();
});

/* mobile menu toggle */
menuTog.onclick = () => {
  const expanded = menuTog.getAttribute("aria-expanded") === "true";
  menuTog.setAttribute("aria-expanded", !expanded);
  if(primaryNav.classList.contains("open")){
    primaryNav.classList.remove("open");
  } else {
    primaryNav.classList.add("open");
  }
};
</script>
</body>
</html>
