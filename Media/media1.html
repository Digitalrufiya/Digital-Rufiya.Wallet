<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRFMedia — Post & View (Optimized)</title>
<style>
:root {
  --accent: #007bff;
  --accent-hover: #0056b3;
  --accent-muted: #3399ff;
  --bg-body: #f8f9fa;
  --bg-surface: #fff;
  --bg-surface-alt: #fafafa;
  --text-body: #212529;
  --text-muted: #6c757d;
  --radius: .5rem;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
  --shadow-md: 0 2px 4px rgba(0,0,0,.1);
}
@media(prefers-color-scheme:dark) {
  :root {
    --bg-body: #181a1b;
    --bg-surface: #242628;
    --bg-surface-alt: #2b2e30;
    --text-body: #f1f3f5;
    --text-muted: #adb5bd;
    --shadow-sm: none;
    --shadow-md: none;
  }
}
*{box-sizing:border-box;margin:0}
body{font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-body); min-height:100vh; display:flex; flex-direction:column;}
header{background: var(--accent); color:#fff; padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:1000;}
.brand{display:flex; align-items:center; gap:.5rem; font-weight:700;}
.brand img{width:2.25rem; height:2.25rem; border-radius:.25rem; background:#fff; padding:2px;}
#primaryNav{display:flex; gap:1rem; align-items:center;}
#primaryNav a{color:#fff; font-weight:600; padding:.5rem .75rem; border-radius:var(--radius); transition:background-color .2s;}
#primaryNav a:hover,#primaryNav a.active{background-color:var(--accent-hover);}
.btn{background:var(--accent); color:#fff; border:none; border-radius:var(--radius); padding:.5rem 1rem; font-weight:600; cursor:pointer; transition:background .2s;}
.btn:hover{background:var(--accent-hover);}
.btn:disabled{background:#adb5bd; cursor:not-allowed;}
.container{width:min(100%,700px); margin:0 auto; padding:0 1rem;}
#searchInput{width:100%; padding:.55rem .85rem; margin:1rem 0; border:1px solid #ced4da; border-radius:var(--radius); background:var(--bg-surface); color:var(--text-body);}
.post-item{background:var(--bg-surface-alt); border:1px solid #dee2e6; border-radius:var(--radius); padding:1rem; margin:1.25rem 0; box-shadow:var(--shadow-sm);}
.post-owner{display:flex; align-items:center; gap:.6rem; font-weight:700;}
.avatar{width:2.25rem; height:2.25rem; border-radius:50%; object-fit:cover; border:1px solid #ccc;}
.post-time{font-size:.8rem; color:var(--text-muted);}
.post-caption{margin-top:.75rem; white-space:pre-wrap;}
video,img{border-radius:var(--radius); background:#000; display:block; opacity:0; transition:opacity .3s;}
[data-loaded="true"]{opacity:1;}
#uploadForm{margin-top:1.25rem;}
#uploadForm textarea{width:100%; min-height:6rem; padding:.65rem .85rem; margin:.75rem 0; border:1px solid #ced4da; border-radius:var(--radius); resize:vertical;}
#prog{width:100%; height:4px; background:#e9ecef; border-radius:2px; overflow:hidden; display:none;}
#progBar{height:4px; width:0; background:var(--accent);}
#sentinel{height:1px;}
.helper{color:var(--text-muted); text-align:center; margin:.5rem 0;}
/* Fixed top-left reward button */
#rewardBtn{position:fixed; top:18px; left:18px; z-index:2000; background:#10b981; color:#fff; border:none; border-radius:6px; padding:.6rem 1rem; font-weight:700; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2);}
#rewardForm{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:1rem 1.25rem; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.3); z-index:2001; max-width:90%; width:350px;}
#rewardForm input, #rewardForm textarea, #rewardForm button{width:100%; margin:.5rem 0; padding:.55rem .75rem; border-radius:6px; border:1px solid #ced4da;}
#rewardForm button{background:#007bff; color:#fff; border:none; cursor:pointer;}
#rewardFormClose{position:absolute; top:8px; right:12px; cursor:pointer; font-weight:bold; color:#dc3545;}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2001_10_55%20PM.png?updatedAt=1748874907311" alt="logo" />
    <span>DRFMedia</span>
  </div>
  <nav id="primaryNav">
    <a href="media.html" class="active">Posts</a>
    <a href="chat.html">Chat</a>
    <a href="profile.html">Profile</a>
    <a href="gift.html">Timelines</a>
    <a href="market.html">Market Place</a>
  </nav>
</header>

<!-- Reward & Share button -->
<button id="rewardBtn">Share & Get Reward</button>

<!-- Reward form -->
<div id="rewardForm">
  <span id="rewardFormClose">✖</span>
  <h3>Share & Get Reward</h3>
  <input type="text" id="rewardName" placeholder="Your Name" required />
  <input type="email" id="rewardEmail" placeholder="Your Email" required />
  <textarea id="rewardPost" placeholder="Your Post / Share link" required></textarea>
  <button id="rewardSubmit">Submit & Get Reward</button>
  <p id="rewardMsg" style="color:green; font-weight:bold; display:none;">Submitted! You will get reward soon.</p>
</div>

<main class="container">
  <input id="searchInput" placeholder="Search posts…" />
  <button id="loginBtn" class="btn">Sign in with Google</button>
  <button id="logoutBtn" class="btn" style="display:none;background:#dc3545">Logout</button>

  <form id="uploadForm" style="display:none">
    <input id="mediaFile" type="file" accept="image/*,video/*" required />
    <textarea id="caption" minlength="4" placeholder="Write your caption…" required></textarea>
    <div id="prog"><div id="progBar"></div></div>
    <button class="btn" type="submit">Post</button>
  </form>

  <section id="postContainer" aria-live="polite"></section>
  <p id="feedHint" class="helper" style="display:none">Scroll for more…</p>
  <div id="sentinel" aria-hidden="true"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp, limit, startAfter } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
  authDomain: "drfsocial-23a06.firebaseapp.com",
  projectId: "drfsocial-23a06",
  storageBucket: "drfsocial-23a06.appspot.com",
  messagingSenderId: "608135115201",
  appId: "1:608135115201:web:b3d1f368e0c09ac4400f43"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUser = null;

onAuthStateChanged(auth, user => { if(user) currentUser=user; else signInAnonymously(auth).catch(console.error); });

// ===== Fast Video / Image Load =====
function createVideoElement(cid){
  const gateways = [
    `https://gateway.pinata.cloud/ipfs/${cid}`,
    `https://cloudflare-ipfs.com/ipfs/${cid}`,
    `https://ipfs.io/ipfs/${cid}`
  ];
  const v = document.createElement('video');
  v.controls=true; v.playsInline=true; v.preload='metadata'; v.muted=false;
  v.dataset.gateways=JSON.stringify(gateways); v.currentFallback=0;
  v.src=gateways[0];
  v.onerror = ()=>{
    v.currentFallback++;
    if(v.currentFallback<gateways.length){ v.src=gateways[v.currentFallback]; v.load(); v.play().catch(()=>{}); }
  };
  return v;
}
function createImageElement(cid){
  const gateways = [
    `https://gateway.pinata.cloud/ipfs/${cid}`,
    `https://cloudflare-ipfs.com/ipfs/${cid}`,
    `https://ipfs.io/ipfs/${cid}`
  ];
  const img = document.createElement('img');
  img.src=gateways[0];
  img.onerror = ()=>{
    if(img.src===gateways[0]) img.src=gateways[1];
    else if(img.src===gateways[1]) img.src=gateways[2];
  };
  return img;
}

// ===== Load posts =====
const postContainer = document.getElementById('postContainer');
let lastVisible = null, loading=false;

async function loadPosts(reset=false){
  if(loading) return; loading=true;
  if(reset){ postContainer.innerHTML=""; lastVisible=null; }
  const q = lastVisible
    ? query(collection(db,"posts"), orderBy("createdAt","desc"), startAfter(lastVisible), limit(8))
    : query(collection(db,"posts"), orderBy("createdAt","desc"), limit(8));
  try{
    const snap = await getDocs(q);
    if(snap.empty){ loading=false; return; }
    snap.forEach(doc=>{
      const d = doc.data();
      const div = document.createElement('div'); div.className='post-item';
      div.innerHTML=`<h3>${d.title||''}</h3><p>${d.description||''}</p>`;
      if(d.mediaType==='video' && d.ipfsHash) div.appendChild(createVideoElement(d.ipfsHash));
      else if(d.ipfsHash) div.appendChild(createImageElement(d.ipfsHash));
      postContainer.appendChild(div);
    });
    lastVisible = snap.docs[snap.docs.length-1];
  }catch(err){ console.error(err); } finally{ loading=false; }
}
loadPosts(true);
window.addEventListener('scroll',()=>{ if((window.innerHeight+window.scrollY)>=(document.body.offsetHeight-120)) loadPosts(); });

// ===== Reward Button =====
const rewardBtn = document.getElementById('rewardBtn');
const rewardForm = document.getElementById('rewardForm');
const rewardClose = document.getElementById('rewardFormClose');
const rewardSubmit = document.getElementById('rewardSubmit');
const rewardMsg = document.getElementById('rewardMsg');

rewardBtn.addEventListener('click', ()=> rewardForm.style.display='block');
rewardClose.addEventListener('click', ()=> rewardForm.style.display='none');
rewardSubmit.addEventListener('click', async ()=>{
  const name=document.getElementById('rewardName').value.trim();
  const email=document.getElementById('rewardEmail').value.trim();
  const post=document.getElementById('rewardPost').value.trim();
  if(!name||!email||!post){ alert('All fields required'); return; }
  // Here, send reward post to Firestore or DB
  try{
    await addDoc(collection(db,"rewardPosts"),{
      name, email, post, createdAt: serverTimestamp()
    });
    rewardMsg.style.display='block';
    setTimeout(()=>{ rewardMsg.style.display='none'; rewardForm.style.display='none'; },2000);
    document.getElementById('rewardName').value=''; document.getElementById('rewardEmail').value=''; document.getElementById('rewardPost').value='';
  }catch(e){ console.error(e); alert('Error submitting reward post'); }
});
</script>
</body>
</html>
