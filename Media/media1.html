<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DRFMedia DApp</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f7fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .post-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .post-owner {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .post-caption {
      margin: 10px 0;
    }
    .post-actions button {
      margin-right: 10px;
      padding: 6px 12px;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>DRFMedia DApp</h2>
<input type="file" id="mediaInput" accept="image/*,video/*" /><br/><br/>
<textarea id="captionInput" placeholder="Enter caption..." style="width:100%; padding:10px;"></textarea><br/><br/>
<button onclick="uploadPost()">Upload Post</button>
<div id="postContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
const CONTRACT_ADDRESS = "0x9CF972437e17927C1114F44D2D38aA77c4845d01";
const contractABI = [/* ABI you provided here */];
const PINATA_JWT = "Bearer eyJhbGciOiJIUz...<TRIMMED>..."; // use your JWT token

let provider, signer, contract;

(async function connectWallet() {
  if (window.drfWallet) {
    provider = new ethers.providers.Web3Provider(window.drfWallet);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, contractABI, signer);
    console.log("Wallet connected:", await signer.getAddress());
  } else {
    alert("DRF Wallet not detected");
  }
})();

async function uploadToPinata(file) {
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const formData = new FormData();
  formData.append("file", file);
  const response = await fetch(url, {
    method: "POST",
    headers: { Authorization: PINATA_JWT },
    body: formData
  });
  const data = await response.json();
  return data.IpfsHash;
}

async function uploadPost() {
  const file = document.getElementById('mediaInput').files[0];
  const caption = document.getElementById('captionInput').value;
  if (!file || !caption) return alert("Media and caption required");

  try {
    const ipfsHash = await uploadToPinata(file);
    const mediaType = file.type.startsWith('video') ? 1 : 0;
    const tx = await contract.post(ipfsHash, mediaType);
    await tx.wait();
    alert("Post uploaded and rewarded!");
    renderPosts();
  } catch (err) {
    console.error("Upload failed:", err);
    alert("Failed to upload post");
  }
}

async function renderPosts() {
  if (!contract) return;
  const count = await contract.totalPosts();
  const container = document.getElementById("postContainer");
  container.innerHTML = "";
  for (let i = count - 1; i >= 0 && i > count - 10; i--) {
    const post = await contract.getPost(i);
    const url = `https://gateway.pinata.cloud/ipfs/${post.ipfsHash}`;
    const card = document.createElement("div");
    card.className = "post-card";
    card.innerHTML = `
      <div class="post-owner">
        <img src="https://www.gravatar.com/avatar/${post.author.slice(2,10)}?d=identicon" class="avatar" />
        <div><strong>${post.author}</strong></div>
      </div>
      <div class="post-caption">${post.ipfsHash}</div>
      ${post.mediaType == 1 ?
        `<video controls width="100%"><source src="${url}" /></video>` :
        `<img src="${url}" width="100%" />`
      }
      <div class="post-actions">
        <button onclick="likePost(${i})">Like (${post.likes})</button>
        <button onclick="commentPost(${i})">Comment</button>
      </div>
    `;
    container.appendChild(card);
  }
}

async function likePost(id) {
  const tx = await contract.likePost(id);
  await tx.wait();
  renderPosts();
}

async function commentPost(id) {
  const msg = prompt("Enter comment");
  if (!msg) return;
  const tx = await contract.commentOnPost(id, msg);
  await tx.wait();
  alert("Comment posted");
}

setTimeout(renderPosts, 1500);
</script>
</body>
</html>
