<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRF Marketplace — Payment Verified & Free Uploads</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:18px; background:#f3f4f6; color:#111; }
  #upload-section { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:1000px; margin:18px auto; }
  input, textarea, button, select { box-sizing:border-box; width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #d1d5db; }
  button{ background:#2563eb; color:#fff; border:none; padding:10px; cursor:pointer; }
  button.secondary{ background:#10b981; }
  button.premium{ background:#f59e0b; }
  button:disabled{ background:#9ca3af; cursor:default; }
  #posts{ max-width:1000px; margin:18px auto; }
  .post{ background:#fff; padding:14px; border-radius:8px; margin-bottom:14px; box-shadow:0 4px 12px rgba(0,0,0,0.04); position:relative; }
  .badge{ position:absolute; top:12px; right:12px; background:#10b981; color:#fff; padding:4px 8px; font-size:12px; border-radius:6px; }
  .badge.free{ background:#2563eb; }
  .buttons{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .note{ font-size:13px; color:#374151; margin-top:8px; }
  .small{ font-size:13px; color:#6b7280; }
  img, video { max-width:100%; border-radius:8px; margin-top:8px; }
  .header { text-align:center; margin-bottom:10px; }
  .cols { display:grid; grid-template-columns: 1fr 380px; gap:16px; align-items:start; max-width:1100px; margin: 0 auto; }
  @media(max-width:900px){ .cols { grid-template-columns: 1fr; } }
  .txbox { display:flex; gap:8px; }
  .watermark { position:absolute; bottom:8px; right:8px; opacity:0.7; font-size:12px; color:#fff; background:rgba(0,0,0,0.4); padding:2px 4px; border-radius:4px; }
</style>
</head>
<body>

<div class="header">
  <h1>DRF Marketplace — Upload & Listings</h1>
  <p class="small">Free users can post images and videos up to 1 minute. Upgrade to Premium to post longer videos and remove restrictions.</p>
</div>

<div class="cols">
  <section id="upload-section">
    <h2>Upload Listing</h2>

    <input type="file" id="mediaInput" accept="image/*,video/*" />
    <input type="text" id="titleInput" placeholder="Title" />
    <textarea id="descriptionInput" placeholder="Description" rows="3"></textarea>
    <input type="number" id="priceInput" placeholder="Price (USD)" />
    <input type="text" id="locationInput" placeholder="Location" />
    <input type="text" id="whatsappInput" placeholder="WhatsApp Number" />
    <input type="text" id="paymentLinkInput" placeholder="Seller Payment Link (trustworthy URL or wallet link)" />

    <div style="display:flex;gap:8px;">
      <button id="payBtn">Open Trust Wallet (Pay 1 USDC)</button>
      <button id="openWalletBtn" style="background:#111827">Open Wallet (MetaMask)</button>
      <button id="premiumBtn" class="premium">Upgrade to Premium</button>
    </div>

    <div class="note">After payment, paste either your <strong>transaction hash</strong> (recommended) or <strong>BSC wallet address</strong> and click <em>Verify Payment</em>.</div>

    <div class="txbox">
      <input type="text" id="txHashInput" placeholder="Paste tx hash (0x...) or wallet address (0x...)" />
      <button id="verifyBtn" class="secondary">Verify Payment</button>
    </div>

    <div id="uploadStatus" class="small" style="margin-top:10px">Free (not verified)</div>

    <div style="margin-top:12px">
      <button id="uploadBtn" disabled>Upload Listing</button>
    </div>
  </section>

  <aside style="background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);">
    <h3>Status</h3>
    <p id="statusBox" class="small">Free user (not verified)</p>
    <h4 style="margin-top:10px">Setup (one-time)</h4>
    <ol class="small">
      <li>BscScan API key is embedded to verify payments.</li>
      <li>If you change USDC token/decimals, update constants inside the file.</li>
    </ol>
  </aside>
</div>

<section id="posts"></section>

<script type="module">
/* ========================== CONFIG ========================== */
const BSCSCAN_API_KEY = "G9H3FIK6M6EREF9DENVXG9EXHAVJJCXFM8";
const OWNER_ADDRESS = "0x88253d87990edd1e647c3b6ed21f57fb061a3040".toLowerCase();
const USDC_CONTRACT = "0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d".toLowerCase();
const REQUIRED_AMOUNT = BigInt(1) * BigInt(10 ** 18);
let isPremium = false;

/* ========================== Helper ========================== */
function hexToBigInt(hex) { if(!hex) return BigInt(0); if(hex.startsWith("0x")) hex = hex.slice(2); return BigInt("0x"+hex); }
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeAttr(s){ if(!s) return '#'; return String(s).replaceAll('"','&quot;'); }

/* UI */
const payBtn = document.getElementById("payBtn");
const openWalletBtn = document.getElementById("openWalletBtn");
const premiumBtn = document.getElementById("premiumBtn");
const txHashInput = document.getElementById("txHashInput");
const verifyBtn = document.getElementById("verifyBtn");
const uploadBtn = document.getElementById("uploadBtn");
const uploadStatus = document.getElementById("uploadStatus");
const statusBox = document.getElementById("statusBox");
const postsContainer = document.getElementById("posts");

/* Trust Wallet & Premium link */
const trustLink = `https://link.trustwallet.com/send?coin=20000714&address=${OWNER_ADDRESS}&amount=1.0&token_id=${USDC_CONTRACT}`;
payBtn.onclick = () => { window.open(trustLink, "_blank"); alert("Trust Wallet opened. Paste tx hash or wallet address and click Verify Payment."); };
premiumBtn.onclick = () => { window.open(trustLink, "_blank"); alert("Premium upgrade link opened."); };
openWalletBtn.onclick = async () => { if(window.ethereum){ try{ await window.ethereum.request({method:"eth_requestAccounts"}); alert("Wallet connected (MetaMask)."); } catch(e){ console.error(e); alert("Wallet connect failed"); } } else alert("MetaMask not found"); };

/* Verify Payment */
verifyBtn.onclick = async () => {
  const input = (txHashInput.value||"").trim();
  if(!input){ alert("Paste tx hash or wallet address"); return; }
  uploadStatus.textContent = "Verifying payment...";
  statusBox.textContent = "Verifying...";
  try{
    let verifiedTx = "";
    if(input.startsWith("0x") && input.length>20){
      const txUrl = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionByHash&txhash=${input}&apikey=${BSCSCAN_API_KEY}`;
      const rcptUrl = `https://api.bscscan.com/api?module=proxy&action=eth_getTransactionReceipt&txhash=${input}&apikey=${BSCSCAN_API_KEY}`;
      const [txRes, rcptRes] = await Promise.all([fetch(txUrl), fetch(rcptUrl)]);
      const txJson = await txRes.json(); const rcptJson = await rcptRes.json();
      if(!txJson.result || !rcptJson.result) throw new Error("Transaction not found");
      if(rcptJson.result.status!=="0x1") throw new Error("Tx failed");
      const txTo = (txJson.result.to||"").toLowerCase();
      if(txTo!==USDC_CONTRACT) throw new Error("Not USDC transfer");
      const inputData = txJson.result.input||"";
      if(!inputData.startsWith("0xa9059cbb")) throw new Error("Not ERC20 transfer");
      const recipient = "0x"+inputData.slice(10+24,10+64);
      if(recipient.toLowerCase()!==OWNER_ADDRESS) throw new Error("Recipient mismatch");
      const amount = hexToBigInt("0x"+inputData.slice(inputData.length-64));
      if(amount<REQUIRED_AMOUNT) throw new Error("Amount less than 1 USDC");
      verifiedTx = input;
    } else {
      const wallet = input.toLowerCase();
      const url = `https://api.bscscan.com/api?module=account&action=tokentx&contractaddress=${USDC_CONTRACT}&address=${OWNER_ADDRESS}&page=1&offset=50&sort=desc&apikey=${BSCSCAN_API_KEY}`;
      const res = await fetch(url); const json = await res.json();
      if(!json.result || json.status!=="1") throw new Error("No token transfers found");
      const found = json.result.find(tx => tx.from.toLowerCase()===wallet && tx.to.toLowerCase()===OWNER_ADDRESS && BigInt(tx.value)>=BigInt(10**(parseInt(tx.tokenDecimal||"18"))));
      if(!found) throw new Error("No qualifying payment found");
      verifiedTx = found.hash;
    }
    uploadStatus.textContent = "✅ Payment verified!";
    statusBox.textContent = "Premium verified tx: "+verifiedTx;
    uploadBtn.disabled = false;
    isPremium = true;
  } catch(err){
    console.error(err);
    uploadStatus.textContent = "❌ Verification failed: "+err.message;
    statusBox.textContent = "Verification failed";
    alert("Verification failed: "+err.message);
  }
};

/* Firebase + Pinata */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp, limit, startAfter } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae",
  measurementId: "G-MV9JQZHLLY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUser = null;
onAuthStateChanged(auth, user => { if(user) currentUser=user; else signInAnonymously(auth).catch(console.error); });

async function uploadToPinata(file){
  const form = new FormData(); form.append("file", file);
  const PINATA_JWT = ""; // keep secret later
  const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS",{method:"POST",headers:{Authorization:`Bearer ${PINATA_JWT}`},body:form});
  if(!res.ok) throw new Error("Pinata upload failed");
  const js = await res.json(); return js.IpfsHash;
}

/* Upload listing */
uploadBtn.onclick = async () => {
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();
  const price = parseFloat(document.getElementById("priceInput").value);
  const location = document.getElementById("locationInput").value.trim();
  const whatsapp = document.getElementById("whatsappInput").value.trim();
  const paymentLink = document.getElementById("paymentLinkInput").value.trim();

  if(!fileInput.files[0] || !title || !description || isNaN(price) || !location || !whatsapp || !paymentLink){
    alert("All fields required"); return;
  }

  // Video restriction for free users
  if(!isPremium && fileInput.files[0].type.startsWith("video")){
    const vid = document.createElement("video"); vid.src = URL.createObjectURL(fileInput.files[0]);
    await vid.play().catch(()=>{}); vid.pause();
    if(vid.duration>60){ alert("Free users can upload videos max 1 minute."); return; }
  }

  uploadBtn.disabled = true;
  uploadStatus.textContent = "Uploading media to IPFS...";

  try{
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video") ? "video" : "image";

    await addDoc(collection(db,"posts"),{
      title, description, price, location, whatsapp, paymentLink,
      ipfsHash, mediaType, createdAt: serverTimestamp(), verifiedTx: isPremium ? "Premium" : "Free"
    });

    uploadStatus.textContent = "Upload successful!";
    fileInput.value=""; document.getElementById("titleInput").value="";
    document.getElementById("descriptionInput").value=""; document.getElementById("priceInput").value="";
    document.getElementById("locationInput").value=""; document.getElementById("whatsappInput").value="";
    document.getElementById("paymentLinkInput").value="";
    loadPosts(true);
  }catch(err){ console.error(err); alert("Upload failed: "+err.message);} finally{uploadBtn.disabled=false;}
};

/* Load posts */
let lastVisible=null, loading=false;
async function loadPosts(reset=false){
  if(loading) return; loading=true;
  if(reset){ postsContainer.innerHTML=""; lastVisible=null; }
  const q = lastVisible
    ? query(collection(db,"posts"),orderBy("createdAt","desc"),startAfter(lastVisible),limit(8))
    : query(collection(db,"posts"),orderBy("createdAt","desc"),limit(8));
  try{
    const snap = await getDocs(q);
    if(snap.empty){ if(postsContainer.children.length===0){ const p=document.createElement("p"); p.className="small"; p.textContent="No listings yet."; postsContainer.appendChild(p); } loading=false; return; }
    snap.forEach(doc=>{
      const d = doc.data();
      const div = document.createElement("div"); div.className="post";
      if(d.verifiedTx==="Premium") div.innerHTML+=`<div class="badge">Verified</div>`;
      else div.innerHTML+=`<div class="badge free">Free</div>`;
      let mediaHTML="";
      if(d.mediaType==="video" && d.ipfsHash){
        mediaHTML=`<div style="position:relative;"><video playsinline controls src="https://gateway.pinata.cloud/ipfs/${d.ipfsHash}"></video><div class="watermark">DRFChain</div></div>`;
      } else if(d.ipfsHash){ mediaHTML=`<img src="https://gateway.pinata.cloud/ipfs/${d.ipfsHash}" alt="${escapeHtml(d.title||'')}" />`; }
      div.innerHTML+=`
        <h3>${escapeHtml(d.title||'')}</h3>
        <p>${escapeHtml(d.description||'')}</p>
        <p><b>Price:</b> $${d.price||''} | <b>Location:</b> ${escapeHtml(d.location||'')}</p>
        <p><b>WhatsApp:</b> <a href="https://wa.me/${encodeURIComponent(d.whatsapp||'')}" target="_blank">${escapeHtml(d.whatsapp||'')}</a></p>
        ${mediaHTML}
        <div class="buttons">
          <a href="${escapeAttr(d.paymentLink||'#')}" target="_blank"><button>Pay Seller</button></a>
          <button class="shareBtn">Share</button>
        </div>
        <div class="small" style="margin-top:8px">Status: ${escapeHtml(d.verifiedTx||'')}</div>
      `;
      const shareBtn = div.querySelector(".shareBtn");
      shareBtn.onclick = ()=>{ if(navigator.share) navigator.share({title:d.title,text:d.description,url:window.location.href}); else alert("Sharing not supported"); };
      postsContainer.appendChild(div);
    });
    lastVisible=snap.docs[snap.docs.length-1];
  }catch(err){ console.error("Load posts error:",err); const p=document.createElement("p"); p.className="small"; p.textContent="Failed to load listings."; postsContainer.appendChild(p);}
  finally{loading=false;}
}

/* initial load & infinite scroll */
loadPosts(true);
window.addEventListener("scroll",()=>{ if((window.innerHeight+window.scrollY)>=(document.body.offsetHeight-120)) loadPosts(); });
</script>
</body>
</html>
