<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DRFMedia Live</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0d0d0d;
    color: #fff;
  }
  header {
    padding: 10px;
    text-align: center;
    font-size: 1.5rem;
    background: #111;
  }
  #live-feed {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 10px;
  }
  .stream-card {
    position: relative;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
  }
  video {
    width: 100%;
    height: auto;
    border-radius: 12px;
  }
  .overlay {
    position: absolute;
    bottom: 10px;
    left: 10px;
    color: #fff;
    display: flex;
    gap: 15px;
    align-items: center;
  }
  .like-btn, .comment-btn, .join-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
  }
  .go-live-container {
    text-align: center;
    padding: 15px;
  }
  .go-live-btn {
    background: #ff5722;
    border: none;
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 8px;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
  }
  .comments-list {
    max-height: 120px;
    overflow-y: auto;
    margin-top: 5px;
    font-size: 0.9rem;
  }
  .comment-item {
    margin-bottom: 3px;
  }
</style>
</head>
<body>
<header>DRFMedia Live Stream</header>
<div class="go-live-container">
  <button class="go-live-btn" id="goLiveBtn">🎥 Go Live</button>
</div>
<div id="live-feed"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getDatabase, ref, set, push, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // ---------------- FIREBASE ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.firebasestorage.app",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40",
    measurementId: "G-W6VHMP77YR"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------------- LIVEPEER ----------------
  const LIVEPEER_API_KEY = "86690d89-ff4d-4e5e-abeb-68c2d7582b35";

  const liveFeed = document.getElementById("live-feed");
  const goLiveBtn = document.getElementById("goLiveBtn");

  let userStream = null;
  let streamId = null;

  // Utility: random string
  const rid = () => Math.random().toString(36).substring(2,10);

  // ---------------- CREATE LIVEPEER STREAM ----------------
  async function createLivepeerStream() {
    const response = await fetch("https://livepeer.studio/api/stream", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${LIVEPEER_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ name: `DRFUserLive_${rid()}`, profiles: [{name:"720p", bitrate:2000000, fps:30, width:1280, height:720}] })
    });
    const data = await response.json();
    return data;
  }

  // ---------------- GO LIVE ----------------
  goLiveBtn.onclick = async () => {
    try {
      // 1) get camera
      userStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

      // 2) create Livepeer stream
      const streamData = await createLivepeerStream();
      streamId = streamData.id;
      const playbackId = streamData.playbackId;

      // 3) add live info to Firebase
      const myStreamRef = push(ref(db, "liveStreams"));
      await set(myStreamRef, {
        streamId,
        playbackId,
        userName: `User_${rid()}`,
        likes: 0,
        comments: {},
        timestamp: Date.now()
      });

      alert("✅ Stream created! Start broadcasting using OBS or WHIP/WebRTC (browser streaming coming later).");

    } catch(e) {
      console.error(e);
      alert("⚠️ Error accessing camera or creating stream.");
    }
  };

  // ---------------- WATCH LIVE STREAMS ----------------
  const liveStreamsRef = ref(db, "liveStreams");
  onValue(liveStreamsRef, (snapshot) => {
    liveFeed.innerHTML = "";
    const streams = snapshot.val();
    if (!streams) return;
    Object.values(streams).forEach((stream) => {
      const card = document.createElement("div");
      card.className = "stream-card";

      const video = document.createElement("video");
      video.controls = true;
      video.autoplay = true;
      video.playsInline = true;
      video.src = `https://cdn.livepeer.com/hls/${stream.playbackId}/index.m3u8`;
      card.appendChild(video);

      // overlay likes/comments/viewers
      const overlay = document.createElement("div");
      overlay.className = "overlay";

      const likeBtn = document.createElement("button");
      likeBtn.className = "like-btn";
      likeBtn.textContent = `❤ ${stream.likes || 0}`;
      likeBtn.onclick = async () => {
        const likesRef = ref(db, `liveStreams/${stream.streamId}/likes`);
        await set(likesRef, (stream.likes || 0) + 1);
      };

      const commentBtn = document.createElement("button");
      commentBtn.className = "comment-btn";
      commentBtn.textContent = "💬";
      commentBtn.onclick = () => {
        const comment = prompt("Enter comment:");
        if(comment) {
          const commentsRef = ref(db, `liveStreams/${stream.streamId}/comments`);
          const cRef = push(commentsRef);
          set(cRef, { text: comment, timestamp: Date.now() });
        }
      };

      overlay.appendChild(likeBtn);
      overlay.appendChild(commentBtn);
      card.appendChild(overlay);

      // show comments below video
      const commentsList = document.createElement("div");
      commentsList.className = "comments-list";
      const commentsRef = ref(db, `liveStreams/${stream.streamId}/comments`);
      onValue(commentsRef, (snap) => {
        commentsList.innerHTML = "";
        const data = snap.val();
        if (!data) return;
        Object.values(data).forEach(c => {
          const item = document.createElement("div");
          item.className = "comment-item";
          item.textContent = c.text;
          commentsList.appendChild(item);
        });
      });
      card.appendChild(commentsList);

      liveFeed.appendChild(card);
    });
  });

</script>
</body>
</html>
