<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRF Marketing Posts</title>

<!-- Default Open Graph / Social Meta -->
<meta property="og:title" content="DRF Marketing" id="ogTitle"/>
<meta property="og:description" content="Check out our marketing content!" id="ogDesc"/>
<meta property="og:image" content="" id="ogImage"/>
<meta property="og:type" content="website"/>

<style>
body { font-family: Arial; margin:0; padding:20px; background:#f3f4f6; color:#111; }
#posts { max-width:900px; margin:auto; }
.post { background:#fff; padding:14px; border-radius:8px; margin-bottom:14px; box-shadow:0 4px 12px rgba(0,0,0,0.04);}
.post img, .post video{ max-width:100%; border-radius:6px; margin-top:8px; }
.buttons{ display:flex; gap:6px; margin-top:10px; flex-wrap:wrap; }
.buttons button{ flex:1; font-size:12px; padding:6px; }
</style>
</head>
<body>

<section id="posts"></section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.appspot.com",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function getIpfsUrls(hash){
  const gateways = [
    "https://gateway.pinata.cloud/ipfs/",
    "https://ipfs.io/ipfs/",
    "https://cloudflare-ipfs.com/ipfs/"
  ];
  return gateways.map(g=>g+hash);
}

const postsContainer = document.getElementById("posts");

// Check if a specific post query ?post=ID exists
const urlParams = new URLSearchParams(window.location.search);
const singlePostId = urlParams.get("post");

async function loadPosts(){
  if(singlePostId){
    const docRef = doc(db, "marketingPosts", singlePostId);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()){
      const data = docSnap.data();
      setMetaTags(data);
      renderPost(singlePostId, data);
    } else {
      postsContainer.innerHTML = "<p>Post not found.</p>";
    }
  } else {
    const q = query(collection(db,"marketingPosts"), orderBy("createdAt","desc"));
    const snapshot = await getDocs(q);
    snapshot.forEach(docSnap => renderPost(docSnap.id, docSnap.data()));
  }
}

function renderPost(id, data){
  const urls = getIpfsUrls(data.ipfsHash);
  const mediaTag = data.mediaType === "video"
    ? `<video controls src="${urls[0]}" onerror="this.src='${urls[1]}'; this.onerror='this.src=\'${urls[2]}\';'"></video>`
    : `<img src="${urls[0]}" onerror="this.src='${urls[1]}'; this.onerror='this.src=\'${urls[2]}\';'"/>`;

  const postEl = document.createElement("div");
  postEl.className = "post";
  postEl.innerHTML = `
    <h3>${data.title}</h3>
    <p>${data.description}</p>
    ${mediaTag}
    <div class="buttons">
      <button onclick="navigator.clipboard.writeText(window.location.href+'?post=${id}'); alert('Link copied!')">Copy Link</button>
      <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(window.location.href+'?post=${id}'))">Facebook</button>
      <button onclick="window.open('https://twitter.com/intent/tweet?url='+encodeURIComponent(window.location.href+'?post=${id})'))">Twitter</button>
      <button onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url='+encodeURIComponent(window.location.href+'?post=${id})'))">LinkedIn</button>
    </div>
  `;
  postsContainer.appendChild(postEl);
}

// Dynamically set OG meta tags for social previews
function setMetaTags(data){
  document.getElementById("ogTitle").setAttribute("content", data.title);
  document.getElementById("ogDesc").setAttribute("content", data.description);
  const urls = getIpfsUrls(data.ipfsHash);
  document.getElementById("ogImage").setAttribute("content", urls[0]);
}

loadPosts();
</script>
</body>
</html>
