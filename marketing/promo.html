<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DRF Marketing Dashboard</title>
<style>
body { font-family: Arial; margin:0; padding:20px; background:#f3f4f6; color:#111; }
#upload-section { background:#fff; padding:16px; border-radius:10px; max-width:900px; margin:auto; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
input, textarea, button { width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid #d1d5db; box-sizing:border-box; }
button{ background:#2563eb; color:#fff; border:none; padding:10px; cursor:pointer; font-size:14px; }
button:disabled{ background:#9ca3af; cursor:default; }
#uploadStatus{ margin-top:10px; }
</style>
</head>
<body>

<section id="upload-section">
  <h2>Upload Marketing Content</h2>
  <input type="file" id="mediaInput" accept="image/*,video/*" />
  <input type="text" id="titleInput" placeholder="Title" />
  <textarea id="descriptionInput" placeholder="Description" rows="3"></textarea>
  <button id="uploadBtn">Upload & Generate Post</button>
  <div id="uploadStatus"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDBxNIIuYonkgF9m8QYdUFDOXIXAM6FYqA",
  authDomain: "drfmarket-place.firebaseapp.com",
  projectId: "drfmarket-place",
  storageBucket: "drfmarket-place.firebasestorage.app",
  messagingSenderId: "752616443115",
  appId: "1:752616443115:web:73b71924daf66ae9c882ae"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pinataJWT = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI4MDFmMDAxNy04YjZkLTQ2YjYtOGIwZi04Y2NkZWU5NzE4ODIiLCJlbWFpbCI6ImRpZ2l0YWxydWZpeWFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjNkODdmOWVkOTA0ZGY4OTI2NTRjIiwic2NvcGVkS2V5U2VjcmV0IjoiYTI3OWU4ODU0ZDQ0YWY2Y2IxNzA0N2RhOThhYTc3MmExOTAyMmFhYTIwOTQ5YjEzN2Y5ZmIxMDI3YzAzYmY5ZiIsImV4cCI6MTc4MDQyMzA3Mn0.YpqewbjW7gAVyPSKYiO9Ym9QhddKc_1vm8CJIoXDQyA";

async function uploadToPinata(file){
  const url = "https://api.pinata.cloud/pinning/pinFileToIPFS";
  const data = new FormData();
  data.append("file", file);
  const res = await fetch(url, { method:"POST", headers:{ Authorization: pinataJWT }, body:data });
  if(!res.ok) throw new Error("Pinata upload failed");
  const json = await res.json();
  return json.IpfsHash;
}

// --- Generate unique ID ---
function generateId(){ return 'post_'+Date.now()+'_'+Math.floor(Math.random()*1000); }

const uploadBtn = document.getElementById("uploadBtn");
const uploadStatus = document.getElementById("uploadStatus");

uploadBtn.onclick = async()=>{
  const fileInput = document.getElementById("mediaInput");
  const title = document.getElementById("titleInput").value.trim();
  const description = document.getElementById("descriptionInput").value.trim();
  if(!fileInput.files[0] || !title || !description){
    alert("All fields required"); return;
  }

  uploadBtn.disabled = true;
  uploadStatus.textContent = "Uploading to IPFS...";

  try{
    const ipfsHash = await uploadToPinata(fileInput.files[0]);
    const mediaType = fileInput.files[0].type.startsWith("video") ? "video" : "image";
    const uniqueId = generateId();

    // Save to Firestore
    await addDoc(collection(db,"marketingPosts"), {
      title, description, ipfsHash, mediaType, createdAt: serverTimestamp(), uniqueId
    });

    // Generate static HTML post file content
    const postHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta property="og:title" content="${title}" />
<meta property="og:description" content="${description}" />
<meta property="og:image" content="https://gateway.pinata.cloud/ipfs/${ipfsHash}" />
<meta property="og:type" content="website" />
<title>${title}</title>
</head>
<body>
<h1>${title}</h1>
<p>${description}</p>
${mediaType==="video" ? `<video controls src="https://gateway.pinata.cloud/ipfs/${ipfsHash}"></video>` : `<img src="https://gateway.pinata.cloud/ipfs/${ipfsHash}" />`}
</body>
</html>`;

    // Create Blob and download as HTML (manual save)
    const blob = new Blob([postHtml], {type:"text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = uniqueId+".html";
    a.click();

    uploadStatus.textContent = "âœ… Post generated! Download the HTML and upload to your server for sharing.";
    fileInput.value = "";
    document.getElementById("titleInput").value="";
    document.getElementById("descriptionInput").value="";
  }catch(err){
    console.error(err);
    uploadStatus.textContent = "Error: "+err.message;
  }finally{
    uploadBtn.disabled=false;
  }
};
</script>
</body>
</html>
