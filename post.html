<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>DRF Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    .input, textarea { width: 100%; margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    button { padding: 10px 15px; background: #0088cc; color: white; border: none; border-radius: 5px; cursor: pointer; }
    img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
    .post { border-bottom: 1px solid #ddd; padding: 15px 0; }
  </style>
</head>
<body>

<div class="container">
  <h2>DRF Profile</h2>
  <input class="input" type="text" id="name" placeholder="Your Name" />
  <input class="input" type="text" id="wallet" placeholder="Wallet Address" />
  <input class="input" type="file" id="profileImage" />
  <button onclick="saveProfile()">Save Profile</button>

  <h2 style="margin-top:40px;">Create Post</h2>
  <textarea class="input" id="postText" placeholder="What's on your mind?"></textarea>
  <input class="input" type="file" id="postImage" onchange="previewPostImage()" />
  <img id="preview" style="display:none" />
  <button onclick="createPost()">Post</button>

  <h2 style="margin-top:40px;">Timeline</h2>
  <div id="timeline"></div>
</div>

<!-- Firebase App (CDN) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB-W_j74lsbmJUFnTbJpn79HM62VLmkQC8",
    authDomain: "drfsocial-23a06.firebaseapp.com",
    databaseURL: "https://drfsocial-23a06-default-rtdb.firebaseio.com",
    projectId: "drfsocial-23a06",
    storageBucket: "drfsocial-23a06.appspot.com",
    messagingSenderId: "608135115201",
    appId: "1:608135115201:web:dc999df2c0f37241ff3f40"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const jwt = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." // â† Replace with your full JWT if trimmed

  async function uploadToIPFS(file) {
    const formData = new FormData();
    formData.append("file", file);

    const res = await fetch("https://api.pinata.cloud/pinning/pinFileToIPFS", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${jwt}`
      },
      body: formData
    });

    if (!res.ok) {
      alert("Failed to upload to IPFS.");
      return "";
    }

    const json = await res.json();
    if (json.IpfsHash) {
      return `https://gateway.pinata.cloud/ipfs/${json.IpfsHash}`;
    } else {
      alert("Pinata did not return a valid IPFS hash.");
      return "";
    }
  }

  async function saveProfile() {
    const name = document.getElementById("name").value;
    const wallet = document.getElementById("wallet").value.trim();
    const imageFile = document.getElementById("profileImage").files[0];

    let imageUrl = "";
    if (imageFile) {
      imageUrl = await uploadToIPFS(imageFile);
    }

    if (!wallet) {
      alert("Please enter your wallet address.");
      return;
    }

    await db.ref("profiles/" + wallet).set({
      name,
      wallet,
      imageUrl
    });

    alert("Profile saved successfully.");
  }

  function previewPostImage() {
    const file = document.getElementById("postImage").files[0];
    const reader = new FileReader();
    reader.onloadend = function () {
      const img = document.getElementById("preview");
      img.src = reader.result;
      img.style.display = "block";
    };
    if (file) reader.readAsDataURL(file);
  }

  async function createPost() {
    const text = document.getElementById("postText").value;
    const wallet = document.getElementById("wallet").value.trim();
    const imageFile = document.getElementById("postImage").files[0];

    if (!wallet || !text.trim()) {
      alert("Please enter text and wallet address.");
      return;
    }

    let imageUrl = "";
    if (imageFile) {
      imageUrl = await uploadToIPFS(imageFile);
    }

    await db.ref("posts").push({
      wallet,
      text,
      imageUrl,
      timestamp: Date.now()
    });

    document.getElementById("postText").value = "";
    document.getElementById("postImage").value = "";
    document.getElementById("preview").style.display = "none";

    alert("Post created!");
    loadPosts();
  }

  async function loadPosts() {
    const timeline = document.getElementById("timeline");
    timeline.innerHTML = "";

    firebase.database().ref("posts").on("value", async function(snapshot) {
      const posts = snapshot.val();
      if (!posts) return;

      const postList = Object.entries(posts).sort((a, b) => b[1].timestamp - a[1].timestamp);

      for (let [key, post] of postList) {
        const profileSnap = await firebase.database().ref("profiles/" + post.wallet).once("value");
        const profile = profileSnap.val();

        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <strong>${profile?.name || "Unknown"}</strong> (${post.wallet})<br/>
          <p>${post.text || ""}</p>
          ${post.imageUrl ? `<img src="${post.imageUrl}" />` : ""}
        `;
        timeline.appendChild(div);
      }
    });
  }

  loadPosts();
</script>

</body>
</html>
