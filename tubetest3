<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DRFTube - Watch</title>
  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 650px;
      margin: 40px auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #0a84ff;
      margin-top: 0;
    }
    /* Logo styling */
    #logo {
      display: block;
      max-width: 180px;
      margin: 0 auto 10px auto;
      cursor: pointer;
      border-radius: 12px;
      box-shadow: 0 0 10px #0a84ff88;
    }
    /* Mobile friendly menu */
    .menu-bar {
      display: flex;
      justify-content: space-around;
      background: #222;
      padding: 12px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .menu-bar a {
      color: #0a84ff;
      text-decoration: none;
      font-weight: bold;
      font-size: 1rem;
      flex-grow: 1;
      text-align: center;
      padding: 6px 0;
      transition: background 0.3s ease;
      border-radius: 6px;
    }
    .menu-bar a:hover {
      background: #0a84ff22;
    }
    /* Search input */
    #searchInput {
      width: 100%;
      padding: 10px 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      margin-bottom: 20px;
      background: #222;
      color: #eee;
      box-shadow: inset 0 0 8px #0a84ff88;
    }
    .videoItem {
      margin-bottom: 30px;
      padding: 15px;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 0 8px #0a84ff88;
    }
    .videoItem h3 {
      color: #0affff;
      margin-bottom: 4px;
    }
    .videoItem video {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .videoItem .meta {
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 6px;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    .actions button {
      background: transparent;
      border: none;
      color: #0a84ff;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .actions button:hover {
      text-decoration: underline;
    }
    .commentBox {
      margin-top: 10px;
    }
    .commentBox input {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #fff;
      margin-top: 6px;
    }
    .comments {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #ccc;
      max-height: 150px;
      overflow-y: auto;
    }
    .commentItem {
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid #444;
    }
    .commentUser {
      font-weight: 600;
      color: #0affff;
    }
    .commentText {
      margin-left: 6px;
      color: #eee;
    }
  </style>
</head>
<body>
  <div class="menu-bar">
    <a href="watch.html">üè† Home</a>
    <a href="upload.html">‚¨ÜÔ∏è Upload</a>
    <a href="profile.html">üë§ Profile</a>
  </div>

  <!-- DRFTube logo -->
  <img
    src="https://ik.imagekit.io/ttbbg9ocv/ChatGPT%20Image%20Jun%202,%202025,%2009_15_02%20AM.png?updatedAt=1748838061244"
    alt="DRFTube Logo"
    id="logo"
    onclick="window.location.href='watch.html'"
    title="Go to Home"
  />

  <h1>üé• DRFTube Watch</h1>

  <!-- Search box -->
  <input
    type="text"
    id="searchInput"
    placeholder="Search videos by title, category, or description..."
    aria-label="Search videos"
  />

  <div id="videoList">Loading videos...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      updateDoc,
      arrayUnion
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdFX1PbNEgubM4Zib7U-hgtJbSOONPk6U",
      authDomain: "drftube-634c6.firebaseapp.com",
      projectId: "drftube-634c6",
      storageBucket: "drftube-634c6.appspot.com",
      messagingSenderId: "819828633864",
      appId: "1:819828633864:web:513002b461259b000cbcbd",
      measurementId: "G-ZPTJE4DMNN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;
    onAuthStateChanged(auth, user => {
      currentUser = user;
    });

    const videoList = document.getElementById("videoList");
    const searchInput = document.getElementById("searchInput");
    let allVideos = [];
    let commentUnsubscribers = new Map();

    const videosQuery = query(collection(db, "videos"), orderBy("uploadedAt", "desc"));

    // Load videos and render initially and on updates
    onSnapshot(videosQuery, snapshot => {
      allVideos = [];
      // Unsubscribe previous comment listeners
      commentUnsubscribers.forEach(unsub => unsub());
      commentUnsubscribers.clear();

      snapshot.forEach(docSnap => {
        allVideos.push({ id: docSnap.id, data: docSnap.data() });
      });

      renderVideos(allVideos);
    });

    // Render videos filtered by search text
    function renderVideos(videos) {
      videoList.innerHTML = "";
      if (videos.length === 0) {
        videoList.innerHTML = "<p>No videos found.</p>";
        return;
      }

      videos.forEach(({ id, data: v }) => {
        const container = document.createElement("div");
        container.className = "videoItem";
        container.innerHTML = `
          <h3>${v.title}</h3>
          <div class="meta">Category: ${v.category || 'Uncategorized'}</div>
          <video controls>
            <source src="https://ipfs.io/ipfs/${v.ipfsHash}" type="video/mp4" />
          </video>
          <p>${v.description || ""}</p>
          <div class="actions">
            <button id="likeBtn-${id}">‚ù§Ô∏è Like (${(v.likes || []).length})</button>
            <button id="shareBtn-${id}">üì£ Share</button>
          </div>
          <div class="commentBox">
            <input type="text" placeholder="Add a comment..." id="commentInput-${id}" />
          </div>
          <div class="comments" id="comments-${id}">Loading comments...</div>
        `;

        videoList.appendChild(container);

        // Like button handler
        document.getElementById(`likeBtn-${id}`).onclick = async () => {
          if (!currentUser) return alert("Please login to like videos.");
          const ref = doc(db, "videos", id);
          await updateDoc(ref, {
            likes: arrayUnion({
              userId: currentUser.uid,
              userEmail: currentUser.email || currentUser.displayName || "Unknown",
              date: new Date().toISOString()
            })
          });
          alert("You liked the video!");
        };

        // Share button handler
        document.getElementById(`shareBtn-${id}`).onclick = () => {
          const link = `https://ipfs.io/ipfs/${v.ipfsHash}`;
          navigator.clipboard.writeText(link);
          alert("Video link copied to clipboard!");
        };

        // Comment input handler
        const commentInput = document.getElementById(`commentInput-${id}`);
        commentInput.onkeydown = async (e) => {
          if (e.key === "Enter" && e.target.value.trim() !== "") {
            if (!currentUser) return alert("Please login to comment.");
            const ref = doc(db, "videos", id);
            await updateDoc(ref, {
              comments: arrayUnion({
                text: e.target.value.trim(),
                date: new Date().toISOString(),
                userId: currentUser.uid,
                userEmail: currentUser.email || currentUser.displayName || "Unknown"
              })
            });
            e.target.value = "";
          }
        };

        // Real-time comment listener
        const commentsRef = doc(db, "videos", id);
        const unsubscribe = onSnapshot(commentsRef, docSnap => {
          const data = docSnap.data();
          const comments = data.comments || [];
          const container = document.getElementById("comments-" + id);
          if (!comments.length) {
            container.innerText = "No comments yet.";
            return;
          }
          container.innerHTML = comments
            .map(c => `
              <div class="commentItem">
                <span class="commentUser">${escapeHtml(c.userEmail || "Unknown")}:</span>
                <span class="commentText">${escapeHtml(c.text)}</span>
              </div>
            `).join("");
        });

        commentUnsubscribers.set(id, unsubscribe);
      });
    }

    // Search input event
    searchInput.addEventListener("input", () => {
      const text = searchInput.value.toLowerCase();
      const filtered = allVideos.filter(({ data: v }) => {
        return (
          (v.title && v.title.toLowerCase().includes(text)) ||
          (v.category && v.category.toLowerCase().includes(text)) ||
          (v.description && v.description.toLowerCase().includes(text))
        );
      });
      renderVideos(filtered);
    });

    // Simple HTML escape for safety
    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
